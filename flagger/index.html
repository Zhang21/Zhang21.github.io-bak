<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Flagger - 风继续吹</title><meta name="Description" content="个人博客"><meta property="og:title" content="Flagger" />
<meta property="og:description" content="参考:

Flagger github: https://github.com/fluxcd/flagger
Flagger docs: https://docs.flagger.app/


" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhang21.cn/flagger/" /><meta property="og:image" content="https://zhang21.cn/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-14T19:25:19&#43;00:00" />
<meta property="article:modified_time" content="2021-01-14T19:25:19&#43;00:00" /><meta property="og:site_name" content="My cool site" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://zhang21.cn/logo.png"/>

<meta name="twitter:title" content="Flagger"/>
<meta name="twitter:description" content="参考:

Flagger github: https://github.com/fluxcd/flagger
Flagger docs: https://docs.flagger.app/


"/>
<meta name="application-name" content="风继续吹">
<meta name="apple-mobile-web-app-title" content="风继续吹"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://zhang21.cn/flagger/" /><link rel="prev" href="https://zhang21.cn/helm/" /><link rel="next" href="https://zhang21.cn/istio/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Flagger",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/zhang21.cn\/flagger\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/zhang21.cn\/images\/Apple-Devices-Preview.png",
                            "width":  3200 ,
                            "height":  2048 
                        }],"genre": "posts","keywords": "K8s, CNCF, DevOps, GitOps, Canary, ServiceMesh","wordcount":  14456 ,
        "url": "https:\/\/zhang21.cn\/flagger\/","datePublished": "2021-01-14T19:25:19+00:00","dateModified": "2021-01-14T19:25:19+00:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "Zhang21","logo": "https:\/\/zhang21.cn\/leslie.png"},"author": {
                "@type": "Person",
                "name": "Zhang21"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="风继续吹"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>风继续吹</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="https://github.com/zhang21" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="风继续吹"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>风继续吹</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="https://github.com/zhang21" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Flagger</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://zhang21.cn" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Zhang21</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/devops/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>devops</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2021-01-14">2021-01-14</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;约 14456 字&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;预计阅读 29 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#介绍">介绍</a></li>
    <li><a href="#快速开始">快速开始</a></li>
    <li><a href="#安装">安装</a>
      <ul>
        <li><a href="#k8s">k8s</a>
          <ul>
            <li><a href="#先决条件">先决条件</a></li>
            <li><a href="#helm安装flagger">Helm安装Flagger</a></li>
            <li><a href="#helm安装grafana">Helm安装Grafana</a></li>
            <li><a href="#kustomize安装flagger">Kustomize安装Flagger</a></li>
          </ul>
        </li>
        <li><a href="#gke-istio">gke istio</a></li>
        <li><a href="#eks-app-mesh">eks app mesh</a></li>
      </ul>
    </li>
    <li><a href="#使用">使用</a>
      <ul>
        <li><a href="#它如何工作">它如何工作</a>
          <ul>
            <li><a href="#canary-resource">Canary resource</a></li>
            <li><a href="#canary-target">Canary target</a></li>
            <li><a href="#canary-service">Canary service</a></li>
            <li><a href="#canary-status">Canary status</a></li>
            <li><a href="#canary-finalizers">Canary finalizers</a></li>
            <li><a href="#canary-analysis">Canary analysis</a></li>
          </ul>
        </li>
        <li><a href="#部署策略">部署策略</a>
          <ul>
            <li><a href="#金丝雀发布">金丝雀发布</a>
              <ul>
                <li><a href="#rollout-weights">Rollout Weights</a></li>
              </ul>
            </li>
            <li><a href="#ab测试">AB测试</a></li>
            <li><a href="#蓝绿部署">蓝绿部署</a></li>
            <li><a href="#流量镜像的蓝绿部署">流量镜像的蓝绿部署</a></li>
          </ul>
        </li>
        <li><a href="#指标分析">指标分析</a>
          <ul>
            <li><a href="#内置指标">内置指标</a></li>
            <li><a href="#自定义指标">自定义指标</a></li>
            <li><a href="#prometheus">Prometheus</a></li>
            <li><a href="#prometheus认证">Prometheus认证</a></li>
            <li><a href="#dataddog">DataDdog</a></li>
            <li><a href="#amazon-cloudwatch">Amazon CloudWatch</a></li>
            <li><a href="#new-relic">New Relic</a></li>
          </ul>
        </li>
        <li><a href="#webhooks">Webhooks</a>
          <ul>
            <li><a href="#负载测试">负载测试</a></li>
            <li><a href="#负载测试委托">负载测试委托</a></li>
            <li><a href="#集成测试">集成测试</a></li>
            <li><a href="#手动门控">手动门控</a></li>
          </ul>
        </li>
        <li><a href="#告警">告警</a>
          <ul>
            <li><a href="#全局配置">全局配置</a></li>
            <li><a href="#金丝雀层面配置">金丝雀层面配置</a></li>
            <li><a href="#alertmnager">AlertMnager</a></li>
          </ul>
        </li>
        <li><a href="#监控">监控</a>
          <ul>
            <li><a href="#grafana">Grafana</a></li>
            <li><a href="#logging">Logging</a></li>
            <li><a href="#event-webhook">Event Webhook</a></li>
            <li><a href="#metrics">Metrics</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#教程">教程</a>
      <ul>
        <li><a href="#isito金丝雀部署">Isito金丝雀部署</a></li>
        <li><a href="#istio-ab测试">Istio AB测试</a></li>
        <li><a href="#nginx-金丝雀部署">Nginx 金丝雀部署</a></li>
        <li><a href="#蓝绿部署-1">蓝绿部署</a></li>
        <li><a href="#使用prometheus-operator的金丝雀分析">使用Prometheus Operator的金丝雀分析</a></li>
        <li><a href="#零停机时间部署">零停机时间部署</a>
          <ul>
            <li><a href="#部署策略-1">部署策略</a></li>
            <li><a href="#存活度健康检查">存活度健康检查</a></li>
            <li><a href="#准备度健康检查">准备度健康检查</a></li>
            <li><a href="#优雅地关闭">优雅地关闭</a></li>
            <li><a href="#推迟envoy关闭">推迟envoy关闭</a></li>
            <li><a href="#资源请求和限制">资源请求和限制</a></li>
            <li><a href="#自动伸缩">自动伸缩</a></li>
            <li><a href="#ingress重试">ingress重试</a></li>
          </ul>
        </li>
        <li><a href="#推出权重">推出权重</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>参考:</p>
<ul>
<li>Flagger github: <a href="https://github.com/fluxcd/flagger">https://github.com/fluxcd/flagger</a></li>
<li>Flagger docs: <a href="https://docs.flagger.app/">https://docs.flagger.app/</a></li>
</ul>
<br>
<hr>
<br>
<h1 id="介绍">介绍</h1>
<p>Introduction</p>
<p>Flagger是一个渐进式交付的k8s operator，可使用Istio, Linkerd, App Mesh, Nginx, Sgipper, Contour, Gloo, Traefik路由流量漂移(traffic shifting)，自动化进行金丝雀部署，Prometheus指标用于金丝雀分析。金丝雀分析可通过webhook扩展，用于运行系统集成/测试验收、负载测试，或其它自定义验证。</p>
<p>Flagger实现了一个控制循环(control loop)，逐渐向金丝雀转移流量，同时测量如HTTP请求成功率、请求平均持续时间、pod健康度等关键性能指标。基于对KPIs的分析，提升(promoted)或中止(aborted)金丝雀，分析结果发布到Slack等其它软件。</p>
<br>
<p>Flagger架构图：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/Flagger/flagger-canary-overview.png"
        data-srcset="/images/Flagger/flagger-canary-overview.png, /images/Flagger/flagger-canary-overview.png 1.5x, /images/Flagger/flagger-canary-overview.png 2x"
        data-sizes="auto"
        alt="/images/Flagger/flagger-canary-overview.png"
        title="/images/Flagger/flagger-canary-overview.png" /></p>
<br>
<p>Flagger可以k8s CRD进行配置，并与任何用于k8s ci/cd 方案兼容。由于Flagger是声明性的，并对k8s events做出反应，它可与Flux CD或JenkinsX一起用于GitOps管道中。</p>
<p>Flagger是一个CNCF项目。</p>
<br>
<hr>
<br>
<h1 id="快速开始">快速开始</h1>
<p>Getting started</p>
<p>要开始使用Flagger，请选择一个受支持的路由提供商，并安装它(Helm/Kustmoze)。</p>
<p>安装Flagger之后，可从以下指导手册开始：</p>
<p><strong>Service mesh</strong></p>
<ul>
<li>Istio</li>
<li>Linkerd</li>
<li>aws app mesh</li>
</ul>
<p><strong>Ingress controller</strong></p>
<ul>
<li>Contour</li>
<li>Gloo</li>
<li>Nginx ingress</li>
<li>skipper ingress</li>
<li>Traefik</li>
</ul>
<p><strong>Hand-on Gitops</strong></p>
<ul>
<li>Istio</li>
<li>Linkerd</li>
<li>aws app mesh</li>
</ul>
<br>
<hr>
<br>
<h1 id="安装">安装</h1>
<p>Install</p>
<br>
<h2 id="k8s">k8s</h2>
<p>Flagger Install on Kubernetes</p>
<br>
<h3 id="先决条件">先决条件</h3>
<p>Prerequisites</p>
<p>k8s v1.16+</p>
<br>
<br>
<h3 id="helm安装flagger">Helm安装Flagger</h3>
<p>Install Flagger with Helm</p>
<p>你可在任意namespace安装Flagger，只要它能够访问Prometheus。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 添加helm 仓库</span>
helm repo add flagger https://flagger.app


<span class="c1"># 安装Flagger Canary CRD</span>
kubectl apply -f https://raw.githubusercontent.com/fluxcd/flagger/main/artifacts/flagger/crd.yaml


<span class="c1"># Deploy Flagger for Istio</span>
<span class="c1"># Flagger依赖Istio telemetry和Prometheus</span>
helm upgrade -i flagger flagger/flagger <span class="se">\
</span><span class="se"></span>--namespace<span class="o">=</span>istio-system <span class="se">\
</span><span class="se"></span>--set crd.create<span class="o">=</span><span class="nb">false</span> <span class="se">\
</span><span class="se"></span>--set <span class="nv">meshProvider</span><span class="o">=</span>istio <span class="se">\
</span><span class="se"></span>--set <span class="nv">metricsServer</span><span class="o">=</span>http://prometheus:9090
</code></pre></td></tr></table>
</div>
</div><br>
<p>对于Istio多集群共享控制面板，你可在每个远程集群上安装Flagger，并设置Istio控制面板host cluster kubeconfig:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">helm upgrade -i flagger flagger/flagger <span class="se">\
</span><span class="se"></span>--namespace<span class="o">=</span>istio-system <span class="se">\
</span><span class="se"></span>--set crd.create<span class="o">=</span><span class="nb">false</span> <span class="se">\
</span><span class="se"></span>--set <span class="nv">meshProvider</span><span class="o">=</span>istio <span class="se">\
</span><span class="se"></span>--set <span class="nv">metricsServer</span><span class="o">=</span>http://istio-cluster-prometheus:9090 <span class="se">\
</span><span class="se"></span>--set istio.kubeconfig.secretName<span class="o">=</span>istio-kubeconfig <span class="se">\
</span><span class="se"></span>--set istio.kubeconfig.key<span class="o">=</span>kubeconfig
</code></pre></td></tr></table>
</div>
</div><p>注意，Istio kubeconfig必须存储为k8s secret，其数据键名称为<code>kubeconfig</code>。关于如果配置Istio multi-cluster credential的详细信息，请参考Istio文档: <a href="https://istio.io/docs/setup/install/multicluster/shared-vpn/#credentials">https://istio.io/docs/setup/install/multicluster/shared-vpn/#credentials</a></p>
<br>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Deploy Flagger for Linkerd</span>
helm upgrade -i flagger flagger/flagger <span class="se">\
</span><span class="se"></span>--namespace<span class="o">=</span>linkerd <span class="se">\
</span><span class="se"></span>--set crd.create<span class="o">=</span><span class="nb">false</span> <span class="se">\
</span><span class="se"></span>--set <span class="nv">meshProvider</span><span class="o">=</span>linkerd <span class="se">\
</span><span class="se"></span>--set <span class="nv">metricsServer</span><span class="o">=</span>http://linkerd-prometheus:9090
</code></pre></td></tr></table>
</div>
</div><br>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Deploy Flagger for App Mesh</span>
helm upgrade -i flagger flagger/flagger <span class="se">\
</span><span class="se"></span>--namespace<span class="o">=</span>appmesh-system <span class="se">\
</span><span class="se"></span>--set crd.create<span class="o">=</span><span class="nb">false</span> <span class="se">\
</span><span class="se"></span>--set <span class="nv">meshProvider</span><span class="o">=</span>appmesh <span class="se">\
</span><span class="se"></span>--set <span class="nv">metricsServer</span><span class="o">=</span>http://appmesh-prometheus:9090
</code></pre></td></tr></table>
</div>
</div><br>
<p>对于ingress controlles，安装指南如下：</p>
<ul>
<li><a href="https://docs.flagger.app/tutorials/contour-progressive-delivery" target="_blank" rel="noopener noreffer ">Contour</a></li>
<li><a href="https://docs.flagger.app/tutorials/gloo-progressive-delivery" target="_blank" rel="noopener noreffer ">Gloo</a></li>
<li><a href="https://docs.flagger.app/tutorials/nginx-progressive-delivery" target="_blank" rel="noopener noreffer ">Nginx</a></li>
<li><a href="https://docs.flagger.app/tutorials/skipper-progressive-delivery" target="_blank" rel="noopener noreffer ">Skipper</a></li>
<li><a href="https://docs.flagger.app/tutorials/traefik-progressive-delivery" target="_blank" rel="noopener noreffer ">Traefik</a></li>
</ul>
<br>
<br>
<h3 id="helm安装grafana">Helm安装Grafana</h3>
<p>Install Grafana with Helm</p>
<p>Flagger使用Grafana来监测金丝雀分析。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Deploy Grafana in the istio-system namespace</span>
helm upgrade -i flagger-grafana flagger/grafana <span class="se">\
</span><span class="se"></span>--namespace<span class="o">=</span>istio-system <span class="se">\
</span><span class="se"></span>--set <span class="nv">url</span><span class="o">=</span>http://prometheus.istio-system:9090 <span class="se">\
</span><span class="se"></span>--set <span class="nv">user</span><span class="o">=</span>admin <span class="se">\
</span><span class="se"></span>--set <span class="nv">password</span><span class="o">=</span>change-me


<span class="c1"># 使用端口转发访问Grafana</span>
kubectl -n istio-system port-forward svc/flagger-grafana 3000:80
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="kustomize安装flagger">Kustomize安装Flagger</h3>
<br>
<br>
<h2 id="gke-istio">gke istio</h2>
<br>
<br>
<h2 id="eks-app-mesh">eks app mesh</h2>
<br>
<hr>
<br>
<h1 id="使用">使用</h1>
<p>Usage</p>
<br>
<br>
<h2 id="它如何工作">它如何工作</h2>
<p>How it works</p>
<p>Flagger可以配置使用名为<code>canary</code>的自定义资源来自动化k8s工作负载发布过程。</p>
<br>
<h3 id="canary-resource">Canary resource</h3>
<p>canary CRD定义了运行在k8s上的程序的发布过程，它是跨集群、服务网格、Ingress提供商可移植。</p>
<p>对一个名为podinfo的deployment，具有渐进式流量迁移的金丝雀发布(canary release)如下所定义。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">flagger.app/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Canary</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">podinfo</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">targetRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">podinfo</span><span class="w">
</span><span class="w">  </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9898</span><span class="w">
</span><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span><span class="w">    </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">    </span><span class="nt">maxWeight</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span><span class="w">    </span><span class="nt">stepWeight</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">    </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">request-success-rate</span><span class="w">
</span><span class="w">        </span><span class="nt">thresholdRange</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">min</span><span class="p">:</span><span class="w"> </span><span class="m">99</span><span class="w">
</span><span class="w">        </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">request-duration</span><span class="w">
</span><span class="w">        </span><span class="nt">thresholdRange</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">max</span><span class="p">:</span><span class="w"> </span><span class="m">500</span><span class="w">
</span><span class="w">        </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span><span class="w">    </span><span class="nt">webhooks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">load-test</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://flagger-loadtester.test/</span><span class="w">
</span><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;hey -z 1m -q 10 -c 2 http://podinfo-canary.test:9898/&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>当部署一个应用的新版本时，Flagger逐渐地向金丝雀(canary)转移流量，同时测量请求成功率以及响应持续时间。你可以使用自定义指标扩展金丝雀分析，接受和负载测试来硬化应用发布过程的验证过程。</p>
<p>如果你在同一个集群内运行了多个服务网格(service mesh)或ingress controller，则可以使用<code>spec.provider</code>配置金丝雀来覆盖全局配置。</p>
<br>
<br>
<h3 id="canary-target">Canary target</h3>
<p>一个金丝雀资源可以目标到一个k8s deployment或daemonset。</p>
<p>k8s deployment示例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">progressDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span><span class="w">  </span><span class="nt">targetRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">podinfo</span><span class="w">
</span><span class="w">  </span><span class="nt">autoscalerRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">autoscaling/v2beta2</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HorizontalPodAutoscaler</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">podinfo</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>根据上述配置，Flagger生成如下k8s对象:</p>
<ul>
<li><code>deployment/&lt;targetRef.name&gt;-primary</code></li>
<li><code>hpa/&lt;autoscalerRef.name&gt;-primary</code></li>
</ul>
<p>primary deployment被视为应用稳定版本，默认情况下所有流量都路由到此版本，并且target deployment将缩放为0。Flagger会检测targer deployment（包括secrets和configmaps）的更改，并在新版本替换为主版本(primary)之前执行金丝雀分析。</p>
<p>注意，target deployment必须具有这种格式的单个标签(single label): <code>app: &lt;deployment-name&gt;</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">podinfo</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">podinfo</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">podinfo</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>除了<code>app</code>，Flagger支持<code>name</code>和<code>app.kubernetes.io/name</code>选择器(selector)。如果使用不同的惯例，你可以在Flagger deployment的容器参数下指定<code>-selector-labels=my-app-label</code>命令行标志，或在使用Helm安装Flagger时设置<code>--set selectorLabels=my-app-label</code>，来指定特定的标签。</p>
<p>如果target deployment使用了secrets或configmaps，Flagger将使用<code>--primary</code>后缀创建每个对象的副本，并将在primary deployment中引用这些对象。如果在configmap, secret中注释了<code>flagger.app/config-tracking: disabled</code>，Flagger将为primary deployment使用相同的对象，而不是做一个primary的副本。可在Flagger deployment的容器参数中使用<code>-enable-config-tracking=false</code>命令行标志，或在使用Helm安装Flagger时设置<code>--set configTracking.enabled=false</code>来全局禁用secrets/configmaps tracking。不过不建议全局禁用，建议使用注释(annotation)。</p>
<p>自动伸缩(autoscaler)引用是可选的，当指定时，在target和primary deployment在伸缩时，Flagger将暂停流量增加(traffic increase)。HPA可以帮助减少金丝雀分析期间的资源使用情况。</p>
<p>进度截止时间表示canary deployment在回滚之前进行的最大时间，默认为十分钟。</p>
<br>
<br>
<h3 id="canary-service">Canary service</h3>
<p>金丝雀资源决定了如何在集群内公开工作负载。金丝雀目标应该公开一个TCP端口，由Flagger去创建一个ClusterIP服务。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">podinfo</span><span class="w">
</span><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9898</span><span class="w">
</span><span class="w">    </span><span class="nt">portName</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">9898</span><span class="w">
</span><span class="w">    </span><span class="nt">portDiscovery</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>如果工作负载使用gRPC（默认是http），则portName应设置为<code>grpc</code>。</p>
<p>如果启用了端口发现(port discovery)，Flagger扫描目标工作负载并提取排除了canary service和service mesh sidecar端口的容器端口。生成CluterIP服务时会使用这些端口。</p>
<p>基于canary spec service，Flagger创建如下的k8s ClusterIP service:</p>
<ul>
<li><code>&lt;service.name&gt;.&lt;namespace&gt;.svc.cluster.local</code>，selector <code>app=&lt;name&gt;-primary</code></li>
<li><code>&lt;service.name&gt;-primary.&lt;namespace&gt;.svc.cluster.local</code>，selector <code>app=&lt;name&gt;-primary</code></li>
<li><code>&lt;service.name&gt;-canary.&lt;namespace&gt;.svc.cluster.local</code>，selector <code>app=&lt;name&gt;</code></li>
</ul>
<p>这可确保流量到<code>podinfo.test:9898</code>将被路由到应用的最新稳定版本。<code>podinfo-canary.test:9898</code>这个地址仅在金丝雀分析期间可用，可用于符合测试或负载测试。</p>
<p>可以配置Flagger为service生成annotations和labels：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9898</span><span class="w">
</span><span class="w">    </span><span class="nt">apex</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;test&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;test&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">canary</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;test&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;test&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">primary</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;test&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;test&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>除了端口映射和元数据，service spec可包含URI和重定向规则，超时和重试策略：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9898</span><span class="w">
</span><span class="w">    </span><span class="nt">match</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">uri</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">prefix</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span><span class="w">    </span><span class="nt">rewrite</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span><span class="w">    </span><span class="nt">retries</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">attempts</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">      </span><span class="nt">perTryTimeout</span><span class="p">:</span><span class="w"> </span><span class="l">1s</span><span class="w">
</span><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>当使用Istio时，你还可以指定HTTP headers, CORS, traffic policies, Istio gateway, hosts。Istio的路由配置请参考: <a href="https://docs.flagger.app/faq#istio-routing">https://docs.flagger.app/faq#istio-routing</a></p>
<br>
<br>
<h3 id="canary-status">Canary status</h3>
<p>可使用kubectl来获取canary deployment的当前状态:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">kubectl get canaries --all-namespaces

NAMESPACE   NAME      STATUS        WEIGHT   LASTTRANSITIONTIME
test        podinfo   Progressing   15       2019-06-30T14:05:07Z
prod        frontend  Succeeded     0        2019-06-30T16:15:07Z
prod        backend   Failed        0        2019-06-30T17:05:07Z
</code></pre></td></tr></table>
</div>
</div><p>状态条件反映了金丝雀分析的最后一个已知状态:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">kubectl -n test get canary/podinfo -oyaml | awk &#39;/status/,0&#39;
</code></pre></td></tr></table>
</div>
</div><p>一个成功的rollout状态:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">status:
  canaryWeight: 0
  failedChecks: 0
  iterations: 0
  lastAppliedSpec: &#34;14788816656920327485&#34;
  lastPromotedSpec: &#34;14788816656920327485&#34;
  conditions:
  - lastTransitionTime: &#34;2019-07-10T08:23:18Z&#34;
    lastUpdateTime: &#34;2019-07-10T08:23:18Z&#34;
    message: Canary analysis completed successfully, promotion finished.
    reason: Succeeded
    status: &#34;True&#34;
    type: Promoted
</code></pre></td></tr></table>
</div>
</div><p>CD样例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># update the container image
kubectl set image deployment/podinfo podinfod=stefanprodan/podinfo:3.0.1

# wait for Flagger to detect the change
ok=false
until ${ok}; do
    kubectl get canary/podinfo | grep &#39;Progressing&#39; &amp;&amp; ok=true || ok=false
    sleep 5
done

# wait for the canary analysis to finish
kubectl wait canary/podinfo --for=condition=promoted --timeout=5m

# check if the deployment was successful 
kubectl get canary/podinfo | grep Succeeded
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="canary-finalizers">Canary finalizers</h3>
<p>Flagger对金丝雀删除(canary deletion)的默认行为是 离开(leave)不受当前状态控制器拥有的资源。这简化了删除操作，避免了在资源最终确定期间可能的死锁。如果金丝雀被引入现有资源，他们将在初始化阶段变异(mutated)，并且不再反映它们的初始状态。如果删除时所需的功能是将资源还原到他们的初始阶段，则可以启动<code>revertOnDeletion</code>属性。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">revertOnDeletion</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>当一个删除操作提交到集群，Flagger经尝试恢复(revert)以下资源：</p>
<ul>
<li>canary target副本将更新到primary副本数</li>
<li>canary service选择器将被恢复</li>
<li>mesh/ingress 流量路由到target</li>
</ul>
<p>推荐的方法是禁用金丝雀分析，将使用<code>skipAnalysis</code>属性，这限制了资源和解(reconciliation)的需求。当不再计划依赖Flagger部署管理时，应该启用<code>revertOnDeletion</code>属性。</p>
<br>
<br>
<h3 id="canary-analysis">Canary analysis</h3>
<p>金丝雀部署定义了：</p>
<ul>
<li>部署策略的类型</li>
<li>验证金丝雀版本的指标</li>
<li>一致性测试、负载测试和手动门控的webhooks</li>
<li>告警设置</li>
</ul>
<p>spec:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># schedule interval (default 60s)</span><span class="w">
</span><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># max number of failed metric checks before rollback</span><span class="w">
</span><span class="w">    </span><span class="nt">threshold</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># max traffic percentage routed to canary</span><span class="w">
</span><span class="w">    </span><span class="c"># percentage (0-100)</span><span class="w">
</span><span class="w">    </span><span class="nt">maxWeight</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># canary increment step</span><span class="w">
</span><span class="w">    </span><span class="c"># percentage (0-100)</span><span class="w">
</span><span class="w">    </span><span class="nt">stepWeight</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># promotion increment step</span><span class="w">
</span><span class="w">    </span><span class="c"># percentage (0-100)</span><span class="w">
</span><span class="w">    </span><span class="nt">stepWeightPromotion</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># total number of iterations</span><span class="w">
</span><span class="w">    </span><span class="c"># used for A/B Testing and Blue/Green</span><span class="w">
</span><span class="w">    </span><span class="nt">iterations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># canary match conditions</span><span class="w">
</span><span class="w">    </span><span class="c"># used for A/B Testing</span><span class="w">
</span><span class="w">    </span><span class="nt">match</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="c"># HTTP header</span><span class="w">
</span><span class="w">    </span><span class="c"># key performance indicators</span><span class="w">
</span><span class="w">    </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="c"># metric check</span><span class="w">
</span><span class="w">    </span><span class="c"># alerting</span><span class="w">
</span><span class="w">    </span><span class="nt">alerts</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="c"># alert provider</span><span class="w">
</span><span class="w">    </span><span class="c"># external checks</span><span class="w">
</span><span class="w">    </span><span class="nt">webhooks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="c"># hook</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>金丝雀分析定期运行，直到它达到最大流量权重或迭代次数。在每个运行时，Flagger调用webhook，检查指标，如果达到失败的检查阈值，则停止分析并回滚金丝雀。如果配置了告警，Flagger将发送分析结果。</p>
<br>
<br>
<h2 id="部署策略">部署策略</h2>
<p>Deployment Strategies: <a href="https://docs.flagger.app/usage/deployment-strategies">https://docs.flagger.app/usage/deployment-strategies</a></p>
<p>Flagger可以为以下部署策略自动运行应用分析(application analysis)，提升(promotion)，回滚(rollback):</p>
<ul>
<li>金丝雀发布(Canary Release, progressive traffic shifting): Istio, Linkerd, App Mesh, NGINX, Skipper, Contour, Gloo Edge, Traefik</li>
<li>AB测试(A/B Testing, HTTP headers and cookies traffic routing): Istio, App Mesh, NGINX, Contour, Gloo Edge</li>
<li>蓝绿(Blue/Green, traffic switching): Kubernetes CNI, Istio, Linkerd, App Mesh, NGINX, Contour, Gloo Edge</li>
<li>蓝绿镜像(Blue/Green Mirroring, traffic shadowing): Istio</li>
</ul>
<br>
<p>对于金丝雀发布和A/B测试，你应该使用7层流量管理方案，如service mesh或ingress controller。
对于蓝绿部署，不需要service mesh 或 ingress controller。</p>
<p>可通过改变以下对象来触发一个金丝雀分析：</p>
<ul>
<li>Deployment PodSpec (container image, command, ports, env, resources, etc)</li>
<li>ConfigMaps mounted as volumes or mapped to environment variables</li>
<li>Secrets mounted as volumes or mapped to environment variables</li>
</ul>
<br>
<br>
<h3 id="金丝雀发布">金丝雀发布</h3>
<p>Canary Release</p>
<p>Flagger实现了一个控制循环(control loop)，可以逐渐地将流量转移到金丝雀，同时测量关键性能指标（如http请求成功率，请求平均耗时，Pod健康状态&hellip;）。</p>
<br>
<p>Flagger金丝雀阶段：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/Flagger/flagger-canary-steps.png"
        data-srcset="/images/Flagger/flagger-canary-steps.png, /images/Flagger/flagger-canary-steps.png 1.5x, /images/Flagger/flagger-canary-steps.png 2x"
        data-sizes="auto"
        alt="/images/Flagger/flagger-canary-steps.png"
        title="/images/Flagger/flagger-canary-steps.png" /></p>
<p>金丝雀分析会定期运行，直到达到最大流量权重或检查失败。</p>
<br>
<p>spec:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># schedule interval (default 60s)</span><span class="w">
</span><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span><span class="w">    </span><span class="c"># max number of failed metric checks before rollback</span><span class="w">
</span><span class="w">    </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">    </span><span class="c"># max traffic percentage routed to canary</span><span class="w">
</span><span class="w">    </span><span class="c"># percentage (0-100)</span><span class="w">
</span><span class="w">    </span><span class="nt">maxWeight</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span><span class="w">    </span><span class="c"># canary increment step</span><span class="w">
</span><span class="w">    </span><span class="c"># percentage (0-100)</span><span class="w">
</span><span class="w">    </span><span class="nt">stepWeight</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">    </span><span class="c"># promotion increment step (default 100)</span><span class="w">
</span><span class="w">    </span><span class="c"># percentage (0-100)</span><span class="w">
</span><span class="w">    </span><span class="nt">stepWeightPromotion</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span><span class="w">  </span><span class="c"># deploy straight to production without</span><span class="w">
</span><span class="w">  </span><span class="c"># the metrics and webhook checks</span><span class="w">
</span><span class="w">  </span><span class="nt">skipAnalysis</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>以上分析，如果成功，将运行25分钟，每分钟验证HTTP指标和webhokk。</p>
<p>你可以使用以下供使确定验证和升级金丝雀部署所需的最短时间：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">interval * (maxWeight / stepWeight)

# 上面
1 * ( 50 / 2)
</code></pre></td></tr></table>
</div>
</div><p>当指标检测失败时，金丝雀回滚需要的时间：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">interval * threshold

# 上面
1 * 10
</code></pre></td></tr></table>
</div>
</div><p>当指定了<code>stepWeightPromotion</code>，promotion阶段发生在stages中，流量以逐步的方式路由回primary pod，主权重逐渐增加直到100%。</p>
<br>
<p>在紧急情况下，你可能希望提升分析阶段并直接应用变更到生产环境。你随时都可以设置<code>spec.skipAnalysis: true</code>。当启用了跳过分析，Flagger会检查金丝雀部署是否健康，并在不分析它的情况下提升它(promote)。如果正在进行分析，则Flagger回取消分析并运行提升(promotion)。</p>
<p>Gated canary promotion stages:</p>
<ul>
<li>扫描金丝雀部署（scan for canary deployments）</li>
<li>检查主和金丝雀部署状态（check primary and canary deployment status）
<ul>
<li>如果正在进行滚动更新，则停止（halt advancement if a rolling update is underway）</li>
<li>如果pod不健康，则停止（halt advancement if pods are unhealthy）</li>
</ul>
</li>
<li>确认部署并检查结果（call confirm-rollout webhooks and check results）
<ul>
<li>如果任意hook返回非http 2xx结果，则停止提升（halt advancement if any hook returns a non HTTP 2xx result）</li>
</ul>
</li>
<li>预览部署并检查结果（call pre-rollout webhooks and check results）
<ul>
<li>如果任意hook返回非http 2xx结果，则停止提升</li>
<li>递增失败的检查计数器（increment the failed checks counter）</li>
</ul>
</li>
<li>增加金丝雀流量权重（increase canary traffic weight percentage from 0% to 2% (step weight)）</li>
<li>调用推出并检查结果（call rollout webhooks and check results）</li>
<li>检查金丝雀HTTP请求成功率和延迟（call rollout webhooks and check results）
<ul>
<li>如果任意指标都在指定的阈值下，则停止提升（halt advancement if any metric is under the specified threshold）</li>
<li>递增失败的检查计数器</li>
</ul>
</li>
<li>检查失败的检查的数量是否达到了阈值（check if the number of failed checks reached the threshold）
<ul>
<li>路由所有流量到主（route all traffic to primary）</li>
<li>将金丝雀部署缩减为0并标记为失败（scale to zero the canary deployment and mark it as failed）</li>
<li>调用推出后的钩子（call post-rollout webhooks）</li>
<li>发送分析结果（post the analysis result to Slack）</li>
<li>等待金丝雀部署更新或重新开始（wait for the canary deployment to be updated and start over）</li>
</ul>
</li>
<li>增加金丝雀流量直到最大（increase canary traffic weight by 2% (step weight) till it reaches 50% (max weight) ）
<ul>
<li>如果任意狗子调用失败，则停止提升（halt advancement if any webhook call fails）</li>
<li>金丝雀请求成功率在阈值之下，则停止提升（halt advancement while canary request success rate is under the threshold）</li>
<li>金丝雀请求持续时间超过阈值，则停止提升（halt advancement while canary request duration P99 is over the threshold）</li>
<li>任意自定义指标检查失败，则停止提升（halt advancement while any custom metric check fails）</li>
<li>如果primary或金丝雀部署不健康，则停止提升（halt advancement if the primary or canary deployment becomes unhealthy ）</li>
<li>金丝雀部署正通过HPA进行伸缩，则停止提升（halt advancement while canary deployment is being scaled up/down by HPA）</li>
</ul>
</li>
<li>调用确认提升钩子并检查结果（call confirm-promotion webhooks and check results）
<ul>
<li>如果任意hook返回非http 2xx结果，则停止提升</li>
</ul>
</li>
<li>提升金丝雀为主（promote canary to primary）
<ul>
<li>将configmap和secret从金丝雀复制到主（copy ConfigMaps and Secrets from canary to primary）</li>
<li>复制金丝雀部署spec模板（copy canary deployment spec template over primary）</li>
</ul>
</li>
<li>等待主滚动更新完成（wait for primary rolling update to finish）
<ul>
<li>如果pod不健康，则停止提升</li>
</ul>
</li>
<li>路由所有流量到主（route all traffic to primary）</li>
<li>将金丝雀部署伸缩为0（scale to zero the canary deployment）</li>
<li>标记推出为完成（mark rollout as finished）</li>
<li>调用推出后钩子（call post-rollout webhooks）</li>
<li>发送金丝雀分析结果通知（send notification with the canary analysis result）</li>
<li>等待金丝雀部署更新并重新开始（wait for the canary deployment to be updated and start over）</li>
</ul>
<br>
<br>
<h4 id="rollout-weights">Rollout Weights</h4>
<p>默认情况下，Flagger对提升使用线性权重值（开始值，步进值，最大权重）。</p>
<p>栗子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">canary</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">promotion</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">maxWeight</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span><span class="w">      </span><span class="nt">stepWeight</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>此配置执行分析，从20开始，每次递增20，直到权重到达50。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">20 (20 : 80)
40 (40 : 60)
60 (60 : 40)
promotion
</code></pre></td></tr></table>
</div>
</div><br>
<p>要启用非线性提升，可以使用<code>stepWeights</code>参数（在金丝雀提升期间使用有序权重数组）。</p>
<p>栗子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">canary:
  analysis:
    promotion:
      stepWeights: [1, 2, 10, 80]
</code></pre></td></tr></table>
</div>
</div><p>此配置分析，从1开始，经过有序权重直到80。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">1 (1 : 99)
2 (2 : 98)
10 (10 : 90)
80 (20 : 60)
promotion
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="ab测试">AB测试</h3>
<p>A/B Testing</p>
<p>对于需要会话关联(session affinity)的前端应用，你应该使用HTTP headers或cookie匹配条件，以便在整个金丝雀分析期间，确保一组用户将保持同一应用版本。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/flagger/flagger-abtest-steps.png"
        data-srcset="/images/flagger/flagger-abtest-steps.png, /images/flagger/flagger-abtest-steps.png 1.5x, /images/flagger/flagger-abtest-steps.png 2x"
        data-sizes="auto"
        alt="/images/flagger/flagger-abtest-steps.png"
        title="/images/flagger/flagger-abtest-steps.png" /></p>
<br>
<p>你可以通过指定HTTP匹配条件和迭代次数来启用AB测试。如果Flagger发现HTTP匹配条件，它会忽略<code>maxWeight</code>和<code>stepWeight</code>设置。</p>
<p>Istio栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># schedule interval (default 60s)</span><span class="w">
</span><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span><span class="w">    </span><span class="c"># total number of iterations</span><span class="w">
</span><span class="w">    </span><span class="nt">iterations</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">    </span><span class="c"># max number of failed iterations before rollback</span><span class="w">
</span><span class="w">    </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">    </span><span class="c"># canary match condition</span><span class="w">
</span><span class="w">    </span><span class="nt">match</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">headers</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">x-canary</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;.*insider.*&#34;</span><span class="w">
</span><span class="w">      </span>- <span class="nt">headers</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">cookie</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;^(.*?;)?(canary=always)(;.*)?$&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span><span class="w">    </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">    </span><span class="nt">iterations</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">    </span><span class="nt">match</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">headers</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">x-canary</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">exact</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;insider&#34;</span><span class="w">
</span><span class="w">      </span>- <span class="nt">headers</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">cookie</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;^(.*?;)?(canary=always)(;.*)?$&#34;</span><span class="w">
</span><span class="w">      </span>- <span class="nt">sourceLabels</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;scheduler&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>header key必须小写，并使用作为分隔符。header value是大小写敏感的。</p>
<ul>
<li><code>exact: &quot;value&quot;</code> for exact string match</li>
<li><code>prefix: &quot;value&quot;</code> for prefix-based match</li>
<li><code>suffix: &quot;value&quot;</code> for suffix-based match</li>
<li><code>regex: &quot;value&quot;</code> for RE2 style regex-based match</li>
</ul>
<p>请注意，只有当网格网关包含在<code>canary.service.gateways</code>列表时，才适用<code>sourceLabels</code>匹配条件。</p>
<p>App Mesh栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span><span class="w">    </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">    </span><span class="nt">iterations</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">    </span><span class="nt">match</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">headers</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">user-agent</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;.*Chrome.*&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>注意，App Mesh支持单个条件。</p>
<br>
<p>轮廓栗子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span><span class="w">    </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">    </span><span class="nt">iterations</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">    </span><span class="nt">match</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">headers</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">user-agent</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">prefix</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Chrome&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>请注意，contour不支持正则，你可以使用prefix, suffix, exact。</p>
<br>
<p>nginx栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span><span class="w">    </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">    </span><span class="nt">iterations</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">    </span><span class="nt">match</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">headers</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">x-canary</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">exact</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;insider&#34;</span><span class="w">
</span><span class="w">      </span>- <span class="nt">headers</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">cookie</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">exact</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;canary&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>请注意，nginx ingress controller仅支持cookies的精确匹配，其中值必须设置为<code>always</code>。从nginx ingress v0.31开始，header values支持正常匹配。</p>
<p>以上配置将会路由带有x-canary header或canary cookie的用户:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">curl -H <span class="s1">&#39;X-Canary: insider&#39;</span> http://app.example.com
curl -b <span class="s1">&#39;canary=always&#39;</span> http://app.example.com
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="蓝绿部署">蓝绿部署</h3>
<p>Blue/Green Deployments</p>
<p>对于未使用服务网格部署的应用，Flagger可使用k8s 四层网络的蓝绿格式的部署。使用Istio，你可以在蓝绿之间选择镜像流量。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/Flagger/flagger-bluegreen-steps.png"
        data-srcset="/images/Flagger/flagger-bluegreen-steps.png, /images/Flagger/flagger-bluegreen-steps.png 1.5x, /images/Flagger/flagger-bluegreen-steps.png 2x"
        data-sizes="auto"
        alt="/images/Flagger/flagger-bluegreen-steps.png"
        title="/images/Flagger/flagger-bluegreen-steps.png" /></p>
<br>
<p>你可以在<code>analysis</code> spec中使用<code>iterations</code>替换<code>stepWeight/maxWeight</code>来使用蓝绿部署策略：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># schedule interval (default 60s)</span><span class="w">
</span><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span><span class="w">    </span><span class="c"># total number of iterations</span><span class="w">
</span><span class="w">    </span><span class="nt">iterations</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">    </span><span class="c"># max number of failed iterations before rollback</span><span class="w">
</span><span class="w">    </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>上面的配置，Flagger将在canary pod上运行一致性和负载测试10分钟。如果指标分析成功，当金丝雀提升时，实时流量(live traffic)将从旧版本切换到新版本。</p>
<p>蓝绿部署策略支持多个服务网格提供商。</p>
<p>服务网格的蓝绿推出步骤（Blue/Green rollout steps for service mesh）：</p>
<ul>
<li>检测新的修订（detect new revision (deployment spec, secrets or configmaps changes)）</li>
<li>扩展金丝雀（scale up the canary (green)）</li>
<li>运行一致性测试（run conformance tests for the canary pods）</li>
<li>每分钟为canary pods运行负载测试和指标检测（run load tests and metric checks for the canary pods every minute）</li>
<li>如果达到失败阈值，则中止金丝雀发布（abort the canary release if the failure threshold is reached）</li>
<li>路由流量到金丝雀（route traffic to canary）</li>
<li>提升主的canary spec（promote canary spec over primary (blue)）</li>
<li>等待主推出（wait for primary rollout）</li>
<li>路由流量到主（route traffic to primary）</li>
<li>缩小金丝雀（scale down canary）</li>
</ul>
<p>分析完成后，在触发主(primary, blue)滚动更新之前，流量被路由到金丝雀(canary, green)，这确保了在k8s部署推出期间避免删除飞行中(in-flight)的请求，平滑过渡到新版本。</p>
<br>
<br>
<h3 id="流量镜像的蓝绿部署">流量镜像的蓝绿部署</h3>
<p>Blue/Green with Traffic Mirroring</p>
<p>流量镜像是金丝雀（逐渐流量漂移）或蓝绿部署策略的前阶段(pre-stage)。流量镜像将复制每个入请求，将请求分别发送给主和金丝雀服务。来自主的响应将发送回用户，来自金丝雀的响应将被丢弃。两个请求都会收集指标，以便在金丝雀指标健康时，部署会继续进行。</p>
<p>镜像应该用于幂等的请求或能够进行两次处理（一次主，一次金丝雀）。读取是幂等的。在请求上使用镜像之前，请求可能写入，你应该考虑会发生什么，如果一个写重复并且由主和金丝雀处理。</p>
<p>要使用镜像，将<code>spec.analysis.mirror</code>设置为f<code>true</code>。</p>
<p>Istio栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># schedule interval (default 60s)</span><span class="w">
</span><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span><span class="w">    </span><span class="c"># total number of iterations</span><span class="w">
</span><span class="w">    </span><span class="nt">iterations</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">    </span><span class="c"># max number of failed iterations before rollback</span><span class="w">
</span><span class="w">    </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">    </span><span class="c"># Traffic shadowing (compatible with Istio only)</span><span class="w">
</span><span class="w">    </span><span class="nt">mirror</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="c"># Weight of the traffic mirrored to your canary (defaults to 100%)</span><span class="w">
</span><span class="w">    </span><span class="nt">mirrorWeight</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p>服务网格的镜像推出步骤（Mirroring rollout steps for service mesh）：</p>
<ul>
<li>检测新的改动（detect new revision (deployment spec, secrets or configmaps changes)）</li>
<li>伸展金丝雀（scale from zero the canary deployment）</li>
<li>等待HPA设置金丝雀最小副本数（wait for the HPA to set the canary minimum replicas）</li>
<li>检查金丝雀pod健康状态（check canary pods health）</li>
<li>运行验收测试（run the acceptance tests）</li>
<li>如果测试失败，则中止金丝雀发布（abort the canary release if tests fail）</li>
<li>启动负载测试（start the load tests）</li>
<li>从主镜像流量到金丝雀（mirror 100% of the traffic from primary to canary）</li>
<li>检查请求成功率和每分钟请求耗时（check request success rate and request duration every minute）</li>
<li>如果达到失败阈值，则中止金丝雀发布（abort the canary release if the failure threshold is reached）</li>
<li>如果达到迭代次数，则停止流量镜像（stop traffic mirroring after the number of iterations is reached）</li>
<li>路由实时流量到金丝雀pod（route live traffic to the canary pods）</li>
<li>提升金丝雀（promote the canary (update the primary secrets, configmaps and deployment spec)）</li>
<li>等待主推出完成（wait for the primary deployment rollout to finish）</li>
<li>等待HPA设置主的最小副本数（wait for the HPA to set the primary minimum replicas）</li>
<li>检查主pod健康状况（check primary pods health）</li>
<li>将实时流量切换回主（switch live traffic back to primary）</li>
<li>缩小金丝雀（scale to zero the canary）</li>
<li>发送金丝雀分析结果通知（send notification with the canary analysis result）</li>
</ul>
<br>
<br>
<h2 id="指标分析">指标分析</h2>
<p>Metrics Analysis</p>
<p>作为分析过程的一部分，Flagger可以根据应用特定指标验证其可用性、错误率、平均响应时间和任何其它目标级别的服务(SLOs, service level objectives)。如果在SLOs分期期间注意到性能下降，则发布将自动回滚以最小化影响用户。</p>
<br>
<br>
<h3 id="内置指标">内置指标</h3>
<p>Builtin metrics</p>
<p>Flaggger有两个内置的指标检查：HTTP请求成功率和持续时间。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">request-success-rate</span><span class="w">
</span><span class="w">      </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span><span class="w">      </span><span class="c"># minimum req success rate (non 5xx responses)</span><span class="w">
</span><span class="w">      </span><span class="c"># percentage (0-100)</span><span class="w">
</span><span class="w">      </span><span class="nt">thresholdRange</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">min</span><span class="p">:</span><span class="w"> </span><span class="m">99</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">request-duration</span><span class="w">
</span><span class="w">      </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span><span class="w">      </span><span class="c"># maximum req duration P99</span><span class="w">
</span><span class="w">      </span><span class="c"># milliseconds</span><span class="w">
</span><span class="w">      </span><span class="nt">thresholdRange</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">max</span><span class="p">:</span><span class="w"> </span><span class="m">500</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>内置的检查指标支持每个service mesh、ingress controller，并可使用Prometheus进行查询。</p>
<br>
<br>
<h3 id="自定义指标">自定义指标</h3>
<p>Custom metrics</p>
<p>金丝雀分析可以通过自定义检测指标进行扩展。使用<code>MetricTemplate</code>自定义资源，你可以配置Flagger连接到一个指标提供商（如Prometheus），并运行一个查询，它返回一个<code>float64</code>值。查询结果用于基于特定阈值范围来验证金丝雀。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">flagger.app/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">MetricTemplate</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-metric</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">provider</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="c"># can be prometheus or datadog</span><span class="w">
</span><span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="c"># API URL</span><span class="w">
</span><span class="w">    </span><span class="nt">secretRef</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="c"># name of the secret containing the API credentials</span><span class="w">
</span><span class="w">  </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="c"># metric query</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p>以下变量可用于查询模板：</p>
<ul>
<li><code>name</code> (canary.metadata.name)</li>
<li><code>namespace</code> (canary.metadata.namespace)</li>
<li><code>target</code> (canary.spec.targetRef.name)</li>
<li><code>service</code> (canary.spec.service.name)</li>
<li><code>ingress</code> (canary.spec.ingresRef.name)</li>
<li><code>interval</code> (canary.spec.analysis.metrics[].interval)</li>
</ul>
<p>金丝雀分析指标可以使用<code>templateRef</code>引用模板：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;my metric&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">templateRef</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-metric</span><span class="w">
</span><span class="w">          </span><span class="c"># namespace is optional</span><span class="w">
</span><span class="w">          </span><span class="c"># when not specified, the canary namespace will be used</span><span class="w">
</span><span class="w">          </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">flagger</span><span class="w">
</span><span class="w">        </span><span class="c"># accepted values</span><span class="w">
</span><span class="w">        </span><span class="nt">thresholdRange</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">min</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">          </span><span class="nt">max</span><span class="p">:</span><span class="w"> </span><span class="m">1000</span><span class="w">
</span><span class="w">        </span><span class="c"># metric query time window</span><span class="w">
</span><span class="w">        </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="prometheus">Prometheus</h3>
<p>你可以使用如Prometheus，并编写PromQL查询，来创建自定义检查指标目标。</p>
<p>Prometheus template栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">flagger.app/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">MetricTemplate</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">not-found-percentage</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">provider</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">prometheus</span><span class="w">
</span><span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l">http://prometheus.istio-system:9090</span><span class="w">
</span><span class="w">  </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    100 - sum(
</span><span class="sd">        rate(
</span><span class="sd">            istio_requests_total{
</span><span class="sd">              reporter=&#34;destination&#34;,
</span><span class="sd">              destination_workload_namespace=&#34;{{ namespace }}&#34;,
</span><span class="sd">              destination_workload=&#34;{{ target }}&#34;,
</span><span class="sd">              response_code!=&#34;404&#34;
</span><span class="sd">            }[{{ interval }}]
</span><span class="sd">        )
</span><span class="sd">    )
</span><span class="sd">    /
</span><span class="sd">    sum(
</span><span class="sd">        rate(
</span><span class="sd">            istio_requests_total{
</span><span class="sd">              reporter=&#34;destination&#34;,
</span><span class="sd">              destination_workload_namespace=&#34;{{ namespace }}&#34;,
</span><span class="sd">              destination_workload=&#34;{{ target }}&#34;
</span><span class="sd">            }[{{ interval }}]
</span><span class="sd">        )
</span><span class="sd">    ) * 100</span><span class="w">    
</span></code></pre></td></tr></table>
</div>
</div><p>在金丝雀分析中引用模板：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;404s percentage&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">templateRef</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">not-found-percentage</span><span class="w">
</span><span class="w">          </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system</span><span class="w">
</span><span class="w">        </span><span class="nt">thresholdRange</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">max</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">        </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>上面的配置验证金丝雀，通过检查HTTP 404 req/sec 百分比是否低于5%。如果大于5%阈值，那么金丝雀失败。</p>
<br>
<p>Prometheus gRPC错误率栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">flagger.app/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">MetricTemplate</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">grpc-error-rate-percentage</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">flagger</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">provider</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">prometheus</span><span class="w">
</span><span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l">http://flagger-prometheus.flagger-system:9090</span><span class="w">
</span><span class="w">  </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    100 - sum(
</span><span class="sd">        rate(
</span><span class="sd">            grpc_server_handled_total{
</span><span class="sd">              grpc_code!=&#34;OK&#34;,
</span><span class="sd">              kubernetes_namespace=&#34;{{ namespace }}&#34;,
</span><span class="sd">              kubernetes_pod_name=~&#34;{{ target }}-[0-9a-zA-Z]+(-[0-9a-zA-Z]+)&#34;
</span><span class="sd">            }[{{ interval }}]
</span><span class="sd">        )
</span><span class="sd">    )
</span><span class="sd">    /
</span><span class="sd">    sum(
</span><span class="sd">        rate(
</span><span class="sd">            grpc_server_started_total{
</span><span class="sd">              kubernetes_namespace=&#34;{{ namespace }}&#34;,
</span><span class="sd">              kubernetes_pod_name=~&#34;{{ target }}-[0-9a-zA-Z]+(-[0-9a-zA-Z]+)&#34;
</span><span class="sd">            }[{{ interval }}]
</span><span class="sd">        )
</span><span class="sd">    ) * 100</span><span class="w">    
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="prometheus认证">Prometheus认证</h3>
<p>Prometheus authentication</p>
<p>如果Prometheus启用了认证，你可以在相同的命名空间内创建一个包含认证信息的secret。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">prom-basic-auth</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">flagger</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">your-user</span><span class="w">
</span><span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">your-password</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>在<code>MetricTemplate</code>中引用secret：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">flagger.app/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">MetricTemplate</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-metric</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">flagger</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">provider</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">prometheus</span><span class="w">
</span><span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l">http://prometheus.monitoring:9090</span><span class="w">
</span><span class="w">    </span><span class="nt">secretRef</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">prom-basic-auth</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="dataddog">DataDdog</h3>
<br>
<br>
<h3 id="amazon-cloudwatch">Amazon CloudWatch</h3>
<br>
<br>
<h3 id="new-relic">New Relic</h3>
<br>
<br>
<h2 id="webhooks">Webhooks</h2>
<p>url: <a href="https://docs.flagger.app/usage/webhooks">https://docs.flagger.app/usage/webhooks</a></p>
<p>金丝雀分析可以用webhooks进行扩展延伸。如果金丝雀失败，Flagger会调用每个webhook url并检测响应状态码。</p>
<p>有几种类型的钩子：</p>
<ul>
<li><strong>confirm-rollout</strong>：在扩展金丝雀部署之前执行，并可用于手动批准。推出是暂停的，直到钩子返回一个成功的HTTP状态码。</li>
<li><strong>pre-rollout</strong>：在将流量路由到金丝雀之前执行。如果钩子失败，并且失败次数达到阈值，金丝雀进展是将暂停， 并回滚。</li>
<li><strong>rollout</strong>：在指标检查之前在分析期间执行。如果失败，金丝雀进展将暂停并最终回滚。</li>
<li><strong>confirm-promotion</strong>：在提升之前执行。金丝雀提升是暂停的，直到钩子返回HTTP 200。当提升暂停时，Flagger将继续运行指标检查和rollout钩子。</li>
<li><strong>post-rollout</strong>：在金丝雀被提升或回滚之后执行。如果失败，则记录错误。</li>
<li><strong>rollback</strong>：在金丝雀部署处于进度和等待状态时执行。这提供了在分析期间回滚或等待确认的能力。如果它返回一个成功的HTTP状态码，Flagger将停止分析并将金丝雀发布标记为失败。</li>
<li><strong>event</strong>：在每次Flagger发出k8s事件时执行。配置后，在Flagger在金丝雀部署期间的每个动作都将通过HTTP POST作为JSON发送。</li>
</ul>
<p>spec：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">webhooks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;start gate&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">confirm-rollout</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://flagger-loadtester.test/gate/approve</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;helm test&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">pre-rollout</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://flagger-helmtester.flagger/</span><span class="w">
</span><span class="w">        </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l">3m</span><span class="w">
</span><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;helmv3&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;test podinfo -n test&#34;</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;load test&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">rollout</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://flagger-loadtester.test/</span><span class="w">
</span><span class="w">        </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l">15s</span><span class="w">
</span><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;hey -z 1m -q 5 -c 2 http://podinfo-canary.test:9898/&#34;</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;promotion gate&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">confirm-promotion</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://flagger-loadtester.test/gate/approve</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;notify&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">post-rollout</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://telegram.bot:8080/</span><span class="w">
</span><span class="w">        </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">some</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;message&#34;</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;rollback gate&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">rollback</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://flagger-loadtester.test/rollback/check</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;send to Slack&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">event</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://event-recevier.notifications/slack</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>webhook payload(http post)：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">{<span class="w">
</span><span class="w">    </span><span class="nt">&#34;name&#34;: </span><span class="s2">&#34;podinfo&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="nt">&#34;namespace&#34;: </span><span class="s2">&#34;test&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="nt">&#34;phase&#34;: </span><span class="s2">&#34;Progressing&#34;</span><span class="p">,</span><span class="w"> 
</span><span class="w">    </span><span class="nt">&#34;metadata&#34;: </span>{<span class="w">
</span><span class="w">        </span><span class="nt">&#34;test&#34;: </span><span class="w"> </span><span class="s2">&#34;all&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="nt">&#34;token&#34;: </span><span class="w"> </span><span class="s2">&#34;16688eb5e9f289f1991c&#34;</span><span class="w">
</span><span class="w">    </span>}<span class="w">
</span><span class="w"></span>}<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>响应状态码：</p>
<ul>
<li>200-202，通过增加流量权重来提升金丝雀</li>
<li>timeout或非2xx，停止提升并增加失败检查</li>
</ul>
<p>在一个非2xx响应，Flagger将包含response body在失败检查日志和k8s事件中。</p>
<p>event payload(http post)：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">{<span class="w">
</span><span class="w">  </span><span class="nt">&#34;name&#34;: </span><span class="s2">&#34;string (canary name)&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="nt">&#34;namespace&#34;: </span><span class="s2">&#34;string (canary namespace)&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="nt">&#34;phase&#34;: </span><span class="s2">&#34;string (canary phase)&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="nt">&#34;metadata&#34;: </span>{<span class="w">
</span><span class="w">    </span><span class="nt">&#34;eventMessage&#34;: </span><span class="s2">&#34;string (canary event message)&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="nt">&#34;eventType&#34;: </span><span class="s2">&#34;string (canary event type)&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="nt">&#34;timestamp&#34;: </span><span class="s2">&#34;string (unix timestamp ms)&#34;</span><span class="w">
</span><span class="w">  </span>}<span class="w">
</span><span class="w"></span>}<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>事件接收器可以根据接收阶段创建告警（可能的值：Initialized, Waiting, Progressing, Promoting, Finalising, Succeeded或Failed）。</p>
<br>
<br>
<h3 id="负载测试">负载测试</h3>
<p>Load Testing</p>
<p>对于未接收恒定流量的工作负载，Flagger可以使用webhook配置，即在调用时，为目标工作负载启动一个负载测试。如果工作负载在金丝雀分析期间没有接收任何流量，Flagger指标检查将失败（no values found for metric request-success-rate）。</p>
<p>Flagger的负载测试服务基于<a href="https://github.com/rakyll/hey" target="_blank" rel="noopener noreffer ">rakyll/hey</a>，当配置为webhooks时会在分析期间生成流量。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/Flagger/flagger-load-testing.png"
        data-srcset="/images/Flagger/flagger-load-testing.png, /images/Flagger/flagger-load-testing.png 1.5x, /images/Flagger/flagger-load-testing.png 2x"
        data-sizes="auto"
        alt="/images/Flagger/flagger-load-testing.png"
        title="/images/Flagger/flagger-load-testing.png" /></p>
<br>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># First you need to deploy the load test runner in a namespace with sidecar injection enabled</span>
kubectl apply -k https://github.com/fluxcd/flagger//kustomize/tester?ref<span class="o">=</span>main

<span class="c1"># 或使用helm</span>
helm repo add flagger https://flagger.app

helm upgrade -i flagger-loadtester flagger/loadtester <span class="se">\
</span><span class="se"></span>--namespace<span class="o">=</span><span class="nb">test</span> <span class="se">\
</span><span class="se"></span>--set cmd.timeout<span class="o">=</span>1h

<span class="c1"># When deployed the load tester API will be available at http://flagger-loadtester.test/</span>
</code></pre></td></tr></table>
</div>
</div><br>
<p>现在，你可以将webhook添加到金丝雀分析规范中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">webhooks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">load-test-get</span><span class="w">
</span><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://flagger-loadtester.test/</span><span class="w">
</span><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">cmd</span><span class="w">
</span><span class="w">      </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;hey -z 1m -q 10 -c 2 http://podinfo-canary.test:9898/&#34;</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">load-test-post</span><span class="w">
</span><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://flagger-loadtester.test/</span><span class="w">
</span><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">cmd</span><span class="w">
</span><span class="w">      </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;hey -z 1m -q 10 -c 2 -m POST -d &#39;{test: 2}&#39; http://podinfo-canary.test:9898/echo&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>当金丝雀分析开始时，如果它们尚未运行，Flagger将调用webhook，负载测试器将在后台运行hey命令。这将确保在分析期间，<code>podinfo-canary.test</code>服务将收到稳定的GET和POST请求流。</p>
<br>
<p>对于gRPC服务，你可以使用<a href="https://github.com/bojand/ghz" target="_blank" rel="noopener noreffer ">bojand/ghz</a>工具，它是一个类似于<code>hey</code>但用于gRPC测试的工具。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">webhooks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">grpc-load-test</span><span class="w">
</span><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://flagger-loadtester.test/</span><span class="w">
</span><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">cmd</span><span class="w">
</span><span class="w">      </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;ghz -z 1m -q 10 -c 2 --insecure podinfo.test:9898&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><code>ghz</code>使用反射(reflection)来确定要调用哪种gRPC方法。如果你不希望为gRPC服务启用反射，你可以从grpc-proto library实现标准化的健康检查。要使用不带反射的健康检查架构，亦可以将参数传递给<code>ghz</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">webhooks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">grpc-load-test-no-reflection</span><span class="w">
</span><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://flagger-loadtester.test/</span><span class="w">
</span><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">cmd</span><span class="w">
</span><span class="w">      </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;ghz --insecure --proto=/tmp/ghz/health.proto --call=grpc.health.v1.Health/Check podinfo.test:9898&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p>负载测试器可以运行任何命令，只要容器镜像中存在二进制文件即可。例如，如果你想用其它命令替代<code>hey</code>，你可以创建自己的Dockerfile和镜像：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Dockerfile" data-lang="Dockerfile"><span class="k">FROM</span><span class="s"> weaveworks/flagger-loadtester:&lt;VER&gt;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> curl -Lo /usr/local/bin/my-cli https://github.com/user/repo/releases/download/ver/my-cli <span class="se">\
</span><span class="se"></span>    <span class="o">&amp;&amp;</span> chmod +x /usr/local/bin/my-cli<span class="err">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="负载测试委托">负载测试委托</h3>
<p>Load Testing Delegation</p>
<p>负载测试器同样可以转发测试任务到外部工具，目前支持nGrinder。</p>
<br>
<br>
<h3 id="集成测试">集成测试</h3>
<p>Integration Testing</p>
<p>Flagger附带的测试服务，当配置为webhook是，可以运行helm测试、Bash测试或Concord测试。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 部署一个helm测试器</span>
helm repo add flagger https://flagger.app

helm upgrade -i flagger-helmtester flagger/loadtester <span class="se">\
</span><span class="se"></span>--namespace<span class="o">=</span>kube-system <span class="se">\
</span><span class="se"></span>--set <span class="nv">serviceAccountName</span><span class="o">=</span>tiller

<span class="c1"># When deployed the Helm tester API will be available at http://flagger-helmtester.kube-system/</span>
</code></pre></td></tr></table>
</div>
</div><p>现在，你可以向金丝雀分析规范中添加pre-rollout webhook：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">webhooks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;smoke test&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">pre-rollout</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://flagger-helmtester.kube-system/</span><span class="w">
</span><span class="w">        </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l">3m</span><span class="w">
</span><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;helm&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;test {{ .Release.Name }} --cleanup&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>当金丝雀分析启动时，在路由流量到金丝雀之前，Flagger将调用pre-rollout webhook。如果helm测试失败，Flagger将重试直到到达分析阈值，并回滚金丝雀。</p>
<p>如果使用Helm v3，你必须在此命名空间创建专用的service account，并将命名空间添加到命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">webhooks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;smoke test&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">pre-rollout</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://flagger-helmtester.kube-system/</span><span class="w">
</span><span class="w">        </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l">3m</span><span class="w">
</span><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;helmv3&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;test {{ .Release.Name }} --timeout 3m -n {{ .Release.Namespace }}&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>如果测试挂起或错误日志暗示权限不足，它可能与RBAC有关。</p>
<br>
<p>作为helm的替代方案，你可以使用Bash Automated Testing System来运行你的测试。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">webhooks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;acceptance tests&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">pre-rollout</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://flagger-batstester.default/</span><span class="w">
</span><span class="w">        </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l">5m</span><span class="w">
</span><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;bash&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;bats /tests/acceptance.bats&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>使用Bats测试，你应该创建一个ConfigMap，并将其挂载到测试器容器内。</p>
<br>
<p>你同样可以配置测试器来启动Concord程序：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">webhooks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;concord integration test&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">pre-rollout</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://flagger-concordtester.default/</span><span class="w">
</span><span class="w">        </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l">60s</span><span class="w">
</span><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;concord&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">org</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;your-concord-org&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">project</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;your-concord-project&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;your-concord-repo&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;your-concord-entrypoint&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">apiKeyPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/tmp/concord-api-key&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">endpoint</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://canary-endpoint/&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">pollInterval</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;5&#34;</span><span class="w">
</span><span class="w">          </span><span class="nt">pollTimeout</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;60&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="手动门控">手动门控</h3>
<p>Manual Gating</p>
<p>对于手动批准(manual approval)金丝雀部署，你可以使用<code>confirm-rollout</code>和<code>confirm-promotion</code> webhooks。confirm rollout钩子在pre-rollout钩子之前执行。Flagger会中止金丝雀流量漂移并分析，直到confirm钩子返回HTTP 200。</p>
<p>对于手动回滚(manual rollback)金丝雀部署，你可以使用<code>rollback</code> webhook。此钩子将在分析和确认状态期间被调用。如果回滚钩子返回成功的HTTP状态码，Flagger将漂移所有流量回主实例(primary)并失败金丝雀。</p>
<p>使用Flagger测试器手动门控：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># /gate/halt会返回http 403，因此会阻止推出</span><span class="w">
</span><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">webhooks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;gate&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">confirm-rollout</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://flagger-loadtester.test/gate/halt</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p>如果你启用了通知，如果金丝雀推出等待批准，Flagger将会给你推送消息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># 启动金丝雀分析</span><span class="w">
</span><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">webhooks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;gate&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">confirm-rollout</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://flagger-loadtester.test/gate/approve</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># 手动门控可通过Flagger测试器API驱动</span><span class="w">
</span><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">webhooks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;ask for confirmation&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">confirm-rollout</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://flagger-loadtester.test/gate/check</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p>默认情况下，门控是关闭的，你可以开启或恢复金丝雀推出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">kubectl -n <span class="nb">test</span> <span class="nb">exec</span> -it flagger-loadtester-xxxx-xxxx sh

curl -d <span class="s1">&#39;{&#34;name&#34;: &#34;podinfo&#34;,&#34;namespace&#34;:&#34;test&#34;}&#39;</span> http://localhost:8080/gate/open
</code></pre></td></tr></table>
</div>
</div><br>
<p>你可以在任意时间暂停推出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">curl -d <span class="s1">&#39;{&#34;name&#34;: &#34;podinfo&#34;,&#34;namespace&#34;:&#34;test&#34;}&#39;</span> http://localhost:8080/gate/close
</code></pre></td></tr></table>
</div>
</div><br>
<p>如果一个金丝雀分析暂停，状态将改变为等待：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="l">kubectl get canary/podinfo</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="l">NAME      STATUS        WEIGHT</span><span class="w">
</span><span class="w"></span><span class="l">podinfo   Waiting       0</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p><code>confirm-promotion</code>钩子类型可用于手动批准金丝雀提升。当提升暂停时，Flagger将继续运行指标检查和负载测试。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">webhooks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;promotion gate&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">confirm-promotion</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://flagger-loadtester.test/gate/halt</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p><code>rollback</code>钩子类型可用于手动回滚金丝雀提升。与门控一样，通过将回滚URL设置为<code>/rollback/check</code>，回滚可以被Flagger测试器API驱动</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">webhooks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;rollback&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">rollback</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://flagger-loadtester.test/rollback/check</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p>默认情况下，回滚是关闭的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 你可以回滚一个金丝雀推出</span>
kubectl -n <span class="nb">test</span> <span class="nb">exec</span> -it flagger-loadtester-xxxx-xxxx sh
curl -d <span class="s1">&#39;{&#34;name&#34;: &#34;podinfo&#34;,&#34;namespace&#34;:&#34;test&#34;}&#39;</span> http://localhost:8080/rollback/open

<span class="c1"># 你可以关闭回滚</span>
curl -d <span class="s1">&#39;{&#34;name&#34;: &#34;podinfo&#34;,&#34;namespace&#34;:&#34;test&#34;}&#39;</span> http://localhost:8080/rollback/close
</code></pre></td></tr></table>
</div>
</div><p>如果你启用了通知，如果一个金丝雀已经回滚，Flagger会发送通知消息。</p>
<br>
<br>
<h2 id="告警">告警</h2>
<p>Alerting: <a href="https://docs.flagger.app/usage/alerting">https://docs.flagger.app/usage/alerting</a></p>
<p>Flagger可配置来将告警发送到各种聊天平台。你可以在全局配置，也可以在金丝雀层面配置。</p>
<br>
<h3 id="全局配置">全局配置</h3>
<p>Global configuration</p>
<p>全局配置通知：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Slack全局配置</span>
helm upgrade -i flagger flagger/flagger <span class="se">\
</span><span class="se"></span>--set slack.url<span class="o">=</span>https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK <span class="se">\
</span><span class="se"></span>--set slack.channel<span class="o">=</span>general <span class="se">\
</span><span class="se"></span>--set slack.user<span class="o">=</span>flagger


<span class="c1"># Microsoft Teams全局配置</span>
helm upgrade -i flagger flagger/flagger <span class="se">\
</span><span class="se"></span>--set msteams.url<span class="o">=</span>https://outlook.office.com/webhook/YOUR/TEAMS/WEBHOOK
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="金丝雀层面配置">金丝雀层面配置</h3>
<p>Canary configuration</p>
<p>全局配置通知不够细化，为了使告警更加灵活，可在金丝雀层面配置。</p>
<p>Slack栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">flagger.app/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AlertProvider</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="kc">on</span>-<span class="l">call</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">flagger</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">slack</span><span class="w">
</span><span class="w">  </span><span class="nt">channel</span><span class="p">:</span><span class="w"> </span><span class="kc">on</span>-<span class="l">call-alerts</span><span class="w">
</span><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">flagger</span><span class="w">
</span><span class="w">  </span><span class="c"># webhook address (ignored if secretRef is specified)</span><span class="w">
</span><span class="w">  </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l">https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK</span><span class="w">
</span><span class="w">  </span><span class="c"># secret containing the webhook address (optional)</span><span class="w">
</span><span class="w">  </span><span class="nt">secretRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="kc">on</span>-<span class="l">call-url</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="kc">on</span>-<span class="l">call-url</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">flagger</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;encoded-url&gt;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>金丝雀分析的告警列表：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">alerts</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;on-call Slack&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">error</span><span class="w">
</span><span class="w">        </span><span class="nt">providerRef</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="kc">on</span>-<span class="l">call</span><span class="w">
</span><span class="w">          </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">flagger</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;qa Discord&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">warn</span><span class="w">
</span><span class="w">        </span><span class="nt">providerRef</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">qa-discord</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;dev MS Teams&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">info</span><span class="w">
</span><span class="w">        </span><span class="nt">providerRef</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dev-msteams</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="alertmnager">AlertMnager</h3>
<p>Prometheus AlertMnager</p>
<p>当金丝雀部署失败时，你可以使用AlertManger来触发告警：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">canary_rollback</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">flagger_canary_status &gt; 1</span><span class="w">
</span><span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">warning</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Canary failed&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Workload {{ $labels.name }} namespace {{ $labels.namespace }}&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h2 id="监控">监控</h2>
<p>Monitoring: <a href="https://docs.flagger.app/usage/monitoring">https://docs.flagger.app/usage/monitoring</a></p>
<br>
<h3 id="grafana">Grafana</h3>
<p>Flagger配有针对金丝雀分析的Grafana仪表盘。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Install Grafana with Helm</span>
helm upgrade -i flagger-grafana flagger/grafana <span class="se">\
</span><span class="se"></span>--set <span class="nv">url</span><span class="o">=</span>http://prometheus:9090
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="logging">Logging</h3>
<p>金丝雀错误和延迟尖峰被记录为k8s事件，并被Flagger以json格式记录：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">kubectl -n istio-system logs deployment/flagger --tail=100 | jq .msg

Starting canary deployment for podinfo.test
Advance podinfo.test canary weight 5
Advance podinfo.test canary weight 10
Advance podinfo.test canary weight 15
Advance podinfo.test canary weight 20
Advance podinfo.test canary weight 25
Advance podinfo.test canary weight 30
Advance podinfo.test canary weight 35
Halt podinfo.test advancement success rate 98.69% &lt; 99%
Advance podinfo.test canary weight 40
Halt podinfo.test advancement request duration 1.515s &gt; 500ms
Advance podinfo.test canary weight 45
Advance podinfo.test canary weight 50
Copying podinfo.test template spec to podinfo-primary.test
Halt podinfo-primary.test advancement waiting for rollout to finish: 1 old replicas are pending termination
Scaling down podinfo.test
Promotion completed! podinfo.test
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="event-webhook">Event Webhook</h3>
<p>Flagger可以配置来发送event payloads到特定webhook：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">helm upgrade -i flagger flagger/flagger <span class="se">\
</span><span class="se"></span>--set <span class="nv">eventWebhook</span><span class="o">=</span>https://example.com/flagger-canary-event-webhook
</code></pre></td></tr></table>
</div>
</div><p>栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">{
  &#34;name&#34;: &#34;podinfo&#34;,
  &#34;namespace&#34;: &#34;default&#34;,
  &#34;phase&#34;: &#34;Progressing&#34;,
  &#34;metadata&#34;: {
    &#34;eventMessage&#34;: &#34;New revision detected! Scaling up podinfo.default&#34;,
    &#34;eventType&#34;: &#34;Normal&#34;,
    &#34;timestamp&#34;: &#34;1578607635167&#34;
  }
}
</code></pre></td></tr></table>
</div>
</div><br>
<p>在金丝雀层面，event webhook可被覆盖：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">webhooks</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;send to Slack&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">event</span><span class="w">
</span><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://event-recevier.notifications/slack</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="metrics">Metrics</h3>
<p>Flagger公开了可用于确定金丝雀分析状态和目标权重值的Prometheus metrics：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># Flagger version and mesh provider gauge</span><span class="w">
</span><span class="w"></span><span class="l">flagger_info{version=&#34;0.10.0&#34;, mesh_provider=&#34;istio&#34;} 1</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Canaries total gauge</span><span class="w">
</span><span class="w"></span><span class="l">flagger_canary_total{namespace=&#34;test&#34;} 1</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Canary promotion last known status gauge</span><span class="w">
</span><span class="w"></span><span class="c"># 0 - running, 1 - successful, 2 - failed</span><span class="w">
</span><span class="w"></span><span class="l">flagger_canary_status{name=&#34;podinfo&#34; namespace=&#34;test&#34;} 1</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Canary traffic weight gauge</span><span class="w">
</span><span class="w"></span><span class="l">flagger_canary_weight{workload=&#34;podinfo-primary&#34; namespace=&#34;test&#34;} 95</span><span class="w">
</span><span class="w"></span><span class="l">flagger_canary_weight{workload=&#34;podinfo&#34; namespace=&#34;test&#34;} 5</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Seconds spent performing canary analysis histogram</span><span class="w">
</span><span class="w"></span><span class="l">flagger_canary_duration_seconds_bucket{name=&#34;podinfo&#34;,namespace=&#34;test&#34;,le=&#34;10&#34;} 6</span><span class="w">
</span><span class="w"></span><span class="l">flagger_canary_duration_seconds_bucket{name=&#34;podinfo&#34;,namespace=&#34;test&#34;,le=&#34;+Inf&#34;} 6</span><span class="w">
</span><span class="w"></span><span class="l">flagger_canary_duration_seconds_sum{name=&#34;podinfo&#34;,namespace=&#34;test&#34;} 17.3561329</span><span class="w">
</span><span class="w"></span><span class="l">flagger_canary_duration_seconds_count{name=&#34;podinfo&#34;,namespace=&#34;test&#34;} 6</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<hr>
<br>
<h1 id="教程">教程</h1>
<p>Tutorials</p>
<br>
<h2 id="isito金丝雀部署">Isito金丝雀部署</h2>
<p>Istio Canary Deployments: <a href="https://docs.flagger.app/tutorials/istio-progressive-delivery">https://docs.flagger.app/tutorials/istio-progressive-delivery</a></p>
<br>
<br>
<h2 id="istio-ab测试">Istio AB测试</h2>
<p>Istio A/B Testing: <a href="https://docs.flagger.app/tutorials/istio-ab-testing">https://docs.flagger.app/tutorials/istio-ab-testing</a></p>
<br>
<br>
<h2 id="nginx-金丝雀部署">Nginx 金丝雀部署</h2>
<p>NGINX Canary Deployments: <a href="https://docs.flagger.app/tutorials/nginx-progressive-delivery">https://docs.flagger.app/tutorials/nginx-progressive-delivery</a></p>
<br>
<br>
<h2 id="蓝绿部署-1">蓝绿部署</h2>
<p>Blue/Green Deployments: <a href="https://docs.flagger.app/tutorials/kubernetes-blue-green">https://docs.flagger.app/tutorials/kubernetes-blue-green</a></p>
<br>
<br>
<h2 id="使用prometheus-operator的金丝雀分析">使用Prometheus Operator的金丝雀分析</h2>
<p>Canary analysis with Prometheus Operator: <a href="https://docs.flagger.app/tutorials/prometheus-operator">https://docs.flagger.app/tutorials/prometheus-operator</a></p>
<br>
<br>
<h2 id="零停机时间部署">零停机时间部署</h2>
<p>Zero downtime deployments: <a href="https://docs.flagger.app/tutorials/zero-downtime-deployments">https://docs.flagger.app/tutorials/zero-downtime-deployments</a></p>
<p>如果你想最大限度地减少滚动更新(rolling updates)和缩小(downscaling)带来的影响，当处理高流量生产环境时，有下面一些事情你应该考虑。</p>
<br>
<h3 id="部署策略-1">部署策略</h3>
<p>Deployment strategy</p>
<p>在滚动更新期间限制不可用pod的数量：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">progressDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">120</span><span class="w">
</span><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>一个部署的默认的进度截止日期为十分钟。你应该考虑调整此值以使部署过程更快地失败。</p>
<br>
<br>
<h3 id="存活度健康检查">存活度健康检查</h3>
<p>Liveness health check</p>
<p>你的应用程序应该公开一个http endpoint，让k8s能够调用它来检测应用是否转换为无法恢复的断开状态，并且需要重新启动。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">wget</span><span class="w">
</span><span class="w">    </span>- --<span class="l">quiet</span><span class="w">
</span><span class="w">    </span>- --<span class="l">tries=1</span><span class="w">
</span><span class="w">    </span>- --<span class="l">timeout=4</span><span class="w">
</span><span class="w">    </span>- --<span class="l">spider</span><span class="w">
</span><span class="w">    </span>- <span class="l">http://localhost:8080/healthz</span><span class="w">
</span><span class="w">  </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">  </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="准备度健康检查">准备度健康检查</h3>
<p>Readiness health check</p>
<p>你的应用程序应该公开一个http endpoint，让k8s可以调用它来确认应用是否准备好接收流量。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">readinessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">wget</span><span class="w">
</span><span class="w">    </span>- --<span class="l">quiet</span><span class="w">
</span><span class="w">    </span>- --<span class="l">tries=1</span><span class="w">
</span><span class="w">    </span>- --<span class="l">timeout=4</span><span class="w">
</span><span class="w">    </span>- --<span class="l">spider</span><span class="w">
</span><span class="w">    </span>- <span class="l">http://localhost:8080/readyz</span><span class="w">
</span><span class="w">  </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">  </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">  </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>如果你的应用依赖于外部服务，在允许k8s路由流量到应用实例之前，你应该检查服务是否可用。请记住， envoy sidecar可以比应用慢得多启动。这意味着在应用程序开始时，你应该重试至少几秒钟任意外部连接。</p>
<br>
<br>
<h3 id="优雅地关闭">优雅地关闭</h3>
<p>Graceful shutdown</p>
<p>在pod terminated(终止)之前，k8s发送<code>SIGTERM</code>信号到每个容器，并等待所有容器的一段时间(默认30s)来优雅地退出。如果你的应用不处理<code>SIGTERM</code>信号，或如果它不在宽限期内退出，k8s将杀死容器和任意正在处理的流量，这意味着你的应用处理将会失败。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span><span class="w">        </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">preStop</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="l">sleep</span><span class="w">
</span><span class="w">              </span>- <span class="s2">&#34;10&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>你的应用应该具有延迟容器的关闭的<code>preStop</code>钩子。这将允许服务网格耗尽流量，并在应用不可用之前从所有其它envoy sidecar移除此pod。</p>
<br>
<br>
<h3 id="推迟envoy关闭">推迟envoy关闭</h3>
<p>Delay Envoy shutdown</p>
<p>即使你的应用对<code>SIGTERM</code>信号做出反应并尝试完全在关闭之前完成请求，并不意味着响应会将结果返回给调用者。如果envoy sidecar在你的应用之前关闭，则调用者会收到503错误。</p>
<p>要缓解此问题，你可以将<code>preStop</code>钩子添加到Istio代理，并等待主应用程序在envoy之前退出。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c">#!/bin/bash</span><span class="w">
</span><span class="w"></span><span class="l">set -e</span><span class="w">
</span><span class="w"></span><span class="l">if ! pidof envoy &amp;&gt;/dev/null; then</span><span class="w">
</span><span class="w">  </span><span class="l">exit 0</span><span class="w">
</span><span class="w"></span><span class="l">fi</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="l">if ! pidof pilot-agent &amp;&gt;/dev/null; then</span><span class="w">
</span><span class="w">  </span><span class="l">exit 0</span><span class="w">
</span><span class="w"></span><span class="l">fi</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="l">while [ $(netstat -plunt | grep tcp | grep -v envoy | wc -l | xargs) -ne 0 ]; do</span><span class="w">
</span><span class="w">  </span><span class="l">sleep 1;</span><span class="w">
</span><span class="w"></span><span class="l">done</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="l">exit 0</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>你必须使用上面的脚本构建你自己的envoy docker image，并使用<code>preStop</code>指令修改Istio来注入webhook。</p>
<br>
<br>
<h3 id="资源请求和限制">资源请求和限制</h3>
<p>Resource requests and limits</p>
<p>如果你正在运行生产环境，则为所有工作负载设置CPU和MEM的请求和限制是必需的步骤。如果没有资源限制，由于CPU或MEM耗尽，你的节点可能会反应迟钝。如果没有资源请求，k8s scheduler将无法做出将pod调度到哪个节点的决定。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">1000m</span><span class="w">
</span><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w">
</span><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">128Mi</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>请注意，如果没有资源请求(requests)，hpa无法确定何时扩展你的应用程序。换句话来说，hpa是根据requests来进行伸缩的，而不是limits。</p>
<br>
<br>
<h3 id="自动伸缩">自动伸缩</h3>
<p>Autoscaling</p>
<p>生产环境应该能够处理突发流量(traffic burst)而不会影响服务质量(quality of service)。这可以通过k8s自动伸缩功能来实现。k8s的自动伸缩有亮哥维度：集群层面的节点伸缩和负载层面Pod数量自动伸缩。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">autoscaling/v2beta2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HorizontalPodAutoscaler</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">scaleTargetRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span><span class="w">  </span><span class="nt">minReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">  </span><span class="nt">maxReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Resource</span><span class="w">
</span><span class="w">    </span><span class="nt">resource</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cpu</span><span class="w">
</span><span class="w">      </span><span class="nt">targetAverageValue</span><span class="p">:</span><span class="w"> </span><span class="l">900m</span><span class="w">
</span><span class="w">  </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Resource</span><span class="w">
</span><span class="w">    </span><span class="nt">resource</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">memory</span><span class="w">
</span><span class="w">      </span><span class="nt">targetAverageValue</span><span class="p">:</span><span class="w"> </span><span class="l">768Mi</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="ingress重试">ingress重试</h3>
<p>Ingress retries</p>
<p>为了最大限度地减少缩小操作的影响，你可以利用Envoy retry功能。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">flagger.app/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Canary</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9898</span><span class="w">
</span><span class="w">    </span><span class="nt">gateways</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">public-gateway.istio-system.svc.cluster.local</span><span class="w">
</span><span class="w">    </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">app.example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">retries</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">attempts</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w">      </span><span class="nt">perTryTimeout</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span><span class="w">      </span><span class="nt">retryOn</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;gateway-error,connect-failure,refused-stream&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>当hpa缩小应用副本数是，用户可能会获取到503错误。上面的配置将使Envoy重试由于网关错误而失败的http请求。</p>
<br>
<br>
<h2 id="推出权重">推出权重</h2>
<p>Rollout Weights: <a href="https://docs.flagger.app/tutorials/rollout-weights">https://docs.flagger.app/tutorials/rollout-weights</a></p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2021-01-14</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/flagger/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://zhang21.cn/flagger/" data-title="Flagger" data-hashtags="K8s,CNCF,DevOps,GitOps,Canary,ServiceMesh"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://zhang21.cn/flagger/" data-title="Flagger"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Reddit" data-sharer="reddit" data-url="https://zhang21.cn/flagger/"><i class="fab fa-reddit fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://zhang21.cn/flagger/" data-title="Flagger"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.0.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://zhang21.cn/flagger/" data-title="Flagger"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/k8s/">K8s</a>,&nbsp;<a href="/tags/cncf/">cncf</a>,&nbsp;<a href="/tags/devops/">DevOps</a>,&nbsp;<a href="/tags/gitops/">GitOps</a>,&nbsp;<a href="/tags/canary/">Canary</a>,&nbsp;<a href="/tags/servicemesh/">ServiceMesh</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/helm/" class="prev" rel="prev" title="Helm"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Helm</a>
            <a href="/istio/" class="next" rel="next" title="Istio">Istio<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.83.1">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2017 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://zhang21.cn" target="_blank">Zhang21</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css"><script type="text/javascript" src="https://zhang21.disqus.com/embed.js" defer></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":20},"comment":{},"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"RZ22ZCTIDN","algoliaIndex":"hugo-index","algoliaSearchKey":"11ec277ef4d730e232eda9651548da78","highlightTag":"em","maxResultLength":20,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"twemoji":true};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
