<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Ansible - 风继续吹</title><meta name="Description" content="个人博客"><meta property="og:title" content="Ansible" />
<meta property="og:description" content="参考:

Ansible docs: https://docs.ansible.com


环境:

RHELx86_64
Ansible v2.9



" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhang21.cn/ansible/" /><meta property="og:image" content="https://zhang21.cn/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-12-26T17:40:11&#43;00:00" />
<meta property="article:modified_time" content="2019-12-26T17:40:11&#43;00:00" /><meta property="og:site_name" content="My cool site" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://zhang21.cn/logo.png"/>

<meta name="twitter:title" content="Ansible"/>
<meta name="twitter:description" content="参考:

Ansible docs: https://docs.ansible.com


环境:

RHELx86_64
Ansible v2.9



"/>
<meta name="application-name" content="风继续吹">
<meta name="apple-mobile-web-app-title" content="风继续吹"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://zhang21.cn/ansible/" /><link rel="prev" href="https://zhang21.cn/tornado/" /><link rel="next" href="https://zhang21.cn/javascript/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Ansible",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/zhang21.cn\/ansible\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/zhang21.cn\/images\/Apple-Devices-Preview.png",
                            "width":  3200 ,
                            "height":  2048 
                        }],"genre": "posts","keywords": "Ansible, Automation, DevOps","wordcount":  27833 ,
        "url": "https:\/\/zhang21.cn\/ansible\/","datePublished": "2019-12-26T17:40:11+00:00","dateModified": "2019-12-26T17:40:11+00:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "Zhang21","logo": "https:\/\/zhang21.cn\/leslie.png"},"author": {
                "@type": "Person",
                "name": "Zhang21"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="风继续吹"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>风继续吹</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="https://github.com/zhang21" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="风继续吹"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>风继续吹</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="https://github.com/zhang21" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Ansible</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://zhang21.cn" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Zhang21</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/devops/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>devops</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2019-12-26">2019-12-26</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;约 27833 字&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;预计阅读 56 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#介绍">介绍</a></li>
    <li><a href="#词汇表">词汇表</a></li>
    <li><a href="#安装指南">安装指南</a>
      <ul>
        <li><a href="#安装ansible">安装Ansible</a>
          <ul>
            <li><a href="#先决条件">先决条件</a></li>
            <li><a href="#选择版本">选择版本</a></li>
            <li><a href="#在rhel上安装">在RHEL上安装</a></li>
            <li><a href="#使用pip安装">使用pip安装</a></li>
            <li><a href="#ansible-command-shell-completion">Ansible command shell completion</a></li>
          </ul>
        </li>
        <li><a href="#配置ansible">配置Ansible</a>
          <ul>
            <li><a href="#配置文件">配置文件</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#ansible移植指南">Ansible移植指南</a></li>
    <li><a href="#用户指南">用户指南</a>
      <ul>
        <li><a href="#quickstart">Quickstart</a></li>
        <li><a href="#概念">概念</a></li>
        <li><a href="#入门">入门</a>
          <ul>
            <li><a href="#从清单选择机器">从清单选择机器</a></li>
            <li><a href="#连接到远程节点">连接到远程节点</a></li>
            <li><a href="#复制和执行模块">复制和执行模块</a></li>
          </ul>
        </li>
        <li><a href="#如何构建清单">如何构建清单</a>
          <ul>
            <li><a href="#清单基本">清单基本</a></li>
            <li><a href="#添加变量到清单">添加变量到清单</a></li>
            <li><a href="#主机变量">主机变量</a></li>
            <li><a href="#组变量">组变量</a></li>
            <li><a href="#组织主机和组变量">组织主机和组变量</a></li>
            <li><a href="#变量如何合并">变量如何合并</a></li>
            <li><a href="#使用多个清单源">使用多个清单源</a></li>
            <li><a href="#清单参数">清单参数</a></li>
            <li><a href="#清单配置样例">清单配置样例</a></li>
          </ul>
        </li>
        <li><a href="#动态清单">动态清单</a>
          <ul>
            <li><a href="#cobbler">cobbler</a></li>
            <li><a href="#aws-ec2">AWS ec2</a></li>
            <li><a href="#openstack">OpenStack</a></li>
            <li><a href="#其它清单脚本">其它清单脚本</a></li>
          </ul>
        </li>
        <li><a href="#模式">模式</a>
          <ul>
            <li><a href="#模式使用">模式使用</a></li>
            <li><a href="#常见模式">常见模式</a></li>
            <li><a href="#模式的局限性">模式的局限性</a></li>
            <li><a href="#高级的模式选项">高级的模式选项</a></li>
            <li><a href="#playbook标志">playbook标志</a></li>
          </ul>
        </li>
        <li><a href="#ad-hoc">ad-hoc</a>
          <ul>
            <li><a href="#为什么使用它">为什么使用它</a></li>
            <li><a href="#用例">用例</a></li>
          </ul>
        </li>
        <li><a href="#连接方法和详情">连接方法和详情</a>
          <ul>
            <li><a href="#controlpersist和paramiko">ControlPersist和paramiko</a></li>
            <li><a href="#ssh-key配置">ssh-key配置</a></li>
            <li><a href="#本地运行">本地运行</a></li>
            <li><a href="#主机密钥检查">主机密钥检查</a></li>
            <li><a href="#其它连接方法">其它连接方法</a></li>
          </ul>
        </li>
        <li><a href="#命令行工具">命令行工具</a></li>
        <li><a href="#playbook">playbook</a>
          <ul>
            <li><a href="#介绍-1">介绍</a>
              <ul>
                <li><a href="#playbook-language">playbook language</a></li>
                <li><a href="#基本">基本</a></li>
                <li><a href="#action-shorthand">action shorthand</a></li>
                <li><a href="#handlers">Handlers</a></li>
                <li><a href="#执行playbook">执行playbook</a></li>
                <li><a href="#ansible-pull">Ansible-Pull</a></li>
                <li><a href="#linting-playbooks">Linting playbooks</a></li>
                <li><a href="#其它playbook验证项">其它playbook验证项</a></li>
              </ul>
            </li>
            <li><a href="#可重复使用的playbook">可重复使用的playbook</a>
              <ul>
                <li><a href="#including和importing">including和importing</a></li>
                <li><a href="#roles">Roles</a>
                  <ul>
                    <li><a href="#角色目录结构">角色目录结构</a></li>
                    <li><a href="#角色使用">角色使用</a></li>
                    <li><a href="#角色副本和扩展">角色副本和扩展</a></li>
                    <li><a href="#角色默认变量">角色默认变量</a></li>
                    <li><a href="#角色依赖">角色依赖</a></li>
                    <li><a href="#角色中的嵌入模块和插件">角色中的嵌入模块和插件</a></li>
                    <li><a href="#角色搜索路径">角色搜索路径</a></li>
                    <li><a href="#galaxy">Galaxy</a></li>
                  </ul>
                </li>
                <li><a href="#动态与静态">动态与静态</a></li>
                <li><a href="#两者比较">两者比较</a></li>
              </ul>
            </li>
            <li><a href="#使用变量">使用变量</a>
              <ul>
                <li><a href="#创建有效的变量名">创建有效的变量名</a></li>
                <li><a href="#在清单中定义变量">在清单中定义变量</a></li>
                <li><a href="#在playbook中定义变量">在playbook中定义变量</a></li>
                <li><a href="#在文件和角色中定义变量">在文件和角色中定义变量</a></li>
                <li><a href="#在jinja2中使用变量">在Jinja2中使用变量</a></li>
                <li><a href="#使用jinja2过滤器转换变量">使用Jinja2过滤器转换变量</a></li>
                <li><a href="#yaml疑难杂症">YAML疑难杂症</a></li>
                <li><a href="#系统facts中的变量">系统facts中的变量</a></li>
                <li><a href="#注册变量">注册变量</a></li>
                <li><a href="#访问复杂的变量数据">访问复杂的变量数据</a></li>
                <li><a href="#使用magic变量访问其它主机的信息">使用magic变量访问其它主机的信息</a></li>
                <li><a href="#在文件中定义变量">在文件中定义变量</a></li>
                <li><a href="#在命令行上传递参数">在命令行上传递参数</a></li>
                <li><a href="#变量的优先级我应该把变量放在哪">变量的优先级：我应该把变量放在哪</a></li>
              </ul>
            </li>
            <li><a href="#jinja2模板">Jinja2模板</a>
              <ul>
                <li><a href="#filters">Filters</a></li>
                <li><a href="#tests">Tests</a></li>
                <li><a href="#lookups">Lookups</a></li>
                <li><a href="#python版本和模板">Python版本和模板</a></li>
              </ul>
            </li>
            <li><a href="#条件语句">条件语句</a>
              <ul>
                <li><a href="#when语句">When语句</a></li>
                <li><a href="#循环和条件">循环和条件</a></li>
                <li><a href="#在自定义facts中载入">在自定义facts中载入</a></li>
                <li><a href="#applying-when-to-rolesimportsand-includes">Applying when to roles,imports,and includes</a></li>
                <li><a href="#有条件的导入">有条件的导入</a></li>
                <li><a href="#基于变量来选择文件和模板">基于变量来选择文件和模板</a></li>
                <li><a href="#注册变量-1">注册变量</a></li>
                <li><a href="#常用facts">常用facts</a></li>
              </ul>
            </li>
            <li><a href="#循环">循环</a>
              <ul>
                <li><a href="#两者比较-1">两者比较</a></li>
                <li><a href="#标准循环">标准循环</a>
                  <ul>
                    <li><a href="#遍历一个简单列表">遍历一个简单列表</a></li>
                    <li><a href="#遍历一个散列列表">遍历一个散列列表</a></li>
                    <li><a href="#遍历一个字典">遍历一个字典</a></li>
                  </ul>
                </li>
                <li><a href="#循环与注册变量">循环与注册变量</a></li>
                <li><a href="#复杂循环">复杂循环</a>
                  <ul>
                    <li><a href="#遍历嵌套的列表">遍历嵌套的列表</a></li>
                    <li><a href="#重试任务直到满足条件">重试任务直到满足条件</a></li>
                    <li><a href="#循环清单">循环清单</a></li>
                  </ul>
                </li>
                <li><a href="#query与lookup">query与lookup</a></li>
                <li><a href="#循环控制">循环控制</a>
                  <ul>
                    <li><a href="#限制循环输出">限制循环输出</a></li>
                    <li><a href="#暂停循环">暂停循环</a></li>
                    <li><a href="#追踪流程">追踪流程</a></li>
                    <li><a href="#inner-and-outer-variable-names">inner and outer variable names</a></li>
                    <li><a href="#扩展的循环变量">扩展的循环变量</a></li>
                  </ul>
                </li>
                <li><a href="#从with_x迁移到loop">从with_x迁移到loop</a></li>
              </ul>
            </li>
            <li><a href="#block">Block</a>
              <ul>
                <li><a href="#块错误处理">块错误处理</a></li>
              </ul>
            </li>
            <li><a href="#高级的playbook功能">高级的playbook功能</a>
              <ul>
                <li><a href="#特权晋升">特权晋升</a></li>
                <li><a href="#异步操作和轮询">异步操作和轮询</a></li>
                <li><a href="#检查模式">检查模式</a></li>
                <li><a href="#debugger">Debugger</a></li>
                <li><a href="#滚动升级">滚动升级</a></li>
                <li><a href="#设置环境">设置环境</a></li>
                <li><a href="#特定语言版本管理器">特定语言版本管理器</a></li>
                <li><a href="#错误处理">错误处理</a></li>
                <li><a href="#高级语法">高级语法</a></li>
                <li><a href="#使用插件">使用插件</a></li>
                <li><a href="#提示和输入">提示和输入</a></li>
                <li><a href="#标签">标签</a></li>
              </ul>
            </li>
            <li><a href="#控制playbook执行">控制playbook执行</a>
              <ul>
                <li><a href="#选择策略">选择策略</a></li>
                <li><a href="#设置fork数">设置fork数</a></li>
                <li><a href="#使用关键字控制执行">使用关键字控制执行</a></li>
              </ul>
            </li>
            <li><a href="#最佳实践">最佳实践</a>
              <ul>
                <li><a href="#内容组织">内容组织</a>
                  <ul>
                    <li><a href="#目录布局">目录布局</a></li>
                    <li><a href="#可选的目录布局">可选的目录布局</a></li>
                    <li><a href="#使用云动态资产">使用云动态资产</a></li>
                    <li><a href="#如何区分测试与生产">如何区分测试与生产</a></li>
                    <li><a href="#组和主机变量">组和主机变量</a></li>
                    <li><a href="#顶级playbook通过角色分离">顶级playbook通过角色分离</a></li>
                    <li><a href="#角色的任务和处理程序组织">角色的任务和处理程序组织</a></li>
                    <li><a href="#什么组织启用">什么组织启用</a></li>
                    <li><a href="#部署于配置组织">部署于配置组织</a></li>
                  </ul>
                </li>
                <li><a href="#测试与生产">测试与生产</a></li>
                <li><a href="#滚动更新">滚动更新</a></li>
                <li><a href="#注意状态">注意状态</a></li>
                <li><a href="#通过角色分组">通过角色分组</a></li>
                <li><a href="#操作系统和发行版本">操作系统和发行版本</a></li>
                <li><a href="#使用playbook捆绑ansible模块">使用playbook捆绑ansible模块</a></li>
                <li><a href="#空白和注释">空白和注释</a></li>
                <li><a href="#任务命名">任务命名</a></li>
                <li><a href="#使它简单">使它简单</a></li>
                <li><a href="#版本控制">版本控制</a></li>
                <li><a href="#变量和拱顶">变量和拱顶</a></li>
              </ul>
            </li>
            <li><a href="#持续交付和滚动更新">持续交付和滚动更新</a>
              <ul>
                <li><a href="#什么是持续交付">什么是持续交付</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#特权晋升-1">特权晋升</a>
          <ul>
            <li><a href="#使用">使用</a></li>
            <li><a href="#风险和局限性">风险和局限性</a></li>
          </ul>
        </li>
        <li><a href="#vault">Vault</a></li>
        <li><a href="#modules">Modules</a>
          <ul>
            <li><a href="#模块介绍">模块介绍</a></li>
            <li><a href="#返回值">返回值</a></li>
            <li><a href="#模块索引">模块索引</a></li>
          </ul>
        </li>
        <li><a href="#插件">插件</a></li>
        <li><a href="#collections">collections</a></li>
      </ul>
    </li>
    <li><a href="#开发指南">开发指南</a></li>
    <li><a href="#ansible-galaxy">Ansible Galaxy</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>参考:</p>
<ul>
<li>Ansible docs: <a href="https://docs.ansible.com">https://docs.ansible.com</a></li>
</ul>
<br>
<p>环境:</p>
<ul>
<li>RHELx86_64</li>
<li>Ansible v2.9</li>
</ul>
<br/>
<br/>
<hr>
<br/>
<br/>
<h1 id="介绍">介绍</h1>
<p>About Ansible: <a href="https://docs.ansible.com/ansible/latest/index.html">https://docs.ansible.com/ansible/latest/index.html</a></p>
<p>Ansible是一个IT自动化工具。它可以配置系统，部署软件和编排更先进的IT任务。Ansible的主要目标是简单和易于使用。它也专注于安全性和可靠性。</p>
<p>Ansible以无代理(agent-less)方式管理机器。Ansible是分散的，它依赖于现有操作系统的平局来控制访问到远程主机。如果需要，Ansible可以很容易地使用Kerberos, LDAP等集中认证管理系统连接。</p>
<br/>
<br/>
<hr>
<br/>
<br/>
<h1 id="词汇表">词汇表</h1>
<p><a href="https://docs.ansible.com/ansible/latest/reference_appendices/glossary.html" target="_blank" rel="noopener noreffer ">Glossary</a></p>
<ul>
<li>
<p><strong>Action</strong>
动作(action)是任务的一部分，用于指定要运行的模块和传递给该模块的参数。每个任务只能有一个动作，但也可能有其它参数。</p>
</li>
<li>
<p><strong>Ad Hoc</strong>
指使用<code>/usr/bin/ansible</code>运行Ansible执行一些快速命令，而不是编排语言，即<code>/usr/bin/ansible-play-book</code>。ad hoc命令的示例可能是重新启动基础结构中的50台计算机。你可以通过编写playbook来完成你可以做的任何事情，而playbook也可以将许多其它操作粘合在一起。</p>
</li>
<li>
<p><strong>Async</strong>
指配置为在后台运行而不是等待完成的任务。如果你的进程时间长度超过了SSH超时时间，那么以异步(async)模式启动该任务是有意义的。异步模式可以每隔很多秒轮询完成，或者可配置为&rsquo;fire and  forget'，在这种情况下，Ansible甚至不会再次检查任务，它将开始并继续进行未来的步骤。异步模式使用<code>/usr/bin/ansible</code>和<code>/usr/bin/ansible-playbook</code>。</p>
</li>
<li>
<p><strong>Callback Plugin</strong>
指一些用户编写的代码，可拦截Ansible的结构并对它们执行某些操作。GitHub中提供的一些示例执行自定义日志记录，发送电子邮件&hellip;</p>
</li>
<li>
<p><strong>Check Mode</strong>
值运行带有<code>--check</code>选项的Ansible，它不会对远程系统进行任何更改，但仅输出在没有此标志的情况下运行时才有可能发生的更改。</p>
</li>
<li>
<p><strong>Connection Plugin</strong>
默认情况下，Ansible通过pluggable libraries与远程计算机通信。Ansible支持原生OpenSSH或称为paramiko的Python实现。如果您使用的是最新版本，则首选OpenSSH，并启用Kerberos和jump host等功能。还有其它连接类型，如<code>accelerate</code>模式，必须通过一种基于SSH的连接类型进行引导，但速度非常快，而本地模式则作用于本地系统。用户还可以编写自己的连接插件。</p>
</li>
<li>
<p><strong>Conditionals</strong>
条件是一个表达式，其计算结果为<code>true</code>或<code>false</code>，用于决定给定任务是否在给定计算机上执行。</p>
</li>
<li>
<p><strong>Declarative</strong>
实现使用最终状态描述的任务的方法，而不是实现该状态所需的步骤序列的描述。对于真实世界的栗子，任务的声明规范将是: &ldquo;put me in California&rdquo;。根据你当前的位置，前往加州的步骤顺序可能会有所不同，如果你已在加州，则根本不需要做任何事情。Ansible的资源是声明性的；它确定了实现最终状态所需的步骤。它还可让你知道是否需要采取任何步骤才能到达最终状态。</p>
</li>
<li>
<p><strong>Diff Mode</strong>
将<code>--diff</code>标志传递给Ansible，以显示支持它的模块。</p>
</li>
<li>
<p><strong>Executor</strong>
Ansible的核心软件组件，它是<code>/usr/bin/ansible</code>背后的力量——并且对应于剧本中每个任务的调用。</p>
</li>
<li>
<p><strong>Facts</strong>
事实是发现的有关远程节点的事情。通过在远程节点上执行内部设置模块来运行，Ansible会自动发现事实。</p>
</li>
<li>
<p><strong>Filter Plugin</strong>
这允许创建新的Jinja2过滤器，这只适用于知道Jinja2过滤器的人。</p>
</li>
<li>
<p><strong>Fork</strong>
Ansible并行地与远程节点通信，并且可通过传递<code>--forks</code>或编辑配置文件中的默认值来设置并行级别。</p>
</li>
<li>
<p><strong>Gather Facts (Boolean)</strong>
有时，当运行多重playbook时，如果不需要利用任何这些值，则希望有一些不打扰事实计算的playbook。</p>
</li>
<li>
<p><strong>Globbing</strong>
通配符是一种选择大量主机，或它们所在组的名称的方法</p>
</li>
<li>
<p><strong>Group</strong>
一组主机</p>
</li>
<li>
<p><strong>Group Vars</strong>
这是将提供给指定组的变量，尤其是复杂的数据结构，这样这些变量就不必嵌入到库存文件或playbook中。</p>
</li>
<li>
<p><strong>Handlers</strong>
处理程序就像Ansible playbook中的常规任务，但只有在任务包含<code>notify</code>指定并且还指示它已更改某些内容时才会运行。</p>
</li>
<li>
<p><strong>Host</strong>
主机是Ansible管理的远程机器。</p>
</li>
<li>
<p><strong>Host Specifier</strong>
Ansible中的每个<code>play</code>都将一系列任务映射到一组系统。每个<code>play</code>中的<code>hosts:</code>指令通常称为主机说明符。它可以选择一个或多个系统，一个或多个组，甚至一个组中的一些主机，而不是另一个组中的主机。</p>
</li>
<li>
<p><strong>Host Vars</strong>
主机变量类似与组变量。</p>
</li>
<li>
<p><strong>Idempotency</strong>
如果执行一次的结果与在没有任何干预动作的情况下重复执行它的结果完全相同，则操作是幂等的。</p>
</li>
<li>
<p><strong>Includes</strong>
playbook文件可以包括其它play list，任务列表可以外部化其它文件中的任务列表，类似于处理程序。</p>
</li>
<li>
<p><strong>Inventory</strong>
用于描述Ansible中的主机和组的文件。</p>
</li>
<li>
<p><strong>Inventory Script</strong>
一个程序，用于查找主机，主机的组关系以及外部资源的变量信息——无论是SQL数据库，CMDB方案，还是LDAP等。</p>
</li>
<li>
<p><strong>Jinja2</strong>
Jinja2是Ansible模板模块的首选语言。它是一种非常简单的Python模板语言，可读且易于编写。</p>
</li>
<li>
<p><strong>JSON</strong>
Ansible使用JSON从远程模块返回数据。这允许用任何语言编写。</p>
</li>
<li>
<p><strong>Lazy Evaluation</strong>
通常，Ansible会在最后一秒评估playbook内容中的任何变量。</p>
</li>
<li>
<p><strong>Library</strong>
Ansible的模块集合。</p>
</li>
<li>
<p><strong>Limit Groups</strong>
通过将<code>--limit somegroup</code>传递给Ansible或ansible-playbook可以限制主机的子集。</p>
</li>
<li>
<p><strong>Local Action</strong>
针对远程计算机的playbook中的本地活动指令意味着给定的步骤实际上将在本地计算机上发生，但是可以传入变量<code>{{ansible_hostname}}</code>以引用该步骤中引用的远程主机名。</p>
</li>
<li>
<p><strong>Local Connection</strong>
通过在playbook中使用<code>connection: local</code>，或将<code>-c local</code>传递给<code>/usr/bin/ansible</code>，这表明我们正在管理本地主机而不是远程主机。</p>
</li>
<li>
<p><strong>Lookup Plugin</strong>
查找插件是一种从外部获取数据到Ansible的方法。</p>
</li>
<li>
<p><strong>Loops</strong>
通常，Ansible不是一种编程语言。它更喜欢声明性，尽管循环这样的各种结构允许对列表中的多个项重复特定任务。</p>
</li>
<li>
<p><strong>Modules</strong>
模块是Ansible发送到远程机器的工作单元。</p>
</li>
<li>
<p><strong>Multi-Tier</strong>
IT系统不是一次管理一个系统的概念，而是通过明确定义的订单中多个系统和系统组之间的交互。</p>
</li>
<li>
<p><strong>Notify</strong>
任务注册更改事件并通知处理程序任务需要在play结束时运行另一个操作的行为。</p>
</li>
<li>
<p><strong>Orchestration</strong>
许多软件自动化系统使用这个词来表示不同的东西。Ansible使用它作为编排的指挥。</p>
</li>
<li>
<p><strong>paramiko</strong>
默认情况下，Ansible通过SSH管理机器。Ansible默认使用的库是一个名为paramiko的Python驱动库。</p>
</li>
<li>
<p><strong>Playbooks</strong>
playbook是Ansible编排，配置，管理或部署系统的语言。它被称为剧本，部分原因在于它是一种运动类比，并且使用它们应该很有趣。</p>
</li>
<li>
<p><strong>Plays</strong>
A playbook is a list of plays。剧本最小是由主机说明符选择的一组主机之间的映射，以及在这些主机上运行定义这些系统将执行的角色的任务。</p>
</li>
<li>
<p><strong>Pull Mode</strong>
默认情况下，Ansible以<code>push</code>模式运行，这使得它可以在与每个系统进行通信时进行非常精细的控制。当你希望在特定计划时间点检查节点时，可以使用<code>pull</code>模式。</p>
</li>
<li>
<p><strong>Push Mode</strong></p>
</li>
<li>
<p><strong>Register Variable</strong>
在Ansible中运行任何任务的结果可以存储在变量中，以便在模板或条件语句中使用。</p>
</li>
<li>
<p><strong>Resource Model</strong>
Ansible模块在资源方面起作用。</p>
</li>
<li>
<p><strong>Roles</strong>
角色是Ansible的组织单位。</p>
</li>
<li>
<p><strong>Rolling Update</strong>
一次解决组中的多个节点的行为，以避免一次更新所有节点并使系统脱机。</p>
</li>
<li>
<p><strong>Sudo</strong></p>
</li>
<li>
<p><strong>SSH (Native)</strong></p>
</li>
<li>
<p><strong>Tags</strong>
Ansible允许使用任意关键字标记剧本中的资源，然后仅运行与这些关键字对应的剧本部分。</p>
</li>
<li>
<p><strong>Task</strong>
任务将操作(模块及其参数)与名称和可选的其他关键字(如循环指令)组合在一起。</p>
</li>
<li>
<p><strong>Templates</strong>
Ansible可以轻松地将文件传输到远程系统，但通常需要在其它文件中替换变量。</p>
</li>
<li>
<p><strong>Transport</strong>
Ansible使用<code>term:</code>连接插件来定以可用传输的类型。</p>
</li>
<li>
<p><strong>When</strong>
一个可选的条件语句。</p>
</li>
<li>
<p><strong>Vars (Variables)</strong>
与事实相反，变量是值的名称(int, bool, string)或复杂的数据(dict, hash, lists)。它是声明的东西，而不是从远程系统获取的东西。</p>
</li>
<li>
<p><strong>YAML</strong>
Ansible不想强迫人们编写程序代码来自动化基础设施，因此使用YAML来定义剧本配置语言和变量文件。</p>
</li>
</ul>
<br/>
<br/>
<hr>
<br/>
<br/>
<h1 id="安装指南">安装指南</h1>
<p>Installtion Guide: <a href="https://docs.ansible.com/ansible/latest/installation_guide/index.html">https://docs.ansible.com/ansible/latest/installation_guide/index.html</a></p>
<br>
<h2 id="安装ansible">安装Ansible</h2>
<p>Installing Ansible: <a href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html">https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html</a></p>
<p>Ansible是一个默认通过SSH协议管理机器的无代理(agentless)的自动化工具。一旦安装，Ansible不添加数据库，并且不需要启动守护进程。你只需要在一台机器上安装它，它可以从该中心点管理远程所有机器。</p>
<br>
<br/>
<h3 id="先决条件">先决条件</h3>
<p>Prerequisite</p>
<p>在控制节点上安装Ansible，然后使用SSH(默认)与管理的节点通信。</p>
<br>
<p><strong>控制节点的依赖</strong>
Control node requirements</p>
<p>目前，Ansible可以从任何安装了Python2.7或Python3.5+的机器上运行。不支持Windows。</p>
<br>
<p><strong>被管理节点的依赖</strong></p>
<p>Managed node requirements</p>
<p>在被管理的节点上，你需要一种方法来通信（通常是SSH）。</p>
<br/>
<br/>
<h3 id="选择版本">选择版本</h3>
<p>Selecting an Ansible version to install</p>
<p>选择自己需要的Ansible版本进行安装，可选择一下几种方式：</p>
<ul>
<li>使用操作系统包管理器进行安装</li>
<li>使用pip进行安装</li>
<li>使用源码进行安装</li>
</ul>
<br/>
<br/>
<h3 id="在rhel上安装">在RHEL上安装</h3>
<p>Installing Ansible on RHEL, CentOS, or Fedora</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">yum search ansible

sudo yum install ansible
</code></pre></td></tr></table>
</div>
</div><br/>
<br/>
<h3 id="使用pip安装">使用pip安装</h3>
<p>Installing Ansible with pip</p>
<p>使用Python的包管理工具pip来安装Ansible。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># env</span>
<span class="c1"># python -m virtualenv ansible</span>
<span class="c1"># source ansible/bin/activate</span>
pip install --user ansible
pip install --user paramiko
</code></pre></td></tr></table>
</div>
</div><br/>
<br/>
<h3 id="ansible-command-shell-completion">Ansible command shell completion</h3>
<p>Ansible 2.9的命令行工具由称为<code>argcomplete</code>的依赖提供。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">sudo yum install epel-release
sudo yum install python-argcomplete

<span class="c1"># pip</span>
<span class="c1"># pip install argcomplete</span>
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>配置argcomplete</strong></p>
<p>有两种方式来配置Ansible的命令行工具argcomplete：</p>
<ul>
<li>全局(Globally)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># Global completion requires bash 4.2.</span>
sudo activate-global-python-argcomplete
</code></pre></td></tr></table>
</div>
</div><ul>
<li>每个命令(Per command)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># If you do not have bash 4.2, you must register each script independently.</span>
<span class="c1"># 可将这些写入.profile里</span>
<span class="nb">eval</span> <span class="k">$(</span>register-python-argcomplete ansible<span class="k">)</span>
<span class="nb">eval</span> <span class="k">$(</span>register-python-argcomplete ansible-config<span class="k">)</span>
<span class="nb">eval</span> <span class="k">$(</span>register-python-argcomplete ansible-console<span class="k">)</span>
<span class="nb">eval</span> <span class="k">$(</span>register-python-argcomplete ansible-doc<span class="k">)</span>
<span class="nb">eval</span> <span class="k">$(</span>register-python-argcomplete ansible-galaxy<span class="k">)</span>
<span class="nb">eval</span> <span class="k">$(</span>register-python-argcomplete ansible-inventory<span class="k">)</span>
<span class="nb">eval</span> <span class="k">$(</span>register-python-argcomplete ansible-playbook<span class="k">)</span>
<span class="nb">eval</span> <span class="k">$(</span>register-python-argcomplete ansible-pull<span class="k">)</span>
<span class="nb">eval</span> <span class="k">$(</span>register-python-argcomplete ansible-vault<span class="k">)</span>
</code></pre></td></tr></table>
</div>
</div><br/>
<br/>
<br/>
<h2 id="配置ansible">配置Ansible</h2>
<p>Configuring Ansible: <a href="https://docs.ansible.com/ansible/latest/installation_guide/intro_configuration.html">https://docs.ansible.com/ansible/latest/installation_guide/intro_configuration.html</a></p>
<br>
<h3 id="配置文件">配置文件</h3>
<p>Configuration file</p>
<p>Ansible将按照一下顺序搜索配置文件：</p>
<ul>
<li><code>ANSIBLE_CONFIG</code>环境变量</li>
<li><code>ansible.cfg</code>当前目录</li>
<li><code>~/.ansible.cfg</code></li>
<li><code>/etc/ansible/ansible.cfg</code></li>
</ul>
<br>
<p><a href="https://docs.ansible.com/ansible/latest/reference_appendices/config.html#ansible-configuration-settings" target="_blank" rel="noopener noreffer ">Ansible配置参考</a></p>
<br/>
<br/>
<hr>
<br/>
<br/>
<h1 id="ansible移植指南">Ansible移植指南</h1>
<p>Ansible Porting Guides: <a href="https://docs.ansible.com/ansible/latest/porting_guides/porting_guides.html">https://docs.ansible.com/ansible/latest/porting_guides/porting_guides.html</a></p>
<br/>
<br/>
<hr>
<br/>
<br/>
<h1 id="用户指南">用户指南</h1>
<p>User Guide: <a href="https://docs.ansible.com/ansible/latest/user_guide/index.html">https://docs.ansible.com/ansible/latest/user_guide/index.html</a></p>
<p>本指南介绍如何使用Ansible工作，包括CLI, invetory, playbooks。</p>
<br/>
<br/>
<h2 id="quickstart">Quickstart</h2>
<p>Ansible Quickstart Guide: <a href="https://docs.ansible.com/ansible/latest/user_guide/quickstart.html">https://docs.ansible.com/ansible/latest/user_guide/quickstart.html</a></p>
<br/>
<br/>
<h2 id="概念">概念</h2>
<p>Ansible concepts: <a href="https://docs.ansible.com/ansible/latest/user_guide/basic_concepts.html">https://docs.ansible.com/ansible/latest/user_guide/basic_concepts.html</a></p>
<ul>
<li><strong>Controle node</strong>：按照Ansible的任意机器。Windows机器无法作为控制节点。可以有多个控制节点。</li>
<li><strong>Managed nodes</strong>：使用Ansible管理的网络设备。通常称为主机，Ansible未安装在管理节点上。</li>
<li><strong>Inventory</strong>：一组管理节点的列表。清单文件有时称为主机文件(hostfile)。</li>
<li><strong>Modules</strong>：Ansible执行代码单元。<a href="https://docs.ansible.com/ansible/latest/modules/modules_by_category.html#modules-by-category" target="_blank" rel="noopener noreffer ">Ansible模块列表</a></li>
<li><strong>Tasks</strong>：Ansible中的动作单元。可使用<code>ad-hoc</code>命令执行单一任务一次。</li>
<li><strong>Playbooks</strong>：任务的有序列表。可按照顺序反复执行这些任务。剧本可以包含变量和任务。它以YAML格式编写。</li>
</ul>
<br/>
<br/>
<h2 id="入门">入门</h2>
<p>Getting Started: <a href="https://docs.ansible.com/ansible/latest/user_guide/intro_getting_started.html">https://docs.ansible.com/ansible/latest/user_guide/intro_getting_started.html</a></p>
<p>一个基本的Ansible命令或playbooks：</p>
<ul>
<li>从清单中选择机器来执行</li>
<li>连接到这些机器（通常是SSH）</li>
<li>复制一个或多个模块到远程机器，并执行</li>
</ul>
<p>Ansible可以做很多事。一旦你理解了Ansible是如何工作的，你可以阅读有关的<code>ad-hoc</code>命令的详细信息，使用清单组织你的基础架构，并利用Ansible强大的playbooks。</p>
<br/>
<br/>
<h3 id="从清单选择机器">从清单选择机器</h3>
<p>Ansible从你的清单中读取管理的机器的信息。虽然你可以通过IP地址和<code>ad-hoc</code>命令，你也需要清单来增加Ansible的灵活性和重复性。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 创建一个基本的清单
# 在此文件中添加远程系统
vim /etc/ansible/hosts
192.0.2.50
aserver.example.org
bserver.example.org
</code></pre></td></tr></table>
</div>
</div><p>也可以使用别名(aliases)，主机变量(host vars)，组变量(group vars)。</p>
<br>
<br/>
<h3 id="连接到远程节点">连接到远程节点</h3>
<p>Ansible与远程机器通过SSH协议进行通信。默认情况下，Ansible使用原生的OpenSSH连接到远程机器。</p>
<p>确认用户名可使用SSH进行连接。如有必要，将SSH公钥添加到系统的<code>authorized_keys</code>文件。</p>
<br>
<br>
<h3 id="复制和执行模块">复制和执行模块</h3>
<p>一旦建立连接，Ansible传输你的命令或剧本需要的模块到远程机器。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 运行第一个ansible命令
ansible all -m ping


# 运行一个节点上的命令
ansible all -a &#34;/bin/echo hell&#34;
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h2 id="如何构建清单">如何构建清单</h2>
<p>How to build your inventory: <a href="https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html">https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html</a></p>
<p>Ansible对多个被管理的节点使用被称为清单的列表或组列表。一旦清单定义，你可以选择主机或组来运行。</p>
<p>清单的默认位置是<code>/etc/ansible/hosts</code>。可以通过<code>-i</code>选项来指定不同的清单文件。也可以同时使用多个清单文件。从动态或云拉取清单。</p>
<br>
<br>
<h3 id="清单基本">清单基本</h3>
<p>formats, hosts, groups。</p>
<p>清单文件有多种形式。最常用的是INI和YAML。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ini" data-lang="ini"><span class="c1"># INI格式</span>
<span class="na">mail.example.com</span>

<span class="c1"># 组名</span>
<span class="k">[webservers]</span>
<span class="na">a.example.com</span>
<span class="na">b.example.com</span>

<span class="k">[dbserver]</span>
<span class="na">db1.example.com</span>
<span class="na">db2.example.com</span>
<span class="na">db3.example.com</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># YAML格式</span><span class="w">
</span><span class="w"></span><span class="nt">all</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">mail.example.com</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">children</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">webserver</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">a.example.com</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">b.example.com</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">dbservers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">db1.example.com</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">db2.example.com</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">db3.example.com</span><span class="p">:</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p>默认组(default groups)，有两个默认组。</p>
<ul>
<li><code>all</code>：包含每个主机</li>
<li><code>ungrouped</code>：all中没有组的主机</li>
</ul>
<br>
<p>在多个组中的主机(Hosts in multiple groups)。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">all</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">mail.example</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">children</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">webservers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">f.example.com</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">b.example.com</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">dbservers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">one.example.com</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">two.example.com</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">east</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">f.example.com</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">one.example.com</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">west</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">b.example.com</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">two.example.com</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">prod</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">children</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">east</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">test</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">b.example.com</span><span class="p">:</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p>添加主机范围(Adding ranges of hosts)。如果有很多主机有一个类似的模式，可将其添加为一个范围，而不是单独列出每个主机名。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">...</span><span class="w">
</span><span class="w">  </span><span class="nt">webservers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">www[01:20].example.com</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">dbservers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="l">db-[a:f].example.com</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="添加变量到清单">添加变量到清单</h3>
<p>Adding variables to inventory</p>
<p>可以在清单中存储涉及到特定主机或组的变量值。</p>
<br/>
<br/>
<h3 id="主机变量">主机变量</h3>
<p>Assigning a variable to one machine: host variables</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">atlanta</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts1</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">http_port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">    </span><span class="nt">maxRequestPerChild</span><span class="p">:</span><span class="w"> </span><span class="m">808</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts2</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">http_port</span><span class="p">:</span><span class="w"> </span><span class="m">303</span><span class="w">
</span><span class="w">    </span><span class="nt">maxRequestPerChild</span><span class="p">:</span><span class="w"> </span><span class="m">909</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p>清单别名(Inventory aliases)。在清单中定义别名：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">...</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">jumper</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">ansible_port</span><span class="p">:</span><span class="w"> </span><span class="m">5555</span><span class="w">
</span><span class="w">      </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="m">192.0.2.50</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br/>
<br/>
<h3 id="组变量">组变量</h3>
<p>Assigning a variable to many machines: group variables</p>
<p>在一组的主机中共享变量值。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">atlanta</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">hosts1</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">host2</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">ntp_server</span><span class="p">:</span><span class="w"> </span><span class="l">ntp.atlanta.example.com</span><span class="w">
</span><span class="w">    </span><span class="nt">proxy</span><span class="p">:</span><span class="w"> </span><span class="l">proxy.atlanta.example.com</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p>继承变量值(Inheriting variable values: group variables for groups of groups)。可使用<code>children:</code>(yaml)来构建组的组，同样，可使用<code>vars:</code>来构建组变量的组变量。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">all</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">children</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">usa</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">children</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">southeast</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">children</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">atlanta</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">hosts1</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">hosts2</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">raleigh</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">hosts2</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">hosts3</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">some_server</span><span class="p">:</span><span class="w"> </span><span class="l">foo.southeast.example.com</span><span class="w">
</span><span class="w">              </span><span class="nt">halon_system_timeout</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span><span class="w">              </span><span class="nt">self_destruct_countdown</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span><span class="w">              </span><span class="nt">escape_pods</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">          </span><span class="nt">northeast</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">norethwest</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">southwest</span><span class="p">:</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>子组有几个属性的注意事项：</p>
<ul>
<li>子组成员的任何主机自动成为父组的成员</li>
<li>子组的变量的优先级高于(覆盖)父组的变量</li>
<li>组可以有多个父亲和孩子</li>
<li>主机可以在多个组，但只会有一台主机实例，合并来自多个组的数据</li>
</ul>
<br/>
<br/>
<h3 id="组织主机和组变量">组织主机和组变量</h3>
<p>Organizing host and group variables</p>
<p>尽管你可以将变量存储在清单文件，但存储独立的主机和组变量可以帮助您更轻松地阻止你的变量值。主机和组变量文件必须使用YAML语法。</p>
<p>Ansible通过搜索清单文件或剧本文件的路径来载入主机和组变量文件。</p>
<br/>
<br/>
<h3 id="变量如何合并">变量如何合并</h3>
<p>How variables are merged</p>
<p>默认情况下，在play运行前变量被合并到特定的主机。这使Ansible集中在主机和任务，因此组并没有真正生存在清单和主机匹配之外。Ansible覆盖变量的顺序：</p>
<ul>
<li>all group</li>
<li>parent group</li>
<li>child group</li>
<li>host</li>
</ul>
<p>默认情况下Ansible在相同的父/子级按字母顺序合并组，并在最后一组加载覆盖前面的组。你可以通过设置组变量<code>ansible_group_priority</code>来改变同级组合并顺序的行为。数字越大，优先级就越高。默认值是1。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># testvar == a</span><span class="w">
</span><span class="w"></span><span class="nt">a_group</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">testvar</span><span class="p">:</span><span class="w"> </span><span class="l">a</span><span class="w">
</span><span class="w">  </span><span class="nt">ansible_group_priority</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w"></span><span class="nt">b_group</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">testvar</span><span class="p">:</span><span class="w"> </span><span class="l">b</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br/>
<br/>
<h3 id="使用多个清单源">使用多个清单源</h3>
<p>Using multiple inventory sources</p>
<p>可通过在命令行中或配置<code>ANSIBLE_INVENTORY</code>通过给定多个清单参数在同一时间目标多个清单源（目录，动态清单脚本，清单插件&hellip;）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># target 2 sources</span><span class="w">
</span><span class="w"></span><span class="l">ansible-playbook get_logs.yml -i staging -i production</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p><strong>以一个目录组合多个清单源(Aggregating inventory sources with a directory)</strong></p>
<p>还可以通过一个目录下结合多个清单源和原类型来创建清单。这对于动静结合主机和管理它们为一体化清单很有用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="l">inventory/</span><span class="w">
</span><span class="w">  </span><span class="l">openstack.yml         </span><span class="w"> </span><span class="c"># configure inventory plugin to get hosts from Openstack cloud</span><span class="w">
</span><span class="w">  </span><span class="l">dynamic-inventory.py  </span><span class="w"> </span><span class="c"># add additional hosts with dynamic inventory script</span><span class="w">
</span><span class="w">  </span><span class="l">static-inventory      </span><span class="w"> </span><span class="c"># add static hosts and groups</span><span class="w">
</span><span class="w">  </span><span class="l">group_vars/</span><span class="w">
</span><span class="w">    </span><span class="l">all.yml             </span><span class="w"> </span><span class="c"># assign variables to all hosts</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># target inventory</span>
ansible-playbook example.yml -i inventory
</code></pre></td></tr></table>
</div>
</div><br/>
<br/>
<h3 id="清单参数">清单参数</h3>
<p>Connecting to hosts: behavioral inventory parameters</p>
<p>以下变量控制与远程主机如何与Ansible相互作用。</p>
<br/>
<br/>
<h3 id="清单配置样例">清单配置样例</h3>
<p>Inventory setup examples</p>
<ul>
<li>每个环境一个清单(One inventory per environment)</li>
<li>通过功能分组(Group by function)</li>
<li>通过地址分组(Group by location)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># Example: One inventory per environment
# inventory_test
[dbservers]
db01.test.example.com
db02.test.example.com
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># Example: Group by function</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">dbservers</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">allow access from 10.0.0.1</span><span class="w">
</span><span class="w">    </span><span class="nt">iptables</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">chain</span><span class="p">:</span><span class="w"> </span><span class="l">INPUT</span><span class="w">
</span><span class="w">      </span><span class="nt">jump</span><span class="p">:</span><span class="w"> </span><span class="l">ACCEPT</span><span class="w">
</span><span class="w">      </span><span class="nt">source</span><span class="p">:</span><span class="w"> </span><span class="m">10.0.0.1</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># Example: Group by location
[dc1]
db01.test.example.com
app01.test.example.com
</code></pre></td></tr></table>
</div>
</div><br/>
<br/>
<br/>
<h2 id="动态清单">动态清单</h2>
<p>Working with dynamic inventory: <a href="https://docs.ansible.com/ansible/latest/user_guide/intro_dynamic_inventory.html">https://docs.ansible.com/ansible/latest/user_guide/intro_dynamic_inventory.html</a></p>
<br/>
<h3 id="cobbler">cobbler</h3>
<br/>
<br/>
<h3 id="aws-ec2">AWS ec2</h3>
<br/>
<br/>
<h3 id="openstack">OpenStack</h3>
<br/>
<br/>
<h3 id="其它清单脚本">其它清单脚本</h3>
<p>Other inventory scripts</p>
<br/>
<br/>
<br/>
<h2 id="模式">模式</h2>
<p>Patterns: targeting hosts and groups: <a href="https://docs.ansible.com/ansible/latest/user_guide/intro_patterns.html">https://docs.ansible.com/ansible/latest/user_guide/intro_patterns.html</a></p>
<p>当你通过<code>ad-hoc</code>或<code>playbook</code>执行Ansible时，你必须选择要对哪些节点或组执行。模式可以让你针对清单中的特定主机或组执行。一个Ansible Pattern可以指定单个主机、IP地址、清单组、一组组、所有主机&hellip;模式非常灵活，可以排除需要的主机子集、使用通配符、正则表达式&hellip;Ansible将在包含在模式上的所有清单主机上执行。</p>
<br/>
<h3 id="模式使用">模式使用</h3>
<p>Using patterns</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># ad-hoc</span>
<span class="c1"># ansible {pattern} -m {module_name} -a &#34;{module_options}&#34;</span>
ansible webservers -m service -a <span class="s2">&#34;name=httpd state=restarted&#34;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># palybook</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span>{<span class="l">play_name}</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span>{<span class="l">pattern}</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">restart webservers</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">webservers</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br/>
<br/>
<h3 id="常见模式">常见模式</h3>
<p>Common patterns</p>
<table>
<thead>
<tr>
<th>描述</th>
<th>模式</th>
<th>目标</th>
</tr>
</thead>
<tbody>
<tr>
<td>All hosts</td>
<td>all(*)</td>
<td>-</td>
</tr>
<tr>
<td>One host</td>
<td>host1</td>
<td>-</td>
</tr>
<tr>
<td>Multiple hosts</td>
<td>host1:host2(host1,host2)</td>
<td>-</td>
</tr>
<tr>
<td>One group</td>
<td>g1</td>
<td>-</td>
</tr>
<tr>
<td>Multiple groups</td>
<td>g1:g2</td>
<td>all hosts in g1 and g2</td>
</tr>
<tr>
<td>Excluding groups</td>
<td>g1:!g2</td>
<td>all hosts in g1 except those in g2</td>
</tr>
<tr>
<td>Intersection of groups</td>
<td>g1:&amp;g2</td>
<td>g1和g2的交集</td>
</tr>
</tbody>
</table>
<br/>
<br/>
<h3 id="模式的局限性">模式的局限性</h3>
<p>Limitations of patterns</p>
<p>模式依赖于清单。如果主机或组不在清单中，则不能使用模式来目标它。如果模式中包含清单中不存在的IP地址或主机名，会报错。模式必须匹配清单语法。</p>
<br/>
<br/>
<h3 id="高级的模式选项">高级的模式选项</h3>
<p>Advanced pattern options</p>
<p>常用的模式将满足你的大部分需求，但Ansible提供了几种方法来定义你需要定位(target)的主机和组。</p>
<p><strong>在模式中使用环境变量</strong>
Using variables in patterns</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># playbook
webservers:!{{ excluded }}:&amp;{{ required }}
</code></pre></td></tr></table>
</div>
</div><p><strong>在模式中使用组位置</strong>
Using group position in patterns</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[g1]
aa
bb
cc


g1[0]
g1[-1]
g1[0:2]
g1[1:]
</code></pre></td></tr></table>
</div>
</div><p><strong>在模式中使用正则</strong>
Using regexes in patterns</p>
<p>以<code>~</code>符号开始使用模式的正则: <code>~(web|db).*\.example\.com</code></p>
<br/>
<br/>
<h3 id="playbook标志">playbook标志</h3>
<p>Patterns and ansible-playbook flags</p>
<p>可以使用命令行选项改变playbook中定义的行为。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">ansible-playbook site.yml --limit datacenter2
</code></pre></td></tr></table>
</div>
</div><br/>
<br/>
<br/>
<h2 id="ad-hoc">ad-hoc</h2>
<p>Introduction to ad-hoc commands: <a href="https://docs.ansible.com/ansible/latest/user_guide/intro_adhoc.html">https://docs.ansible.com/ansible/latest/user_guide/intro_adhoc.html</a></p>
<p>一个Ansible的<code>ad-hoc</code>命令使用ansible命令行工具在一个或多个管理节点上执行单一任务。<code>ad-hoc</code>命令是快速和容易的，但却无法重复使用。那么为什么首先学习<code>ad-hoc</code>命令呢？它表明Ansible的简单和功能。在这学的内容可直接到playbook里。在执行前，请先阅读构建清单。</p>
<p><code>ansible</code>命令行实用程序的默认模块是<a href="https://docs.ansible.com/ansible/latest/modules/command_module.html" target="_blank" rel="noopener noreffer ">command module</a>。</p>
<p>如果像重复一个命令，可使用playbook中的template module。</p>
<br/>
<h3 id="为什么使用它">为什么使用它</h3>
<p>Why use ad-hoc commands?</p>
<p><code>ad-hoc</code>命令针对的是很少会重复的任务。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 栗子</span>
ansible <span class="o">[</span>pattern<span class="o">]</span> -m <span class="o">[</span>module<span class="o">]</span> -a <span class="s2">&#34;[module options]&#34;</span>
</code></pre></td></tr></table>
</div>
</div><br/>
<br/>
<h3 id="用例">用例</h3>
<p>Use cases for ad-hoc tasks</p>
<p><code>ad-hoc</code>任务可用来重启服务器、复制文件、管理包和用户&hellip;可在<code>ad-hoc</code>任务中使用任意Ansible模块。Ad-hoc tasks与playbooks类似，使用一个声明模型，计算并执行以达到规定的最终状态所需的操作。</p>
<br>
<p><strong>重启服务器</strong></p>
<p><code>ad-hoc</code>任务调用命令模块。在执行前，确保清单和SSH。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># rebooting servers</span>
ansible host1 -a <span class="s2">&#34;/sbin/reboot&#34;</span>


<span class="c1"># 默认是5并发进程</span>
ansible host1 -a <span class="s2">&#34;/sbin/reboot&#34;</span> -f <span class="m">10</span>


<span class="c1"># ansible将默认为你的用户账户</span>
ansible host1 -a <span class="s2">&#34;/sbin/reboot&#34;</span> -f <span class="m">10</span> -u username



<span class="c1"># 重启服务器可能需要特权提升，如从user到root</span>
ansible host1 -a <span class="s2">&#34;/sbin/reboot&#34;</span> -f <span class="m">10</span> -u username --become <span class="o">[</span>--ask-become-pass<span class="o">]</span>


<span class="c1"># 使用不同的模块</span>
ansible host1 -m shell -a <span class="s1">&#39;echo ${TERM}&#39;</span>
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>文件管理</strong></p>
<p><code>ad-hoc</code>可利用Ansible和scp的力量，并行传输文件到多台机器。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 复制文件</span>
ansible atlanta -m copy -a <span class="s2">&#34;src=/etc/hosts dest=/tmp/hosts&#34;</span>

<span class="c1"># file模块属主和权限，创建目录，递归删除</span>
ansible webservers -m file -a <span class="s2">&#34;dest=/srv/foo/b.txt mode=600 owner=mdehaan group=mdehaan&#34;</span>
ansible webservers -m file -a <span class="s2">&#34;dest=/path/to/c mode=755 owner=mdehaan group=mdehaan state=directory&#34;</span>
ansible webservers -m file -a <span class="s2">&#34;dest=/path/to/c state=absent&#34;</span>
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>包管理</strong></p>
<p>使用<code>ad-hoc</code>任务使用包管理模块（如yum），来安装、升级、移除包。</p>
<p>Ansible有许多平台的许多包管理工具的模块，详情请看文档。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 安装了包不更新</span>
ansible webservers -m yum -a <span class="s2">&#34;name=acme state=present&#34;</span>

<span class="c1"># 特定包版本</span>
ansible webservers -m yum -a <span class="s2">&#34;name=acme-1.5 state=present&#34;</span>

<span class="c1"># 确认包是最新版</span>
ansible webservers -m yum -a <span class="s2">&#34;name=acme state=latest&#34;</span>


<span class="c1"># 确保未安装</span>
ansible webservers -m yum -a <span class="s2">&#34;name=acme state=absent&#34;</span>
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>管理用户和组</strong></p>
<p>使用<code>ad-hoc</code>任务在管理的节点上创建、管理、移除用户账户。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">ansible all -m user -a <span class="s2">&#34;name=foo password={crypted password here}&#34;</span>

ansible all -m user -a <span class="s2">&#34;name=foo state=absent&#34;</span>
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>服务管理</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 确保服务已启动</span>
ansible webservers -m service -a <span class="s2">&#34;name=httpd state=started&#34;</span>


<span class="c1"># 重启服务</span>
ansible webservers -m service -a <span class="s2">&#34;name=httpd state=restarted&#34;</span>


<span class="c1"># 确保服务已停止</span>
ansible webservers -m service -a <span class="s2">&#34;name=httpd state=stopped&#34;</span>
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>收集事实</strong></p>
<p>事实代表发现关于系统的变量。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 查看所有facts</span>
ansible all -m setup
</code></pre></td></tr></table>
</div>
</div><br/>
<br/>
<br/>
<h2 id="连接方法和详情">连接方法和详情</h2>
<p>Connection methods and details: <a href="https://docs.ansible.com/ansible/latest/user_guide/connection_details.html">https://docs.ansible.com/ansible/latest/user_guide/connection_details.html</a></p>
<br/>
<h3 id="controlpersist和paramiko">ControlPersist和paramiko</h3>
<p>默认情况下，Ansible使用原生的OpenSSH，因为它支持ControlPersist（一个性能特点），Kerberos，和<code>~/.ssh/config</code>中的配置。如果你的控制机使用的旧版本OpenSSH不支持ControlPersist，Ansible将回退到称为<code>paramiko</code>的一个Python实现的OpenSSH。</p>
<br/>
<br/>
<h3 id="ssh-key配置">ssh-key配置</h3>
<p>SSH key setup</p>
<p>默认情况下，Ansible假定您使用SSH keys连接到远程主机。推荐使用key，但可使用<code>--ask-pass</code>选项来使用密码。使用<code>--ask-become-pass</code>选项来使用特权提升。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 建立ssh agent来避免输入密码</span>
ssh-agent bash
ssh-add ~/.ssh/id_rsa
</code></pre></td></tr></table>
</div>
</div><br/>
<br/>
<h3 id="本地运行">本地运行</h3>
<p>Running against localhost</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">ansible localhost -m ping -e <span class="s1">&#39;ansible_python_interpreter=&#34;/usr/bin/env python&#34;&#39;</span>
</code></pre></td></tr></table>
</div>
</div><br/>
<br/>
<h3 id="主机密钥检查">主机密钥检查</h3>
<p>Host key checking</p>
<p>Ansible默认启用主机密钥检查。如果主机重装并在<code>known_hosts</code>中有不同的密钥，这将导致一个错误消息，知道纠正。</p>
<p>可在<code>/etc/ansible/ansible.cfg</code>或<code>~/.ansible.cfg</code>中禁用它:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[defaults]
host_key_checking = False
</code></pre></td></tr></table>
</div>
</div><p>或设置环境变量: <code>export ANSIBLE_HOST_KEY_CHECKING=False</code></p>
<br/>
<br/>
<h3 id="其它连接方法">其它连接方法</h3>
<p>Other connection methods</p>
<p>除了SSH之外，Ansible还可以使用许多连接方法。</p>
<br/>
<br/>
<br/>
<h2 id="命令行工具">命令行工具</h2>
<p>Working with command line tools: <a href="https://docs.ansible.com/ansible/latest/user_guide/command_line_tools.html">https://docs.ansible.com/ansible/latest/user_guide/command_line_tools.html</a></p>
<p>大多数用户对<code>ansible</code>和<code>ansilbe-playbook</code>比较熟悉，但它们不是Ansible提供的唯一实用工具。下面是完整的Ansible使用工具列表。</p>
<ul>
<li><a href="https://docs.ansible.com/ansible/latest/cli/ansible.html" target="_blank" rel="noopener noreffer ">ansible</a>: 在一组主机上定义和运行一个单任务playbook</li>
<li><a href="https://docs.ansible.com/ansible/latest/cli/ansible-config.html" target="_blank" rel="noopener noreffer ">ansible-config</a>: 查看Ansible配置信息</li>
<li><a href="https://docs.ansible.com/ansible/latest/cli/ansible-console.html" target="_blank" rel="noopener noreffer ">ansible-console</a>: REPL控制台执行Ansible任务</li>
<li><a href="https://docs.ansible.com/ansible/latest/cli/ansible-doc.html" target="_blank" rel="noopener noreffer ">ansible-doc</a>: 插件文档工具</li>
<li><a href="https://docs.ansible.com/ansible/latest/cli/ansible-galaxy.html" target="_blank" rel="noopener noreffer ">ansible-galaxy</a>: 执行各种角色并收集相关的操作</li>
<li><a href="https://docs.ansible.com/ansible/latest/cli/ansible-inventory.html" target="_blank" rel="noopener noreffer ">ansible-invotory</a>: 显示或转配置清单</li>
<li><a href="https://docs.ansible.com/ansible/latest/cli/ansible-playbook.html" target="_blank" rel="noopener noreffer ">ansible-playbook</a>: 运行Ansible playbook</li>
<li><a href="https://docs.ansible.com/ansible/latest/cli/ansible-pull.html" target="_blank" rel="noopener noreffer ">ansible-pull</a>: 从仓库拉playbook并为本地主机执行</li>
<li><a href="https://docs.ansible.com/ansible/latest/cli/ansible-vault.html" target="_blank" rel="noopener noreffer ">ansible-valut</a>: Ansible数据文件的加解密工具</li>
</ul>
<br/>
<br/>
<br/>
<h2 id="playbook">playbook</h2>
<p>Working With Playbooks: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks.html</a></p>
<p>Playbooks是Ansible的配置(configuration)、部署(deployment)和编排(orchestration)语言。它可以描述你希望你的远程系统强制执行的策略，或在IT流程的步骤。</p>
<p>在最基本的级别上，playbook可以被用来管理部署的配置到远程机器。在更高级的，它们可以序列进行涉及多层(mulit-tier)的滚动更新和回滚，并可以委托操作其它主机，与监控服务器进行交互和负载均衡。它有很多功能和信息，详情看文档。</p>
<p>playbook被设计为人类可读的和基于文本语言开发。有多种方式来组织playbook和它包含的文件。</p>
<p>你应该看一看<a href="https://github.com/ansible/ansible-examples" target="_blank" rel="noopener noreffer ">Example Playbooks</a>，并与playbook文档一起阅读。这些说明的最佳实践，以及如何把众多的各种概念混合在一起。</p>
<br/>
<h3 id="介绍-1">介绍</h3>
<p>Intro to Playbooks: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html</a></p>
<p>playbook是比在<code>ad-hoc</code>任务执行模式下的一个完全不同的使用ansible的方式，并且特别强大。</p>
<p>简单来说，Playbook是一个非常基础的用于配置管理和多机部署系统，不同于任何已存在的，并且非常适合部署复杂的应用程序。</p>
<p>playbook可以声明配置，但它也可以通过编排任意手动排序进程的步骤，尽管不同的步骤必须来回在特定命令的机器之间。它可以同步(synchronously)或异步(asynchronously)发射任务。</p>
<p>虽然你为<code>ad-hoc</code>任务运行主要的<code>/usr/bin/ansible</code>程序，playbook更可能被保持在原控制和用于推送配置或保证远程系统上的配置。palybook example中有许多栗子，建议去看一看。</p>
<br/>
<h4 id="playbook-language">playbook language</h4>
<p>playbook以YAML语法格式表示，故意不设计成一种编程语言或脚本，而是过程或配置的模型。</p>
<p>每个playbooks由列表中的play组成。play的目标是映射一组主机到一些良好定义的角色(roles)，由ansible调用任务来表示。通过多个paly组成playbook，有可能协调多机部署，在某个组的所有机器上运行某些步骤&hellip;你可以由相当多的影响你的系统做不同事情的paly。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># 仅包含一个paly的`verigy-apache.yml`的playbook的栗子</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">webserver</span><span class="w">
</span><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">http_port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">    </span><span class="nt">max_clients</span><span class="p">:</span><span class="w"> </span><span class="m">200</span><span class="w">
</span><span class="w">  </span><span class="nt">remote_user</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ensure apache is at the latest version</span><span class="w">
</span><span class="w">    </span><span class="nt">yum</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">httpd</span><span class="w">
</span><span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">latest</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">write the apache config file</span><span class="w">
</span><span class="w">    </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l">/srv/httpd.j2</span><span class="w">
</span><span class="w">      </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/httpd.conf</span><span class="w">
</span><span class="w">    </span><span class="nt">notify</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">restart apache</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ensure apache is running</span><span class="w">
</span><span class="w">    </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">httpd</span><span class="w">
</span><span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">started</span><span class="w">
</span><span class="w">  </span><span class="nt">handlers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">restart apache</span><span class="w">
</span><span class="w">      </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">httpd</span><span class="w">
</span><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">restarted</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># 包含多个play的栗子</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">webservers</span><span class="w">
</span><span class="w">  </span><span class="nt">remote_user</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ensure apache is at the lastest version</span><span class="w">
</span><span class="w">    </span><span class="nt">yum</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">httpd</span><span class="w">
</span><span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">latest</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">write the apache config file</span><span class="w">
</span><span class="w">    </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l">/srv/httpd.j2</span><span class="w">
</span><span class="w">      </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/httpd.conf</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">databases</span><span class="w">
</span><span class="w">  </span><span class="nt">remote_user</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ensure pgsql is at the latest version</span><span class="w">
</span><span class="w">    </span><span class="nt">yum</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">postgresql</span><span class="w">
</span><span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">latest</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ensure that postgresql is started</span><span class="w">
</span><span class="w">    </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">postgresql</span><span class="w">
</span><span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">started</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br/>
<br/>
<h4 id="基本">基本</h4>
<p>Basics</p>
<br>
<p><strong>主机和用户</strong>
Hosts and Users</p>
<p>对于playbook中的每个play，你可以选择哪些机器在你的基础设施到目标，什么远程用户完成这些步骤。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># hosts行是一个或多个主机或组的模式，以冒号分隔</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">webservers</span><span class="w">
</span><span class="w">  </span><span class="nt">remote_user</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span><span class="w">      </span><span class="nt">ping</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">remote_user</span><span class="p">:</span><span class="w"> </span><span class="l">username</span><span class="w"> </span><span class="c"># 远程用户可在每个用户中定义</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># 特权提升</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">webservers</span><span class="w">
</span><span class="w">  </span><span class="nt">remote_user</span><span class="p">:</span><span class="w"> </span><span class="l">username</span><span class="w">
</span><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="kc">yes</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># 也可在每个paly中使用become</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">g1</span><span class="w">
</span><span class="w">  </span><span class="nt">remote_user</span><span class="p">:</span><span class="w"> </span><span class="l">uername</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">started</span><span class="w">
</span><span class="w">      </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="kc">yes</span><span class="w">
</span><span class="w">      </span><span class="nt">become_method</span><span class="p">:</span><span class="w"> </span><span class="l">sudo</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># 权限提升为特定用户</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">g1</span><span class="w">
</span><span class="w">  </span><span class="nt">remote_user</span><span class="p">:</span><span class="w"> </span><span class="l">username</span><span class="w">
</span><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="kc">yes</span><span class="w">
</span><span class="w">  </span><span class="nt">become_user</span><span class="p">:</span><span class="w"> </span><span class="l">postgres</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># 控制运行顺序，默认是清单里面的顺序</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span><span class="w">  </span><span class="nt">order</span><span class="p">:</span><span class="w"> </span><span class="l">sorted</span><span class="w">
</span><span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="kc">False</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">var</span><span class="p">:</span><span class="w"> </span><span class="l">inventory_hostname</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p><strong>任务列表</strong>
Tasks list</p>
<p>每个play包含任务列表。任务在移动到下一个任务之前执行，一次一个，由模式匹配的所有主机。理解在一个play中，所用主机都将得到同样的任务指令是很重要的。这是play映射选择主机到任务的目的。</p>
<p>当运行playbook时，它从上到下运行，失败任务的主机被从playbook轮转中取出。如果事情失败，只是纠正playbook文件，然后重新运行。</p>
<p>每个任务的目标是执行带有特定参数的模块，变量可以在参数中传给模块。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># 一个任务的基本栗子</span><span class="w">
</span><span class="w"></span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">make sure apache is running</span><span class="w">
</span><span class="w">    </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">httpd</span><span class="w">
</span><span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">started</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># command, shell模块</span><span class="w">
</span><span class="w"></span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">enable selinux</span><span class="w">
</span><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">/sbin/setenfore 1</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">run this command and ignore the result</span><span class="w">
</span><span class="w">    </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/bin/somecommand || /bin/true</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">create a virtual host file for {{ vhost}}</span><span class="w">
</span><span class="w">    </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l">somefile.j2</span><span class="w">
</span><span class="w">      </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/httpd/conf.d/{{ vhost}}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br/>
<br/>
<h4 id="action-shorthand">action shorthand</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># Ansible prefers listing modules like this:</span><span class="w">
</span><span class="w"></span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l">template/foo.j2</span><span class="w">
</span><span class="w">  </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/foo.conf</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>早期版本使用以下格式，仍旧有效: <code>action: template src=templates/foo.j2 dest=/etc/foo.conf</code></p>
<br/>
<br/>
<h4 id="handlers">Handlers</h4>
<p>Handlers: Running Operations On Change</p>
<p>如前所述，当远程系统上做了改变时模块应该是幂等的和可以中继(relay)。playbook认识到了这一点，并有一个基本的事件系统用于应对改变。</p>
<p>这些play中的<code>notify</code>行动在任务的每个末尾块触发，即使被多个不同任务通知也只能被触发一次。</p>
<p>例如，多个资源可能表明Apache需要重启，因为配置文件发生了更改，但Apache将跳跃一次，以避免不必要的重启。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># 当一个文件的内容更改时（仅此文件），重启两个服务的栗子</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">template configuration file</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l">template.j2</span><span class="w">
</span><span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/foo.conf</span><span class="w">
</span><span class="w">  </span><span class="nt">notify</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">restart memcached</span><span class="w">
</span><span class="w">    </span>- <span class="l">restart apache</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>在任务的<code>notify</code>中列出的事情的部分被称为处理程序(handlers)。</p>
<p>处理程序是任务列表，与常规的任务没什么区别，由一个全局唯一的名称进行引用，并通过通知程序(notifier)进行通知。如果没有事情通知一个处理程序，它将不会运行。不管有多少任务通知处理程序，它只能运行一次，在一个特定paly中的所有任务完成之后。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># handlers section</span><span class="w">
</span><span class="w"></span><span class="nt">handlers</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">restart memcached</span><span class="w">
</span><span class="w">    </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">memcached</span><span class="w">
</span><span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">restarted</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">restart apached</span><span class="w">
</span><span class="w">    </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apache</span><span class="w">
</span><span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">restarted</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>你可能想让Ansible handlers使用变量。如果handlers name使用的变量不可用，则整个paly将失败。取而代之的是，在handlers的任务参数中使用变量。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Set host variables based on distribution</span><span class="w">
</span><span class="w">    </span><span class="nt">include_vars</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ ansible_facts.distribution}}.yml&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">handlers</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">restart web service</span><span class="w">
</span><span class="w">    </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ web_service_name | default(&#39;httpd&#39;) }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">restarted</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Ansible 2.2，handlers可以监听(listen)通用话题(generic topics)，任务可以通知这些话题。以下这种使用使它更容易触发多个处理程序。它还从名称解耦处理程序，使得在playbook和roles之间更容易共享处理程序。（特别是当使用像Galaxy的第三方角色时）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">handlers</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">restart memcached</span><span class="w">
</span><span class="w">    </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">memcached</span><span class="w">
</span><span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">restarted</span><span class="w">
</span><span class="w">    </span><span class="nt">listen</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;restart web service&#34;</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">restart apache</span><span class="w">
</span><span class="w">    </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apached</span><span class="w">
</span><span class="w">      </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">restarted</span><span class="w">
</span><span class="w">    </span><span class="nt">listen</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;restart web services&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">restart everything</span><span class="w">
</span><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">echo &#34;this task will restart the web services&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">notify</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;resstart web service&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<blockquote>
<p><strong>注意:</strong>
Notify handlers are always run in the same order they are defined, not in the order listed in the notify-statement. This is also the case for handlers using listen.
Handler names and listen topics live in a global namespace.
Handler names are templatable and listen topics are not.
Use unique handler names. If you trigger more than one handler with the same name, the first one(s) get overwritten. Only the last one defined will run.
You cannot notify a handler that is defined inside of an include. As of Ansible 2.1, this does work, however the include must be static.</p>
</blockquote>
<br>
<p>角色(Roles)后面会说明，但它值得指出的是：</p>
<ul>
<li>handlers notified within <code>pre_tasks</code>, <code>tasks</code>, and <code>post_tasks</code> sections are automatically flushed in the end of section where they were notified</li>
<li>handlers notified within <code>roles</code> section are automatically flushed in the end of <code>tasks</code> section, but before any <code>tasks</code> handlers</li>
<li>handlers are play scoped and as such can be used outside of the role they are defined in</li>
</ul>
<br/>
<br/>
<h4 id="执行playbook">执行playbook</h4>
<p>Executing A Playbook</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">ansible-playbook playbook.yml -f <span class="m">10</span>
</code></pre></td></tr></table>
</div>
</div><br/>
<br/>
<h4 id="ansible-pull">Ansible-Pull</h4>
<p>节点检查到重要位置，而不是推送配置给它们。<code>ansilbe-pull</code>是一个检查从git指令配置仓库的一个脚本，然后针对改内容运行<code>ansible-playbook</code>。</p>
<br/>
<br/>
<h4 id="linting-playbooks">Linting playbooks</h4>
<p>你可以在执行前使用<code>ansible-lint</code>来检查playbook的运行情况。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="l">ansible-lint verify-apache.yml</span><span class="w">
</span><span class="w"></span><span class="p">[</span><span class="m">403</span><span class="p">]</span><span class="w"> </span><span class="l">Package installs should not use latest</span><span class="w">
</span><span class="w"></span><span class="l">verify-apache.yml:8</span><span class="w">
</span><span class="w"></span><span class="nt">Task/Handler</span><span class="p">:</span><span class="w"> </span><span class="l">ensure apache is at the latest version</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br/>
<br/>
<h4 id="其它playbook验证项">其它playbook验证项</h4>
<p>Other playbook verification options</p>
<p>查看<a href="https://docs.ansible.com/ansible/latest/community/other_tools_and_programs.html#validate-playbook-tools" target="_blank" rel="noopener noreffer ">验证playbook工具</a>的详情列表，你可以使用它们来验证playbook。这里有些情况你应该考虑：</p>
<ul>
<li>要检查playbook语法问题，使用<code>ansible-playbook</code>的<code>--syntax-check</code>标志。</li>
<li>要查看完整的输出信息，使用<code>--verbose</code>标志。</li>
<li>要查看playbook会影响哪些主机，可运行: <code>ansible-playbook playbook.yml --list-hosts</code></li>
</ul>
<br/>
<br/>
<h3 id="可重复使用的playbook">可重复使用的playbook</h3>
<p>Creating Reusable Playbooks: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse.html</a></p>
<p>虽然可以在一个非常大的文件里编写playbook，最终你会想重新使用文件和整理东西。在Ansible中，有三种方式可以做到这一点：</p>
<ul>
<li>includes</li>
<li>imports</li>
<li>roles</li>
</ul>
<p>includes和imports允许用户将大型playbook分解为小型文件，可跨多个parent playbook或设置多次在相同的playbook里。
roles允许不仅仅是任务可以打包在一起，可以包括变量(variables)，处理程序(handlers)，甚至模块(modules)和其它插件(plugins)。不同于includes和imports，roles也可上传并经由Ansible Galaxy共享。</p>
<br>
<h4 id="including和importing">including和importing</h4>
<p>Including and Importing: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_includes.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_includes.html</a></p>
<p>include和import语句相似，但Ansible执行引擎处理它们却非常不同。</p>
<p><code>import*</code>语句在playbook被解析的时候进行预处理(pre-processed)。
<code>include*</code>语句在playbook的执行过程中遇到才处理。</p>
<p>include和import语句可以在任意深度使用。</p>
<br>
<p>在一个master playbook内包含playbook：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">import_playbook</span><span class="p">:</span><span class="w"> </span><span class="l">a.yml</span><span class="w">
</span><span class="w"></span>- <span class="nt">import_playbook</span><span class="p">:</span><span class="w"> </span><span class="l">b.yml</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>每个playbook中列出的plays和tasks将以列出的顺序 执行，就好像它们已经在这里直接定义。</p>
<br>
<p>大型任务划分成不同的文件是组织复杂任务或重用它们的一种好方式。一个任务文件只包含简单的任务列表：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">aaa</span><span class="w">
</span><span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/aaa</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">bbb</span><span class="w">
</span><span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/bbb</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>可以使用<code>import_tasks</code>或<code>include_tasks</code>来执行在主任务列表中的文件的任务：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">import_tasks</span><span class="p">:</span><span class="w"> </span><span class="l">aaa_tasks.yml</span><span class="w">
</span><span class="w"></span><span class="c"># or</span><span class="w">
</span><span class="w"></span>- <span class="nt">include_tasks</span><span class="p">:</span><span class="w"> </span><span class="l">aaa_tasks.yml</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>你也可以传递变量到imports和includes：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">import_tasks</span><span class="p">:</span><span class="w"> </span><span class="l">aaa.yaml</span><span class="w">
</span><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l">aaa</span><span class="w">
</span><span class="w"></span>- <span class="nt">import_tasks</span><span class="p">:</span><span class="w"> </span><span class="l">aaa.yml</span><span class="w">
</span><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l">bbb</span><span class="w">
</span><span class="w"></span>- <span class="nt">import_tasks</span><span class="p">:</span><span class="w"> </span><span class="l">aaa.yml</span><span class="w">
</span><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l">ccc</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p>include和import同样可以用于<code>handlers:</code>部分。栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># more_handlers.yml</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">restart apache</span><span class="w">
</span><span class="w">  </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apache</span><span class="w">
</span><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">restarted</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">handlers</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">include_tasks</span><span class="p">:</span><span class="w"> </span><span class="l">more_handlers.yml</span><span class="w">
</span><span class="w"></span><span class="c"># or</span><span class="w">
</span><span class="w"></span>- <span class="nt">import_tasks</span><span class="p">:</span><span class="w"> </span><span class="l">more_handlers.yml</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="roles">Roles</h4>
<p>roles: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html</a></p>
<p>角色(role)是基于已知的文件架构自动加载某些变量文件、任务和处理程序的方式。按角色分组的内容还可以方便地与其他用户共享。</p>
<br>
<h5 id="角色目录结构">角色目录结构</h5>
<p>Role Directory Structure</p>
<p>栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="l">site.yml</span><span class="w">
</span><span class="w"></span><span class="l">webservers.yml</span><span class="w">
</span><span class="w"></span><span class="l">fooservers.yml</span><span class="w">
</span><span class="w"></span><span class="l">roles/</span><span class="w">
</span><span class="w">    </span><span class="l">common/</span><span class="w">
</span><span class="w">        </span><span class="l">tasks/</span><span class="w">
</span><span class="w">        </span><span class="l">handlers/</span><span class="w">
</span><span class="w">        </span><span class="l">files/</span><span class="w">
</span><span class="w">        </span><span class="l">templates/</span><span class="w">
</span><span class="w">        </span><span class="l">vars/</span><span class="w">
</span><span class="w">        </span><span class="l">defaults/</span><span class="w">
</span><span class="w">        </span><span class="l">meta/</span><span class="w">
</span><span class="w">    </span><span class="l">webservers/</span><span class="w">
</span><span class="w">        </span><span class="l">tasks/</span><span class="w">
</span><span class="w">        </span><span class="l">defaults/</span><span class="w">
</span><span class="w">        </span><span class="l">meta/</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>角色在特定目录名下期待文件。角色必须包括这些目录中的至少一个，但它是完全没排除任何未使用。在使用时，每个目录必须包含一个<code>main.yml</code>文件，其中包含的相关内容：</p>
<ul>
<li><code>tasks</code>：包含由角色执行的主任务列表</li>
<li><code>handlers</code>：包含可通过此角色甚至此角色外的任何地方使用的处理程序</li>
<li><code>defaults</code>：角色的默认变量</li>
<li><code>vars</code>：角色的其它变量</li>
<li><code>files</code>：通过此角色可以部署的文件</li>
<li><code>templates</code>：通过此角色可以部署的模板</li>
<li><code>meta</code>：为角色定义的元数据</li>
</ul>
<p>其它YAML文件可能包含在特定目录。栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># roles/example/tasks/main.yml</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">added in 2.4, previously you used include</span><span class="w">
</span><span class="w">  </span><span class="nt">import_tasks</span><span class="p">:</span><span class="w"> </span><span class="l">redhat.yml</span><span class="w">
</span><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">ansible_facts[&#39;os_family&#39;]|lower == &#39;redhat&#39;</span><span class="w">
</span><span class="w">  </span><span class="nt">import_tasks</span><span class="p">:</span><span class="w"> </span><span class="l">debian.yml</span><span class="w">
</span><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">ansible_facts[&#39;os_family&#39;]|lower == &#39;debian&#39;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># roles/example/tasks/redhat.yml</span><span class="w">
</span><span class="w"></span>- <span class="nt">yum</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;httpd&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># roles/example/tasks/debian.yml</span><span class="w">
</span><span class="w"></span>- <span class="nt">pat</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;apache2&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>角色还可以包含模块和其它插件类型。</p>
<br>
<br>
<h5 id="角色使用">角色使用</h5>
<p>使用角色的原始的方式是在play中通过<code>roles:</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">webservers</span><span class="w">
</span><span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">common</span><span class="w">
</span><span class="w">    </span>- <span class="l">webservers</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>这将为每个角色(x)指定以下行为：</p>
<ul>
<li>如果<code>roles/x/tasks/main.yml</code>存在，其中列出的任务将被添加到play；</li>
<li>如果<code>roles/x/handlers/main.yml</code>存在，其中列出的处理程序将被添加到play；</li>
<li>如果<code>roles/x/vars/main.yml</code>存在，其中列出的变量将被添加到play；</li>
<li>如果<code>roles/x/defaults/main.yml</code>存在，其中列出的变量将被添加到play；</li>
<li>如果<code>roles/x/meta/main.yml</code>存在，其中列出的任何角色的依赖都将被添加到角色列表；</li>
<li>角色中的任意copy, script, template, include tasks，可在<code>roles/x/{files,templates,tasks}/dir</code>进行引用，而不必关心它们的相对或绝对路径。</li>
</ul>
<p>当以这种方式使用时，playbook的执行顺序如下：</p>
<ul>
<li>play中定义的任意<code>pre_tasks</code></li>
<li>任意处理程序触发到目前为止将会运行</li>
<li>在roles中列出的每个角色将依次执行。在角色<code>meta/main.yml</code>中定义的任意角色依赖将首先运行，受标签过滤和条件</li>
<li>play中定义的任意<code>tasks</code></li>
<li>任意处理程序触发到目前为止将会运行</li>
<li>play中定义的任意<code>post_tasks</code></li>
<li>任意处理程序触发到目前为止将会运行</li>
</ul>
<p>可使用<code>import_role</code>或<code>include_role</code>在其它任务中使用角色：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">webservers</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;before we run our role&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="nt">import_role</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example</span><span class="w">
</span><span class="w">    </span>- <span class="nt">include_role</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example</span><span class="w">
</span><span class="w">    </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;after we ran our role&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>当角色在原始方式中定义，它们被视为静态导入和在playbook解析时进行处理。</p>
<p>角色的名称可是很简单，也可以是一个完全合格的路径：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">webservers</span><span class="w">
</span><span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;/path/to/roles/common&#39;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>角色可以接受其它关键字：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">webservers</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">include_role</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foo_app_instance</span><span class="w">
</span><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;ansible_facts[&#39;os_family&#39;] == &#39;RedHat&#39;&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">dir</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;/opt/a&#39;</span><span class="w">
</span><span class="w">        </span><span class="nt">app_port</span><span class="p">:</span><span class="w"> </span><span class="m">5000</span><span class="w">
</span><span class="w">      </span><span class="nt">tags</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="l">aaa</span><span class="w">
</span><span class="w">        </span>- <span class="l">bbb</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h5 id="角色副本和扩展">角色副本和扩展</h5>
<p>Role Duplication and Execution</p>
<p>Ansible只允许一个角色执行一次，即使多次定义：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">webservers</span><span class="w">
</span><span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">foo</span><span class="w">
</span><span class="w">    </span>- <span class="l">foo</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>上面给出的<code>foo</code>角色仅将运行一次。为了使角色多次运行，有两种选择：</p>
<ol>
<li>每个角色传递不同的参数</li>
<li>添加<code>allow_duplicates: true</code>到<code>meta/main.yml</code>文件</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># playbook.yml</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">webservers</span><span class="w">
</span><span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">foo</span><span class="w">
</span><span class="w">    </span>- <span class="l">foo</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># roles/foo/meta/main.yml</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">allow_duplicates</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h5 id="角色默认变量">角色默认变量</h5>
<p>Role Default Variables</p>
<p>角色的默认变量允许你为角色设定默认变量。在角色目录中添加<code>defaults/main.yml</code>文件。这些变量具有最低优先级，可以轻易被覆盖。</p>
<br>
<br>
<h5 id="角色依赖">角色依赖</h5>
<p>Role Dependencies</p>
<p>角色依赖让你在其它角色使用角色时自动拉取。角色依赖存储在角色目录的<code>meta/main.yml</code>文件。此文件应包含角色和参数列表在指定角色之前插入：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># orles/myapp/meta/main.yml</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">dependencies</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l">common</span><span class="w">
</span><span class="w">    </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">come_parameter</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span>- <span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l">apache</span><span class="w">
</span><span class="w">    </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">apache_port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">  </span>- <span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l">postgres</span><span class="w">
</span><span class="w">    </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">dbname</span><span class="p">:</span><span class="w"> </span><span class="l">blarg</span><span class="w">
</span><span class="w">      </span><span class="nt">other_parameter</span><span class="p">:</span><span class="w"> </span><span class="m">12</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h5 id="角色中的嵌入模块和插件">角色中的嵌入模块和插件</h5>
<p>Embedding Modules and Plugins In Roles</p>
<br>
<br>
<h5 id="角色搜索路径">角色搜索路径</h5>
<p>Ansible将按以下方式为角色搜索：</p>
<ul>
<li>相对于playbook文件的<code>roles/</code>目录</li>
<li>默认情况下，在<code>/etc/ansible/roles</code></li>
</ul>
<br>
<br>
<h5 id="galaxy">Galaxy</h5>
<p>Ansible Galaxy是一个用于查找、下载、评级、审查各种社区ansible roles的免费网站。</p>
<p><code>ansible-galaxy</code>客户端包含在Ansible中。可使用它从Ansible Galaxy下载角色。</p>
<br>
<br>
<h4 id="动态与静态">动态与静态</h4>
<p>Dynamic vs. Static</p>
<p>Ansible有两种操作模式用于可重用内容：动态与静态。</p>
<p>如果你使用<code>include*</code>，它将是动态的。如果你使用<code>import*</code>，它是静态的。</p>
<br>
<p><strong>动态与静态的区别</strong></p>
<p>两种操作模式都非常简单：</p>
<ul>
<li>动态包含在遇到任务运行时处理</li>
<li>静态导入在解析playbook前处理</li>
</ul>
<p>当遇到<code>tag</code>或<code>when</code>：</p>
<ul>
<li>动态包含仅适用于动态的任务，不会复制到子任务</li>
<li>静态导入，将被复制到所有子任务</li>
</ul>
<br>
<br>
<h4 id="两者比较">两者比较</h4>
<p>使用<code>include*</code>与<code>import*</code>有一定的优势，权衡两者。</p>
<p>使用<code>include*</code>语句的最大优势是循环。当在include中使用循环，所包含的将在每个循环中执行。</p>
<ul>
<li>
<p>tags仅在动态包含内存在</p>
</li>
<li>
<p>tasks仅在动态包含内存在</p>
</li>
<li>
<p>在动态包含内不能使用<code>notify</code>来触发处理程序</p>
</li>
<li>
<p>在动态包含内不能使用<code>--start-at-task</code>来开始执行</p>
</li>
<li>
<p>静态导入内循环不能使用</p>
</li>
<li>
<p>静态导入内不能从库存源使用变量</p>
</li>
<li>
<p>静态导入内当通知它们的名字时，使用处理程序将不会触发</p>
</li>
</ul>
<br>
<br>
<h3 id="使用变量">使用变量</h3>
<p>Using Variables: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html</a></p>
<p>Ansible中使用变量可以更好地帮助处理各系统之间的差异。</p>
<br>
<h4 id="创建有效的变量名">创建有效的变量名</h4>
<p>Creating valid variable names</p>
<p>有效的变量名是很重要的。变量名应该是字母 、数字和下划线，且总是以字母开头。</p>
<p>YAML也支持映射键值对的字典：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">foo</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">field1</span><span class="p">:</span><span class="w"> </span><span class="l">one</span><span class="w">
</span><span class="w">  </span><span class="nt">field2</span><span class="p">:</span><span class="w"> </span><span class="l">two</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>你可以使用中括号或点来引用特定字段的值:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">foo[&#39;field1&#39;]
foo.field2
</code></pre></td></tr></table>
</div>
</div><p>请注意，如果使用点来引用，它们属性和Python字典的方法相冲突可能会导致一些问题。如果你使用的键开始和结束有两个下划线，或它们是已知的公共属性，则你应该使用中括号来代替点使用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 公共属性
add, append, count, decode...
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="在清单中定义变量">在清单中定义变量</h4>
<p>Defining variables in inventory</p>
<p>通常，你需要为单独的主机或组设置变量。你可以在清单文件(如hosts)中定义所需的变量：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">west</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">host1</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">    </span><span class="nt">maxRequest</span><span class="p">:</span><span class="w"> </span><span class="m">808</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">east</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">host1</span><span class="p">:</span><span class="w"> </span><span class="l">xx</span><span class="w">
</span><span class="w">    </span><span class="nt">host2</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="在playbook中定义变量">在playbook中定义变量</h4>
<p>Defining variables in a playbook</p>
<p>你可以直接在playbook中定义变量：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="在文件和角色中定义变量">在文件和角色中定义变量</h4>
<p>Defining variables in included files and roles</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span><span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span><span class="w">      </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">dir</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;/opt/a&#39;</span><span class="w">
</span><span class="w">    </span>- <span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l">test2</span><span class="w">
</span><span class="w">      </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">dir</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;/opt/b&#39;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="在jinja2中使用变量">在Jinja2中使用变量</h4>
<p>Using variables with Jinja2</p>
<p>一旦你定义了变量，便可以在Jinja2的模板系统中引用它：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">Ma amp goes to {{ max_amp_value }}
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="使用jinja2过滤器转换变量">使用Jinja2过滤器转换变量</h4>
<p>Transforming variables with Jinja2 filters</p>
<p>Jinja2 filters 让你在模板表达式内转换变量的值。如<code>capitalize</code>大写过滤器，<code>to_yaml</code>和<code>to_json</code>过滤器来转换成对应格式。</p>
<p>Jinja2包含了许多内置过滤器： <a href="https://jinja.palletsprojects.com/en/2.11.x/templates/#builtin-filters">https://jinja.palletsprojects.com/en/2.11.x/templates/#builtin-filters</a>
Ansible也支持许多过滤器： <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html#playbooks-filters">https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html#playbooks-filters</a></p>
<br>
<br>
<h4 id="yaml疑难杂症">YAML疑难杂症</h4>
<p>Hey wait, a YAML gotcha</p>
<p>YAML语法要求，如果你使用<code>{{ foo }}</code>值引用整行，它要确保你不是想开始一个YAML字典。所以记得使用双引号。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># wrong</span><span class="w">
</span><span class="w"></span><span class="nn">...</span><span class="w">
</span><span class="w"></span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">dir }}/22</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># right</span><span class="w">
</span><span class="w"></span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ dir }}/22&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="系统facts中的变量">系统facts中的变量</h4>
<p>Variables discovered from systems: Facts</p>
<p>facts是从远程系统获得的信息。你可以从<code>ansible_facts</code>变量中找到。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 查看facts</span>
ansible hostname -m setup
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">var</span><span class="p">:</span><span class="w"> </span><span class="l">ansible_facts</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">{{ ansible_facts[&#39;devices&#39;][&#39;xvda&#39;][&#39;model&#39;]}}
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>禁用facts</strong></p>
<p>如果你不需要fact数据，你可以禁用它。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span><span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="kc">no</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p><strong>Local facts(facts.d)</strong></p>
<p>facts通常都是由Ansible setup模块自动发现。用户也可以编写自定义的facts模块，请参考API指南。但是，如果你想要一个简单的方法来使用用户提供的数据，而不需要写一个facts模块。</p>
<p><code>facts.d</code>是一种可让用户控制它们的系统是如果管理的某些方面的机制。</p>
<p>如果远程管理系统有<code>/etc/ansible/facts.d</code>目录，该目录中的所有<code>.fact</code>文件（JSON, INI&hellip;）。可使用<code>fact_path</code> paly 关键字作为可选目录。</p>
<br>
<br>
<h4 id="注册变量">注册变量</h4>
<p>Registering variables</p>
<p>另一个主要使用的变量是正在运行一个命令和将此命令的返回的结果注册为一个变量，供其它地方使用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/bin/foo</span><span class="w">
</span><span class="w">      </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l">foo_result</span><span class="w">
</span><span class="w">      </span><span class="nt">ignore_errors</span><span class="p">:</span><span class="w"> </span><span class="kc">True</span><span class="w">
</span><span class="w">    </span>- <span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/bin/bar</span><span class="w">
</span><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">foo_result.rc == 5</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="访问复杂的变量数据">访问复杂的变量数据</h4>
<p>Accessing complex variable data</p>
<p>有些提供的facts，如网络信息，包含了复杂的嵌套结构。取值会稍微麻烦一些：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">{{ ansible_facts[&#39;eth0&#39;][&#39;ipv4&#39;][&#39;address&#39;]}}

# or
{{ ansible_facts.eth0.ipv4.address }}

# 访问数组的第一个元素
{{ foo[0] }}
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="使用magic变量访问其它主机的信息">使用magic变量访问其它主机的信息</h4>
<p>Accessing information about other hosts with magic variables</p>
<p>无论你是否定义变量，你也可以利用特殊的Ansible变量访问有关主机的信息，包括magic, facts, connection变量。magic变量名称被保留，所以不要使用这些名称来设置变量。<code>enviroment</code>变量也同样被保留。</p>
<p>最常使用的魔术变量有：<code>hostvars</code>, <code>groups</code>, <code>group_names</code>, <code>inventory_hostname</code>。</p>
<p><code>host_vars</code>允许你访问其它主机的变量，包括该主机的facts。你可以在playbook中的任意一点访问主机变量。即使你在playbook中并没有连接到此主机，你仍可以得到变量。
<code>groups</code>是清单中所有组的列表。这可以用于枚举组内的所有主机。
<code>group_names</code>是所有组中当前主机的列表或数组。
<code>inventory_hostname</code>是清单主机文件中配置的主机名。使用<code>inventory_hostname_short</code>获取更简短的信息。
<code>ansible_play_hosts</code>是当前play中仍然活跃的主机列表。
<code>ansible_play_batch</code>是当前批量paly上可用的主机名列表。
<code>ansible_playbook_python</code>是python执行调用ansible命令行工具的路径。
<code>role_path</code>返回当前角色的路径名。这仅在角色里工作。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">{{ hostvars[&#39;test.example.com&#39;][&#39;ansible_facts&#39;][&#39;distribution&#39;] }}

{% for host in groups[&#39;app_servers&#39;] %}
    {{ hostvars[host][&#39;ansible_facts&#39;][&#39;eth0&#39;][&#39;ipv4&#39;][&#39;address&#39;] }}
{% endfor %}

{% if &#39;webserver&#39; in group_names %}
    # xxx
{% endif %}
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="在文件中定义变量">在文件中定义变量</h4>
<p>Defining variables in files</p>
<p>让playbook使用版本控制是很好的想法，但你可能希望让playbook 源公开化，但同时又保证一定的重要的私有变量。</p>
<p>你可以通过一个外部变量文件来这么做：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span><span class="w">  </span><span class="l">...</span><span class="w">
</span><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="l">blue</span><span class="w">
</span><span class="w">  </span><span class="nt">vars_files</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">/vars/external_vars.yml</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># external_vars.yml</span><span class="w">
</span><span class="w"></span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l">xx</span><span class="w">
</span><span class="w"></span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">xxxx</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>这消除了分享playbook但避免分享数据的风险。</p>
<br>
<br>
<h4 id="在命令行上传递参数">在命令行上传递参数</h4>
<p>Passing variables on the command line</p>
<p>可在命令行上使用<code>--extra-vars</code>参数来设置变量：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># k:v格式</span>
ansible-playbook release.yml --extra-vars <span class="s2">&#34;version=1.23.45 other_variable=foo&#34;</span>

<span class="c1"># json格式</span>
ansible-playbook arcade.yml --extra-vars <span class="s1">&#39;{&#34;pacman&#34;:&#34;mrs&#34;,&#34;ghosts&#34;:[&#34;inky&#34;,&#34;pinky&#34;,&#34;clyde&#34;,&#34;sue&#34;]}&#39;</span>

<span class="c1"># 文件</span>
ansible-playbook release.yml --extra-vars <span class="s2">&#34;@some_file.json&#34;</span>
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="变量的优先级我应该把变量放在哪">变量的优先级：我应该把变量放在哪</h4>
<p>Variable precedence: Where should I put a variable?</p>
<p>同一名称的变量如果在多个地方被定义，则它们会以特定的顺序发生覆盖，所需需要知道Ansible变量的优先级，以及它们的放置位置。下面是从小到大的优先级：</p>
<ol>
<li>command line values</li>
<li>role defaults</li>
<li>inventory file or script group vars</li>
<li>inventory group_vars/all</li>
<li>playbook group_vars/all</li>
<li>inventory group_vars/*</li>
<li>playbook group_vars/*</li>
<li>inventory file or script host vars</li>
<li>inventory host_vars/*</li>
<li>playbook host_vars/*</li>
<li>host facts / cached set_facts</li>
<li>play vars</li>
<li>play vars_prompt</li>
<li>play vars_files</li>
<li>role vars (defined in role/vars/main.yml)</li>
<li>block vars (only for tasks in block)</li>
<li>task vars (only for the task)</li>
<li>include_vars</li>
<li>set_facts/registered vars</li>
<li>role (and include_role) params</li>
<li>include params</li>
<li>extra vars (always win precedence)</li>
</ol>
<br>
<br>
<h3 id="jinja2模板">Jinja2模板</h3>
<p>Templating (Jinja2): <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_templating.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_templating.html</a></p>
<p>Ansible使用Jinja2模板化来实现动态表达式和访问变量。Ansilbe大大扩展的filters和tests数量，以及新增了一个插件类型：lookups。</p>
<p>请注意，所有模板发生在Ansible控制器上，在任务发送和执行在目标主机之前。</p>
<br>
<h4 id="filters">Filters</h4>
<p>Filters: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html</a></p>
<br>
<br>
<h4 id="tests">Tests</h4>
<p>Tests: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_tests.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_tests.html</a></p>
<p>Jinja中的测试是评估模板表达式并返回True或False。许多内置测试: <a href="https://jinja.palletsprojects.com/en/2.11.x/templates/#builtin-tests">https://jinja.palletsprojects.com/en/2.11.x/templates/#builtin-tests</a></p>
<p>测试器和过滤器的主要区别是测试用于比较，而过滤去用于数据操作。测试同样可以在列表处理器中使用，如<code>map()</code>和<code>select()</code>在列表中选择项。</p>
<p>与所有模板一样，测试始终在Ansible控制器上执行，而不是任务的目标主机。除了这些Jinja2的测试，Ansible支持用户轻松创建自己的测试。</p>
<br>
<br>
<h4 id="lookups">Lookups</h4>
<p>Lookups: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_lookups.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_lookups.html</a></p>
<p>查找插件允许访问外部数据源。与所有模板一样，这些插件在Ansible控制器上进行评估，并且可以包括读取文件系统、对外联络网络数据存储和服务。这些数据使用Ansible标准模板系统提供。</p>
<br>
<blockquote>
<p><strong>注意</strong>
查找发生在本地主机，而不是远程主机；
它们在包含role或play的目录内执行，而不是与执行脚本的目录执行本地任务；
可以传递<code>wantlist=True</code>给lookups来使用Jinja2中的for循环；
查找是一个高级的功能，你应该对Ansible有足够的了解。</p>
</blockquote>
<br>
<br>
<h4 id="python版本和模板">Python版本和模板</h4>
<p>Python Version and Templating: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_python_version.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_python_version.html</a></p>
<p>Jinja2模板利用Python数据类型和标准函数。这使得可对数据进行丰富的操作。然而，这也意味着潜在的Python的某些细节对模板编写者可见。由于Ansible playbook使用Jinja2用于模板与变量，这意味着playbook作者需要了解这些细节。</p>
<p>除了这些，请注意在Python2和Python3上运行Ansible的不同。</p>
<br>
<br>
<h3 id="条件语句">条件语句</h3>
<p>Conditionals: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_conditionals.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_conditionals.html</a></p>
<p>经常的一个play的结果可能依赖于一个变量的值，或之前的任务的结果。在某些情况下，变量的值可能依赖于其它变量。本主题介绍如何在playbook中使用条件语句。</p>
<br>
<h4 id="when语句">When语句</h4>
<p>The When Statement</p>
<p>有时你会想在某个特定主机上跳过特定的步骤。</p>
<p>在Ansible中使用<code>when</code>子句很容易达到，它不包含Jinja2中的双花括号表达式。它非常简单：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;shut down CentOS 6 systems&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">/sbin/shutdown -t now</span><span class="w">
</span><span class="w">    </span><span class="nt">when</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">ansible_facts[&#39;distribution&#39;] == &#34;CentOS&#34;</span><span class="w">
</span><span class="w">      </span>- <span class="l">ansible_facts[&#39;distribution_major_version&#39;] == &#34;6&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>许多Jinja2的测试器和过滤器都可在<code>when</code>子句中使用，其中某些是由Ansible单独提供的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/false</span><span class="w">
</span><span class="w">    </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l">result</span><span class="w">
</span><span class="w">    </span><span class="nt">ignore_errors</span><span class="p">:</span><span class="w"> </span><span class="kc">True</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/something</span><span class="w">
</span><span class="w">    </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">result is failed</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># In older versions of ansible use ``success``, now both are valid but succeeded uses the correct tense.</span><span class="w">
</span><span class="w">  </span>- <span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/something_else</span><span class="w">
</span><span class="w">    </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">result is succeeded</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/still/something_else</span><span class="w">
</span><span class="w">    </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">result is skipped</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">echo &#34;This certainly is epic!&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">epic or monumental|bool</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">echo &#34;I&#39;ve got &#39;{{ foo }}&#39; and am not afraid to use it!&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">foo is defined</span><span class="w">
</span><span class="w">
</span><span class="w">    </span>- <span class="nt">fail</span><span class="p">:</span><span class="w"> </span><span class="l">msg=&#34;Bailing out. this play requires &#39;bar&#39;&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">bar is undefined</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="循环和条件">循环和条件</h4>
<p>Loops and Conditionals</p>
<p><code>when</code>和<code>loops</code>结合使用，请注意when语句是根据每个项分别处理。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">echo {{ item }}</span><span class="w">
</span><span class="w">      </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">6</span><span class="p">,</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">item &gt; 5</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="在自定义facts中载入">在自定义facts中载入</h4>
<p>Loading in Custom Facts</p>
<p>如果你想提供自己的facts也很简单。要运行它们，只需要在任务顶部调用你自己定义的模块，这里返回的变量将能访问未来的任务：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gather site specific fact data</span><span class="w">
</span><span class="w">      </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">site_facts</span><span class="w">
</span><span class="w">    </span>- <span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/bin/thingy</span><span class="w">
</span><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">my_custom_fact_just_retrieved_from_the_remote_system == &#39;1234&#39;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="applying-when-to-rolesimportsand-includes">Applying when to roles,imports,and includes</h4>
<p>在roles, imports, includes中使用when语句：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">webservers</span><span class="w">
</span><span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w">
</span><span class="w">     </span>- <span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l">debian_stock_config</span><span class="w">
</span><span class="w">       </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">ansible_facts[&#39;os_family&#39;] == &#39;Debian&#39;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="有条件的导入">有条件的导入</h4>
<p>Conditional Imports</p>
<p>一个剧本适用于多个平台和操作系统是很好的栗子。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span><span class="w">  </span><span class="nt">remote_user</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">  </span><span class="nt">vars_files</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;vars/common.yml&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="p">[</span><span class="w"> </span><span class="s2">&#34;vars/{{ ansible_facts[&#39;os_family&#39;] }}.yml&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;vars/os_defaults.yml&#34;</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">make sure apache is started</span><span class="w">
</span><span class="w">    </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l">name={{ apache }} state=started</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="基于变量来选择文件和模板">基于变量来选择文件和模板</h4>
<p>Selecting Files And Templates Based On Variables</p>
<p>基于不同的系统来生成不同的配置文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">template a file</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/myapp/foo.conf</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ query(&#39;first_found&#39;, { &#39;files&#39;: myfiles, &#39;paths&#39;: mypaths}) }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">myfiles</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;{{ansible_facts[&#39;distribution&#39;]}}.conf&#34;</span><span class="w">
</span><span class="w">      </span>- <span class="w"> </span><span class="l">default.conf</span><span class="w">
</span><span class="w">    </span><span class="nt">mypaths</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;search_location_one/somedir/&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/opt/other_location/somedir/&#39;</span><span class="p">]</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="注册变量-1">注册变量</h4>
<p>Register Variables</p>
<p>存储一个给定命令的结果，以便后面来访问它，在playbook中可能很有用。</p>
<blockquote>
<p>注意：
即使当一个任务由于条件语句跳过，注册也会发生。</p>
</blockquote>
<p><code>register</code>关键字决定将结果保存哪个变量。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">check registered variable for emptiness</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">list contents of directory</span><span class="w">
</span><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">ls mydir</span><span class="w">
</span><span class="w">        </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l">contents</span><span class="w">
</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">check contents for emptiness</span><span class="w">
</span><span class="w">        </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Directory is empty&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">contents.stdout == &#34;&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="常用facts">常用facts</h4>
<p>Commonly Used Facts</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">ansible_facts[‘distribution’]

ansible_facts[‘distribution_major_version’]

ansible_facts[‘os_family’]
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="循环">循环</h3>
<p>Loops: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html</a></p>
<p>常见的Ansible循环包括改变多个文件/目录的权限、创建多个用户、重复轮询&hellip;Ansible提供了两个关键字来创建循环：</p>
<ul>
<li><code>loop</code></li>
<li><code>with_&lt;lookup&gt;</code></li>
</ul>
<br>
<blockquote>
<p>注意：
We added loop in Ansible 2.5. It is not yet a full replacement for <code>with_&lt;lookup&gt;</code>, but we recommend it for most use cases.
We have not deprecated the use of <code>with_&lt;lookup&gt;</code>
We are looking to improve loop syntax</p>
</blockquote>
<br>
<h4 id="两者比较-1">两者比较</h4>
<p>Comparing <code>loop</code> and <code>with_*</code></p>
<ul>
<li><code>with_&lt;lookup&gt;</code>关键字依赖于Lookup插件，即便<code>items</code>也是查找；</li>
<li><code>loop</code>关键字等于<code>with_list</code>，它是简单循环的最佳选择；</li>
<li><code>loop</code>关键字不接受字符串作为输入；</li>
<li>一般来说，任何在Migrating from with_X to loop中使用<code>with_*</code>可以更新为使用<code>loop</code>；</li>
<li>当更改<code>with_items</code>为<code>loop</code>时请小心，<code>with_items</code>执行单级的。你需要在<code>loop</code>中使用<code>flatten(1)</code>。栗子如下：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">with_items</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="m">1</span><span class="w">
</span><span class="w">  </span>- <span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">]</span><span class="w">
</span><span class="w">  </span>- <span class="m">4</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># you would need</span><span class="w">
</span><span class="w"></span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ [1, [2,3] ,4] | flatten(1) }}&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="标准循环">标准循环</h4>
<p>Standard loops</p>
<br>
<h5 id="遍历一个简单列表">遍历一个简单列表</h5>
<p>Iterating over a simple list</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">add several users</span><span class="w">
</span><span class="w">  </span><span class="nt">user</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;wheel&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w">
</span><span class="w">     </span>- <span class="l">testuser1</span><span class="w">
</span><span class="w">     </span>- <span class="l">testuser2</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<h5 id="遍历一个散列列表">遍历一个散列列表</h5>
<p>Iterating over a list of hashes</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">add several users</span><span class="w">
</span><span class="w">  </span><span class="nt">user</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.name }}&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.groups }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- {<span class="w"> </span><span class="nt">name: &#39;testuser1&#39;, groups</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;wheel&#39;</span><span class="w"> </span>}<span class="w">
</span><span class="w">    </span>- {<span class="w"> </span><span class="nt">name: &#39;testuser2&#39;, groups</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;root&#39;</span><span class="w"> </span>}<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<h5 id="遍历一个字典">遍历一个字典</h5>
<p>Iterating over a dictionary</p>
<p>使用<code>dict2items</code>字典过滤器来遍历字典：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">create a tag dictionary of non-empty tags</span><span class="w">
</span><span class="w">  </span><span class="nt">set_fact</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">tags_dict</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ (tags_dict|default({}))|combine({item.key: item.value}) }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ tags|dict2items }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">tags</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">Environment</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span><span class="w">      </span><span class="nt">Application</span><span class="p">:</span><span class="w"> </span><span class="l">payment</span><span class="w">
</span><span class="w">      </span><span class="nt">Another</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ doesnotexist|default() }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">item.value != &#34;&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="循环与注册变量">循环与注册变量</h4>
<p>Registering variables with a loop</p>
<p>你可以将循环的输出注册为变量：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;echo {{ item }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;one&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;two&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l">echo</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="复杂循环">复杂循环</h4>
<p>Complex loops</p>
<br>
<h5 id="遍历嵌套的列表">遍历嵌套的列表</h5>
<p>Iterating over nested lists</p>
<p>你可以使用Jinja2的表达式来遍历复杂的列表：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">give users access to multiple databases</span><span class="w">
</span><span class="w">  </span><span class="nt">mysql_user</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item[0] }}&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">priv</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item[1] }}.*:ALL&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">append_privs</span><span class="p">:</span><span class="w"> </span><span class="kc">yes</span><span class="w">
</span><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;foo&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ [&#39;alice&#39;, &#39;bob&#39;] |product([&#39;clientdb&#39;, &#39;employeedb&#39;, &#39;providerdb&#39;])|list }}&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<h5 id="重试任务直到满足条件">重试任务直到满足条件</h5>
<p>Retrying a task until a condition is met</p>
<p>可以使用<code>until</code>关键字来重试任务直到满足特定条件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/bin/foo</span><span class="w">
</span><span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l">result</span><span class="w">
</span><span class="w">  </span><span class="nt">until</span><span class="p">:</span><span class="w"> </span><span class="l">result.stdout.find(&#34;all systems go&#34;) != -1</span><span class="w">
</span><span class="w">  </span><span class="nt">retries</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">  </span><span class="nt">delay</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<h5 id="循环清单">循环清单</h5>
<p>Looping over inventory</p>
<p>遍历资产清单：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># show all the hosts in the inventory</span><span class="w">
</span><span class="w"></span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ groups[&#39;all&#39;] }}&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># show all the hosts in the current play</span><span class="w">
</span><span class="w"></span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ ansible_play_batch }}&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># show all the hosts in the inventory</span><span class="w">
</span><span class="w"></span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ query(&#39;inventory_hostnames&#39;, &#39;all&#39;) }}&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># show all the hosts matching the pattern, ie all but the group www</span><span class="w">
</span><span class="w"></span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ query(&#39;inventory_hostnames&#39;, &#39;all:!www&#39;) }}&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="query与lookup">query与lookup</h4>
<p><code>loop</code>关键字需要一个列表作为输入，但是<code>lookup</code>关键字默认返回逗号分隔的值的字符串。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># same thing</span><span class="w">
</span><span class="w"></span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ query(&#39;inventory_hostnames&#39;, &#39;all&#39;) }}&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ lookup(&#39;inventory_hostnames&#39;, &#39;all&#39;, wantlist=True) }}&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="循环控制">循环控制</h4>
<p>Adding controls to loops</p>
<p><code>loop_control</code>关键字让你可以以有效的方式管理自己的循环。</p>
<br>
<h5 id="限制循环输出">限制循环输出</h5>
<p>Limiting loop output with label</p>
<p>当遍历复杂的数据结构，你的任务的控制台输出可能是巨大的。为了限制显示的输出，在<code>loop_control</code>中使用<code>label</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># 此任务输出仅显示每项的name字段</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">create servers</span><span class="w">
</span><span class="w">  </span><span class="nt">digital_ocean</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.name }}&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">server1</span><span class="w">
</span><span class="w">      </span><span class="nt">disks</span><span class="p">:</span><span class="w"> </span><span class="l">3gb</span><span class="w">
</span><span class="w">      </span><span class="nt">ram</span><span class="p">:</span><span class="w"> </span><span class="l">15Gb</span><span class="w">
</span><span class="w">      </span><span class="nt">network</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">nic01</span><span class="p">:</span><span class="w"> </span><span class="l">100Gb</span><span class="w">
</span><span class="w">        </span><span class="nt">nic02</span><span class="p">:</span><span class="w"> </span><span class="l">10Gb</span><span class="w">
</span><span class="w">        </span><span class="l">...</span><span class="w">
</span><span class="w">  </span><span class="nt">loop_control</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.name }}&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<h5 id="暂停循环">暂停循环</h5>
<p>Pausing within a loop</p>
<p>要控制每个项的执行之间的时间(seconds)，在<code>loop_control</code>中使用<code>pause</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># main.yml</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">create servers, pause 3s before creating next</span><span class="w">
</span><span class="w">  </span><span class="nt">digital_ocean</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">server1</span><span class="w">
</span><span class="w">    </span>- <span class="l">server2</span><span class="w">
</span><span class="w">  </span><span class="nt">loop_control</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">pause</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<h5 id="追踪流程">追踪流程</h5>
<p>Tracking progress through a loop with <code>index_var</code></p>
<p>要追踪你在循环的位置，在<code>loop_control</code>中使用<code>index_var</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">count our fruit</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }} with index {{ my_idx }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">apple</span><span class="w">
</span><span class="w">    </span>- <span class="l">banana</span><span class="w">
</span><span class="w">    </span>- <span class="l">pear</span><span class="w">
</span><span class="w">  </span><span class="nt">loop_control</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">index_var</span><span class="p">:</span><span class="w"> </span><span class="l">my_idx</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<h5 id="inner-and-outer-variable-names">inner and outer variable names</h5>
<p>Defining inner and outer variable names with <code>loop_var</code></p>
<p>可使用<code>include_tasks</code>嵌套两个循环任务。然而，默认情况下Ansible为每个循环<code>item</code>设置循环变量。This means the inner, nested loop will overwrite the value of item from the outer loop.你可以在<code>loop_control</code>中使用<code>loop_var</code>来为每个循环指定变量名。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">include_tasks</span><span class="p">:</span><span class="w"> </span><span class="l">inner.yml</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="m">1</span><span class="w">
</span><span class="w">    </span>- <span class="m">2</span><span class="w">
</span><span class="w">    </span>- <span class="m">3</span><span class="w">
</span><span class="w">  </span><span class="nt">loop_control</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">loop_var</span><span class="p">:</span><span class="w"> </span><span class="l">outer_item</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># inner.yml</span><span class="w">
</span><span class="w"></span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;outer item={{ outer_item }} inner item={{ item }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">a</span><span class="w">
</span><span class="w">    </span>- <span class="l">b</span><span class="w">
</span><span class="w">    </span>- <span class="l">c</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<h5 id="扩展的循环变量">扩展的循环变量</h5>
<p>Extended loop variables</p>
<p>在循环控制中使用<code>extended</code>选项来获取扩展的循环信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">loop_control</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">extended</span><span class="p">:</span><span class="w"> </span><span class="kc">yes</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">Variable	Description
ansible_loop.allitems	The list of all items in the loop
ansible_loop.index	The current iteration of the loop. (1 indexed)
ansible_loop.index0	The current iteration of the loop. (0 indexed)
ansible_loop.revindex	The number of iterations from the end of the loop (1 indexed)
ansible_loop.revindex0	The number of iterations from the end of the loop (0 indexed)
ansible_loop.first	True if first iteration
ansible_loop.last	True if last iteration
ansible_loop.length	The number of items in the loop
ansible_loop.previtem	The item from the previous iteration of the loop. Undefined during the first iteration.
ansible_loop.nextitem	The item from the following iteration of the loop. Undefined during the last iteration.
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="从with_x迁移到loop">从with_x迁移到loop</h4>
<p>Migrating from with_X to loop</p>
<p>从Ansible 2.5开始，执行循环的推荐的方式是使用新的<code>loop</code>关键字来取代<code>with_x</code>格式的循环。</p>
<p>在许多情况下，<code>loop</code>语法是使用过滤器的更好的表达，而不是更复杂的<code>query</code>或<code>lookup</code>。</p>
<br>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># with_list被loop替代</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with_list</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">with_list</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">one</span><span class="w">
</span><span class="w">    </span>- <span class="l">two</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with_list -&gt; loop</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">one</span><span class="w">
</span><span class="w">    </span>- <span class="l">two</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># with_items被loop和flatten过滤器替代</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with_items</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">with_items</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ items }}&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with_items -&gt; loop</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ items|flatten(levels=1) }}&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># with_indexed_items被loop, flatten, loop_control.index_var替代</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with_indexed_items</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.0 }} - {{ item.1 }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">with_indexed_items</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ items }}&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with_indexed_items -&gt; loop</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ index }} - {{ item }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ items|flatten(levels=1) }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">loop_control</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">index_var</span><span class="p">:</span><span class="w"> </span><span class="l">index</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># with_flattened被loop和flatten替代</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with_flattened</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">with_flattened</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ items }}&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with_flattened -&gt; loop</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ items|flatten }}&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># with_together被loop和zip替代</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with_together</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.0 }} - {{ item.1 }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">with_together</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;{{ list_one }}&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;{{ list_two }}&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with_together -&gt; loop</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.0 }} - {{ item.1 }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ list_one|zip(list_two)|list }}&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># with_dict可通过loop和 dictsort或dict2items替代</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with_dict</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.key }} - {{ item.value }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">with_dict</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ dictionary }}&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with_dict -&gt; loop (option 1)</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.key }} - {{ item.value }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ dictionary|dict2items }}&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with_dict -&gt; loop (option 2)</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.0 }} - {{ item.1 }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ dictionary|dictsort }}&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># with_sequence被loop, range, format替代</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with_sequence</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">with_sequence</span><span class="p">:</span><span class="w"> </span><span class="l">start=0 end=4 stride=2 format=testuser%02x</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with_sequence -&gt; loop</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ &#39;testuser%02x&#39; | format(item) }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="c"># range is exclusive of the end point</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ range(0, 4 + 1, 2)|list }}&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># with_subelements被loop, subelements替代</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with_subelements</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.0.name }} - {{ item.1 }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">with_subelements</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;{{ users }}&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="l">mysql.hosts</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with_subelements -&gt; loop</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.0.name }} - {{ item.1 }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ users|subelements(&#39;mysql.hosts&#39;) }}&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># with_nested/with_cartesian被loop, product替代</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with_nested</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.0 }} - {{ item.1 }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">with_nested</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;{{ list_one }}&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;{{ list_two }}&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with_nested -&gt; loop</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item.0 }} - {{ item.1 }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ list_one|product(list_two)|list }}&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># with_random_choice被random替代</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with_random_choice</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ item }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">with_random_choice</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ my_list }}&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">with_random_choice -&gt; loop (No loop is needed here)</span><span class="w">
</span><span class="w">  </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ my_list|random }}&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="l">random</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="block">Block</h3>
<p>Blocks: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_blocks.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_blocks.html</a></p>
<p>块允许任务的逻辑分组，并在play中错误处理。大多数可以适用于单任务的也可适用于块(block)，这使得它很容易设置数据或常见指令到任务。这并不意味着该指令影响块自身，而是有一个块包围的任务继承。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">   </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Install, configure, and start Apache</span><span class="w">
</span><span class="w">     </span><span class="nt">block</span><span class="p">:</span><span class="w">
</span><span class="w">       </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">install httpd and memcached</span><span class="w">
</span><span class="w">         </span><span class="nt">yum</span><span class="p">:</span><span class="w">
</span><span class="w">           </span><span class="nt">name</span><span class="p">:</span><span class="w">
</span><span class="w">           </span>- <span class="l">httpd</span><span class="w">
</span><span class="w">           </span>- <span class="l">memcached</span><span class="w">
</span><span class="w">           </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span><span class="w">
</span><span class="w">       </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apply the foo config template</span><span class="w">
</span><span class="w">         </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">           </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l">templates/src.j2</span><span class="w">
</span><span class="w">           </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/foo.conf</span><span class="w">
</span><span class="w">       </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">start service bar and enable it</span><span class="w">
</span><span class="w">         </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">           </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">bar</span><span class="w">
</span><span class="w">           </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">started</span><span class="w">
</span><span class="w">           </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">True</span><span class="w">
</span><span class="w">     </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l">ansible_facts[&#39;distribution&#39;] == &#39;CentOS&#39;</span><span class="w">
</span><span class="w">     </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">     </span><span class="nt">become_user</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">     </span><span class="nt">ignore_errors</span><span class="p">:</span><span class="w"> </span><span class="kc">yes</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>在上面的栗子中，块中3个任务中的每一个附加在when条件后，在任务上下文评估之后都将执行。</p>
<p>块中的任务名在Ansible 2.3时可用。建议在所有任务中使用名称，无论是块还是其它地方。</p>
<br>
<h4 id="块错误处理">块错误处理</h4>
<p>Blocks error handling</p>
<p>块同样介绍了类似于大多数编程语言的异常处理的错误处理的方法。块仅处理任务的失败(failed)状态。一个糟糕的任务定义或主机不可达不是rescuable错误。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># block error handling example</span><span class="w">
</span><span class="w"></span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w"> </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Handle the error</span><span class="w">
</span><span class="w">   </span><span class="nt">block</span><span class="p">:</span><span class="w">
</span><span class="w">     </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">         </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;I execute normally&#39;</span><span class="w">
</span><span class="w">     </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">i force a failure</span><span class="w">
</span><span class="w">       </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/false</span><span class="w">
</span><span class="w">     </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">         </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;I never execute, due to the above task failing, :-(&#39;</span><span class="w">
</span><span class="w">   </span><span class="nt">rescue</span><span class="p">:</span><span class="w">
</span><span class="w">     </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">         </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;I caught an error, can do stuff here to fix it, :-)&#39;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p><code>always</code>部分，无论什么任务状态都将会运行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w"> </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Always do X</span><span class="w">
</span><span class="w">   </span><span class="nt">block</span><span class="p">:</span><span class="w">
</span><span class="w">     </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">         </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;I execute normally&#39;</span><span class="w">
</span><span class="w">     </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">i force a failure</span><span class="w">
</span><span class="w">       </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/false</span><span class="w">
</span><span class="w">     </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">         </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;I never execute :-(&#39;</span><span class="w">
</span><span class="w">   </span><span class="nt">always</span><span class="p">:</span><span class="w">
</span><span class="w">     </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">         </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;This always executes, :-)&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="高级的playbook功能">高级的playbook功能</h3>
<p>Advanced Playbooks Features: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_special_topics.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_special_topics.html</a></p>
<p>下面有许多playbook功能不需要每个人都去学习，但可以为特定应用提供有用的功能。浏览这些话题，因为你可能找有一些有用的技巧。</p>
<br>
<h4 id="特权晋升">特权晋升</h4>
<br>
<br>
<h4 id="异步操作和轮询">异步操作和轮询</h4>
<p>Asynchronous Actions and Polling: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_async.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_async.html</a></p>
<p>默认情况下，playbook块中的任务，直到任务在每个节点上完成后连接才会断开。这可能不总是可取的，或者你需要运行超过ssh timeout的操作。</p>
<br>
<p><strong>限时后台操作(Time-limited background operations)</strong></p>
<p>你可以在后台运行长时间运行的操作，之后再检查它们的状态。例如，异步地在后台执行<code>long_running_operation</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># -B 超时时间， -p 轮询数</span>
ansible all -B <span class="m">3600</span> -P <span class="m">0</span> -a <span class="s2">&#34;/usr/bin/long_running_operation --do-stuff&#34;</span>


<span class="c1"># async_status模块 检查状态</span>
ansible web1.example.com -m async_status -a <span class="s2">&#34;jid=488359678239.2844&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>轮询模式是智能的，所以在轮询将在任意机器上开始之前所有的工作都将启动。如果想要所有工作快速开始，请确保使用足够高的<code>--forks</code>。在超时之后，远程节点上的进程将会被终止。</p>
<p>通常，你只需在后台长时间运行shell命令或软件更新。后台复制模块不会进行文件传输。</p>
<p>为了避免阻塞或超时问题，你可以使用异步模式来一次运行你的所有任务，并轮询直到它们完成。</p>
<p>异步模式的行为依赖于poll值。</p>
<br>
<p><strong>Avoid connection timeouts: poll &gt; 0</strong></p>
<p>当poll是正值，playbook仍然会阻塞任务直到它完成、失败或超时。</p>
<p>要异步启动任务，请指定其最大运行实践和要轮询状态的频率。如果未指定poll，则默认由<code>DEFAULT_POLL_INTERVAL</code>设置。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span><span class="w">  </span><span class="nt">remote_user</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simulate long running op (15 sec), wait for up to 45 sec, poll every 5 sec</span><span class="w">
</span><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/sleep 15</span><span class="w">
</span><span class="w">    </span><span class="nt">async</span><span class="p">:</span><span class="w"> </span><span class="m">45</span><span class="w">
</span><span class="w">    </span><span class="nt">poll</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p><strong>Concurrent tasks: poll=0</strong></p>
<p>当poll为0时，Ansible将启动任务，并立即移动到下一个而不必等待结果。</p>
<p>从序列试图这点是异步编程：任务现在可以同时运行。playbook将结束而不检查异步返回。异步任务将执行根据async的值，直到它们完成、失败或超时。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span><span class="w">  </span><span class="nt">remote_user</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">simulate long running op, allow to run for 45 sec, fire and forget</span><span class="w">
</span><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/sleep 15</span><span class="w">
</span><span class="w">    </span><span class="nt">async</span><span class="p">:</span><span class="w"> </span><span class="m">45</span><span class="w">
</span><span class="w">    </span><span class="nt">poll</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="检查模式">检查模式</h4>
<p>Check Mode: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_checkmode.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_checkmode.html</a></p>
<br>
<br>
<h4 id="debugger">Debugger</h4>
<p>Playbook Debugger</p>
<p>Ansible包含了debugger作为策略插件的一部分。此调试器允许你调试任务。你可以在任务的上下文中访问所有的调试器的功能，以帮助解决失败的问题。</p>
<p>有多种方式来调用调试器。</p>
<br>
<p><strong>使用debugger关键字(Using the debugger keyword)</strong></p>
<p>可在提供<code>name</code>属性的块中使用<code>debugger</code>关键字，如paly, role, block, task。<code>debugger</code>关键字接受下列值：</p>
<ul>
<li>always: 总是调用调试器</li>
<li>never: 绝不调用调试器</li>
<li>on_failed: 任务失败才调用调试器</li>
<li>on_skipped: 任务跳过才调用调试器</li>
</ul>
<br>
<p>全局配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># on a task</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">execute a command</span><span class="w">
</span><span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">  </span><span class="nt">debugger</span><span class="p">:</span><span class="w"> </span><span class="l">on_failed</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># on a play</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">play</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span><span class="w">  </span><span class="nt">debugger</span><span class="p">:</span><span class="w"> </span><span class="l">on_skipped</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Execute a command</span><span class="w">
</span><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="kc">False</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>在特定层级上：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Play</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span><span class="w">  </span><span class="nt">debugger</span><span class="p">:</span><span class="w"> </span><span class="l">never</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Execute a command</span><span class="w">
</span><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">      </span><span class="nt">debugger</span><span class="p">:</span><span class="w"> </span><span class="l">on_failed</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p><strong>配置或环境变量(Configuration or environment variable)</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># ansible.cfg
[defaults]
enable_task_debugger = True
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># environment variable
ANSIBLE_ENABLE_TASK_DEBUGGER=True ansible-playbook -i hosts site.yml
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>策略(As a Strategy)</strong></p>
<p>要使用debug策略，改变strategy属性：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w"> </span><span class="l">debug</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="l">...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># ansible.cfg
[defaults]
strategy = debug
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># environment variable
ANSIBLE_STRATEGY=debug
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>可用命令(Available Commands)</strong></p>
<p>打印值：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="p">[</span><span class="mf">192.0.2.10</span><span class="p">]</span> <span class="nx">TASK</span><span class="p">:</span> <span class="nx">install</span> <span class="kn">package</span> <span class="p">(</span><span class="nx">debug</span><span class="p">)&gt;</span> <span class="nx">p</span> <span class="nx">task</span>
<span class="nx">TASK</span><span class="p">:</span> <span class="nx">install</span> <span class="kn">package</span>
<span class="p">[</span><span class="mf">192.0.2.10</span><span class="p">]</span> <span class="nx">TASK</span><span class="p">:</span> <span class="nx">install</span> <span class="kn">package</span> <span class="p">(</span><span class="nx">debug</span><span class="p">)&gt;</span> <span class="nx">p</span> <span class="nx">task</span><span class="p">.</span><span class="nx">args</span>
<span class="p">{</span><span class="nx">u</span><span class="err">&#39;</span><span class="nx">name</span><span class="err">&#39;</span><span class="p">:</span> <span class="nx">u</span><span class="err">&#39;</span><span class="p">{{</span> <span class="nx">pkg_name</span> <span class="p">}}</span><span class="err">&#39;</span><span class="p">}</span>
<span class="p">[</span><span class="mf">192.0.2.10</span><span class="p">]</span> <span class="nx">TASK</span><span class="p">:</span> <span class="nx">install</span> <span class="kn">package</span> <span class="p">(</span><span class="nx">debug</span><span class="p">)&gt;</span> <span class="nx">p</span> <span class="nx">task_vars</span>
<span class="p">{</span><span class="nx">u</span><span class="err">&#39;</span><span class="nx">ansible_all_ipv4_addresses</span><span class="err">&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nx">u</span><span class="err">&#39;</span><span class="mf">192.0.2.10</span><span class="err">&#39;</span><span class="p">],</span>
 <span class="nx">u</span><span class="err">&#39;</span><span class="nx">ansible_architecture</span><span class="err">&#39;</span><span class="p">:</span> <span class="nx">u</span><span class="err">&#39;</span><span class="nx">x86_64</span><span class="err">&#39;</span><span class="p">,</span>
 <span class="o">...</span>
<span class="p">}</span>
<span class="p">[</span><span class="mf">192.0.2.10</span><span class="p">]</span> <span class="nx">TASK</span><span class="p">:</span> <span class="nx">install</span> <span class="kn">package</span> <span class="p">(</span><span class="nx">debug</span><span class="p">)&gt;</span> <span class="nx">p</span> <span class="nx">task_vars</span><span class="p">[</span><span class="err">&#39;</span><span class="nx">pkg_name</span><span class="err">&#39;</span><span class="p">]</span>
<span class="nx">u</span><span class="err">&#39;</span><span class="nx">bash</span><span class="err">&#39;</span>
<span class="p">[</span><span class="mf">192.0.2.10</span><span class="p">]</span> <span class="nx">TASK</span><span class="p">:</span> <span class="nx">install</span> <span class="kn">package</span> <span class="p">(</span><span class="nx">debug</span><span class="p">)&gt;</span> <span class="nx">p</span> <span class="nx">host</span>
<span class="mf">192.0.2.10</span>
<span class="p">[</span><span class="mf">192.0.2.10</span><span class="p">]</span> <span class="nx">TASK</span><span class="p">:</span> <span class="nx">install</span> <span class="kn">package</span> <span class="p">(</span><span class="nx">debug</span><span class="p">)&gt;</span> <span class="nx">p</span> <span class="nx">result</span><span class="p">.</span><span class="nx">_result</span>
<span class="p">{</span><span class="err">&#39;</span><span class="nx">_ansible_no_log</span><span class="err">&#39;</span><span class="p">:</span> <span class="nx">False</span><span class="p">,</span>
 <span class="err">&#39;</span><span class="nx">changed</span><span class="err">&#39;</span><span class="p">:</span> <span class="nx">False</span><span class="p">,</span>
 <span class="nx">u</span><span class="err">&#39;</span><span class="nx">failed</span><span class="err">&#39;</span><span class="p">:</span> <span class="nx">True</span><span class="p">,</span>
 <span class="o">...</span>
 <span class="nx">u</span><span class="err">&#39;</span><span class="nx">msg</span><span class="err">&#39;</span><span class="p">:</span> <span class="nx">u</span><span class="s">&#34;No package matching &#39;not_exist&#39; is available&#34;</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="滚动升级">滚动升级</h4>
<p>Delegation, Rolling Updates, and Local Actions: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_delegation.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_delegation.html</a></p>
<br>
<br>
<h4 id="设置环境">设置环境</h4>
<p>Setting the Environment: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_environment.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_environment.html</a></p>
<p><code>environment</code>关键字可以允许你为远程目标主机设置环境变量。例如，需要为http请求设置一个代理。获取其它工具需要的环境变量。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span><span class="w">  </span><span class="nt">remote_user</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Install cobbler</span><span class="w">
</span><span class="w">      </span><span class="nt">package</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cobbler</span><span class="w">
</span><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span><span class="w">      </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">http_proxy</span><span class="p">:</span><span class="w"> </span><span class="l">http://proxy.example.com:8080</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>也可以存储在一个变量里：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span><span class="w">  </span><span class="nt">remote_user</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">  </span><span class="c"># here we make a variable named &#34;proxy_env&#34; that is a dictionary</span><span class="w">
</span><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">proxy_env</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">http_proxy</span><span class="p">:</span><span class="w"> </span><span class="l">http://proxy.example.com:8080</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Install cobbler</span><span class="w">
</span><span class="w">      </span><span class="nt">package</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cobbler</span><span class="w">
</span><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span><span class="w">      </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ proxy_env }}&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="特定语言版本管理器">特定语言版本管理器</h4>
<p>Working With Language-Specific Version Managers</p>
<p>一些特定语言版本管理器(如nvm)要求，而这些工具在使用中都要求环境变量。挡手动使用这些工具，通常需要在配置文件中添加一些环境变量，在Ansible中，你可使用enviroment代替：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">---
### A playbook demonstrating a common npm workflow:
# - Check for package.json in the application directory
# - If package.json exists:
#   * Run npm prune
#   * Run npm install

- hosts: application
  become: false

  vars:
    node_app_dir: /var/local/my_node_app

  environment:
    NVM_DIR: /var/local/nvm
    PATH: /var/local/nvm/versions/node/v4.2.1/bin:{{ ansible_env.PATH }}

  tasks:
  - name: check for package.json
    stat:
      path: &#39;{{ node_app_dir }}/package.json&#39;
    register: packagejson

  - name: npm prune
    command: npm prune
    args:
      chdir: &#39;{{ node_app_dir }}&#39;
    when: packagejson.stat.exists

  - name: npm install
    npm:
      path: &#39;{{ node_app_dir }}&#39;
    when: packagejson.stat.exists
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="错误处理">错误处理</h4>
<p>Error Handling In Playbooks: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_error_handling.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_error_handling.html</a></p>
<p>Ansible通常有默认值来确保检查命令和模块的返回码和是否失败，进行错误处理，除非你做了决定。</p>
<br>
<p><strong>忽略错误命令(Ignoring Failed Commands)</strong></p>
<p>一般来说，如果主机上有任务失败，playbook将停止执行。有时，你想让它继续进行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">this will not be counted as a failure</span><span class="w">
</span><span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/false</span><span class="w">
</span><span class="w">  </span><span class="nt">ignore_errors</span><span class="p">:</span><span class="w"> </span><span class="kc">yes</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p><strong>重置不可达的主机(Resetting Unreachable Hosts)</strong></p>
<p>连接失败将设置主机为不可达(UNREACHABLE)，它将从运行活跃主机列表中删除。可以使用<code>meta: clear_host_errors</code>来设置。</p>
<br>
<p><strong>处理程序和失败(Handlers and Failure)</strong></p>
<p>当主机上的一个任务失败时，先前通知(notify)的处理程序(handler)将不会在此主机上运行。例如，任务更新配置文件并通知处理程序去重启服务。如果任务以后的同一个play失败，则服务不会重启尽管配置已经更改。</p>
<p>可以使用<code>--force-handlers</code>命令行选项来改变此行为。或在play中包含<code>force_handlers: True</code>，或在ansible配置中包含<code>force_handlers = True</code>。当处理程序被强制执行，无论任务成功与否它们都会执行。</p>
<br>
<p><strong>控制如何定义失败(Controlling What Defines Failure)</strong></p>
<p>Ansible允许你使用<code>filed_when</code>条件来定义失败。栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Fail task when the command error output prints FAILED</span><span class="w">
</span><span class="w">  </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/bin/example-command -x -y -z</span><span class="w">
</span><span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l">command_result</span><span class="w">
</span><span class="w">  </span><span class="nt">failed_when</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#39;FAILED&#39; in command_result.stderr&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p><strong>覆盖改变的结果(Overriding The Changed Result)</strong></p>
<p>当一个模块运行，它通常会基于机器状态是否被影响而报告<code>changed</code>状态。</p>
<p>有时候你知道，基于返回码或返回结果，它并没有发生改变，并希望去覆盖<code>changed</code>结果，使它不出现在报告输出里：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/fake_command</span><span class="w">
</span><span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l">result</span><span class="w">
</span><span class="w">  </span><span class="nt">ignore_errors</span><span class="p">:</span><span class="w"> </span><span class="kc">True</span><span class="w">
</span><span class="w">  </span><span class="nt">changed_when</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="s1">&#39;&#34;ERROR&#34; in result.stderr&#39;</span><span class="w">
</span><span class="w">    </span>- <span class="l">result.rc == 2</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p><strong>终止play(Aborting the play)</strong></p>
<p>有时需要终止失败的play，而不是为某主机跳过剩余任务。</p>
<p><code>any_errors_fatal</code>选项将终止Play，并防止任何后续的plays运行。当遇到一个错误，当前批次的所有主机都有机会完成致命的任务，然后play的执行停止。<code>any_errors_fatal</code>可在play或block层级设置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">somehosts</span><span class="w">
</span><span class="w">  </span><span class="nt">any_errors_fatal</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">myrole</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">somehosts</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">block</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">include_tasks</span><span class="p">:</span><span class="w"> </span><span class="l">mytasks.yml</span><span class="w">
</span><span class="w">      </span><span class="nt">any_errors_fatal</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p><strong>使用块(blocks)</strong></p>
<p>大多数可应用到单个任务的也可应用到块，这使得它更容易设置数据或指定到任务。块只处理任务的失败(failed)状态。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Handle the error</span><span class="w">
</span><span class="w">  </span><span class="nt">block</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;I execute normally&#39;</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">i force a failure</span><span class="w">
</span><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l">/bin/false</span><span class="w">
</span><span class="w">    </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;I never execute, due to the above task failing, :-(&#39;</span><span class="w">
</span><span class="w">  </span><span class="nt">rescue</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;I caught an error, can do stuff here to fix it, :-)&#39;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="高级语法">高级语法</h4>
<p>Advanced Syntax: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_advanced_syntax.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_advanced_syntax.html</a></p>
<p>高级的YANL语法可以给你在Ansible的YAML文件中更多控制数据的地方。你可以在<a href="https://pyyaml.org/wiki/PyYAMLDocumentation#YAMLtagsandPythontypes" target="_blank" rel="noopener noreffer ">PyYAML文档</a>中找到等多Python特定化的YAML信息。</p>
<br>
<p><strong>不安全和原生字符串</strong>
Unsafe or Raw Strings</p>
<p>Ansible提供了一个内部的数据类型，用来声明变量不安全(unsafe)。这意味着变量中保存的数据应为不安全，防止字符串被替换和披露。</p>
<p>Jinja2包含了转义，或告诉Jinja2不渲染数据，如<code>{% raw %}...{% endraw %}</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 使用 !unsafe 标签
my_unsafe_variable: !unsafe &#39;this variable has {{ characters that should not be treated as a jinja2 template&#39;
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span><span class="w"></span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">my_unsafe_variable</span><span class="p">:</span><span class="w"> </span>!<span class="l">unsafe &#39;unsafe value&#39;</span><span class="w">
</span><span class="w"></span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="l">...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p><strong>锚和别名</strong>
YAML anchors and aliases: sharing variable values</p>
<p>YAML的锚(anchor)和别名(aliase)可以帮助你在灵活的方式中定义、维护和使用共享变量。使用<code>&amp;</code>定义一个锚，使用别名(<code>*</code>)指向它。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># 锚内设置了3个变量，别名使用其它2个，并覆盖第3个</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nn">...</span><span class="w">
</span><span class="w"></span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app1</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">jvm</span><span class="p">:</span><span class="w"> </span><span class="cp">&amp;jvm_opts</span><span class="w">
</span><span class="w">            </span><span class="nt">opts</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;-Xms1G -Xmx2G&#39;</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">1000</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/lib/app1</span><span class="w">
</span><span class="w">    </span><span class="nt">app2</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">jvm</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="cp">*jvm_opts</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/lib/app2</span><span class="w">
</span><span class="w"></span><span class="nn">...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>path的值由合并操作符(<code>&lt;&lt;</code>)所合并。</p>
<br>
<br>
<h4 id="使用插件">使用插件</h4>
<p>Working With Plugins: <a href="https://docs.ansible.com/ansible/latest/plugins/plugins.html">https://docs.ansible.com/ansible/latest/plugins/plugins.html</a></p>
<p>插件时扩展Ansible的核心功能。Ansible使用插件架构来实现丰富的、灵活的、可扩展的功能集。</p>
<p>Ansible ships附带了许多插件，你也可以自己编写。</p>
<ul>
<li>Action Plugins</li>
<li>Become Plugins</li>
<li>Cache Plugins</li>
<li>Callback Plugins</li>
<li>Cliconf Plugins</li>
<li>Connection Plugins</li>
<li>Httpapi Plugins</li>
<li>Inventory Plugins</li>
<li>Lookup Plugins</li>
<li>Netconf Plugins</li>
<li>Shell Plugins</li>
<li>Strategy Plugins</li>
<li>Vars Plugins</li>
<li>Filters</li>
<li>Tests</li>
<li>Plugin Filter Configuration</li>
</ul>
<br>
<br>
<h4 id="提示和输入">提示和输入</h4>
<p>Prompts: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_prompts.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_prompts.html</a></p>
<p>当运行playbook时，你可能希望提示某些用户输入信息，可使用<code>vars_prompt</code>来完成。一个常见的用途可能是要求输入敏感的数据，但不希望记录。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span><span class="w">  </span><span class="nt">vars_prompt</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">username</span><span class="w">
</span><span class="w">      </span><span class="nt">prompt</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;What is your username?&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">private</span><span class="p">:</span><span class="w"> </span><span class="kc">no</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">password</span><span class="w">
</span><span class="w">      </span><span class="nt">prompt</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;What is your password?&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Logging in as {{ username }}&#39;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="标签">标签</h4>
<p>Tags: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_tags.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_tags.html</a></p>
<p>如果你有一个大型的playbook，它可能成为一个有用的能够运行playbook的一个特定部分，而不是playbook中的所有。Ansible支持使用标签(tags)来完成。</p>
<p>标签可应用于Ansible的许多结构，但最简单的方法是单个任务。</p>
<p>栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">yum</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">httpd</span><span class="w">
</span><span class="w">    </span>- <span class="l">memcached</span><span class="w">
</span><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span><span class="w">  </span><span class="nt">tags</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">packages</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l">templates/src.j2</span><span class="w">
</span><span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/foo.conf</span><span class="w">
</span><span class="w">  </span><span class="nt">tags</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">configuration</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>当你执行playbook，你可以用两种方法基于标签过滤任务：</p>
<ul>
<li>在命令行使用<code>--tags</code>或<code>--skip-tags</code>选项；</li>
<li>在Ansible配置中，使用<code>TAGS_RUN</code>或<code>TAGS_SKIP</code>选项。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 仅执行某个标签
ansible-playbook example.yml --tags &#34;configuration,packages&#34;

# 跳过某个标签
ansible-playbook example.yml --skip-tags &#34;packages&#34;

# 产看标签执行情况
ansible-playbook example.yml --tags &#34;configuration,packages&#34; --list-tasks
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>标签重用</strong>
Tag Reuse</p>
<br>
<br>
<h3 id="控制playbook执行">控制playbook执行</h3>
<p>Controlling playbook execution: strategies and more: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_strategies.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_strategies.html</a></p>
<p>默认情况下，Ansible在使用5forks任意主机上开始下一个任务之前在所有被play影响的主机上运行每个任务。如果你想要改变此默认的行为，你可以使用不同的策略插件，改变fork数，或应用几个play级别的关键字（如<code>serial</code>）。</p>
<br>
<h4 id="选择策略">选择策略</h4>
<p>Selecting a strategy</p>
<ul>
<li>linear strategy: <a href="https://docs.ansible.com/ansible/latest/plugins/strategy/linear.html#linear-strategy">https://docs.ansible.com/ansible/latest/plugins/strategy/linear.html#linear-strategy</a></li>
<li>debug strategy: <a href="https://docs.ansible.com/ansible/latest/plugins/strategy/debug.html#debug-strategy">https://docs.ansible.com/ansible/latest/plugins/strategy/debug.html#debug-strategy</a></li>
<li>free strategy: <a href="https://docs.ansible.com/ansible/latest/plugins/strategy/free.html#free-strategy">https://docs.ansible.com/ansible/latest/plugins/strategy/free.html#free-strategy</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w"> </span><span class="l">free</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="l">...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="设置fork数">设置fork数</h4>
<p>Setting the number of forks</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># ansible.cfg
[defaults]
forks = 30


# or cli
ansible-playbook -f 30 my_playbook.ym
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="使用关键字控制执行">使用关键字控制执行</h4>
<p>Using keywords to control execution</p>
<p><a href="https://docs.ansible.com/ansible/latest/reference_appendices/playbooks_keywords.html#playbook-keywords" target="_blank" rel="noopener noreffer ">play level</a>的关键字会影响paly的执行。</p>
<p>最常见的是<code>serial</code>，还有<code>throttle</code>, <code>ignore_errors</code>, <code>ignore_unreachable</code>, <code>any_errors_fatal</code>。</p>
<br>
<br>
<h3 id="最佳实践">最佳实践</h3>
<p>Best Practices: <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html</a></p>
<p>使用Ansible和playbooks的一些技巧。</p>
<p>你可以在<a href="https://github.com/ansible/ansible-examples" target="_blank" rel="noopener noreffer ">ansible-examples</a>仓库中找到最佳用法。</p>
<br>
<h4 id="内容组织">内容组织</h4>
<p>Content Organization</p>
<p>下面将介绍组织Playbook内容的多种方式。你的ansible的使用应该适合你的需求，因此你可以按需组合各种方法。</p>
<p>组织ansible playbook内容的一个关键方式是role。你应该理解它。</p>
<br>
<h5 id="目录布局">目录布局</h5>
<p>Directory Layout</p>
<p>栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="l">staging                  </span><span class="w"> </span><span class="c"># inventory file for staging environment</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="l">group_vars/</span><span class="w">
</span><span class="w">   </span><span class="l">group1.yml            </span><span class="w"> </span><span class="c"># here we assign variables to particular groups</span><span class="w">
</span><span class="w">   </span><span class="l">group2.yml</span><span class="w">
</span><span class="w"></span><span class="l">host_vars/</span><span class="w">
</span><span class="w">   </span><span class="l">hostname1.yml         </span><span class="w"> </span><span class="c"># here we assign variables to particular systems</span><span class="w">
</span><span class="w">   </span><span class="l">hostname2.yml</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="l">library/                 </span><span class="w"> </span><span class="c"># if any custom modules, put them here (optional)</span><span class="w">
</span><span class="w"></span><span class="l">module_utils/            </span><span class="w"> </span><span class="c"># if any custom module_utils to support modules, put them here (optional)</span><span class="w">
</span><span class="w"></span><span class="l">filter_plugins/          </span><span class="w"> </span><span class="c"># if any custom filter plugins, put them here (optional)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="l">site.yml                 </span><span class="w"> </span><span class="c"># master playbook</span><span class="w">
</span><span class="w"></span><span class="l">webservers.yml           </span><span class="w"> </span><span class="c"># playbook for webserver tier</span><span class="w">
</span><span class="w"></span><span class="l">dbservers.yml            </span><span class="w"> </span><span class="c"># playbook for dbserver tier</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="l">roles/</span><span class="w">
</span><span class="w">    </span><span class="l">common/              </span><span class="w"> </span><span class="c"># this hierarchy represents a &#34;role&#34;</span><span class="w">
</span><span class="w">        </span><span class="l">tasks/           </span><span class="w"> </span><span class="c">#</span><span class="w">
</span><span class="w">            </span><span class="l">main.yml     </span><span class="w"> </span><span class="c">#  &lt;-- tasks file can include smaller files if warranted</span><span class="w">
</span><span class="w">        </span><span class="l">handlers/        </span><span class="w"> </span><span class="c">#</span><span class="w">
</span><span class="w">            </span><span class="l">main.yml     </span><span class="w"> </span><span class="c">#  &lt;-- handlers file</span><span class="w">
</span><span class="w">        </span><span class="l">templates/       </span><span class="w"> </span><span class="c">#  &lt;-- files for use with the template resource</span><span class="w">
</span><span class="w">            </span><span class="l">ntp.conf.j2  </span><span class="w"> </span><span class="c">#  &lt;------- templates end in .j2</span><span class="w">
</span><span class="w">        </span><span class="l">files/           </span><span class="w"> </span><span class="c">#</span><span class="w">
</span><span class="w">            </span><span class="l">bar.txt      </span><span class="w"> </span><span class="c">#  &lt;-- files for use with the copy resource</span><span class="w">
</span><span class="w">            </span><span class="l">foo.sh       </span><span class="w"> </span><span class="c">#  &lt;-- script files for use with the script resource</span><span class="w">
</span><span class="w">        </span><span class="l">vars/            </span><span class="w"> </span><span class="c">#</span><span class="w">
</span><span class="w">            </span><span class="l">main.yml     </span><span class="w"> </span><span class="c">#  &lt;-- variables associated with this role</span><span class="w">
</span><span class="w">        </span><span class="l">defaults/        </span><span class="w"> </span><span class="c">#</span><span class="w">
</span><span class="w">            </span><span class="l">main.yml     </span><span class="w"> </span><span class="c">#  &lt;-- default lower priority variables for this role</span><span class="w">
</span><span class="w">        </span><span class="l">meta/            </span><span class="w"> </span><span class="c">#</span><span class="w">
</span><span class="w">            </span><span class="l">main.yml     </span><span class="w"> </span><span class="c">#  &lt;-- role dependencies</span><span class="w">
</span><span class="w">        </span><span class="l">library/         </span><span class="w"> </span><span class="c"># roles can also include custom modules</span><span class="w">
</span><span class="w">        </span><span class="l">module_utils/    </span><span class="w"> </span><span class="c"># roles can also include custom module_utils</span><span class="w">
</span><span class="w">        </span><span class="l">lookup_plugins/  </span><span class="w"> </span><span class="c"># or other types of plugins, like lookup in this case</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="l">webtier/             </span><span class="w"> </span><span class="c"># same kind of structure as &#34;common&#34; was above, done for the webtier role</span><span class="w">
</span><span class="w">    </span><span class="l">monitoring/          </span><span class="w"> </span><span class="c"># &#34;&#34;</span><span class="w">
</span><span class="w">    </span><span class="l">fooapp/              </span><span class="w"> </span><span class="c"># &#34;&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<h5 id="可选的目录布局">可选的目录布局</h5>
<p>Alternative Directory Layout</p>
<p>此布局为大型环境提供了更多灵活性，栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="l">inventories/</span><span class="w">
</span><span class="w">   </span><span class="l">production/</span><span class="w">
</span><span class="w">      </span><span class="l">hosts              </span><span class="w"> </span><span class="c"># inventory file for production servers</span><span class="w">
</span><span class="w">      </span><span class="l">group_vars/</span><span class="w">
</span><span class="w">         </span><span class="l">group1.yml      </span><span class="w"> </span><span class="c"># here we assign variables to particular groups</span><span class="w">
</span><span class="w">         </span><span class="l">group2.yml</span><span class="w">
</span><span class="w">      </span><span class="l">host_vars/</span><span class="w">
</span><span class="w">         </span><span class="l">hostname1.yml   </span><span class="w"> </span><span class="c"># here we assign variables to particular systems</span><span class="w">
</span><span class="w">         </span><span class="l">hostname2.yml</span><span class="w">
</span><span class="w">
</span><span class="w">   </span><span class="l">staging/</span><span class="w">
</span><span class="w">      </span><span class="l">hosts              </span><span class="w"> </span><span class="c"># inventory file for staging environment</span><span class="w">
</span><span class="w">      </span><span class="l">group_vars/</span><span class="w">
</span><span class="w">         </span><span class="l">group1.yml      </span><span class="w"> </span><span class="c"># here we assign variables to particular groups</span><span class="w">
</span><span class="w">         </span><span class="l">group2.yml</span><span class="w">
</span><span class="w">      </span><span class="l">host_vars/</span><span class="w">
</span><span class="w">         </span><span class="l">stagehost1.yml  </span><span class="w"> </span><span class="c"># here we assign variables to particular systems</span><span class="w">
</span><span class="w">         </span><span class="l">stagehost2.yml</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="l">library/</span><span class="w">
</span><span class="w"></span><span class="l">module_utils/</span><span class="w">
</span><span class="w"></span><span class="l">filter_plugins/</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="l">site.yml</span><span class="w">
</span><span class="w"></span><span class="l">webservers.yml</span><span class="w">
</span><span class="w"></span><span class="l">dbservers.yml</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="l">roles/</span><span class="w">
</span><span class="w">    </span><span class="l">common/</span><span class="w">
</span><span class="w">    </span><span class="l">webtier/</span><span class="w">
</span><span class="w">    </span><span class="l">monitoring/</span><span class="w">
</span><span class="w">    </span><span class="l">fooapp/</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<h5 id="使用云动态资产">使用云动态资产</h5>
<p>Use Dynamic Inventory With Clouds</p>
<p>如果你使用云服务提供商，你不应该在静态文件中管理你的资产。请参考<a href="https://docs.ansible.com/ansible/latest/user_guide/intro_dynamic_inventory.html#intro-dynamic-inventory" target="_blank" rel="noopener noreffer ">Working with dynamic inventory</a></p>
<br>
<h5 id="如何区分测试与生产">如何区分测试与生产</h5>
<p>How to Differentiate Staging vs Production</p>
<p>如果管理静态清单，经常会问到如何区分不同类型的环境。下面的例子提供了一个好方法。分组的类似方法可以适用动态清单。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ini" data-lang="ini"><span class="c1"># file: production</span>

<span class="k">[atlanta_webservers]</span>
<span class="na">www-atl-1.example.com</span>
<span class="na">www-atl-2.example.com</span>

<span class="k">[boston_webservers]</span>
<span class="na">www-bos-1.example.com</span>
<span class="na">www-bos-2.example.com</span>

<span class="k">[atlanta_dbservers]</span>
<span class="na">db-atl-1.example.com</span>
<span class="na">db-atl-2.example.com</span>

<span class="k">[boston_dbservers]</span>
<span class="na">db-bos-1.example.com</span>

<span class="c1"># webservers in all geos</span>
<span class="k">[webservers:children]</span>
<span class="na">atlanta_webservers</span>
<span class="na">boston_webservers</span>

<span class="c1"># dbservers in all geos</span>
<span class="k">[dbservers:children]</span>
<span class="na">atlanta_dbservers</span>
<span class="na">boston_dbservers</span>

<span class="c1"># everything in the atlanta geo</span>
<span class="k">[atlanta:children]</span>
<span class="na">atlanta_webservers</span>
<span class="na">atlanta_dbservers</span>

<span class="c1"># everything in the boston geo</span>
<span class="k">[boston:children]</span>
<span class="na">boston_webservers</span>
<span class="na">boston_dbservers</span>
</code></pre></td></tr></table>
</div>
</div><br>
<h5 id="组和主机变量">组和主机变量</h5>
<p>Group And Host Variables</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="c"># file: group_vars/atlanta</span><span class="w">
</span><span class="w"></span><span class="nt">ntp</span><span class="p">:</span><span class="w"> </span><span class="l">ntp-atlanta.example.com</span><span class="w">
</span><span class="w"></span><span class="nt">backup</span><span class="p">:</span><span class="w"> </span><span class="l">backup-atlanta.example.com</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="c"># file: group_vars/webservers</span><span class="w">
</span><span class="w"></span><span class="nt">apacheMaxRequestsPerChild</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span><span class="w"></span><span class="nt">apacheMaxClients</span><span class="p">:</span><span class="w"> </span><span class="m">900</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="c"># file: group_vars/all</span><span class="w">
</span><span class="w"></span><span class="nt">ntp</span><span class="p">:</span><span class="w"> </span><span class="l">ntp-boston.example.com</span><span class="w">
</span><span class="w"></span><span class="nt">backup</span><span class="p">:</span><span class="w"> </span><span class="l">backup-boston.example.com</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<h5 id="顶级playbook通过角色分离">顶级playbook通过角色分离</h5>
<p>Top Level Playbooks Are Separated By Role</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="c"># file: site.yml</span><span class="w">
</span><span class="w"></span>- <span class="nt">import_playbook</span><span class="p">:</span><span class="w"> </span><span class="l">webservers.yml</span><span class="w">
</span><span class="w"></span>- <span class="nt">import_playbook</span><span class="p">:</span><span class="w"> </span><span class="l">dbservers.yml</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="c"># file: webservers.yml</span><span class="w">
</span><span class="w"></span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">webservers</span><span class="w">
</span><span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">common</span><span class="w">
</span><span class="w">    </span>- <span class="l">webtier</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>这里，我们可以选择运行<code>site.yml</code>来配置我们的整个基础架构，或者通过运行<code>webservers.yml</code>来只运行一个子集。类似于下面：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="l">ansible-playbook site.yml --limit webservers</span><span class="w">
</span><span class="w"></span><span class="l">ansible-playbook webservers.yml</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<h5 id="角色的任务和处理程序组织">角色的任务和处理程序组织</h5>
<p>Task And Handler Organization For A Role</p>
<p>下面解释一个NTP任务是如何工作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># file: roles/common/tasks/main.yml</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">be sure ntp is installed</span><span class="w">
</span><span class="w">  </span><span class="nt">yum</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ntp</span><span class="w">
</span><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">present</span><span class="w">
</span><span class="w">  </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="l">ntp</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">be sure ntp is configured</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l">ntp.conf.j2</span><span class="w">
</span><span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/ntp.conf</span><span class="w">
</span><span class="w">  </span><span class="nt">notify</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">restart ntpd</span><span class="w">
</span><span class="w">  </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="l">ntp</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">be sure ntpd is running and enabled</span><span class="w">
</span><span class="w">  </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ntpd</span><span class="w">
</span><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">started</span><span class="w">
</span><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">yes</span><span class="w">
</span><span class="w">  </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="l">ntp</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>这是一个处理程序(handler)文件栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="c"># file: roles/common/handlers/main.yml</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">restart ntpd</span><span class="w">
</span><span class="w">  </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ntpd</span><span class="w">
</span><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">restarted</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<h5 id="什么组织启用">什么组织启用</h5>
<p>What This Organization Enables</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 重新配置基础服务
ansible-playbook -i production site.yml


# 重新配置NTP
ansible-playbook -i production site.yml --tags ntp


# 重新配置webservers
ansible-playbook -i production webservers.yml
# boston
ansible-playbook -i production webservers.yml --limit boston
# boston first 10
ansible-playbook -i production webservers.yml --limit boston[0:9]


# ad-hoc
ansible boston -i production -m command -a &#39;/sbin/reboot&#39;
</code></pre></td></tr></table>
</div>
</div><br>
<h5 id="部署于配置组织">部署于配置组织</h5>
<p>Deployment vs Configuration Organization</p>
<p>上面的配置模型是一个典型的配置拓扑。当进行多级部署中，会有一些额外的playbook（hop between tiers to roll out an application）。</p>
<br>
<br>
<h4 id="测试与生产">测试与生产</h4>
<p>Staging vs Production</p>
<p>如上所述，让staging(testing)和production环境分离是为不同的环境使用单独的清单文件。你的环境不一定是相同的大小，你可以使用变量来控制它们。</p>
<br>
<br>
<h4 id="滚动更新">滚动更新</h4>
<p>Rolling Updates</p>
<p>理解<code>serial</code>关键字。</p>
<br>
<br>
<h4 id="注意状态">注意状态</h4>
<p>Always Mention The State</p>
<p><code>state</code>参数对许多模块是可选的。如<code>state=present</code>或<code>state=absent</code>。</p>
<br>
<br>
<h4 id="通过角色分组">通过角色分组</h4>
<p>Group By Roles</p>
<p>一个系统可以在多个组。这使得playbook基于角色来选择目标主机。以及使用该组变量系统来分配角色特定的变量。</p>
<br>
<br>
<h4 id="操作系统和发行版本">操作系统和发行版本</h4>
<p>Operating System and Distribution Variance</p>
<p>当在两个不同的操作系统之间处理一个参数时，处理它的一个好方法是使用<code>group_by</code>模块。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"> </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">talk to all hosts just so we can learn about them</span><span class="w">
</span><span class="w">   </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span><span class="w">   </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">     </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Classify hosts depending on their OS distribution</span><span class="w">
</span><span class="w">       </span><span class="nt">group_by</span><span class="p">:</span><span class="w">
</span><span class="w">         </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">os_{{ ansible_facts[&#39;distribution&#39;] }}</span><span class="w">
</span><span class="w">
</span><span class="w"> </span><span class="c"># now just on the CentOS hosts...</span><span class="w">
</span><span class="w">
</span><span class="w"> </span>- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">os_CentOS</span><span class="w">
</span><span class="w">   </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="kc">False</span><span class="w">
</span><span class="w">   </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">     </span>- <span class="c"># tasks that only happen on CentOS go here</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">all</span><span class="w">
</span><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Set OS distribution dependent variables</span><span class="w">
</span><span class="w">      </span><span class="nt">include_vars</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;os_{{ ansible_facts[&#39;distribution&#39;] }}.yml&#34;</span><span class="w">
</span><span class="w">    </span>- <span class="nt">debug</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">var</span><span class="p">:</span><span class="w"> </span><span class="l">asdf</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="使用playbook捆绑ansible模块">使用playbook捆绑ansible模块</h4>
<p>Bundling Ansible Modules With Playbooks</p>
<p>如果playbook有相对于其它YAML文件的<code>./library</code>目录，此目录可以用来添加ansible module，它会自动在ansible模块路径。这是一个保持模块与playbook在一起的好方法。</p>
<br>
<br>
<h4 id="空白和注释">空白和注释</h4>
<p>Whitespace and Comments</p>
<p>空白和注释有利于文件可读性，值得使用。</p>
<br>
<br>
<h4 id="任务命名">任务命名</h4>
<p>Always Name Tasks</p>
<p>给任务建立一个正在做什么的名称。在运行时，playbook显示此名称。</p>
<br>
<br>
<h4 id="使它简单">使它简单</h4>
<p>Keep It Simple</p>
<p>当你能够简单地做事，那就简单地做。不要为了达到使用所有ansible功能而一起使用它们。使用你需要的。把复杂的事情简单化。</p>
<br>
<br>
<h4 id="版本控制">版本控制</h4>
<p>Version Control</p>
<p>使用版本控制来管理playbook。</p>
<br>
<br>
<h4 id="变量和拱顶">变量和拱顶</h4>
<p>Variables and Vaults</p>
<p>当运行playbook，Ansible在未加密的文件中查找变量，并且所有敏感的变量来自加密文件。</p>
<p>一个最佳实践方法是在组下开始一个<code>group_vars</code>子目录。在此子目录内，创建两个名为<code>vars</code>和<code>vault</code>的文件。<code>vars</code>文件内定义所有需要的变量，包括敏感的。接下来，复制所有的敏感变量到<code>vault</code>文件或以<code>vault_</code>开头的文件。你应该在<code>vars</code>文件内使用Jinja2语法调整变量指向匹配的<code>vault_</code>文件，并确保<code>vault</code>文件是vault encrypted。</p>
<br>
<br>
<h3 id="持续交付和滚动更新">持续交付和滚动更新</h3>
<p>Playbook Example: Continuous Delivery and Rolling Upgrades: <a href="https://docs.ansible.com/ansible/latest/user_guide/guide_rolling_upgrade.html">https://docs.ansible.com/ansible/latest/user_guide/guide_rolling_upgrade.html</a></p>
<br>
<h4 id="什么是持续交付">什么是持续交付</h4>
<p>What is continuous delivery</p>
<p>Continuous delivery(CD)是指经常更新你的软件应用程序。</p>
<br>
<br>
<br>
<h2 id="特权晋升-1">特权晋升</h2>
<p>Understanding privilege escalation: become: <a href="https://docs.ansible.com/ansible/latest/user_guide/become.html">https://docs.ansible.com/ansible/latest/user_guide/become.html</a></p>
<p>Ansible使用现有的权限升级系统来执行具有root或其它权限的任务。此功能允许你成为(<code>become</code>)其它用户，与登录到远程机器不同，我们称之为<code>become</code>。become关键字利用现有的权限提升工具（如<code>sudo</code>, <code>su</code>, <code>pfexec</code>, <code>doas</code>, <code>pbrun</code>, <code>dzdo</code>, <code>ksu</code>, <code>runas</code>）。</p>
<br>
<h3 id="使用">使用</h3>
<p>你可以在任务、连接变量、命令行等控制<code>become</code>的使用。如果你以多种方式设置了特权提升，请注意优先级。</p>
<p>所有become plugins完整的列表: <a href="https://docs.ansible.com/ansible/latest/plugins/become.html#become-plugin-list">https://docs.ansible.com/ansible/latest/plugins/become.html#become-plugin-list</a></p>
<br>
<p><strong>become</strong></p>
<p>你可在play或task层设置<code>become</code>指令。你可以设置连接变量，从不同主机之间覆盖它们。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># 激活特权提升</span><span class="w">
</span><span class="w"></span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="kc">yes</span><span class="w">
</span><span class="w"></span><span class="c"># 默认root</span><span class="w">
</span><span class="w"></span><span class="nt">become_user</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span><span class="w"></span><span class="c"># 参考become plugins，可在ansible.cfg中配置。默认sudo</span><span class="w">
</span><span class="w"></span><span class="nt">become_method</span><span class="p">:</span><span class="w"> </span><span class="l">sudo</span><span class="w">
</span><span class="w"></span><span class="c"># 为role或task执行特定标志</span><span class="w">
</span><span class="w"></span><span class="nt">become_flags</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">- name: Ensure the httpd is running
  become: yes
  service:
    name: httpd
    state: started

- name: Run a command as the apache user
  command: somecommand
  become: yes
  become_user: apache

- name: Run a command as nobody
  command: somecommand
  become: yes
  become_method: su
  become_user: nobody
  become_flags: &#39;-s /bin/sh&#39;
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>连接变量</strong></p>
<p>Become connection variables</p>
<p>你可以定义不同的选型来管理node或group。你可以在资产中定义这些变量，或将其作为正常的变量使用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">ansible_become
ansible_become_method
ansible_become_user
ansible_become_password

# 栗子
webserver ansible_user=manager ansible_become=yes
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>命令行选项</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">--ask-become-pass, -K
--become, -b
--become-method=BECOME_METHOD
--become-user=BECOME_USER
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="风险和局限性">风险和局限性</h3>
<p>Risks and limitations of become</p>
<p>虽然权限提升是很直观的，但它如何工作也有一些限制。用户应该知道这些，以避免意外。</p>
<br>
<p><strong>成为一个非特权用户的风险</strong>
Risks of becoming an unprivileged user</p>
<p>Ansible模块由第一个参数带入模块文件，然后将其复制到远程主机，最后在远程机器上执行它。</p>
<p>如果模块文件不使用<code>become</code>，当<code>become_ueer</code>为root时，或当远程机器被设置为root时，一切都好。在这些情况下，Ansible创建具有只允许由所述用户和root读取，或只允许由所述非特权用户切换到读取权限模块文件。</p>
<p>然而，当连接用户和<code>become_user</code>都不是特权用户，模块文件被写入需要由Ansible设置为用户可读。在这种情况下，Ansible使得模块文件世界可读的Ansible模块执行的持续时间。一旦模块执行完毕，Ansible删除临时文件。</p>
<br>
<p><strong>不是所有连接插件都支持</strong>
Not supported by all connection plugins</p>
<p>特权升级方法也必须由连接使用的插件支持。</p>
<br>
<p><strong>每个主机只能启用一个方法</strong>
Only one method may be enabled per host</p>
<br>
<p><strong>特权提升必须通用</strong>
Privilege escalation must be general</p>
<p>你不能限制权限提升某些命令的权限。</p>
<br>
<br>
<br>
<h2 id="vault">Vault</h2>
<p>Ansible Vault: <a href="https://docs.ansible.com/ansible/latest/user_guide/vault.html">https://docs.ansible.com/ansible/latest/user_guide/vault.html</a></p>
<p>Ansible Vault是Ansible的一个功能，可以让你在加密的文件中保存敏感数据（如密码、密钥），而不是像普通文本或playbooks或roles中。这些vault文件可以分布或放置在版本控制中。</p>
<p>要启用此功能，使用命令行选型<code>-ansible-vault</code>，和<code>--vault-password-file</code>。</p>
<br>
<br>
<br>
<h2 id="modules">Modules</h2>
<p>Ansible Modules: <a href="https://docs.ansible.com/ansible/latest/user_guide/modules.html">https://docs.ansible.com/ansible/latest/user_guide/modules.html</a></p>
<p>Ansible包含了大量的模块(module library)，可以直接在远程主机或通过playbook执行。</p>
<p>用户也可以编写自己的模块。这些模块可以控制系统资源（服务、包、文件&hellip;），或执行系统命令。</p>
<br>
<br>
<h3 id="模块介绍">模块介绍</h3>
<p>Introduction to modules: <a href="https://docs.ansible.com/ansible/latest/user_guide/modules_intro.html">https://docs.ansible.com/ansible/latest/user_guide/modules_intro.html</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># adhoc</span>
ansible webservers -m service -a <span class="s2">&#34;name=httpd state=started&#34;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># playbook</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">restart webserver</span><span class="w">
</span><span class="w">  </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">httpd</span><span class="w">
</span><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l">restarted</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="返回值">返回值</h3>
<p>Return Values: <a href="https://docs.ansible.com/ansible/latest/reference_appendices/common_return_values.html">https://docs.ansible.com/ansible/latest/reference_appendices/common_return_values.html</a></p>
<p>Ansible模块通常正常返回一个可以注册为一个变量的数据结构，或直接看到由ansible程序输出。每个模块都可选的记录自己唯一的返回值。</p>
<p>本章节包含的返回值适用于所有模块。</p>
<br>
<ul>
<li>Common
<ul>
<li>backup_file</li>
<li>changed</li>
<li>failed</li>
<li>invocation</li>
<li>msg</li>
<li>rc</li>
<li>results</li>
<li>skipped</li>
<li>stderr</li>
<li>stderr_lines</li>
<li>stdout</li>
<li>stdout_lines</li>
</ul>
</li>
<li>Internal use
<ul>
<li>ansible_facts</li>
<li>exception</li>
<li>warning</li>
<li>deprecations</li>
</ul>
</li>
</ul>
<br>
<br>
<h3 id="模块索引">模块索引</h3>
<p>Module Index: <a href="https://docs.ansible.com/ansible/latest/modules/modules_by_category.html">https://docs.ansible.com/ansible/latest/modules/modules_by_category.html</a></p>
<br>
<br>
<br>
<h2 id="插件">插件</h2>
<p>Working With Plugins: <a href="https://docs.ansible.com/ansible/latest/plugins/plugins.html">https://docs.ansible.com/ansible/latest/plugins/plugins.html</a></p>
<p>插件是一段代码，可以扩充Ansible的核心功能。Ansible使用插件架构，以实现丰富的、灵活的、可扩展的功能集。</p>
<p>Ansible附带了一些方便的插件，你也可以很容易地编写自己的插件。</p>
<br>
<br>
<br>
<h2 id="collections">collections</h2>
<p>collections: <a href="https://docs.ansible.com/ansible/latest/user_guide/collections_using.html">https://docs.ansible.com/ansible/latest/user_guide/collections_using.html</a></p>
<p>Collections是Ansible的内容分发格式，可以包括playbooks, roles, modules, plugins。你可以通过Ansible Galaxy安装和使用collections。</p>
<br>
<br>
<hr>
<br>
<br>
<h1 id="开发指南">开发指南</h1>
<p>Developer Guide: <a href="https://docs.ansible.com/ansible/latest/dev_guide/index.html">https://docs.ansible.com/ansible/latest/dev_guide/index.html</a></p>
<br>
<br>
<hr>
<br>
<br>
<h1 id="ansible-galaxy">Ansible Galaxy</h1>
<p>Ansible Galaxy: <a href="https://docs.ansible.com/ansible/latest/galaxy/user_guide.html">https://docs.ansible.com/ansible/latest/galaxy/user_guide.html</a></p>
<p>Ansible Galaxy是一个查找、分享、下载社区开发的roles的网站。</p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2019-12-26</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/ansible/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://zhang21.cn/ansible/" data-title="Ansible" data-hashtags="Ansible,Automation,DevOps"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://zhang21.cn/ansible/" data-title="Ansible"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Reddit" data-sharer="reddit" data-url="https://zhang21.cn/ansible/"><i class="fab fa-reddit fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://zhang21.cn/ansible/" data-title="Ansible"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://zhang21.cn/ansible/" data-title="Ansible"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/ansible/">Ansible</a>,&nbsp;<a href="/tags/automation/">Automation</a>,&nbsp;<a href="/tags/devops/">DevOps</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/tornado/" class="prev" rel="prev" title="Tornado"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Tornado</a>
            <a href="/javascript/" class="next" rel="next" title="JavaScript">JavaScript<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.83.1">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2017 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://zhang21.cn" target="_blank">Zhang21</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css"><script type="text/javascript" src="https://zhang21.disqus.com/embed.js" defer></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":20},"comment":{},"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"RZ22ZCTIDN","algoliaIndex":"hugo-index","algoliaSearchKey":"11ec277ef4d730e232eda9651548da78","highlightTag":"em","maxResultLength":20,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"twemoji":true};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
