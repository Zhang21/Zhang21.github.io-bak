<!DOCTYPE html>




<html class="theme-next muse" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-flash.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="DevOps,Python,Web,Tornado,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2">






<meta name="description" content="环境:  Tornado: v5.1 Python: v3.6   参考:  Docs: https://www.tornadoweb.org/en/branch5.1/">
<meta name="keywords" content="DevOps,Python,Web,Tornado">
<meta property="og:type" content="article">
<meta property="og:title" content="Tornado">
<meta property="og:url" content="https://zhang21.github.io/2019/10/14/Tornado/index.html">
<meta property="og:site_name" content="风继续吹">
<meta property="og:description" content="环境:  Tornado: v5.1 Python: v3.6   参考:  Docs: https://www.tornadoweb.org/en/branch5.1/">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-11-25T02:57:15.693Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tornado">
<meta name="twitter:description" content="环境:  Tornado: v5.1 Python: v3.6   参考:  Docs: https://www.tornadoweb.org/en/branch5.1/">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.2',
    sidebar: {"position":"left","display":"hide","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zhang21.github.io/2019/10/14/Tornado/">





  <title>Tornado | 风继续吹</title>
  








  <!-- 爆炸效果 -->
  <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;"></canvas>
  <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
  <script type="text/javascript" src="/js/firework.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">风继续吹</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Yesterday, you said tomorrow!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-bullshift">
          <a href="https://suulnnka.github.io/BullshitGenerator/index.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-external-link"></i> <br>
            
            狗屁不通生成器
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhang21.github.io/2019/10/14/Tornado/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Leslie Zhang">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/leslie.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风继续吹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Tornado</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-14T16:19:21+08:00">
                2019-10-14
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2019-11-25T10:57:15+08:00">
                2019-11-25
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/10/14/Tornado/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/10/14/Tornado/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  10,275
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>环境:</p>
<ul>
<li>Tornado: v5.1</li>
<li>Python: v3.6</li>
</ul>
<p><br></p>
<p>参考:</p>
<ul>
<li>Docs: <a href="https://www.tornadoweb.org/en/branch5.1/" target="_blank" rel="noopener">https://www.tornadoweb.org/en/branch5.1/</a></li>
</ul>
<p><br><br><br></p>
<hr>
<a id="more"></a>
<p><br><br><br></p>
<h1 id="用户指南"><a href="#用户指南" class="headerlink" title="用户指南"></a>用户指南</h1><p><br></p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Tornado是一个Python Web框架和异步(asynchronous)网络库。通过使用非阻塞(non-blocking)网络I/O，Tornado可以扩展到上万个连接，因此非常适合长轮询(long polling)、WebSocket需要长期连接到的每个用户的应用程序。</p>
<p>Tornado大致可以分为四个主要组件:</p>
<ul>
<li>Web框架：包含<code>RequestHandler</code>，它的子类用于创建web应用，并支持各种类。</li>
<li>HTTP的Client和Server的实现：<code>HTTPServer</code>和<code>AsyncHTTPClient</code>。</li>
<li>异步网络库(<code>IOLoop</code>和<code>IOStream</code>)，用于HTTP组件的构建块，并且还可实现其它协议。</li>
<li>协程库(<code>tornado.gen</code>)，允许异步代码写的更直接而不用链式回调(chaining callbacks)的方式。</li>
</ul>
<p>Tornado web框架和HTTP server一起为WSGI提供了一个全栈(full-stack)式选择。为了充分利用Tornado的特性，你需要一起使用Tornado Web框架和HTTP Server。</p>
<p><br><br><br><br><br></p>
<h2 id="异步和非阻塞I-O"><a href="#异步和非阻塞I-O" class="headerlink" title="异步和非阻塞I/O"></a>异步和非阻塞I/O</h2><p>实时(real-time) Web功能需要为每个用户提供一个长时间空闲(mostly-idle)的长连接。在传统的同步(synchronous) web server，这意味着为每个用户提供一个线程(thread)，这是非常昂贵的。<br>要尽可能减少并发连接(concurrent connections)的开销，Tornado使用一个单线程事件循环。这意味着所有应用程序代码都应该是异步非阻塞的，因为在同一时间只有一个操作是活跃的。<br>异步和非阻塞这两个术语是非常相关的，并经常交换使用，但它们不是完全相同的事情。</p>
<p><br></p>
<h3 id="阻塞"><a href="#阻塞" class="headerlink" title="阻塞"></a>阻塞</h3><p>一个函数在等待某些事情的返回的时候会被阻塞(block)。函数阻塞的原因有很多，如：网络IO、磁盘IO、互斥锁…事实上，每个函数在运行和使用CPU的时候或多或少会被阻塞。</p>
<p>一个函数可以在某些方面阻塞，在另外一些方面不阻塞。在Tornado下，我们通常讨论网络IO阻塞，尽管各种阻塞也被最小化。</p>
<p><br><br><br></p>
<h3 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h3><p>异步(asynchronous)函数在完成之前返回，在应用中触发下一个动作之前通常会在后台执行一些工作（和正常的同步函数在返回之前就执行完所有的事情不同）。这里列举了几种风格的异步接口：</p>
<ul>
<li>回调参数</li>
<li>返回一个占位符</li>
<li>传送给一个队列</li>
<li>回调注册表</li>
</ul>
<p><br><br><br></p>
<h3 id="栗子"><a href="#栗子" class="headerlink" title="栗子"></a>栗子</h3><p>一个同步(synchronous)函数的栗子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from tornado.httpclient import HTTPClient</span><br><span class="line"></span><br><span class="line">def synchronous_fetch(url):</span><br><span class="line">    http_client = HTTPClient()</span><br><span class="line">    response = http_client.fetch(url)</span><br><span class="line">    return response.body</span><br></pre></td></tr></table></figure>
<p>一个异步(asynchronous)重写的函数:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tornado.httpclient <span class="keyword">import</span> AsyncHTTPClient</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">asynchronous_fetch</span><span class="params">(url)</span>:</span></span><br><span class="line">    http_client = AsyncHTTPClient()</span><br><span class="line">    response = <span class="keyword">await</span> http_client.fetch(url)</span><br><span class="line">    <span class="keyword">return</span> response.body</span><br></pre></td></tr></table></figure>
<p>协程(coroutines)有点不可思议，但它们在内如是这样的:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tornado.concurrent <span class="keyword">import</span> Future</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">async_fetch_manual</span><span class="params">(url)</span>:</span></span><br><span class="line">    http_client = AsyncHTTPClient()</span><br><span class="line">    my_future = Future()</span><br><span class="line">    fetch_future = http_client.fetch(url)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">on_fetch</span><span class="params">(f)</span>:</span></span><br><span class="line">        my_future.set_result(f.result().body)</span><br><span class="line">    fetch_future.add_done_callback(on_fetch)</span><br><span class="line">    <span class="keyword">return</span> my_future</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>任何可用协程做的都可传递到回调(callback)对象周围，但协程提供了一个重要的简化让你以相同的方式组织你的代码。这对于错误处理(error handling)尤其重要，在协程预期的<code>tyr/except</code>块工作，这是难以实现的回调。</p>
<p><br><br><br><br><br></p>
<p>在Tornado中，协程(Coroutines)是推荐的编写异步代码的方式。协程使用Python的<code>await</code>或<code>yield</code>关键字来暂停(suspend)和恢复(resume)来代替回调链。</p>
<p>协程几乎与同步(synchronous)代码一样简单，但不带线程(thread)的开销。它们使得并发(concurrency)更简单。</p>
<p>栗子:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">fetch_coroutine</span><span class="params">(url)</span>:</span></span><br><span class="line">    http_client = AsyncHTTPClient()</span><br><span class="line">	response = <span class="keyword">await</span> http_client.fetch(url)</span><br><span class="line">	<span class="keyword">return</span> response.body</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="原生与装饰的协程"><a href="#原生与装饰的协程" class="headerlink" title="原生与装饰的协程"></a>原生与装饰的协程</h3><p>Native vs decorated coroutines</p>
<p>Python 3.5介绍了<code>async</code>和<code>await</code>关键字。</p>
<p>只要可能，原生协程是推荐的形式。仅需要与旧版本的Python兼容时使用装饰的协程。Tornado文档中一般会使用原生形式。</p>
<p>这两种形式之间的转换一般是简单的:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Decorated</span></span><br><span class="line"><span class="comment"># Normal function declaration</span></span><br><span class="line"><span class="comment"># with decorator</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@gen.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">a</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 'yield' all async funcs</span></span><br><span class="line">	b = <span class="keyword">yield</span> c()</span><br><span class="line">	<span class="comment"># 'return' and 'yield'</span></span><br><span class="line">	<span class="comment"># cannot be mixed in</span></span><br><span class="line">	<span class="comment"># Python 2, so raise a</span></span><br><span class="line">	<span class="comment"># special execption</span></span><br><span class="line">	<span class="keyword">raise</span> gen.Return(b)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Native</span></span><br><span class="line"><span class="comment"># 'async def' keywords</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">a</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 'await' all async funcs</span></span><br><span class="line">	b = <span class="keyword">await</span> c()</span><br><span class="line">	<span class="comment"># return normally</span></span><br><span class="line">	<span class="keyword">return</span> b</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>两种协程形式的不同:</p>
<ul>
<li>原生协程通常更快</li>
<li>原生协程可以使用<code>async for</code>和<code>async with</code>语句，这使得一些模式更简单</li>
<li>除非<code>await</code>和<code>yield</code>它们，原生协程不会运行所有。装饰的协程一经调用就运行在后台(background)。请注意，这两种协程使用<code>await</code>或<code>yield</code>都很重要，以便任何异常都有地方可去</li>
<li>装饰的协程有与<code>concurrent.futures</code>包额外的集成，允许直接yielded <code>executor.submit</code>的结果。对于原生协程，使用<code>IOLoop.run_in_executor</code>代替</li>
<li>通过生成一个列表或字典，装饰的协程支持一些速记。在原生协程中使用<code>tornado.gen.multi</code></li>
<li>装饰的协程可以支持与其它软件包的整合。要在原生协程中访问此功能，使用<code>tornado.gen.convert_yielded</code></li>
<li>装饰的协程总是返回一个<code>Future</code>对象。原生协程返回一个awaitable对象</li>
</ul>
<p><br><br><br></p>
<h3 id="如何工作"><a href="#如何工作" class="headerlink" title="如何工作"></a>如何工作</h3><p>本节介绍装饰的协程的操作。原生协程在概念上相似，但多了几分复杂。因为与Python runtime额外集成。</p>
<p>包含<code>yield</code>的函数是一个生成器(generator)。所有的生成器都是异步的，调用它们时返回一个生成器对象，而不是运行到完成。<code>@gen.coroutine</code>装饰器(decorator)通过<code>yield</code>表达式与生成器进行通信，通过协程调用返回一个<code>Future</code>。</p>
<p>一个协程装饰器的内循环的简单栗子:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Simplified inner loop of tornado.gen.Runner</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="comment"># send(x) makes the current yield return x</span></span><br><span class="line">    <span class="comment"># It returns when the next yield is reached</span></span><br><span class="line">    future = self.gen.send(self.next)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">callback</span><span class="params">(f)</span>:</span></span><br><span class="line">        self.next = f.result()</span><br><span class="line">        self.run()</span><br><span class="line">    future.add_done_callback(callback)</span><br></pre></td></tr></table></figure>
<p>装饰器从生成器接收一个<code>Future</code>，等待(不会阻塞)选择那些完成的<code>Future</code>，解包<code>Future</code>并将结果发送回生成器的<code>yield</code>表达式。大多数异步代码不直接接触<code>Future</code>类，除了由一个异步函数立即传递<code>Future</code>到<code>yield</code>表达式。</p>
<p><br><br><br></p>
<h3 id="如何调用协程"><a href="#如何调用协程" class="headerlink" title="如何调用协程"></a>如何调用协程</h3><p>协程在正常方式下不抛出异常：它们抛出的任何异常都将在<code>awaitable</code>对象直到它被yielded。这意味着以正确的方式调用协程是重要的，或者可能有被你忽略的错误。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">divide</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x / y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bad_call</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># This should raise a ZeroDivisionError, but it won't because</span></span><br><span class="line">    <span class="comment"># the coroutine is called incorrectly.</span></span><br><span class="line">    divide(<span class="number">1</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>在几乎所有情况下，调用协程的任何函数都必须是一个协程本身，并在调用中使用<code>await</code>和<code>yield</code>关键字。当你重写superclass中定义的方法时，查看文档看协程是否被允许。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">good_call</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># await will unwrap the object returned by divide() and raise the exception.</span></span><br><span class="line">    <span class="keyword">await</span> divide(<span class="number">1</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>有时，你可能想fire and forget协程，而无需等待其结果。在这种情况下，推荐使用<code>IOLoop.spawn_callback</code>，这使得<code>IOLoop</code>负责调用。如果失败，<code>IOLoop</code>将记录stack trace。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The IOLoop will catch the exception and print a stack trace in the logs.</span></span><br><span class="line"><span class="comment"># Note that this doesn't look like a normal call, since we pass the function object to be called by the IOLoop.</span></span><br><span class="line"></span><br><span class="line">IOLoop.current().spawn_callback(divide, <span class="number">1</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>函数使用<code>@gen.coroutin</code>在这种方式下建议使用<code>IOLoop.spawn_callback</code>，但它需要函数使用<code>async def</code>。</p>
<p>最后，在程序的顶层，如果<code>IOLoop</code>尚未运行，就可以启动<code>IOLoop</code>，运行协程，然后用<code>IOLoop.run_sync</code>方法停止<code>IOLoop</code>。这经常用来启动一个面向批处理程序的<code>main()</code>函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># run_sync() doesn&apos;t take arguments, so we must wrap the call in lambda.</span><br><span class="line">IOLoop.current().run_sync(lambda: divide(1, 0))</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="协程模式"><a href="#协程模式" class="headerlink" title="协程模式"></a>协程模式</h3><p>Coroutine patterns</p>
<h4 id="调用阻塞函数"><a href="#调用阻塞函数" class="headerlink" title="调用阻塞函数"></a>调用阻塞函数</h4><p>Calling blocking functions</p>
<p>从协程调用阻塞函数最简单的方式是使用<code>IOLoop.run_in_executor</code>，它返回与协程兼容的<code>Future</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">call_blocking</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">await</span> IOLoop.current().run_in_executor(<span class="keyword">None</span>, blocking_func, args)</span><br></pre></td></tr></table></figure>
<p><br></p>
<h4 id="Parallelism"><a href="#Parallelism" class="headerlink" title="Parallelism"></a>Parallelism</h4><p><code>multi</code>函数接收列表和字典，其值是<code>Futures</code>，并等待所有并行(parallel)的<code>Futures</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tornado.gen <span class="keyword">import</span> multi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">paraller_fetch</span><span class="params">(url1, url2)</span>:</span></span><br><span class="line">    resp1, resp2 = <span class="keyword">await</span> multi([http_client.fetch(url1), http_client.fetch(url2)])</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">paraller_fetch_many</span><span class="params">(urls)</span>:</span></span><br><span class="line">    responses = <span class="keyword">await</span> multi (http_client.fetch(url) <span class="keyword">for</span> url <span class="keyword">in</span> urls)</span><br><span class="line">    <span class="comment"># responses is a list of HTTPResponses in the same order</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">parallel_fetch_dict</span><span class="params">(urls)</span>:</span></span><br><span class="line">    responses = <span class="keyword">await</span> multi(&#123;url: http_client.fetch(url) <span class="keyword">for</span> url <span class="keyword">in</span> urls&#125;)</span><br><span class="line">    <span class="comment"># responses is a dict &#123;url: HTTPResponse&#125;</span></span><br></pre></td></tr></table></figure>
<p>在装饰的协程，可<code>yield</code>列表或字典:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@gen.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">aprallel_fetch_decorated</span><span class="params">(url1, url2)</span>:</span></span><br><span class="line">    resp1, resp2 = <span class="keyword">yield</span> [http_client.fetch(url1), http_client.fetch(url2)]</span><br></pre></td></tr></table></figure>
<p><br></p>
<h4 id="Interleaving"><a href="#Interleaving" class="headerlink" title="Interleaving"></a>Interleaving</h4><p>有时保存<code>Future</code>是有用的而不立即yielding，因此你可以在等待之前启动其它操作。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tornado.gen <span class="keyword">import</span> convert_yielded</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="comment"># convert_yielded() starts the native coroutine in the background.</span></span><br><span class="line">    <span class="comment"># This is equivalent to asyncio.ensure_future() (both work in Tornado).</span></span><br><span class="line">    fetch_future = convert_yielded(self.fetch_next_chunk())</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        chunk = <span class="keyword">yield</span> fetch_future</span><br><span class="line">        <span class="keyword">if</span> chunk <span class="keyword">is</span> <span class="keyword">None</span>: <span class="keyword">break</span></span><br><span class="line">        self.write(chunk)</span><br><span class="line">        fetch_future = convert_yielded(self.fetch_next_chunk())</span><br><span class="line">        <span class="keyword">yield</span> self.flush()</span><br></pre></td></tr></table></figure>
<p>这是一个比较容易做装饰的协程，因为它们在调用时立即启动:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@gen.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">    fetch_future = self.fetch_next_chunk()</span><br><span class="line">    <span class="keyword">if</span> chunk <span class="keyword">is</span> <span class="keyword">None</span>: <span class="keyword">break</span></span><br><span class="line">    self.write(chunk)</span><br><span class="line">    fetch_future = self.fetch_next_chunk()</span><br><span class="line">    yiield self.flush()</span><br></pre></td></tr></table></figure>
<p><br></p>
<h4 id="Looping"><a href="#Looping" class="headerlink" title="Looping"></a>Looping</h4><p>在原生协程，可使用<code>async for</code>。在不同版本的Python中，looping is tricky with coroutines，因为没有办法获得对<code>for</code>或<code>while</code>循环的每次迭代结果的yield。你需要从访问结果分隔循环条件。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> motor</span><br><span class="line"></span><br><span class="line">db = motor.MotorClient().test</span><br><span class="line"></span><br><span class="line"><span class="meta">@gen.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loop_example</span><span class="params">(collection)</span>:</span></span><br><span class="line">    cursor = db.collection.find()</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">yield</span> cursor.fetch_next):</span><br><span class="line">        doc = cursor.netx_object()</span><br></pre></td></tr></table></figure>
<p><br></p>
<h4 id="在后台运行"><a href="#在后台运行" class="headerlink" title="在后台运行"></a>在后台运行</h4><p>Running in the background</p>
<p><code>PeriodicCallback</code>通常不与协程使用。相反，协程可以包含<code>While True:</code>循环并使用<code>tornado.gen.sleep</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">minute_loop</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">await</span> do_something()</span><br><span class="line">        <span class="keyword">await</span> gen.sleep(<span class="number">60</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Coroutines that loop forever are generally started with spawn_callback().</span></span><br><span class="line">IOLoop.current().spawn_callback(minute_loop)</span><br></pre></td></tr></table></figure>
<p>有时，一个更复杂的循环可能是可取的。例如，前一个循环每<code>60+N</code>秒运行，N是<code>do_something</code>的运行时间。要准确每60秒运行，使用上面的interleaving模式:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">minute_loop2</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    <span class="title">while</span> <span class="title">True</span>:</span></span><br><span class="line">        nxt = gen.sleep(<span class="number">60</span>)  <span class="comment"># Start the clock.</span></span><br><span class="line">        <span class="keyword">await</span> do_something()  <span class="comment"># Run while the clock is ticking.</span></span><br><span class="line">        <span class="keyword">await</span> nxt  <span class="comment"># Wait for the timer to run out.</span></span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h2><p>Queue example - a concurrent web spider</p>
<p>Tornado的<code>tornado.queues</code>模块实现了协程异步 生产者(producer)/消费者(consumer)模式，类似于由Python标准库的<code>queue</code>模块为线程(thread)实现的模式。</p>
<p>yields <code>Queue.get</code>协程暂停直到队列中有项。如果队列设置了最大大小集(yield <code>Queue.put</code>)协程暂停，直到有另一个项。</p>
<p><code>Queue</code>维护未完成的任务计数，从0开始。<code>put</code>递增计数，<code>task_done</code>递减它。</p>
<p>web-spider栗子，队列开始仅包含base_url。当worker获取它解析的链接和队列放出新的页面，然后调用<code>task_done</code>递减计数。最终，worker取出其url没有过的页面，也没有留在队列中工作。因此，worker调用<code>task_done</code>递减计数器归零。主协程，它等待<code>join</code>，取消暂停和完成。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> datatime <span class="keyword">import</span> timedelta</span><br><span class="line"><span class="keyword">from</span> html.parser <span class="keyword">import</span> HTMLParser</span><br><span class="line"><span class="keyword">from</span> ulllib.parse <span class="keyword">import</span> urljoin, urldefrag</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tornado <span class="keyword">import</span> gen, httpclient, ioloop, queues</span><br><span class="line"></span><br><span class="line">base_url = <span class="string">'http://www.tornadoweb.org/en/stable/'</span></span><br><span class="line">concurrency = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get_links_from_url</span><span class="params">(url)</span>:</span></span><br><span class="line">    <span class="string">"""Download the page at `url` and parse it for links.</span></span><br><span class="line"><span class="string">    Returned links have had the fragment after `#` removed, and have been made bsolute so,</span></span><br><span class="line"><span class="string">    e.g. the URL 'gen.html#tornado.gen.coroutine' becomes</span></span><br><span class="line"><span class="string">    'http://www.tornadoweb.org/en/stable/gen.html'.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    response = <span class="keyword">await</span> httpclient.AsyncHTTPClient().fetch(url)</span><br><span class="line">    print(<span class="string">'fetched %s'</span> % url)</span><br><span class="line"></span><br><span class="line">    html = response.body.decode(<span class="string">'errors='</span>ignore<span class="string">')</span></span><br><span class="line"><span class="string">    return [urljoin(url, remove_fragment(new_url))</span></span><br><span class="line"><span class="string">            for new_url in get_links(html)]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def remove_fragment(url):</span></span><br><span class="line"><span class="string">    pure_url, frag = urldefrag(url)</span></span><br><span class="line"><span class="string">    return pure_url</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def get_links(html):</span></span><br><span class="line"><span class="string">    class URLSeeker(HTMLParser):</span></span><br><span class="line"><span class="string">        def __init__(self):</span></span><br><span class="line"><span class="string">            HTMLParser.__init__(self)</span></span><br><span class="line"><span class="string">            self.urls = []</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        sef handle_starttag(self, tag, attrs):</span></span><br><span class="line"><span class="string">            href = dict(attrs).get('</span>hre<span class="string">f')</span></span><br><span class="line"><span class="string">            if href and tag == '</span>a<span class="string">':</span></span><br><span class="line"><span class="string">                self.urls.append(href)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    url_seeker = URLSeeker()</span></span><br><span class="line"><span class="string">    url_seeker.feed(html)</span></span><br><span class="line"><span class="string">    return url_seeker.urls</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">async def main():</span></span><br><span class="line"><span class="string">    q = queues.Queue()</span></span><br><span class="line"><span class="string">    start = time.time()</span></span><br><span class="line"><span class="string">    fetching, fetched = set(), set()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    async def fetch_url(currrent_url):</span></span><br><span class="line"><span class="string">        if current_url in fetching:</span></span><br><span class="line"><span class="string">            return</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        print('</span>fetching %s<span class="string">' % current_url)</span></span><br><span class="line"><span class="string">        fetching.add(current_url)</span></span><br><span class="line"><span class="string">        urls = await get_links_from_url(current_url)</span></span><br><span class="line"><span class="string">        fetched.add(current_url)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        for new_url in urls:</span></span><br><span class="line"><span class="string">            # Only follow links beneath the base URL</span></span><br><span class="line"><span class="string">            if new_url.startswith(base_url):</span></span><br><span class="line"><span class="string">                await q.put(new_url)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    async def worker():</span></span><br><span class="line"><span class="string">        async for url in q:</span></span><br><span class="line"><span class="string">            if url in None:</span></span><br><span class="line"><span class="string">                return</span></span><br><span class="line"><span class="string">            try:</span></span><br><span class="line"><span class="string">                await fetch_url(url)</span></span><br><span class="line"><span class="string">            except Exception as e:</span></span><br><span class="line"><span class="string">                print('</span>Exception: %s %s<span class="string">' % (e, url))</span></span><br><span class="line"><span class="string">            finally:</span></span><br><span class="line"><span class="string">                q.task_done()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    await q.put(base_url)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # Start workers, then wait for the work queue to be empty.</span></span><br><span class="line"><span class="string">    workers = gen.multi([worker() for _ in range(concurrency)])</span></span><br><span class="line"><span class="string">    await q.join(timeout=timedelta(seconds=300))</span></span><br><span class="line"><span class="string">    assert fetching == fetched</span></span><br><span class="line"><span class="string">    print('</span>Done <span class="keyword">in</span> %d seconds, fetched %s URLs.<span class="string">' % (</span></span><br><span class="line"><span class="string">        time.time() - start, len(fetched)))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # Signal all the workers to exit.</span></span><br><span class="line"><span class="string">    for _ in range(concurrency):</span></span><br><span class="line"><span class="string">        await q.put(None)</span></span><br><span class="line"><span class="string">    await workers</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if __name__ == '</span>__main__<span class="string">':</span></span><br><span class="line"><span class="string">    io_loop = ioloop.IOLoop.current()</span></span><br><span class="line"><span class="string">    io_loop.run_sync(main)</span></span><br></pre></td></tr></table></figure>
<p><br><br><br><br><br></p>
<h2 id="Tornado-web程序结构"><a href="#Tornado-web程序结构" class="headerlink" title="Tornado web程序结构"></a>Tornado web程序结构</h2><p>Structure of a Tornado web application</p>
<p>一个Tornado web程序通常由一个或多个<code>RequestHandler</code>子类组成，<code>Application</code>对象是哪些路由进入的请求的处理程序(handler)，<code>main()</code>函数来启动server。</p>
<p>一个最小化的hello world栗子:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tornado.ioloop</span><br><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.write(<span class="string">"Hello, world"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_app</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> tornado.web.Application([</span><br><span class="line">        (<span class="string">r"/"</span>, MainHandler),</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app = make_app()</span><br><span class="line">    app.listen(<span class="number">8888</span>)</span><br><span class="line">    tornado.ioloop.IOLoop.current().start()</span><br></pre></td></tr></table></figure>
<p><br></p>
<h3 id="Application对象"><a href="#Application对象" class="headerlink" title="Application对象"></a>Application对象</h3><p><code>Application</code>对象是负责全局配置，包括映射请求到处理程序(handler)的路由表。</p>
<p>路由表是<code>URLSpec</code>对象的列表(或元组)，其中每一个包含(至少)一个正则表达式和一个处理类(handler class)。顺序匹配，第一匹配规则被使用。如果正则表达式中包含捕获组，这些组的路径参数将被传递给处理程序(handler)的HTTP方法。如果字典作为<code>URLSpec</code>的第三个参数传递，它提供将初始化参数传递给<code>RequestHandler.initialize</code>。最后，<code>URLSpec</code>可以有一个名称，这将允许它与<code>RequestHandler.reverse_url</code>使用。</p>
<p>栗子:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># / URL 映射到 MainHandler</span></span><br><span class="line"><span class="comment"># /story/后跟数字 映射到 StoryHandler，数字(作为字符串)被传递给StoryHandler.get</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span><span class="params">(RequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.write(<span class="string">'&lt;a href="%s"&gt; link to story 1&lt;/a&gt;'</span> %</span><br><span class="line">                  self.reverse_url(<span class="string">"story"</span>, <span class="string">"1"</span>))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StoryHandler</span><span class="params">(RequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(self, db)</span>:</span></span><br><span class="line">        self.db = db</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, story_id)</span>:</span></span><br><span class="line">        self.write(<span class="string">"this is story %s"</span> % story_id)</span><br><span class="line"></span><br><span class="line">app = Application([</span><br><span class="line">    url(<span class="string">r"/"</span>, MainHandler),</span><br><span class="line">    url(<span class="string">r"/story/([0-9]+)"</span>, StoryHandler, dict(db=db), name=<span class="string">"story"</span>)</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<p><code>Application</code>构造器采用许多关键字参数，可用于定制应用程序的行为和启用可选功能。查看<code>Application.settings</code>获取完整列表。</p>
<p><br><br><br></p>
<h3 id="RequestHandler子类"><a href="#RequestHandler子类" class="headerlink" title="RequestHandler子类"></a>RequestHandler子类</h3><p>Subclassing RequestHandler</p>
<p>大部分Tornado Web应用程序的工作是<code>RequestHandler</code>子类完成的。主入口点的处理程序子类(handler subclass)是正在处理的HTTP方法(<code>get()</code>, <code>post()</code>)的方法命名。例如，每个handler可以定义这些方法中的一种或多种，以处理不同的HTTP动作。如上所述，这些方法将于对应于匹配的路由规则的捕获组参数来调用。</p>
<p>在处理程序内部，调用如<code>RequestHandler.render</code>或<code>RequestHandler.write</code>来产生响应(response)。<code>render()</code>通过名称加载一个模板，并与给定的参数来渲染它。<code>write()</code>被用于非基于模板(non-template-based)输出。它接受字符串，字节和字典(字典被编码为json)。</p>
<p><code>ReqestHandler</code>中的许多方法都设计在子类中重写(overridden)，并在整个application中使用。这是常见的定义<code>BaseHandler</code>类，覆盖方法如<code>write_error</code>, <code>get_current_user</code>，并为你所有指定的handler继承<code>BaseHandler</code>而不是<code>RequestHandler</code>。</p>
<p><br><br><br></p>
<h3 id="处理请求输入"><a href="#处理请求输入" class="headerlink" title="处理请求输入"></a>处理请求输入</h3><p>Handling request input</p>
<p>request handler可以访问表示与<code>self.quest</code>获取当前请求的对象。查看<code>HTTPServerRequest</code>类来获取完整的列表。</p>
<p>通过HTML表单中使用的格式请求的数据将为你解析，并在如<code>get_query_argument</code>和<code>get_body_argument</code>方法中可用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFormHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.write(<span class="string">'&lt;html&gt;&lt;body&gt;&lt;form action="/myform" method="POST"&gt;'</span></span><br><span class="line">                   <span class="string">'&lt;input type="text" name="message"&gt;'</span></span><br><span class="line">                   <span class="string">'&lt;input type="submit" value="Submit"&gt;'</span></span><br><span class="line">                   <span class="string">'&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.set_header(<span class="string">"Conten-Type"</span>, <span class="string">"text/plain"</span>)</span><br><span class="line">        self.write(<span class="string">"You wrote"</span> + self.get_body_argument)</span><br></pre></td></tr></table></figure>
<p>由于HTML表单的编码是模糊的，以元素中的一个参数是否为单一值(single value)或一个列表，<code>RequestHandler</code>有独特的方法，以允许application表明它是否期望一个列表。对于列表，使用<code>get_query_arguments</code>和<code>get_body_arguments</code>来代替它们的singular counterparts。</p>
<p>通过表单上传的文件在<code>self.request.files</code>可用，它映射名称(html <code>input type=&quot;file&quot;</code>元素)到一个文件列表。每个文件是<code>{&quot;filename&quot;:..., &quot;content_type&quot;:..., &quot;body&quot;:...}</code>格式的字典。<code>files</code>对象仅表示文件是否以一种form wrapper上传(如<code>multipart/form-data</code> 内容类型)。如果不使用这种格式，原始上传数据在<code>self.request.body</code>可用。默认情况下上传的文件在内存中完全缓冲(fully buffered)。如果你要处理的文件太大，但想在内存中舒适保存，可参考<code>stream_request_body</code>类装饰器。</p>
<p>由于HTML格式编码的怪癖，Tornado并不试图统一参数和其它输入类型的形式。特别是，我们不解析JSON请求主体。Applicaton希望使用JSON而不是form-encoding可以覆盖<code>prepare</code>来解析它们的请求:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prepare</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> self.request.headers.get(<span class="string">"Content-Type"</span>, <span class="string">""</span>).startswith(<span class="string">'"application/json"'</span>):</span><br><span class="line">        self.json_args = json.loads(self.request.body)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self.json_args = <span class="keyword">None</span></span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="重写RequestHandler方法"><a href="#重写RequestHandler方法" class="headerlink" title="重写RequestHandler方法"></a>重写RequestHandler方法</h3><p>Overriding RequestHandler methods</p>
<p>除了<code>get()</code>, <code>post()</code>…，在<code>RequestHandler</code>某些其它方法被设计成在必要时由子类重写。在每次请求，调用以下顺序进行:</p>
<ol>
<li>在每个请求上，一个新的<code>RequestHandler</code>对象被创建</li>
<li><code>initialize()</code>被调用，从Application配置的初始化参数。初始化通常应该只保存传入成员变量的参数，不产生任何输出或调用(如<code>send_error</code>)</li>
<li><code>prepare()</code>被调用。这是最有用的，由所有handler subclass共享的基类，作为prepare被无论哪个HTTP方法所调用。<code>prepare</code>可产生输出，如果它调用<code>finish</code>或<code>redirect</code>，这里处理停止</li>
<li>当其中一个HTTP方法被调用时: <code>get()</code>, <code>post()</code>, <code>put()</code>。如果URL正则中包含捕获组(capturing group)，它们将被作为参数传递给该方法</li>
<li>当请求完成后，调用<code>on_finish()</code>。对于大多数handler这个在<code>get()</code>返回后立即调用。在调用<code>finish()</code>之后使用<code>tornado.web.asynchronous</code>装饰器来装饰handler</li>
</ol>
<p>在<code>RequestHandler</code>文档中，所有的方法都设计来可重写。一些最常用的重写方法:</p>
<ul>
<li><code>writre_error</code>: 输出HTML错误页面</li>
<li><code>on_connection_close</code>: 当客户端断开连接时调用。应用可选择检测此情况并停止进一步的处理。注意，不能保证一个关闭的连接能够被及时发现</li>
<li><code>get_current_user</code></li>
<li><code>get_user_locale</code>: 返回当前用户的Locale对象</li>
<li><code>set_default_headers</code>: 用于在响应中设置其它header</li>
</ul>
<p><br><br><br></p>
<h3 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h3><p>Error Handling</p>
<p>如果handler抛出一个异常，Tornado将调用<code>RequestHandler.write_error</code>来生成一个错误页。<code>tornado.web.HTTPError</code>可用来生成一个特定状态码。所有其它异常返回500状态。</p>
<p>debug模式下的默认错误页面包含一个stack trace和对错误的一行说明。要生成自定义错误页，重写<code>RequestHandler.write_error</code>。可通过如<code>write</code>和<code>render</code>方法来产生输出。如果错误是由异常导致的，一个<code>exc_info</code>将作为一个关键字参数传递。</p>
<p>也可通过调用<code>set_status</code>产生与常规处理方法<code>write_error</code>生成的错误页面，编写一个响应，并返回。特殊异常<code>tornado.web.Finish</code>可抛出终止处理而不调用<code>write_error</code>在简单返回不方便时。</p>
<p>对于404错误，使用<code>default_handler_class</code>应用设置(Application setting)。此处理程序应重写<code>prepare</code>，而不是像<code>get()</code>方法更具体的方法，所以它与任何HTTP方法工作。如上所述应该产生错误页面: 要么抛出<code>HTTPError(404)</code>和重写<code>write_error</code>，或调用<code>self.set_status(404)</code>和直接在<code>prepare()</code>中产生响应。</p>
<p><br><br><br></p>
<h3 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h3><p>Redirection</p>
<p>Tornado中有两种主要的方式重定向请求: <code>RequestHandler.redirect</code>和<code>RedirectHandler</code>。</p>
<p>可在<code>RequestHandler</code>方法中使用<code>self.redirect()</code>来重定向到别处。这有一个<code>permanent</code>的可选参数，可用它来表示永久的重定向。<code>permanent</code>的默认值为<code>False</code>，其产生一个<code>302 Found</code> HTTP响应码，适合像<code>POST</code>请求成功之后使用。如果<code>permanent</code>为<code>true</code>， 则使用<code>301 Moved Permanently</code> HTTP响应码，其用于重定向到一个规范友好的URL。</p>
<p><code>RedirectHandler</code>让你直接在Application路由表中配置重定向，栗子:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app = tornado.web.Application([</span><br><span class="line">    url(<span class="string">r"/app"</span>, tornado.web.RedirectHandler,</span><br><span class="line">        dict(url=<span class="string">"http://xxx.com"</span>)),</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<p><code>RedirectHandler</code>同样支持正则表达式取代。栗子:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app = tornado.web.Application([</span><br><span class="line">    url(<span class="string">r"/photos/(.*)"</span>, MyPhotoHandler),</span><br><span class="line">    url(<span class="string">r"/pictures/(.*)"</span>, tornado.web.RedirectHandler,</span><br><span class="line">        dict(url=<span class="string">r"/photo/&#123;0&#125;)),</span></span><br><span class="line"><span class="string">])</span></span><br></pre></td></tr></table></figure>
<p>不像<code>RequestHandler.redirect</code>，<code>RedirectHandler</code>默认使用永久重定向。这因为路由表在运行时不发生变化，被认定为时永久性的，而在处理中发现重定向可能改变其它逻辑的结果。要使用<code>RedirectHandler</code>发送一个临时的重定向，将<code>permanent=False</code>添加到<code>RedirectHandler</code>初始化参数。</p>
<p><br><br><br></p>
<h3 id="异步处理程序"><a href="#异步处理程序" class="headerlink" title="异步处理程序"></a>异步处理程序</h3><p>Asynchronous handlers</p>
<p>某些处理方法(如<code>prepare()</code>和HTTP的<code>get()</code>, <code>post()</code>…)可能会被重写为协程，使处理程序异步。</p>
<p>Tornado同样支持使用<code>tornado.web.asynchronous</code>装饰器异步处理的回调风格，但这种风格已经过时，将在Tornado6中一处。新的应用应该使用协程来代替它。</p>
<p>使用协程的一个简单处理程序的栗子:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        http = tornado.httpclient.AsyncHTTPClient()</span><br><span class="line">        response = <span class="keyword">await</span> http.fetch(<span class="string">"http://friendfeed-api.com/v2/feed/bret"</span>)</span><br><span class="line">        json = tornado.escape.json_decode(response.body)</span><br><span class="line">        self.write(<span class="string">"Fetched "</span> + str(len(json[<span class="string">"entries"</span>])) + <span class="string">" entries "</span></span><br><span class="line">                   <span class="string">"from the FriendFeed API"</span>)</span><br></pre></td></tr></table></figure>
<p>更多高级的异步的栗子，查考文档。</p>
<p><br><br><br><br><br></p>
<h2 id="模板和UI"><a href="#模板和UI" class="headerlink" title="模板和UI"></a>模板和UI</h2><p>Templates and UI</p>
<p>Tornado包含了一个简单、快速、灵活的模板语言。想想Django和Jinja2。</p>
<p>Tornado还可与任何其它Python模板语言使用，虽然没有规定集成这些系统到<code>RequestHandler.render</code>里。简单地渲染模板为字符串，并将其传递到<code>RequestHandler.write</code>。</p>
<p><br></p>
<h3 id="配置模板"><a href="#配置模板" class="headerlink" title="配置模板"></a>配置模板</h3><p>Configuring templates</p>
<p>默认情况下，Tornado在引用它的<code>.py</code>文件中的同一目录下查找模板文件。要把模板文件放在不同的目录中，使用<code>template_path</code>应用设置。如果你有不同的模板路径用于不同的处理程序，请重写<code>RequestHandler.get_template_path</code>。</p>
<p>要从非文件系统位置载入模板，子类<code>tornado.template.BaseLoader</code>将在模板并传递一个实例作为<code>template_loader</code>应用设置。</p>
<p>默认缓存编译的模板。要关闭这个缓存和重新加载模板，使用<code>compiled_template_cache=False</code>或<code>debug=True</code>应用设置。</p>
<p><br><br><br></p>
<h3 id="模板语法"><a href="#模板语法" class="headerlink" title="模板语法"></a>模板语法</h3><p>Template syntax</p>
<p>Tornado模板仅仅是HTML(或其它基于文本的格式)与Python控制序列和嵌入在标记内的表达式，想想Django模板和Jinja2。</p>
<p>表达式可以是任意Python表达式，包括函数调用。模板代码在包括以下对象和函数的命名空间执行(请注意，以下列表适用于使用<code>RequestHandler.render</code>和<code>render_string</code>渲染模板。如果你直接使用在<code>RequestHandler</code>外的<code>tornado.template</code>模块，那么许多内容是不存在的。)</p>
<ul>
<li><code>escape</code>: <code>tornado.escape.xhtml_escape</code>的别名</li>
<li><code>xhtml_escape</code>: <code>tornado.escape.xhtml_escape</code>的别名</li>
<li><code>url_escape</code>: <code>tornado.escape.url_escape</code>的别名</li>
<li><code>json_encode</code>: <code>tornado.escape.json_encode</code>的别名</li>
<li><code>squeeze</code>: <code>tornado.escape.squeeze</code>的别名</li>
<li><code>linkify</code>: <code>tornado.escape.linkify</code>的别名</li>
<li><code>datetime</code>: Python的<code>datetime</code>模块</li>
<li><code>handler</code>: 目前的<code>RequestHandler</code>对象</li>
<li><code>request</code>: <code>handler.request</code>的别名</li>
<li><code>current_user</code>: <code>handler.current_user</code>的别名</li>
<li><code>locale</code>: <code>handler.locale</code>的别名</li>
<li><code>_</code>: <code>handler.locale.translate</code>的别名</li>
<li><code>static_url</code>: <code>handler.static_url</code>的别名</li>
<li><code>xsrf_form_html</code>: <code>handler.xsrf_form_html</code>的别名</li>
<li><code>reverse_url</code>: <code>Application.reverse_url</code>的别名</li>
<li>所有条目从应用的<code>ui_methods</code>和<code>ui_modules</code></li>
<li>任何关键字参数传递给<code>render</code>或<code>render_string</code></li>
</ul>
<p>当你在构建一个真正的应用时，你会想要使用Tornado模板的所用功能，尤其是模板继承。阅读<code>tornado.template</code>部分了解详细信息。</p>
<p>引擎盖下，Tornado模板直接转换为Python。模板中的表达式是逐字复制到Python函数中。我们不设法防止模板语言的任何东西。最后，如果你写的模板表达式内随机的东西，当你执行模板可能会获得随机的Python错误。</p>
<p>所有的模板输出默认被转义(escape)，使用<code>tornado.escape.xhtml_escape</code>函数。这个行为可通过全局地传递<code>autoescape=None</code>给应用或<code>tornado.template.Loader</code>构造器，对于模板文件指示<figure class="highlight plain"><figcaption><span>autoescape None%&#125;```或通过```&#123;% raw ... %&#125;```代替```&#123;&#123; ... &#125;&#125;```。此外，在每一个可选择转义函数名的地方，可用`None`代替。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">虽然Tornado的自动转义为避免XSS漏洞有帮助，但它并不是在所有情况下都有效。例如在JS或CSS表达式的某些地方，可能需要额外的转义。此外，必须小心地使用HTML双引号`&quot;`和`xhtml_escape`，可能包含不受信任的内容，或者必须为属性使用单独地转义函数。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### UI模块</span><br><span class="line"></span><br><span class="line">UI modules</span><br><span class="line"></span><br><span class="line">Tornado支持UI模块，可以很容易地在你的应用中支持标准的、可重用的UI组件。UI模块都喜欢特殊的函数调用来渲染网页和组件，它们可以包装自己的CSS和JS。</span><br><span class="line"></span><br><span class="line">例如，如果要实现一个博客，你想拥有的博客条目同时出现在博客主页和每个博客页面上，你可以编写一个`Entry`模块在两个页面上渲染它们。首先，为你的UI模块创建一个Python模块:</span><br><span class="line"></span><br><span class="line">```py</span><br><span class="line"># uimodules.py</span><br><span class="line">class Entry(tonado.web.UIModule):</span><br><span class="line">    def render(self, entry, show_commnets=False):</span><br><span class="line">        return self.render_string(&quot;module-entry.html, entry=entry, show_comments=show_comments&quot;)</span><br></pre></td></tr></table></figure></p>
<p>在应用中设置<code>ui_modules</code>告诉Tornado使用<code>uimodules.py</code>:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> uimodules</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        entries = self.db.query(<span class="string">"SELECT * FROM entries ORDER BY date DESC"</span>)</span><br><span class="line">        self.render(<span class="string">"home.html"</span>, entries=entries)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EntryHander</span><span class="params">(tornado.web.ReqestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, entry_id)</span>:</span></span><br><span class="line">        entry = self.db.get(<span class="string">"SELECT * FROM entries WHERE id = %s, entry_id"</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> entry: <span class="keyword">raise</span> tornado.web.HTTPError(<span class="number">404</span>)</span><br><span class="line">        self.render(<span class="string">"entry.html"</span>, entry=entry)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">settings = &#123;</span><br><span class="line">    <span class="string">"ui_modules"</span>: uimodules,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">application = tornado.web.Application([</span><br><span class="line">    (<span class="string">r"/"</span>, HomeHandler),</span><br><span class="line">    (<span class="string">r"/entry/([0-9])"</span>, EntryHandler),</span><br><span class="line">], **settings)</span><br></pre></td></tr></table></figure>
<p>在模板内，你可以使用<figure class="highlight plain"><figcaption><span>module %&#125;```调用模块，例如在`home.html`中调用`Entry`模块:</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">```jinja2</span><br><span class="line">&#123;% for entry in entries%&#125;</span><br><span class="line">&#123;% module Entry(entry) %&#125;</span><br><span class="line">&#123;% end %&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>entry.html</code>中:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% module Entry(entry, show_comments=True) %&#125;</span><br></pre></td></tr></table></figure>
<p>模块可以通过重写<code>embedded_css</code>, <code>embedded_javascript</code>, <code>javascript_files</code>或<code>css_files</code>方法来包含自定义的CSS和JS函数:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Entry</span><span class="params">(tornado.web.UIModule)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">embedded_css</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">".entry &#123; margin-bottom: 1em; &#125;"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">render</span><span class="params">(self, entry, show_comments=False)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.render_string(<span class="string">"module-entry"</span>, show_comments=show_comments)</span><br></pre></td></tr></table></figure>
<p>模块CSS和JS将包含一次，不管一个页面中这个模块使用了多少次。CSS总是包含在页面的<code>&lt;head&gt;</code>，JS总是包含在<code>&lt;/body&gt;</code>标记之前在页面的页面结束标记。</p>
<p>当不需要附加的Python代码，模板文件本身可以用作一个模块。例如，前面的栗子可以改写在<code>module-entry.html</code>模块:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; set_resources(embedded_css=&quot;.entry &#123; margin-bottom: 1em; &#125;&quot;) &#125;&#125;</span><br><span class="line">&lt;!-- more template html... --&gt;</span><br></pre></td></tr></table></figure>
<p>经修订的模板模块将与下栗被调用:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% module Template(&quot;module-entry.html&quot;, show_comments=True) %&#125;</span><br></pre></td></tr></table></figure>
<p>该<code>set_resources</code>功能尽在通过<br><figure class="highlight plain"><figcaption><span>module Template(...) %&#125;```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">调用模板。不同于</span><br><span class="line">```&#123;% include %&#125;```，</span><br><span class="line">模板模块具有从它们的包含模板的独特命名空间——它们只能看到全局模板命名空间和自己的关键字参数。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 认证和安全</span><br><span class="line"></span><br><span class="line">Authentication and security</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;br&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### Cookie和secure cookies</span><br><span class="line"></span><br><span class="line">可以使用`set_cookie`方法在用户浏览器中设置cookie:</span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line">class MainHandler(tornado.web.ReqestHandler):</span><br><span class="line">    def get(self):</span><br><span class="line">        if not self.get_cookie(&quot;mycookie&quot;):</span><br><span class="line">            self.set_cookie(&quot;mycookie&quot;, &quot;myvalue&quot;)</span><br><span class="line">            self.write(&quot;Your cookie was not set yet!&quot;)</span><br><span class="line">        else:</span><br><span class="line">            self.write(&quot;Your cookie was set!&quot;)</span><br></pre></td></tr></table></figure></p>
<p>cookie是不安全的，可以很容易地被客户修改。如果你需要设置cookie，请确定当前登录的用户，你需要签属(signed)你的cookie来防止伪造。Tornado支持使用<code>set_secure_cookie</code>和<code>get_secure_cookie</code>方法来签属(sign)cookie。要使用这些方法，你需要在创建应用时指定一个名为<code>cookie_secret</code>的密钥键。你可以在应用中设置关键字参数来传递给应用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">application = tornado.web.Application([</span><br><span class="line">    (<span class="string">r"/"</span>, MainHandler),</span><br><span class="line">], cookie_secret=<span class="string">"__TODO:_GENERATE_YOUR_OWN_RANDOM_VALUE_HERE__"</span>)</span><br></pre></td></tr></table></figure>
<p>签属的cookie含有时间戳和HMAC签名的cookie编码值。如果cookie是旧的，或者签名不匹配，<code>get_secure_cookie</code>将会返回<code>None</code>就像没有设置cookie那样。上面栗子的安全版本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.get_secure_cookie(<span class="string">"mycookie"</span>):</span><br><span class="line">            self.set_secure_cookie(<span class="string">"mycookie"</span>, <span class="string">"myvalue"</span>)</span><br><span class="line">            self.write(<span class="string">"Your cookie was not set yet!"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.write(<span class="string">"Your cookie was set!"</span>)</span><br></pre></td></tr></table></figure>
<p>Tornado的secure cookie保证完整性，但不保密。也就是说，cookie不能被修改，但可以被用户看到。<code>cookie_secret</code>是一个对称密钥并且必须保密——得到这个值的人都可以制作自己的签名的cookie。</p>
<p>默认情况下，Tornado的cookie在30天后过期。可对<code>set_secure_cookie</code>使用<code>expires_days</code>参数和<code>max_age_days</code>来修改。</p>
<p>Tornado同样支持多个签名密钥来启用签名轮询。<code>cookie_secret</code>必须与整数密钥版本作为关键字和相应的secret作为字典的值。将当前使用的签名密钥必须在应用中设置为<code>key_version</code>，但在字典的所有其它键都允许cookie签名认证，如果设置在cookie中的是正确的密钥版本。要更新cookie，可通过查询<code>get_secure_cookie_key_version</code>获取当前的签名密钥版本。</p>
<p><br><br><br></p>
<h3 id="用户认证"><a href="#用户认证" class="headerlink" title="用户认证"></a>用户认证</h3><p>User authentication</p>
<p>当前已认证的用户在每个request handler中可使用<code>self.current_user</code>，在每个模板中为<code>current_user</code>。默认情况下，<code>current_user</code>为<code>None</code>。</p>
<p>要在应用中执行用户身份认证，需要在request handler中重写<code>get_current_user</code>以基于cookie的值确定当前用户。下面是一个让用户登录到应用，简单地指定一个昵称，然后将其保存到cookie中:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_current_user</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.get_secure_cookie(<span class="string">"user"</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span><span class="params">(BaseHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.current_user:</span><br><span class="line">            self.redirect(<span class="string">"/login"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        name = tornado.escape.xhtml_escape(self.current_user)</span><br><span class="line">        self.write(<span class="string">"Hello, "</span> + name)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginHandler</span><span class="params">(BaseHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.write(<span class="string">'&lt;html&gt;&lt;body&gt;&lt;form action="/login" method="post"&gt;'</span></span><br><span class="line">            <span class="string">'Name: &lt;input type="text" name="name"&gt;'</span></span><br><span class="line">            <span class="string">'&lt;input type="submit" value="Sign in"&gt;'</span></span><br><span class="line">            <span class="string">'&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.set_secure_cookie(<span class="string">"user"</span>, self.get_argument(<span class="string">"name"</span>))</span><br><span class="line">        self.redirect(<span class="string">"/"</span>)</span><br><span class="line"></span><br><span class="line">application = tornado.web.Application([</span><br><span class="line">    (<span class="string">r"/"</span>, MainHandler),</span><br><span class="line">    (<span class="string">r"/login"</span>, LoginHandler),</span><br><span class="line">], cookie_secret=<span class="string">"__TODO:_GENERATE_YOUR_OWN_RANDOM_VALUE_HERE__"</span>)</span><br></pre></td></tr></table></figure>
<p>你可以要求用户在使用<code>tornado.web.authenticated</code> Python装饰器处登录。如果请求的方法带有此装饰器，并且用户没有登录，则他们将被重定向到<code>login_url</code>或其它设置。重写上面的栗子:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span><span class="params">(BaseHandler)</span>:</span></span><br><span class="line"><span class="meta">    @tornado.web.authenticated</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        name = tornado.escaple.xhtml_escape(self.current_user)</span><br><span class="line">        self.write(<span class="string">"Hello, "</span> + name)</span><br><span class="line"></span><br><span class="line">settings = &#123;</span><br><span class="line">    <span class="string">"cookie_secret"</span>: <span class="string">"__TODO:_GENERATE_YOUR_OWN_RANDOM_VALUE_HERE__"</span>,</span><br><span class="line">    <span class="string">"login_url"</span>:<span class="string">"/login"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">application = tornado.web.Application([</span><br><span class="line">    (<span class="string">r"/"</span>, MainHandler),</span><br><span class="line">    (<span class="string">r"/login"</span>, LoginHandler),</span><br><span class="line">], **settings)</span><br></pre></td></tr></table></figure>
<p>如果你使用<code>authenticate</code>装饰器装饰一个<code>post()</code>方法，并且用户没有登录，则Server会返回403响应。<code>@authenticated</code>装饰器简单来说就是<code>if not self.current_user: self.redirect()</code>的快捷键，并且可能不适用于非基于浏览器的登录方案。</p>
<p><br><br><br></p>
<h3 id="第三方认证"><a href="#第三方认证" class="headerlink" title="第三方认证"></a>第三方认证</h3><p>Third party authentication</p>
<p><code>tornado.auth</code>模块实现了许多受欢迎的网站上提供的认证(authentication)和授权(authorization)协议，包括Google, FaceBook, Twitter…</p>
<p>下面是一个使用谷歌认证的示例，存储Google credential到cookie以便后续访问使用:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoogleOAuth2LoginHandler</span><span class="params">(tornado.web.RequestHandler, tornado.auth.GoogleOAuth2Mixin)</span>:</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.get_argument(<span class="string">'code'</span>, <span class="keyword">False</span>):</span><br><span class="line">            user = <span class="keyword">await</span> self.get_authenticated_user(</span><br><span class="line">                redirect_uri=<span class="string">"http://your.site.com/auth/google"</span>,</span><br><span class="line">                code=self.get_argument(<span class="string">'code'</span>))</span><br><span class="line">            <span class="comment"># Save the user with e.g. set_secure_cookie</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">await</span> self.authorize_redirect(</span><br><span class="line">            redirect_uri=<span class="string">'http://your.site.com/auth/google'</span>,</span><br><span class="line">            client_id=self.setting[<span class="string">'google_oauth'</span>][<span class="string">'key'</span>],</span><br><span class="line">            scope=[<span class="string">'profile'</span>, <span class="string">'email'</span>],</span><br><span class="line">            response_type=<span class="string">'code'</span>,</span><br><span class="line">            extra_params=&#123;<span class="string">'approval_prompt'</span>: <span class="string">'auto'</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>更多详细内容，请参考<code>tornado.auth</code>文档。</p>
<p><br><br><br></p>
<h3 id="跨站请求伪造保护"><a href="#跨站请求伪造保护" class="headerlink" title="跨站请求伪造保护"></a>跨站请求伪造保护</h3><p>Cross-site request forgery protection</p>
<p>跨站请求伪造(Cross-site request forgery, XSRF)，是Web应用的一个常见的问题。</p>
<p>防止XSRF普遍接受的解决方案是每个用户的cookie使用不可预测的值，此值包含网站上每个表单提交的额外参数。如果表单提交的cookie和值不匹配，则请求可能是伪造的。</p>
<p>Tornado内置了XSRF保护。要在你的站点中包含它，启用应用<code>scrf_cookies</code>设置:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">settings = &#123;</span><br><span class="line">    <span class="string">"cookie_secret"</span>: <span class="string">"__TODO:_GENERATE_YOUR_OWN_RANDOM_VALUE_HERE__"</span>,</span><br><span class="line">    <span class="string">"login_url"</span>: <span class="string">"/login"</span>,</span><br><span class="line">    <span class="string">"xsrf_cookies"</span>: <span class="keyword">True</span></span><br><span class="line">&#125;</span><br><span class="line">application = tornado.web.Application([</span><br><span class="line">    (<span class="string">r"/"</span>, MainHandler),</span><br><span class="line">    (<span class="string">r"/login"</span>, LoginHandler),</span><br><span class="line">], **settings)</span><br></pre></td></tr></table></figure>
<p>如果设置了<code>xsrf_cookies</code>，Tornado Web Application将为所有用户设置<code>_xsrf</code> cookie，并拒绝没有包含正确的<code>_xsrf</code>值的所有<code>POST</code>, <code>PUT</code>, <code>DELETE</code>请求。如果你打开了此设置，你需要一切形式的<code>POST</code>提交中包含此字段。你可以使用特殊的UIModule <code>vsrf_form_html()</code>，在所有模板中可用:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=&quot;/new_message&quot; method=&quot;post&quot;&gt;</span><br><span class="line">  &#123;% module xsrf_form_html() %&#125;</span><br><span class="line">  &lt;input type=&quot;text&quot; name=&quot;message&quot;/&gt;</span><br><span class="line">  &lt;input type=&quot;submit&quot; value=&quot;Post&quot;/&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<p>如果你提交AJAX <code>POST</code>请求，你还需要构造JS来包括每个请求的<code>_xsfr</code>值。所有包含<code>_xsrf</code>请求AJAX POST的JQuery函数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function getCookie(name) &#123;</span><br><span class="line">    var r = document.cookie.match(&quot;\\b&quot; + name + &quot;=([^;]*)\\b&quot;);</span><br><span class="line">    return r ? r[1] : undefined;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jQuery.postJSON = function(url, args, callback) &#123;</span><br><span class="line">    args._xsrf = getCookie(&quot;_xsrf&quot;);</span><br><span class="line">    $.ajax(&#123;url: url, data: $.param(args), dataType: &quot;text&quot;, type: &quot;POST&quot;,</span><br><span class="line">        success: function(response) &#123;</span><br><span class="line">        callback(eval(&quot;(&quot; + response + &quot;)&quot;));</span><br><span class="line">    &#125;&#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>对于<code>PUT</code>和<code>DELETE</code>请求，XSRF token可能会通过HTTP <code>X-XSRFToken</code> Header进行传递。使用<code>xsrf_form_html</code>时，XSRF cookie被正常设置，但是在不使用任何形式的纯JS应用中，可能需要手动访问<code>self.xsrf_token</code>。</p>
<p>如果你需要在每个handler中自定义XSRF行为，你可以重写<code>RequestHandler.check_xsrf_cookie()</code>。例如，如果你有一个不使用cookie的API，你可能希望通过使<code>check_xsrf_cookie</code>什么也不做来禁用XSRF保护。然而，如果你支持基于cookie和非基于cookie的认证，只要求当前请求使用cookie认证XSRF保护是重要的。</p>
<p><br><br><br></p>
<h3 id="DNS重新绑定"><a href="#DNS重新绑定" class="headerlink" title="DNS重新绑定"></a>DNS重新绑定</h3><p>DNS Rebinding</p>
<p>DNS重新绑定是一种攻击，可以绕过同源策略，并允许外部站点访问内部网络的资源。使用TLS的应用不容易受到这种攻击。没有使用TLS的应用依赖网络层的访问控制，应警惕通过验证的HTTP Header的<code>Host</code>被DNS重新绑定。This means passing a restrictive hostname pattern to either a <code>HostMatches</code> router or the first argument of <code>Application.add_handlers</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># BAD: uses a default host pattern of r'.*'</span></span><br><span class="line">app = Application([(<span class="string">'/foo'</span>, FooHandler)])</span><br><span class="line"></span><br><span class="line"><span class="comment"># GOOD: only matches localhost or its ip address.</span></span><br><span class="line">app = Application()</span><br><span class="line">app.add_handlers(<span class="string">r'(localhost|127\.0\.0\.1)'</span>,</span><br><span class="line">                 [(<span class="string">'/foo'</span>, FooHandler)])</span><br><span class="line"></span><br><span class="line"><span class="comment"># GOOD: same as previous example using tornado.routing.</span></span><br><span class="line">app = Application([</span><br><span class="line">    (HostMatches(<span class="string">r'(localhost|127\.0\.0\.1)'</span>),</span><br><span class="line">            [(<span class="string">'/foo'</span>, FooHandler)]),</span><br><span class="line">    ])</span><br></pre></td></tr></table></figure>
<p>此外，应用的<code>default_host</code>参数，和<code>DefaultHostMatches</code>路由器不能在应用中使用，这可能受到DNS重新绑定，因为它有一个通配符主模式类似的效果。</p>
<p><br><br><br><br><br></p>
<h2 id="运行和部署"><a href="#运行和部署" class="headerlink" title="运行和部署"></a>运行和部署</h2><p>Running and deploying</p>
<p>自从Tornado提供了自己的HTTPServer，运行和部署它便和其它Python Web框架有点不同。不同于配置WSGI，你只需要写一个<code>main()</code>函数来启动Server:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    app = make_app()</span><br><span class="line">    app.listen(<span class="number">8888</span>)</span><br><span class="line">    IOLoop.current().start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>请注意，这可能需要增加每个进程可打开的文件数(open files)，可能修改<code>ulimit</code>限制。</p>
<p><br><br><br></p>
<h3 id="进程和端口"><a href="#进程和端口" class="headerlink" title="进程和端口"></a>进程和端口</h3><p>Processes and ports</p>
<p>由于Python的GIL(Global Interpreter Lock)，有必要运行多个Python进程，以充分利用多CPU机器。通常，最好为每个CPU运行一个进程。</p>
<p>Tornado包含了一个内置的多进程模式，一次可启动多个进程。这需要稍微修改以下启动方式:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    app = make_app()</span><br><span class="line">    server = tornado.httpserver.HTTPServer(app)</span><br><span class="line">    server.bind(<span class="number">8888</span>)</span><br><span class="line">    server.start(<span class="number">0</span>)  <span class="comment"># forks one process per cpu</span></span><br><span class="line">    IOLoop.current().start()</span><br></pre></td></tr></table></figure>
<p>这是启动多个进程，并让它们使用相同的端口最简单的方法，虽然它有一定的局限性。首先，每个子进程都会有自己的IOLoop，因此在fork前没有事物触及IOLoop示例是很重要的。第二，在这个模型中很难做到零停机更新(zero-downtime updates)。最后，由于所有的进程共享同一端口更难以单独监控。</p>
<p>对于更复杂的部署，建议单独启动进程，并监听不同的端口。<code>supervisord</code>是一个好办法。当每个进程使用了不同的端口，通常需要一个外部的负载均衡器(如HAProxy, Nginx)以单独的访问地址提供给访问者。</p>
<p><br><br><br></p>
<h3 id="运行在负载均衡器后"><a href="#运行在负载均衡器后" class="headerlink" title="运行在负载均衡器后"></a>运行在负载均衡器后</h3><p>Running behind a load balancer</p>
<p>当运行在如Nginx这样的负载均衡器之后，建议传递<code>xheaders=True</code>给HTTPServer构造器。这将告诉Tornado使用<code>X-Real-IP</code>用户Header，来获取用户IP地址，而不是负载均衡器的IP地址。</p>
<p>一个栗子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">user nginx;</span><br><span class="line">worker_processes 1;</span><br><span class="line"></span><br><span class="line">error_log /var/log/nginx/error.log;</span><br><span class="line">pid /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">    use epoll;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    # Enumerate all the Tornado servers here</span><br><span class="line">    upstream frontends &#123;</span><br><span class="line">        server 127.0.0.1:8000;</span><br><span class="line">        server 127.0.0.1:8001;</span><br><span class="line">        server 127.0.0.1:8002;</span><br><span class="line">        server 127.0.0.1:8003;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    include /etc/nginx/mime.types;</span><br><span class="line">    default_type application/octet-stream;</span><br><span class="line">    access_log /var/log/nginx/access.log;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout 65;</span><br><span class="line">    proxy_read_timeout 200;</span><br><span class="line">    sendfile on;</span><br><span class="line">    tcp_nopush on;</span><br><span class="line">    tcp_nodelay on;</span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_min_length 1000;</span><br><span class="line">    gzip_proxied any;</span><br><span class="line">    gzip_types text/plain text/html text/css text/xml</span><br><span class="line">               application/x-javascript application/xml</span><br><span class="line">               application/atom+xml text/javascript;</span><br><span class="line"></span><br><span class="line">    # Only retry if there was a communication error, not a timeout</span><br><span class="line">    # on the Tornado server (to avoid propagating &quot;queries of death&quot;</span><br><span class="line">    # to all frontends)</span><br><span class="line">    proxy_next_upstream error;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line"></span><br><span class="line">        # Allow file uploads</span><br><span class="line">        client_max_body_size 50M;</span><br><span class="line"></span><br><span class="line">        location ^~ /static/ &#123;</span><br><span class="line">            root /var/www;</span><br><span class="line">            if ($query_string) &#123;</span><br><span class="line">                expires max;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        location = /favicon.ico &#123;</span><br><span class="line">            rewrite (.*) /static/favicon.ico;</span><br><span class="line">        &#125;</span><br><span class="line">        location = /robots.txt &#123;</span><br><span class="line">            rewrite (.*) /static/robots.txt;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass_header Server;</span><br><span class="line">            proxy_set_header Host $http_host;</span><br><span class="line">            proxy_redirect off;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header X-Scheme $scheme;</span><br><span class="line">            proxy_pass http://frontends;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="静态文件和侵略性的文件缓存"><a href="#静态文件和侵略性的文件缓存" class="headerlink" title="静态文件和侵略性的文件缓存"></a>静态文件和侵略性的文件缓存</h3><p>Static files and aggressive file caching</p>
<p>你可以通过在应用中指定<code>static_path</code>来设置Tornaodo提供静态文件:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">settings = &#123;</span><br><span class="line">    <span class="string">"static_path"</span>: os.path.join(os.path.dirname(__file__), <span class="string">"static"</span>),</span><br><span class="line">    <span class="string">"cookie_secret"</span>: <span class="string">"__TODO:_GENERATE_YOUR_OWN_RANDOM_VALUE_HERE__"</span>,</span><br><span class="line">    <span class="string">"login_url"</span>: <span class="string">"/login"</span>,</span><br><span class="line">    <span class="string">"xsrf_cookies"</span>: <span class="keyword">True</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">application = tornado.web.Application([</span><br><span class="line">    (<span class="string">r"/"</span>, MainHandler),</span><br><span class="line">    (<span class="string">r"/login"</span>, LoginHandler),</span><br><span class="line">    (<span class="string">r"/(apple-touch-icon\.png)"</span>, tornado.web.StaticFileHandler,</span><br><span class="line">     dict(path=settings[<span class="string">'static_path'</span>])),</span><br><span class="line">], **settings)</span><br></pre></td></tr></table></figure>
<p>此设置会自动设置以<code>/static/</code>的所有请求到静态目录，如<code>http://localhost:8888/static/foo.png</code>将从指定的静态目录提供静态文件。同样还有<code>/robots.txt</code>和<code>/favicon.ico</code>，即便它们并未以<code>/static/</code>为前缀。</p>
<p>在上面的设置，我们已明确的配置Tornado从<code>StaticFileHandler</code>提供<code>apple-touch-icon.png</code>。</p>
<p>要提高性能，通常是浏览器缓存静态资源，因此浏览器将不会发送不必要的<code>If-Modified-Since</code>或<code>Etag</code>请求，这可能会阻止页面的渲染。Tornado支持这一开箱即用的静态内容版本。</p>
<p>要使用此功能，在你的模板中使用<code>static_url</code>方法，而不是在你的HTML中直接输入静态文件:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">title</span>&gt;</span>FriendFeed - &#123;&#123; _("Home") &#125;&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; static_url("</span><span class="attr">images</span>/<span class="attr">logo.png</span>") &#125;&#125;"/&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>static_url()</code>函数会将相对路径转换为如<code>/static/images/logo.png?v=aae54</code>这样的URI。<code>v</code>参数是<code>logo.png</code>的哈希内容，它的存在使得Tornado Server发送cache header到用户浏览器，这将使浏览器无限期缓存内容。</p>
<p>由于<code>v</code>参数使基于文件的内容，如果你更新文件并重启Server，它将发送一个新的<code>v</code>值，因此用户浏览器会自动获取新的文件。如果文件的内容没有改变，浏览器将继续使用本地缓存的副本而没有检查Server上的更新，显著提供渲染性能。</p>
<p>在生产环境，你可能希望从像Nginx这样更优化的静态文件服务器提供静态文件。你可以配置几乎所有的Web Server识别由<code>static_url</code>使用的标签，并设置相应的cache header。</p>
<p>栗子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location /static/ &#123;</span><br><span class="line">    root /var/friendfeed/static;</span><br><span class="line">    if ($query_string) &#123;</span><br><span class="line">        expires max;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p><br><br><br></p>
<h3 id="Debug模式和自动重载"><a href="#Debug模式和自动重载" class="headerlink" title="Debug模式和自动重载"></a>Debug模式和自动重载</h3><p>Debug mode and automatic reloading</p>
<p>如果将<code>debug=True</code>传递给<code>Application</code>构造器，应用将运行在debug/development模式下。在此模式下，一些便于开发调试的功能将被启用:</p>
<ul>
<li><code>autoreload=True</code>：应用会监视更改的源文件并在发生变化时自动重载。这样减少了在开发过程中手动重启服务。然后，某些错误可能导致无法启动。</li>
<li><code>compiled_template_cache=False</code>：模板不会被缓存。</li>
<li><code>static_hash_cache=False</code>：静态文件哈希值(由<code>static_url</code>函数使用)将不会被缓存。</li>
<li><code>serve_traceback=True</code>：当RequestHandler中的异常没有被捕获，将会生成一个包含stack trace的错误页面。</li>
</ul>
<p>自动重载模式不兼容<code>HTTPserver</code>的多进程模式。如果你正在使用自动重载模式，你不要给<code>HTTPServer.start</code>一个或多于一个参数(或调用<code>tornado.process.fork_processes</code>)。</p>
<p>调式模式的自动重载功能是可用作为<code>tornado.autoreload</code>独立(standalone)模块。这两个可以组合使用，以提供对语法错误的额外稳健：在应用中设置<code>autoreload=True</code>来在运行时检测改变，并使用<code>python -m tornado.autoreload myserver.py</code>启动来在启动时捕获任意语法错误或其它错误。</p>
<p>重载将失去任何Python解释器命令行参数(如<code>-u</code>)，因为它使用<code>sys.executable</code>和<code>sys.argv</code>来重新执行Python。此外，修改这些变量将导致重载行为不正确。</p>
<p><br><br><br></p>
<h3 id="WSGI"><a href="#WSGI" class="headerlink" title="WSGI"></a>WSGI</h3><p>Tornado通常是为了独立运行，而不用WSGI容器。然而，在一些环境中（如Google App Engine），只允许WSGI，应用程序无法运行自己的Server。在这种情况下，Tornado支持操作的限制模式，不支持异步操作，但允许在只有WSGI环境的Tornado功能的子集。未在WSIG模式允许的功能包括协程、<code>@asynchronous</code>装饰器，<code>AsyncHTTPclient</code>、<code>auth</code>模块和WebSockets。</p>
<p>你可以使用<code>tornado.wsgi.WSGIAdapter</code>将一个Tornado Application转换为WSGI application。</p>
<p>栗子:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"><span class="keyword">import</span> tornado.wsgi</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.write(<span class="string">'Hello, world'</span>)</span><br><span class="line"></span><br><span class="line">tornado_app = tornado.web.Application([</span><br><span class="line">    (<span class="string">r"/"</span>, MainHandler),</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">application = tornado.wsgi.WSGIAdapter(tornado_app)</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/DevOps/" rel="tag"># DevOps</a>
          
            <a href="/tags/Python/" rel="tag"># Python</a>
          
            <a href="/tags/Web/" rel="tag"># Web</a>
          
            <a href="/tags/Tornado/" rel="tag"># Tornado</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/10/11/HTMLCSS/" rel="next" title="HTML CSS">
                <i class="fa fa-chevron-left"></i> HTML CSS
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/12/26/Ansible/" rel="prev" title="Ansible">
                Ansible <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image" src="/images/leslie.jpg" alt="Leslie Zhang">
          
            <p class="site-author-name" itemprop="name">Leslie Zhang</p>
            <p class="site-description motion-element" itemprop="description">那一年我二十一岁，在我一生的黄金时代</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">70</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">133</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Zhang21" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:me@zhang21.cn" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://instagram.com/Zhang21_" target="_blank" title="Instagram">
                  
                    <i class="fa fa-fw fa-instagram"></i>Instagram</a>
              </span>
            
          
        </div>

        
        

        
        
<br>
<!--����������������ⲿ����,auto=1��ʾ�Զ�����-->
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=411315632&auto=0&height=66"></iframe>


        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#用户指南"><span class="nav-number">1.</span> <span class="nav-text">用户指南</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#介绍"><span class="nav-number">1.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#异步和非阻塞I-O"><span class="nav-number">1.2.</span> <span class="nav-text">异步和非阻塞I/O</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#阻塞"><span class="nav-number">1.2.1.</span> <span class="nav-text">阻塞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异步"><span class="nav-number">1.2.2.</span> <span class="nav-text">异步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#栗子"><span class="nav-number">1.2.3.</span> <span class="nav-text">栗子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#原生与装饰的协程"><span class="nav-number">1.2.4.</span> <span class="nav-text">原生与装饰的协程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何工作"><span class="nav-number">1.2.5.</span> <span class="nav-text">如何工作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何调用协程"><span class="nav-number">1.2.6.</span> <span class="nav-text">如何调用协程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#协程模式"><span class="nav-number">1.2.7.</span> <span class="nav-text">协程模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#调用阻塞函数"><span class="nav-number">1.2.7.1.</span> <span class="nav-text">调用阻塞函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Parallelism"><span class="nav-number">1.2.7.2.</span> <span class="nav-text">Parallelism</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Interleaving"><span class="nav-number">1.2.7.3.</span> <span class="nav-text">Interleaving</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Looping"><span class="nav-number">1.2.7.4.</span> <span class="nav-text">Looping</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在后台运行"><span class="nav-number">1.2.7.5.</span> <span class="nav-text">在后台运行</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Queue"><span class="nav-number">1.3.</span> <span class="nav-text">Queue</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tornado-web程序结构"><span class="nav-number">1.4.</span> <span class="nav-text">Tornado web程序结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Application对象"><span class="nav-number">1.4.1.</span> <span class="nav-text">Application对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RequestHandler子类"><span class="nav-number">1.4.2.</span> <span class="nav-text">RequestHandler子类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#处理请求输入"><span class="nav-number">1.4.3.</span> <span class="nav-text">处理请求输入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重写RequestHandler方法"><span class="nav-number">1.4.4.</span> <span class="nav-text">重写RequestHandler方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#错误处理"><span class="nav-number">1.4.5.</span> <span class="nav-text">错误处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重定向"><span class="nav-number">1.4.6.</span> <span class="nav-text">重定向</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异步处理程序"><span class="nav-number">1.4.7.</span> <span class="nav-text">异步处理程序</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模板和UI"><span class="nav-number">1.5.</span> <span class="nav-text">模板和UI</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置模板"><span class="nav-number">1.5.1.</span> <span class="nav-text">配置模板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模板语法"><span class="nav-number">1.5.2.</span> <span class="nav-text">模板语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#用户认证"><span class="nav-number">1.5.3.</span> <span class="nav-text">用户认证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第三方认证"><span class="nav-number">1.5.4.</span> <span class="nav-text">第三方认证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#跨站请求伪造保护"><span class="nav-number">1.5.5.</span> <span class="nav-text">跨站请求伪造保护</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DNS重新绑定"><span class="nav-number">1.5.6.</span> <span class="nav-text">DNS重新绑定</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运行和部署"><span class="nav-number">1.6.</span> <span class="nav-text">运行和部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#进程和端口"><span class="nav-number">1.6.1.</span> <span class="nav-text">进程和端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#运行在负载均衡器后"><span class="nav-number">1.6.2.</span> <span class="nav-text">运行在负载均衡器后</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#静态文件和侵略性的文件缓存"><span class="nav-number">1.6.3.</span> <span class="nav-text">静态文件和侵略性的文件缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Debug模式和自动重载"><span class="nav-number">1.6.4.</span> <span class="nav-text">Debug模式和自动重载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WSGI"><span class="nav-number">1.6.5.</span> <span class="nav-text">WSGI</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2017 &mdash; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Leslie Zhang</span>

<!--字数统计-->
  <div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count"> 字数: 1.0m</span>
</div>


  
</div>



<!--

  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.2</div>

-->


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  

    
      <script id="dsq-count-scr" src="https://Zhang21.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://zhang21.github.io/2019/10/14/Tornado/';
          this.page.identifier = '2019/10/14/Tornado/';
          this.page.title = 'Tornado';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://Zhang21.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  


  

  

</body>
</html>
