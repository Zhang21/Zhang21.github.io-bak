<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Helm - 风继续吹</title><meta name="Description" content="个人博客"><meta property="og:title" content="Helm" />
<meta property="og:description" content="参考：

docs: https://docs.helm.sh/
github: https://github.com/helm

环境：

el7x86_64
helm v3.3


" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhang21.cn/helm/" /><meta property="og:image" content="https://zhang21.cn/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-09-21T15:11:22&#43;00:00" />
<meta property="article:modified_time" content="2020-09-21T15:11:22&#43;00:00" /><meta property="og:site_name" content="My cool site" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://zhang21.cn/logo.png"/>

<meta name="twitter:title" content="Helm"/>
<meta name="twitter:description" content="参考：

docs: https://docs.helm.sh/
github: https://github.com/helm

环境：

el7x86_64
helm v3.3


"/>
<meta name="application-name" content="风继续吹">
<meta name="apple-mobile-web-app-title" content="风继续吹"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://zhang21.cn/helm/" /><link rel="prev" href="https://zhang21.cn/go/" /><link rel="next" href="https://zhang21.cn/flagger/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Helm",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/zhang21.cn\/helm\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/zhang21.cn\/images\/Apple-Devices-Preview.png",
                            "width":  3200 ,
                            "height":  2048 
                        }],"genre": "posts","keywords": "Helm, K8s, DevOps, CNCF","wordcount":  26542 ,
        "url": "https:\/\/zhang21.cn\/helm\/","datePublished": "2020-09-21T15:11:22+00:00","dateModified": "2020-09-21T15:11:22+00:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "Zhang21","logo": "https:\/\/zhang21.cn\/leslie.png"},"author": {
                "@type": "Person",
                "name": "Zhang21"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="风继续吹"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>风继续吹</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="https://github.com/zhang21" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="风继续吹"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>风继续吹</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="https://github.com/zhang21" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Helm</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://zhang21.cn" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Zhang21</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/cncf/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>cncf</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2020-09-21">2020-09-21</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;约 26542 字&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;预计阅读 53 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#概述">概述</a></li>
    <li><a href="#术语">术语</a></li>
    <li><a href="#介绍">介绍</a>
      <ul>
        <li><a href="#快速入门">快速入门</a>
          <ul>
            <li><a href="#先决条件">先决条件</a></li>
            <li><a href="#安装">安装</a>
              <ul>
                <li><a href="#从helm项目">从Helm项目</a></li>
                <li><a href="#从源码">从源码</a></li>
              </ul>
            </li>
            <li><a href="#初始化helm-chart">初始化Helm chart</a></li>
            <li><a href="#安装chart">安装Chart</a></li>
            <li><a href="#releases">Releases</a></li>
            <li><a href="#卸载release">卸载Release</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#主题">主题</a>
      <ul>
        <li><a href="#charts">Charts</a>
          <ul>
            <li><a href="#文件结构">文件结构</a></li>
            <li><a href="#chartyaml">Chart.yaml</a></li>
            <li><a href="#许可证和描述">许可证和描述</a></li>
            <li><a href="#依赖">依赖</a></li>
            <li><a href="#templates-and-values">Templates and Values</a></li>
            <li><a href="#用户自定义资源">用户自定义资源</a></li>
            <li><a href="#管理chart">管理chart</a></li>
            <li><a href="#仓库">仓库</a></li>
            <li><a href="#starter-packs">Starter Packs</a></li>
          </ul>
        </li>
        <li><a href="#hooks">Hooks</a>
          <ul>
            <li><a href="#可用的hooks">可用的hooks</a></li>
          </ul>
        </li>
        <li><a href="#测试">测试</a>
          <ul>
            <li><a href="#示例">示例</a></li>
          </ul>
        </li>
        <li><a href="#library">Library</a></li>
        <li><a href="#完整性校验">完整性校验</a></li>
        <li><a href="#仓库-1">仓库</a>
          <ul>
            <li><a href="#创建仓库">创建仓库</a></li>
          </ul>
        </li>
        <li><a href="#注册中心">注册中心</a></li>
        <li><a href="#架构">架构</a>
          <ul>
            <li><a href="#目的">目的</a></li>
            <li><a href="#组件">组件</a></li>
            <li><a href="#实现">实现</a></li>
          </ul>
        </li>
        <li><a href="#高级技术">高级技术</a>
          <ul>
            <li><a href="#后置渲染">后置渲染</a></li>
            <li><a href="#go-sdk">GO SDK</a></li>
            <li><a href="#后端存储">后端存储</a></li>
          </ul>
        </li>
        <li><a href="#rbac">RBAC</a>
          <ul>
            <li><a href="#管理用户账户">管理用户账户</a></li>
            <li><a href="#角色集群角色角色绑定集群角色绑定">角色、集群角色、角色绑定、集群角色绑定</a></li>
            <li><a href="#限制用户账户使用rbac访问">限制用户账户使用RBAC访问</a></li>
          </ul>
        </li>
        <li><a href="#插件">插件</a></li>
        <li><a href="#v2迁移到v3">V2迁移到V3</a></li>
        <li><a href="#弃用的k8s-api">弃用的k8s api</a></li>
        <li><a href="#版本支持">版本支持</a></li>
        <li><a href="#sql存储后端的权限管理">SQL存储后端的权限管理</a></li>
      </ul>
    </li>
    <li><a href="#最佳实践">最佳实践</a>
      <ul>
        <li><a href="#一般约定">一般约定</a>
          <ul>
            <li><a href="#chart名称">chart名称</a></li>
            <li><a href="#版本号">版本号</a></li>
            <li><a href="#格式化yaml">格式化YAML</a></li>
            <li><a href="#词">词</a></li>
          </ul>
        </li>
        <li><a href="#值">值</a>
          <ul>
            <li><a href="#命名约定">命名约定</a></li>
            <li><a href="#嵌套值">嵌套值</a></li>
            <li><a href="#使类型清晰">使类型清晰</a></li>
            <li><a href="#考虑用户如何使用你的值">考虑用户如何使用你的值</a></li>
            <li><a href="#valuesyaml">values.yaml</a></li>
          </ul>
        </li>
        <li><a href="#模板">模板</a>
          <ul>
            <li><a href="#templates目录架构">templates目录架构</a></li>
            <li><a href="#定义的模板的名称">定义的模板的名称</a></li>
            <li><a href="#格式化模板">格式化模板</a></li>
            <li><a href="#生成模板中的空格">生成模板中的空格</a></li>
            <li><a href="#注释">注释</a></li>
            <li><a href="#在模板和模板输出中使用json">在模板和模板输出中使用JSON</a></li>
          </ul>
        </li>
        <li><a href="#依赖-1">依赖</a>
          <ul>
            <li><a href="#版本">版本</a></li>
            <li><a href="#条件和标记">条件和标记</a></li>
          </ul>
        </li>
        <li><a href="#标签和注释">标签和注释</a>
          <ul>
            <li><a href="#标签还是注释">标签还是注释</a></li>
            <li><a href="#标准的标签">标准的标签</a></li>
          </ul>
        </li>
        <li><a href="#pods和podtemplates">Pods和PodTemplates</a>
          <ul>
            <li><a href="#镜像">镜像</a></li>
            <li><a href="#镜像拉取策略">镜像拉取策略</a></li>
            <li><a href="#podtemplate应该声明选择器">PodTemplate应该声明选择器</a></li>
          </ul>
        </li>
        <li><a href="#自定义资源的定义">自定义资源的定义</a>
          <ul>
            <li><a href="#使用资源前安装crd声明">使用资源前安装CRD声明</a></li>
          </ul>
        </li>
        <li><a href="#rbac-1">RBAC</a>
          <ul>
            <li><a href="#yaml配置">YAML配置</a></li>
            <li><a href="#rbac资源应该被默认创建">RBAC资源应该被默认创建</a></li>
            <li><a href="#使用rbac资源">使用RBAC资源</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#模板-1">模板</a>
      <ul>
        <li><a href="#入门">入门</a>
          <ul>
            <li><a href="#charts-1">Charts</a></li>
            <li><a href="#示例-1">示例</a></li>
            <li><a href="#第一个模板">第一个模板</a></li>
          </ul>
        </li>
        <li><a href="#内置对象">内置对象</a>
          <ul>
            <li><a href="#值文件">值文件</a></li>
            <li><a href="#删除一个默认键">删除一个默认键</a></li>
          </ul>
        </li>
        <li><a href="#模板函数和管道">模板函数和管道</a>
          <ul>
            <li><a href="#管道">管道</a></li>
            <li><a href="#default函数">default函数</a></li>
            <li><a href="#lookup函数">lookup函数</a></li>
            <li><a href="#操作符">操作符</a></li>
          </ul>
        </li>
        <li><a href="#函数列表">函数列表</a></li>
        <li><a href="#流程控制">流程控制</a>
          <ul>
            <li><a href="#if和else">if和else</a></li>
            <li><a href="#控制空格">控制空格</a></li>
            <li><a href="#使用with修改范围">使用with修改范围</a></li>
            <li><a href="#range循环">range循环</a></li>
          </ul>
        </li>
        <li><a href="#变量">变量</a></li>
        <li><a href="#命名模板">命名模板</a>
          <ul>
            <li><a href="#下划线文件">下划线文件</a></li>
            <li><a href="#声明和使用模板">声明和使用模板</a></li>
            <li><a href="#设置模板范围">设置模板范围</a></li>
            <li><a href="#include">include</a></li>
          </ul>
        </li>
        <li><a href="#在模板内访问文件">在模板内访问文件</a>
          <ul>
            <li><a href="#示例-2">示例</a></li>
            <li><a href="#路径助手">路径助手</a></li>
            <li><a href="#glob模式">Glob模式</a></li>
            <li><a href="#configmap和secrets的实用功能">ConfigMap和Secrets的实用功能</a></li>
            <li><a href="#编码">编码</a></li>
            <li><a href="#行">行</a></li>
          </ul>
        </li>
        <li><a href="#notestxt">NOTES.txt</a></li>
        <li><a href="#subcharts">Subcharts</a>
          <ul>
            <li><a href="#创建一个subchart">创建一个subchart</a></li>
            <li><a href="#对subchart添加值和模板">对subchart添加值和模板</a></li>
            <li><a href="#从parent-chart覆盖值">从parent chart覆盖值</a></li>
            <li><a href="#全局值">全局值</a></li>
            <li><a href="#共享模板">共享模板</a></li>
            <li><a href="#避免使用块">避免使用块</a></li>
          </ul>
        </li>
        <li><a href="#helmignore">.helmignore</a></li>
        <li><a href="#模板调试">模板调试</a></li>
        <li><a href="#yaml技巧">YAML技巧</a></li>
      </ul>
    </li>
    <li><a href="#helm命令">Helm命令</a></li>
    <li><a href="#社区指南">社区指南</a></li>
    <li><a href="#faq">FAQ</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>参考：</p>
<ul>
<li>docs: <a href="https://docs.helm.sh/">https://docs.helm.sh/</a></li>
<li>github: <a href="https://github.com/helm">https://github.com/helm</a></li>
</ul>
<p>环境：</p>
<ul>
<li>el7x86_64</li>
<li>helm v3.3</li>
</ul>
<br/>
<br/>
<hr>
<br/>
<br/>
<h1 id="概述">概述</h1>
<p><strong>Helm</strong>是Kubernetes生态系统中的一个软件包管理工具，主要用来管理<strong>Charts</strong>，有点类似于Ubuntu中的apt或CentOS中的yum。由go编写，是Deis公司发起的一个开源工具，有助于简化部署和管理Kubernetes应用。</p>
<p>在Kubernetes中，应用管理是需求最多、挑战最大的领域。Helm项目提供了一个统一软件打包方式，支持版本控制，可以大大简化Kubernetes应用分发与部署中的复杂性。</p>
<p>Helm Chart是用来封装 Kubernetes原生应用程序的一系列YAML文件。可以在你部署应用的时候自定义应用程序的一些 Metadata，以便于应用程序的分发。</p>
<p>对于应用发布者而言，可以通过 Helm 打包应用、管理应用依赖关系、管理应用版本并发布应用到软件仓库。</p>
<p>对于使用者而言，使用 Helm 后不用需要编写复杂的应用部署文件，可以以简单的方式在 Kubernetes 上查找、安装、升级、回滚、卸载应用程序。</p>
<br>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/Helm/Helm_Logo.png"
        data-srcset="/images/Helm/Helm_Logo.png, /images/Helm/Helm_Logo.png 1.5x, /images/Helm/Helm_Logo.png 2x"
        data-sizes="auto"
        alt="/images/Helm/Helm_Logo.png"
        title="/images/Helm/Helm_Logo.png" /></p>
<br>
<p>The package manager for Kubernetes.</p>
<p>Helm is the best way to find, share, and use software built for Kubernetes.</p>
<br>
<br>
<hr>
<br>
<br>
<h1 id="术语">术语</h1>
<p>Glossary: <a href="https://helm.sh/docs/glossary/">https://helm.sh/docs/glossary/</a></p>
<br>
<p><strong>Chart</strong></p>
<p>Helm包涵盖了将k8s资源安装到k8s集群所需的足够多的信息。
Charts包含了<code>Chart.yaml</code>文件核模板，默认值(<code>values.yaml</code>)，以及相关依赖。
Charts开发设计了良好定义的目录结构，并打包为chart archive。</p>
<br>
<p><strong>Chart Archive</strong></p>
<p>Chart包是被<code>tar</code>和<code>gzip</code>压缩（可选签名）的chart。</p>
<br>
<p><strong>Chart Dependency(Subcharts)</strong></p>
<p>Chart可以依赖于其它chart。依赖有两种方式：</p>
<ul>
<li>软依赖(soft): 如果另一个chart没有在集群中安装，chart可能会无法使用</li>
<li>硬依赖(hard): chart包含它所依赖的chart。（在<code>charts/</code>目录中）</li>
</ul>
<p>当一个chart打包(<code>helm package</code>)时，所有的依赖都会和它绑定。</p>
<br>
<p><strong>Chart Version</strong></p>
<p>每个chart都需要版本号。</p>
<br>
<p><strong>Chart.yaml</strong></p>
<p>chart的信息说明被存储在一个特定文件(<code>Chart.yaml</code>)。每个chart都必须有这个文件。</p>
<br>
<p><strong>helm</strong></p>
<p>Helm是k8s包管理器。作为一个操作系统包管理器，使其很容易在操作系统中安装工具。Helm使得k8s集群中安装应用和资源变得异常简单。</p>
<br>
<p><strong>Helm Configuration Files</strong></p>
<p>Helm将配置文件存储在XDG目录中。<code>helm</code>第一次运行，会自动生成。</p>
<p><strong>Kube Config(KUBECONFIG)</strong></p>
<p>helm客户端通过Kube config配置文件来理解k8s集群。默认<code>$HOME/.kube/config</code>。</p>
<br>
<p><strong>Lint</strong></p>
<p>Helm代码规范，规范一个chart是去验证其遵照Helm chart的标准规范和要求。Helm提供了<code>helm lint</code>命令。</p>
<br>
<p><strong>Provenance</strong></p>
<p>Helm chart可以由来源文件(provenance file)提供chart的出处以及它所包含的内容。</p>
<p>来源文件(<code>.prov</code>)是Helm安全的一部分。一个来源包含chart包文件的加密哈希值，<code>Chart.yaml</code>数据，一个签名块。当再加上一个钥匙链(keychain)时，可为chart用户提供以下能力：</p>
<ul>
<li>验证chart被可信第三方签名</li>
<li>验证chart文件没有被篡改</li>
<li>验证chart的元数据内容(<code>Chart.yaml</code>)</li>
<li>快速匹配chart的数据来源</li>
</ul>
<br>
<p><strong>Release</strong></p>
<p>发行版本。chart安装之后，Helm库会创建一个release来跟踪这个安装。</p>
<p>单个chart可以在同一个集群中安装多次，并能创建多个不同的版本。</p>
<br>
<p><strong>Release Number/Version</strong></p>
<p>单个版本号可以被升级多次。通过连续技术来跟踪升级发布版本。</p>
<br>
<p><strong>Rollback</strong></p>
<p>每一次发布会更新chart或者配置。当生成发布历史后，一次发布也可以被 rolled back 之前的发布版本号。回滚使用<code>helm rollback</code>命令。</p>
<p>重要的是, 每一次回滚版本会生成一个新的发布版本号。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">操作			版本号
install		release 1
upgrade		release 2
upgrade		release 3
rollback 1	release 4 (但使用release 1的配置)
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>Helm Library(SDK)</strong></p>
<p>Helm库（或SDK）涉及到go代码，可以直接与k8s API服务交互进行安装、升级、查询 以及移除k8s资源。</p>
<br>
<p><strong>Repository</strong></p>
<p>Helm chart可以被存储到专用的HTTP服务器上，称之为chart仓库。</p>
<p>Helm客户端可以指向零个或多个chart仓库。默认没有配置仓库，可使用<code>helm repo add</code>添加。</p>
<br>
<p><strong>Values</strong></p>
<p>Values 提供了一种使用您自己的信息覆盖模板默认值的方式。</p>
<p>Helm Chart是参数化的, 这意味着chart开发者可以在安装时显式配置。比如说，chart可以暴露<code>username</code>字段， 允许为服务设置一个用户名。这些可暴露的变量在Helm用语中称为<code>values</code>。</p>
<p>Values可在<code>helm install</code>, <code>helm upgrage</code>时设置。也可以在<code>values.yaml</code>文件中设置。</p>
<br>
<br>
<hr>
<br>
<br>
<h1 id="介绍">介绍</h1>
<p>Introduction: <a href="https://helm.sh/docs/intro/">https://helm.sh/docs/intro/</a></p>
<br>
<h2 id="快速入门">快速入门</h2>
<p>Quickstart: <a href="https://helm.sh/docs/intro/quickstart/">https://helm.sh/docs/intro/quickstart/</a></p>
<p>如何快速安装核使用Helm。</p>
<br>
<h3 id="先决条件">先决条件</h3>
<p>Prerequisites</p>
<p>使用Helm的前置条件：</p>
<ul>
<li>k8s集群
<ul>
<li>建议最新k8s稳定版</li>
<li><code>kubectl</code></li>
</ul>
</li>
<li>安装的安全配置(如果有的话)</li>
<li>安装和配置Helm</li>
</ul>
<p>注意Helm版本对应支持的k8s版本。</p>
<br>
<br>
<h3 id="安装">安装</h3>
<p>Install: <a href="https://helm.sh/docs/intro/install/">https://helm.sh/docs/intro/install/</a></p>
<p>从源码、或二进制安装Helm CLI。</p>
<br>
<h4 id="从helm项目">从Helm项目</h4>
<p>From The Helm Project</p>
<br>
<p><strong>从二进制包:</strong></p>
<ul>
<li>下载特定版本包: <a href="https://github.com/helm/helm/releases">https://github.com/helm/helm/releases</a></li>
<li>解压</li>
<li>添加到PATH</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">wget https://get.helm.sh/helm-v3.3.3-linux-amd64.tar.gz

tar -zxvf helm-v3.3.3-linux-amd64.tar.gz

mv helm /usr/local/bin/helm
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>从脚本:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
chmod <span class="m">700</span> get_helm.sh
./get_helm.sh
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="从源码">从源码</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">git clone https://github.com/helm/helm.git
<span class="nb">cd</span> helm
make
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="初始化helm-chart">初始化Helm chart</h3>
<p>Initialize a Helm Chart Repository</p>
<p>Helm安装好之后，你可以添加一个chart仓库。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 添加Helm官方仓库</span>
helm repo add stable https://kubernetes-charts.storage.googleapis.com/


<span class="c1"># 查看安装的charts列表</span>
helm search repo stable
NAME                                    CHART VERSION   APP VERSION                     DESCRIPTION
stable/acs-engine-autoscaler            2.2.2           2.1.1                           DEPRECATED Scales worker nodes within agent pools
stable/aerospike                        0.2.8           v4.5.0.5                        A Helm chart <span class="k">for</span> Aerospike in Kubernetes
stable/airflow                          4.1.0           1.10.4                          Airflow is a platform to programmatically autho...
stable/ambassador                       4.1.0           0.81.0                          A Helm chart <span class="k">for</span> Datawire Ambassador
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="安装chart">安装Chart</h3>
<p>Install an Example Chart</p>
<p>可以通过<code>helm install</code>命令安装chart。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">helm repo update

<span class="c1"># helm install，都会创建一个新的release</span>
<span class="c1"># 所以一个chart在同一个集群里面可以被安装多次，每一个都可以被独立的管理和升级</span>
helm install stable/mysql --generate-name
NAME: mysql-1600679719
LAST DEPLOYED: Mon Sep <span class="m">21</span> 17:15:23 <span class="m">2020</span>
NAMESPACE: default
STATUS: deployed
REVISION: <span class="m">1</span>
NOTES:
MySQL can be accessed via port <span class="m">3306</span> on the following DNS name from within your cluster:
mysql-1600679719.default.svc.cluster.local

To get your root password run:

    <span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span><span class="k">$(</span>kubectl get secret --namespace default mysql-1600679719 -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.data.mysql-root-password}&#34;</span> <span class="p">|</span> base64 --decode<span class="p">;</span> <span class="nb">echo</span><span class="k">)</span>

To connect to your database:

1. Run an Ubuntu pod that you can use as a client:

    kubectl run -i --tty ubuntu --image<span class="o">=</span>ubuntu:16.04 --restart<span class="o">=</span>Never -- bash -il

2. Install the mysql client:

    $ apt-get update <span class="o">&amp;&amp;</span> apt-get install mysql-client -y

3. Connect using the mysql cli, <span class="k">then</span> provide your password:
    $ mysql -h mysql-1600679719 -p

To connect to your database directly from outside the K8s cluster:
    <span class="nv">MYSQL_HOST</span><span class="o">=</span>127.0.0.1
    <span class="nv">MYSQL_PORT</span><span class="o">=</span><span class="m">3306</span>

    <span class="c1"># Execute the following command to route the connection:</span>
    kubectl port-forward svc/mysql-1600679719 <span class="m">3306</span>

    mysql -h <span class="si">${</span><span class="nv">MYSQL_HOST</span><span class="si">}</span> -P<span class="si">${</span><span class="nv">MYSQL_PORT</span><span class="si">}</span> -u root -p<span class="si">${</span><span class="nv">MYSQL_ROOT_PASSWORD</span><span class="si">}</span>

<span class="c1">#查看此chart的基本信息</span>
helm show chart stable/mysql
helm show all stable/mysql

</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="releases">Releases</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 查看chart发行版</span>
helm ls
NAME                    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART           APP VERSION
mysql-1600679719        default         <span class="m">1</span>               2020-09-21 17:15:23.169811348 +0800 CST deployed        mysql-1.6.7     5.7.30


<span class="c1"># 列出所有部署的发行</span>
helm list
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="卸载release">卸载Release</h3>
<p>使用<code>helm uninstall</code>命令卸载realease。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">helm uninstall mysql-1600679719
release <span class="s2">&#34;mysql-1600679719&#34;</span> uninstalled
</code></pre></td></tr></table>
</div>
</div><p>它会删除和该release相关的所有资源。使用<code>--keep-history</code>选项，Helm将保存release history。所以你可以审计集群历史甚至使用<code>helm rollback</code>回滚release。</p>
<br>
<br>
<hr>
<br>
<br>
<h1 id="主题">主题</h1>
<p>Topic Guides: <a href="https://helm.sh/docs/topics/">https://helm.sh/docs/topics/</a></p>
<br>
<h2 id="charts">Charts</h2>
<p>Charts: <a href="https://helm.sh/docs/topics/charts/">https://helm.sh/docs/topics/charts/</a></p>
<p>Helm使用的包格式称为charts。chart就是一个描述k8s相关资源的文件集合。单个chart可以用来部署简单或复杂的服务。</p>
<p>Chart是作为特定目录布局的文件被创建，它们可以打包到要部署的版本存档中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 下载一个chart，但不安装
helm pull xxx
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="文件结构">文件结构</h3>
<p>chart是一个组织在文件目录中的集合。目录名称就是chart名称(没有版本信息)。</p>
<p>示例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">wordpress/
  Chart.yaml          # 包含了chart信息的YAML文件
  LICENSE             # 可选: 包含chart许可证的纯文本文件
  README.md           # 可选: 可读的README文件
  values.yaml         # chart 默认的配置值
  values.schema.json  # 可选: 一个使用JSON结构的values.yaml文件
  charts/             # 包含chart依赖的其他chart
  crds/               # 自定义资源的定义
  templates/          # 模板目录， 当和values 结合时，可生成有效的Kubernetes manifest文件
  templates/NOTES.txt # 可选: 包含简要使用说明的纯文本文件
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="chartyaml">Chart.yaml</h3>
<p><code>Chart.yaml</code>文件是chart必须的。包含以下字段。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">chart API 版本 （必需）</span><span class="w">
</span><span class="w"></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">chart名称 （必需）</span><span class="w">
</span><span class="w"></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">语义化2 版本（必需）</span><span class="w">
</span><span class="w"></span><span class="nt">kubeVersion</span><span class="p">:</span><span class="w"> </span><span class="l">兼容Kubernetes版本的语义化版本（可选）</span><span class="w">
</span><span class="w"></span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l">一句话对这个项目的描述（可选）</span><span class="w">
</span><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">chart类型 （可选）</span><span class="w">
</span><span class="w"></span><span class="nt">keywords</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">关于项目的一组关键字（可选）</span><span class="w">
</span><span class="w"></span><span class="nt">home</span><span class="p">:</span><span class="w"> </span><span class="l">项目home页面的URL （可选）</span><span class="w">
</span><span class="w"></span><span class="nt">sources</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">项目源码的URL列表（可选）</span><span class="w">
</span><span class="w"></span><span class="nt">dependencies</span><span class="p">:</span><span class="w"> </span><span class="c"># chart 必要条件列表 （可选）</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">chart名称 (nginx)</span><span class="w">
</span><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">chart版本 (&#34;1.2.3&#34;)</span><span class="w">
</span><span class="w">    </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l">仓库URL (&#34;https://example.com/charts&#34;) 或别名 (&#34;@repo-name&#34;)</span><span class="w">
</span><span class="w">    </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">（可选） 解析为布尔值的yaml路径，用于启用、禁用chart (e.g. subchart1.enabled )</span><span class="w">
</span><span class="w">    </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="c"># （可选）</span><span class="w">
</span><span class="w">      </span>- <span class="l">用于一次启用/禁用 一组chart的tag</span><span class="w">
</span><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l">（可选） 决定是否加载chart的布尔值</span><span class="w">
</span><span class="w">    </span><span class="nt">import-values</span><span class="p">:</span><span class="w"> </span><span class="c"># （可选）</span><span class="w">
</span><span class="w">      </span>- <span class="l">ImportValue 保存源值到导入父键的映射。每项可以是字符串或者一对子/父列表项</span><span class="w">
</span><span class="w">    </span><span class="nt">alias</span><span class="p">:</span><span class="w"> </span><span class="l">（可选） chart中使用的别名。当你要多次添加相同的chart时会很有用</span><span class="w">
</span><span class="w"></span><span class="nt">maintainers</span><span class="p">:</span><span class="w"> </span><span class="c"># （可选）</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">维护者名字 （每个维护者都需要）</span><span class="w">
</span><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">维护者邮箱 （每个维护者可选）</span><span class="w">
</span><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">维护者URL （每个维护者可选）</span><span class="w">
</span><span class="w"></span><span class="nt">icon</span><span class="p">:</span><span class="w"> </span><span class="l">用做icon的SVG或PNG图片URL （可选）</span><span class="w">
</span><span class="w"></span><span class="nt">appVersion</span><span class="p">:</span><span class="w"> </span><span class="l">包含的应用版本（可选）。不需要是语义化的</span><span class="w">
</span><span class="w"></span><span class="nt">deprecated</span><span class="p">:</span><span class="w"> </span><span class="l">不被推荐的chart （可选，布尔值）</span><span class="w">
</span><span class="w"></span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">example</span><span class="p">:</span><span class="w"> </span><span class="l">按名称输入的批注列表 （可选）.</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p><strong>Chart和版本控制</strong></p>
<p>每个chart都必须有版本号。版本必须遵循SemVer2标准。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># nginx chart的版本字段version: 1.2.3
# 按照名称设置为
nginx-1.2.3.tgz
</code></pre></td></tr></table>
</div>
</div><p><code>Chart.yaml</code>文件中的<code>version</code>字段被很多Helm工具使用。当生成一个包时，<code>helm package</code>命令可以用<code>Chart.yaml</code>文件中找到的版本号作为包名的token。系统假设chart包名中的版本号可以与<code>Chart.yaml</code>文件中的版本号匹配。如果不满足这一假设会导致错误。</p>
<br>
<p><strong>apiVersion字段</strong></p>
<p>对于至少需要Helm3的chart，<code>apiVersion</code>字段应该是<code>v2</code>。</p>
<br>
<p><strong>kubeVersion字段</strong></p>
<p>可选的<code>kubeVersion</code>字段可以在支持的k8s版本上定义语义约束，Helm 在安装chart时会验证这个版本约束， 并在集群运行不支持的k8s版本时显示失败。</p>
<p>版本约束可以包含空格、比较操作符、逻辑操作符。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt;= 1.13.0 &lt; 1.15.0

&gt;= 1.13.0 &lt; 1.14.0 || &gt;= 1.14.1 &lt; 1.15.0

1.1 - 2.3.4
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>deprecated字段</strong></p>
<p>在Chart仓库管理chart时，有时需要废弃一个chart。<code>deprecated</code>字段可用来标记已弃用的chart。如果latest版本被标记为已弃用，则所有的chart都会被认为是已弃用的。以后可以通过发布未标记为已弃用的新版本来重新使用chart名称。</p>
<p><code>kubernetes/charts</code>项目遵循的弃用charts的流程为：</p>
<ul>
<li>升级chart的<code>Chart.yaml</code>文件，将这个文件标记为已弃用，并更改版本</li>
<li>在chart仓库中发布新版的chart</li>
<li>从源仓库中移除这个chart</li>
</ul>
<br>
<p><strong>type字段</strong></p>
<p><code>type</code>字段定义了chart的类型。有两种类型：</p>
<ul>
<li><code>application</code>：默认类型，是可以完全操作的标准chart。</li>
<li><code>library</code>：不能安装，提供针对chart构建的实用程序和功能。通常不包含任何资源对象。</li>
</ul>
<p>应用类型chart 可以作为库类型chart使用。可以通过将类型设置为<code>library</code>来实现。 然后这个库就被渲染成了一个库类型chart，所有的实用程序和功能都可以使用。所有的资源对象不会被渲染。</p>
<br>
<br>
<h3 id="许可证和描述">许可证和描述</h3>
<p>Chart LICENSE, README and NOTES</p>
<p>Chart也可以包含描述安装、配置和使用的文件，以及chart许可证。</p>
<p>LICENSE是一个包含了chart license的纯文本文件。chart可以包含一个许可证，因为在模板里不只是配置，还可能有编码逻辑。如果需要，还可以为chart安装的应用程序提供单独的许可证。</p>
<p>README自述文件，一般包含：</p>
<ul>
<li>chart提供的应用或服务的描述</li>
<li>运行chart的先决条件或要求</li>
<li><code>values.yaml</code>的可选项和默认值的描述</li>
<li>与chart的安装或配置相关的其它信息</li>
</ul>
<p>chart也会包含一个简短的纯文本<code>templates/NOTES.txt</code>文件，这会在安装后及查看版本状态时打印出来。由于此文件是在运行<code>helm install</code>或<code>helm status</code>时打印到STDOUT的，因此建议保持内容简短，并指向自述文件以获取更多详细信息。</p>
<br>
<br>
<h3 id="依赖">依赖</h3>
<p>Chart Dependencies</p>
<p>Helm中，chart可能会依赖其它任意个chart。这些依赖可使用<code>dependencies</code>字段(<code>Chart.yaml</code>)动态链接，或写入<code>charts/</code>目录。</p>
<br>
<p><strong>dependencies字段</strong></p>
<p>当前chart依赖的其它chart会在<code>dependencies</code>字段定义为一个列表。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">dependencies</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apache</span><span class="w">
</span><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">1.2.3</span><span class="w">
</span><span class="w">    </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l">https://example.com/charts</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mysql</span><span class="w">
</span><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">3.2.1</span><span class="w">
</span><span class="w">    </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l">https://another.example.com/charts</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>必须使用<code>helm repo add</code>在本地添加仓库。</p>
<p>一旦你定义好了依赖，运行<code>helm dependency update</code>就会使用你的依赖文件下载所有你指定的chart到你的<code>charts/</code>目录。</p>
<br>
<p><strong>alias字段</strong></p>
<p>为依赖chart添加一个别名，会使用别名作为新依赖chart的名称。 需要使用其他名称访问chart时可以使用<code>alias</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">dependencies:
  - name: subchart
    repository: http://localhost:10191
    version: 0.1.0
    alias: new-subchart-1
  - name: subchart
    repository: http://localhost:10191
    version: 0.1.0
    alias: new-subchart-2
  - name: subchart
    repository: http://localhost:10191
    version: 0.1.0
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>tags和condition字段</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">dependencies</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">subchart1</span><span class="w">
</span><span class="w">    </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:10191</span><span class="w">
</span><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">0.1.0</span><span class="w">
</span><span class="w">    </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">subchart1.enabled, global.subchart1.enabled</span><span class="w">
</span><span class="w">    </span><span class="nt">tags</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">front-end</span><span class="w">
</span><span class="w">      </span>- <span class="l">subchart1</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">subchart2</span><span class="w">
</span><span class="w">    </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:10191</span><span class="w">
</span><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">0.1.0</span><span class="w">
</span><span class="w">    </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l">subchart2.enabled,global.subchart2.enabled</span><span class="w">
</span><span class="w">    </span><span class="nt">tags</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">back-end</span><span class="w">
</span><span class="w">      </span>- <span class="l">subchart2</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c">#values.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">subchart1</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w"></span><span class="nt">tags</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">front-end</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">  </span><span class="nt">back-end</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 可以在CLI使用--set参数来设置标签和条件值
helm install --set tags.front-end=true --set subchart2.enabled=false
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>通过依赖导入sub values</strong></p>
<p>在某些情况下，允许子chart的值作为公共默认传递到父chart中是值得的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># parent&#39;s Chart.yaml file</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">dependencies</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">subchart</span><span class="w">
</span><span class="w">    </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:10191</span><span class="w">
</span><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">0.1.0</span><span class="w">
</span><span class="w">    </span><span class="nt">import-values</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">data</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># child&#39;s values.yaml file</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">exports</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">myint</span><span class="p">:</span><span class="w"> </span><span class="m">99</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p><strong>通过charts目录手动管理依赖</strong></p>
<p>如果对依赖进行更多控制，通过将有依赖关系的chart复制到<code>charts/</code>目录中来显式表达这些依赖关系。</p>
<p>要将依赖放入<code>charts/</code>目录，使用<code>helm pull</code>命令。</p>
<br>
<br>
<h3 id="templates-and-values">Templates and Values</h3>
<p>Helm Chart模板是按照<a href="https://golang.org/pkg/text/template/" target="_blank" rel="noopener noreffer ">Go模板语言</a>书写。让我想起了Django模板语言，Jinja2模板语言。</p>
<p>所有模板语言存放在chart的<code>templates/</code>目录下。当Helm渲染chart时，它会通过模板引擎遍历目录中的每个文件。</p>
<p>模板的Value通过两种方式提供：</p>
<ul>
<li>通过<code>values.yaml</code>文件提供，此文件包含了默认值。</li>
<li>用户可以提供一个包含value的yaml文件，在<code>helm install</code>时使用它。</li>
</ul>
<p>当用户提供自定义的value时，会覆盖<code>values.yaml</code>中的值。</p>
<br>
<p><strong>模板文件示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">apiVersion: v1
kind: ReplicationController
metadata:
  name: deis-database
  namespace: deis
  labels:
    app.kubernetes.io/managed-by: deis
spec:
  replicas: 1
  selector:
    app.kubernetes.io/name: deis-database
  template:
    metadata:
      labels:
        app.kubernetes.io/name: deis-database
    spec:
      serviceAccount: deis-database
      containers:
        - name: deis-database
          image: {{ .Values.imageRegistry }}/postgres:{{ .Values.dockerTag }}
          imagePullPolicy: {{ .Values.pullPolicy }}
          ports:
            - containerPort: 5432
          env:
            - name: DATABASE_STORAGE
              value: {{ default &#34;minio&#34; .Values.storage }}
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>预定义的Values</strong></p>
<p>以下值是预定义的，对每个模板都有效，并且可以被覆盖。和所有值一样，名称 区分大小写：</p>
<ul>
<li><code>Release.Name</code>: 版本名称(非chart的)</li>
<li><code>Release.Namespace</code>: 发布的chart版本的命名空间</li>
<li><code>Release.Service</code>: 组织版本的服务</li>
<li><code>Release.IsUpgrade</code>: 如果当前操作是升级或回滚，设置为true</li>
<li><code>Release.IsInstall</code>: 如果当前操作是安装，设置为true</li>
<li><code>Chart</code>: <code>Chart.yaml</code>的内容。因此，chart的版本可以从<code>Chart.Version</code>获得， 并且维护者在<code>Chart.Maintainers</code>里</li>
<li><code>Files</code>：chart中的包含了非特殊文件的类图对象</li>
<li><code>Capabilities</code>: 包含了Kubernetes版本信息的类图对象</li>
</ul>
<br>
<p><strong>范围</strong></p>
<p>Scope, Dependencies, and Values</p>
<p>Values文件可以声明顶级chart的值，以及<code>charts/</code>目录中包含的其他任意chart。</p>
<br>
<p><strong>全局Values</strong></p>
<p>Helm支持特殊的<code>global</code>值。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">global</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">MyWordPress</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>这个值以<code>.Values.global.app</code>在所有chart中有效。</p>
<br>
<p><strong>架构文件</strong></p>
<p>有时候，chart容器可能想基于它们的values值定义一个结构，这可以在<code>values.schema.json</code>文件中定义一个架构实现。</p>
<p>示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;$schema&#34;</span><span class="p">:</span> <span class="s2">&#34;https://json-schema.org/draft-07/schema#&#34;</span><span class="p">,</span>
  <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;image&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Container Image&#34;</span><span class="p">,</span>
      <span class="nt">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;repo&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span>
        <span class="p">},</span>
        <span class="nt">&#34;tag&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span>
    <span class="p">},</span>
    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Service name&#34;</span><span class="p">,</span>
      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span>
    <span class="p">},</span>
    <span class="nt">&#34;port&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Port&#34;</span><span class="p">,</span>
      <span class="nt">&#34;minimum&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;integer&#34;</span>
    <span class="p">},</span>
    <span class="nt">&#34;protocol&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nt">&#34;required&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&#34;protocol&#34;</span><span class="p">,</span>
    <span class="s2">&#34;port&#34;</span>
  <span class="p">],</span>
  <span class="nt">&#34;title&#34;</span><span class="p">:</span> <span class="s2">&#34;Values&#34;</span><span class="p">,</span>
  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这个架构会应用values值并验证它。当执行以下任意命令时会进行验证： <code>helm install, helm upgrage, helm lint, helm template</code>。</p>
<br>
<br>
<h3 id="用户自定义资源">用户自定义资源</h3>
<p>Custom Resource Definitions</p>
<p>k8s提供了一种声明k8s新类型对象的机制。使用CustomResourceDefinition（CRD），k8s开发者可以声明自定义资源类型。</p>
<p>Helm3中，CRD被视为一种特殊的对象。它们被安装在chart的其他部分之前，并受到一些限制。</p>
<p>CRD YAML文件应被放置在chart的<code>crds/</code>目录中。 多个CRD(用YAML的开始<code>---</code>和结束符<code>...</code>分隔)可以被放置在同一个文件中。Helm会尝试加载CRD目录中所有的文件到k8s。</p>
<p>当Helm安装新chart时，会上传CRD，暂停安装直到CRD可以被API服务使用，然后启动模板引擎， 渲染chart其他部分，并上传k8s。</p>
<br>
<p><strong>CRD的限制</strong></p>
<p>不像大部分k8s对象，CRD是全局安装的。因此Helm管理CRD时会采取非常谨慎的方式。 CRD受到以下限制：</p>
<ul>
<li>CRD从不重新安装。 如果Helm确定<code>crds/</code>目录中的CRD已经存在（忽略版本），Helm不会安装或升级。</li>
<li>CRD从不会在升级或回滚时安装。Helm只会在安装时创建CRD。</li>
<li>CRD从不会被删除。自动删除CRD会删除集群中所有命名空间中的所有CRD内容。因此Helm不会删除CRD。</li>
</ul>
<p>希望升级或删除CRD的操作员应该谨慎地手动执行此操作。</p>
<br>
<br>
<h3 id="管理chart">管理chart</h3>
<p>Using Helm to Manage Charts</p>
<p><code>helm</code>工具有一些命令用来处理chart。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="err">#</span> <span class="nx">创建新chart</span>
<span class="nx">helm</span> <span class="nx">create</span> <span class="nx">mychart</span>

<span class="err">#</span> <span class="nx">打包</span>
<span class="nx">helm</span> <span class="kn">package</span> <span class="nx">mychart</span>

<span class="err">#</span> <span class="nx">格式信息</span>
<span class="nx">helm</span> <span class="nx">lint</span> <span class="nx">mychart</span>
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="仓库">仓库</h3>
<p>Chart Repositories</p>
<p>当<code>helm</code>用来管理本地chart目录时， 共享chart时，首选的机制就是使用chart仓库。</p>
<p>仓库的主要特征存在一个名为<code>index.yaml</code>的特殊文件，文件中包含仓库提供的包的完整列表， 以及允许检索和验证这些包的元数据。</p>
<p>在客户端，仓库使用<code>helm repo</code>命令管理。然而，Helm不提供上传chart到远程仓库的工具。 这是因为这样做会给执行服务器增加大量的必要条件，也就增加了设置仓库的障碍。</p>
<br>
<br>
<h3 id="starter-packs">Starter Packs</h3>
<p><code>helm create</code>命令可以附带一个可选的<code>--starter</code>选项指定一个starter chart。Starter就只是普通chart，但是被放置在<code>$XDG_DATA_HOME/helm/starters</code>。</p>
<br>
<br>
<h2 id="hooks">Hooks</h2>
<p>Chart Hooks: <a href="https://helm.sh/docs/topics/charts_hooks/">https://helm.sh/docs/topics/charts_hooks/</a></p>
<p>Helm提供了一个hook机制，使chart开发者在发行版(release)生命周期的特定点进行干预。你可以使用hooks做以下事情：</p>
<ul>
<li>安装过程中，在chart载入之前载入configmap或secret。</li>
<li>在安装一个新chart之前，执行一个作业(job)来备份数据库，然后执行第二个作业还原数据库。</li>
<li>在删除一个release之气，运行一个作业，在移除之前，来优雅地取出服务轮询。</li>
</ul>
<p>hooks工作像常规模板，但它们有特殊的注释(写在annotations下)，因此helm可以不同地使用它们。本章节，我们将介绍hooks的基本使用模式。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">&#34;helm.sh/hook&#34;: </span><span class="l">post-install</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="可用的hooks">可用的hooks</h3>
<table>
<thead>
<tr>
<th>Annotation</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pre-install</code></td>
<td>-</td>
<td>模板渲染之后执行，但在k8s创建任何资源之前</td>
</tr>
<tr>
<td><code>post-install</code></td>
<td>-</td>
<td>所有资源载入k8s后执行</td>
</tr>
<tr>
<td><code>pre-delete</code></td>
<td>-</td>
<td>在从k8s删除任意资源前，执行一个删除请求</td>
</tr>
<tr>
<td><code>post-delete</code></td>
<td>-</td>
<td>在所有release的资源被删除后，执行一个删除请求</td>
</tr>
<tr>
<td><code>pre-upgrade</code></td>
<td>-</td>
<td>在模板渲染后，执行一个升级请求，但在任意资源升级之前</td>
</tr>
<tr>
<td><code>post-upgrade</code></td>
<td>-</td>
<td>在所有资源都升级后，执行一个升级</td>
</tr>
<tr>
<td><code>pre-rollback</code></td>
<td>-</td>
<td>在模板渲染后，执行一个回滚请求，但在任意资源回滚前</td>
</tr>
<tr>
<td><code>post-rollback</code></td>
<td>-</td>
<td>在所有资源都被修改后，执行一个回滚请求</td>
</tr>
<tr>
<td><code>test</code></td>
<td>-</td>
<td>当heml test子命令调用时执行</td>
</tr>
</tbody>
</table>
<br>
<br>
<h2 id="测试">测试</h2>
<p>Chart Tests: <a href="https://helm.sh/docs/topics/chart_tests/">https://helm.sh/docs/topics/chart_tests/</a></p>
<p>chart包含许多k8s资源和协同工作的组件。作为包作者，你可能想编写一个测试，来验证包安装时是否如预期那样工作。</p>
<p>helm chart中的测试位于<code>templates/</code>目录下，是一个作业(job)定义，指定一个容器运行特定的命令。容器成功退出(exit 0)，被认为测试成功。作业定义必须包含<code>helm.sh/hook: test</code>的注释。</p>
<p>示例测试：</p>
<ul>
<li>验证<code>values.yaml</code>文件被正确配置</li>
<li>验证服务、负载均衡正常</li>
<li>等等</li>
</ul>
<p>可在helm中运行预定义测试，在release上使用<code>helm test &lt;RELEASE_NAME&gt;</code>命令。对于包的使用者，这是一个检测release of chart工作正常的方式。</p>
<br>
<h3 id="示例">示例</h3>
<p>Example Test</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">helm repo add bitnami https://charts.bitnami.com/bitnami
helm pull bitnami/wordpress --untar

wordpress/
  Chart.yaml
  README.md
  values.yaml
  charts/
  templates/
  templates/tests/test-mariadb-connection.yaml
</code></pre></td></tr></table>
</div>
</div><p><code>templates/tests/test-mariadb-connection.yaml</code>的内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">{{- <span class="l">if .Values.mariadb.enabled }}</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ .Release.Name }}-credentials-test&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">&#34;helm.sh/hook&#34;: </span><span class="l">test</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-credentials-test</span><span class="w">
</span><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">template &#34;wordpress.image&#34; . }}</span><span class="w">
</span><span class="w">      </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.image.pullPolicy | quote }}</span><span class="w">
</span><span class="w">      </span>{{- <span class="l">if .Values.securityContext.enabled }}</span><span class="w">
</span><span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.securityContext.runAsUser }}</span><span class="w">
</span><span class="w">      </span>{{- <span class="l">end }}</span><span class="w">
</span><span class="w">      </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">MARIADB_HOST</span><span class="w">
</span><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">template &#34;mariadb.fullname&#34; . }}</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">MARIADB_PORT</span><span class="w">
</span><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3306&#34;</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">WORDPRESS_DATABASE_NAME</span><span class="w">
</span><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">default &#34;&#34; .Values.mariadb.db.name | quote }}</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">WORDPRESS_DATABASE_USER</span><span class="w">
</span><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">default &#34;&#34; .Values.mariadb.db.user | quote }}</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">WORDPRESS_DATABASE_PASSWORD</span><span class="w">
</span><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">template &#34;mariadb.fullname&#34; . }}</span><span class="w">
</span><span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">mariadb-password</span><span class="w">
</span><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="l">/bin/bash</span><span class="w">
</span><span class="w">        </span>- -<span class="l">ec</span><span class="w">
</span><span class="w">        </span>- <span class="p">|</span><span class="sd">
</span><span class="sd">          </span><span class="w">          </span><span class="l">mysql --host=$MARIADB_HOST --port=$MARIADB_PORT --user=$WORDPRESS_DATABASE_USER --password=$WORDPRESS_DATABASE_PASSWORD</span><span class="w">
</span><span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w">
</span><span class="w"></span>{{- <span class="l">end }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p>运行测试:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">helm install quirky-walrus wordpress --namespace default

helm <span class="nb">test</span> quirky-walrus
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>注意：</strong></p>
<ul>
<li>你可以在<code>templates/</code>目录下定义许多测试</li>
<li>你可以嵌套你的测试<code>&lt;chart-name&gt;/templates/tests/</code></li>
<li>一个测试就是一个helm hook</li>
</ul>
<br>
<br>
<h2 id="library">Library</h2>
<p>Library Charts: <a href="https://helm.sh/docs/topics/library_charts/">https://helm.sh/docs/topics/library_charts/</a></p>
<p>A library chart is a type of Helm chart，定义chart可通过helm模板在其它charts中共享。</p>
<br>
<br>
<h2 id="完整性校验">完整性校验</h2>
<p>Helm Provenance and Integrity: <a href="https://helm.sh/docs/topics/provenance/">https://helm.sh/docs/topics/provenance/</a></p>
<p>helm有来源工具，帮助chart user验证包的来源和完整性。使用基于行业标准的PIK, GnuPG等备受推崇的包管理器，Helm 可以生成和验证签名文件。</p>
<br>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="err">#</span> <span class="nx">生成</span>
<span class="nx">helm</span> <span class="kn">package</span> <span class="o">--</span><span class="nx">sign</span> <span class="o">...</span>
<span class="nx">helm</span> <span class="kn">package</span> <span class="o">--</span><span class="nx">sign</span> <span class="o">--</span><span class="nx">key</span> <span class="err">&#39;</span><span class="nx">John</span> <span class="nx">Smith</span><span class="err">&#39;</span> <span class="o">--</span><span class="nx">keyring</span> <span class="nx">path</span><span class="o">/</span><span class="nx">to</span><span class="o">/</span><span class="nx">keyring</span><span class="p">.</span><span class="nx">secret</span> <span class="nx">mychart</span>

<span class="err">#</span> <span class="nx">校验</span>
<span class="nx">helm</span> <span class="nx">install</span> <span class="o">--</span><span class="nx">verify</span>
<span class="nx">helm</span> <span class="nx">verify</span> <span class="nx">mychart</span><span class="o">-</span><span class="mf">0.1.0</span><span class="p">.</span><span class="nx">tgz</span>
<span class="nx">helm</span> <span class="nx">install</span> <span class="o">--</span><span class="nx">generate</span><span class="o">-</span><span class="nx">name</span> <span class="o">--</span><span class="nx">verify</span> <span class="nx">mychart</span><span class="o">-</span><span class="mf">0.1.0</span><span class="p">.</span><span class="nx">tgz</span>
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h2 id="仓库-1">仓库</h2>
<p>Chart Repository: <a href="https://helm.sh/docs/topics/chart_repository/">https://helm.sh/docs/topics/chart_repository/</a></p>
<p>官方的chart repo由<a href="https://github.com/helm/charts" target="_blank" rel="noopener noreffer ">Kubernetes Charts</a>项目维护。欢迎各位参与。Helm也使得创建和运行自己的chart repo变得很容易。</p>
<br>
<h3 id="创建仓库">创建仓库</h3>
<p>Create a chart repository: <a href="https://helm.sh/docs/topics/chart_repository/">https://helm.sh/docs/topics/chart_repository/</a></p>
<p>一个chart repo是一个HTTP服务器，它容纳了一个<code>index.yaml</code>文件和一些包。当你准备好分享你的charts，方法是将它们上传到一个chart repository。你可以使用GCS, S3, GitHub Pages等来创建你自己的web服务器。</p>
<br>
<br>
<h2 id="注册中心">注册中心</h2>
<p>Registries: <a href="https://helm.sh/docs/topics/registries/">https://helm.sh/docs/topics/registries/</a></p>
<p>Helm 3 支持OCI用于包分发。 Chart包可以通过基于OCI的注册中心存储和分发。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 激活对OCI的支持
export HELM_EXPERIMENTAL_OCI=1


# 运行一个注册中心
docker run -dp 5000:5000 --restart=always --name registry registry


# 认证
htpasswd -cB -b auth.htpasswd myuser mypass
docker run -dp 5000:5000 --restart=always --name registry \
  -v $(pwd)/auth.htpasswd:/etc/docker/registry/auth.htpasswd \
  -e REGISTRY_AUTH=&#34;{htpasswd: {realm: localhost, path: /etc/docker/registry/auth.htpasswd}}&#34; \
  registry


# 登录
helm registry login -u myuser localhost:5000


# 注销
helm registry logout localhost:5000


# 保存
helm chart save mychart/ localhost:5000/myrepo/mychart:2.7.0

# 查看
helm chart list

# 导出
helm chart export localhost:5000/myrepo/mychart:2.7.0

# 推送到远程
helm chart push localhost:5000/myrepo/mychart:2.7.0

# 从缓存中移除
helm chart remove localhost:5000/myrepo/mychart:2.7.0

# 从远程拉取
helm chart pull localhost:5000/myrepo/mychart:2.7.0
</code></pre></td></tr></table>
</div>
</div><br>
<p>使用上述命令存储的chart会被缓存到文件系统中。OCI 镜像设计规范 严格遵守文件系统布局的。如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">tree ~/Library/Caches/helm/
└── registry
    ├── cache
    │   ├── blobs
    │   │   └── sha256
    │   │       ├── 1b251d38cfe948dfc0a5745b7af5ca574ecb61e52aed10b19039db39af6e1617
    │   │       ├── 31fb454efb3c69fafe53672598006790122269a1b3b458607dbe106aba7059ef
    │   │       └── 8ec7c0f2f6860037c19b54c3cfbab48d9b4b21b485a93d87b64690fdb68c2111
    │   ├── index.json
    │   ├── ingest
    │   └── oci-layout
    └── config.json
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h2 id="架构">架构</h2>
<p>Helm Architecture: <a href="https://helm.sh/docs/topics/architecture/">https://helm.sh/docs/topics/architecture/</a></p>
<p>介绍Helm在高级别的架构。</p>
<br>
<h3 id="目的">目的</h3>
<p>The Purpose of Helm</p>
<p>Helm是管理称为chart的k8s包的工具。Helm可以做以下事情：</p>
<ul>
<li>从头开始创建一个新的charts</li>
<li>packages charts为归档(tgz) chart文件</li>
<li>与chart repo交互，并存储在那</li>
<li>安装和卸载charts到k8s集群</li>
<li>管理已安装的charts的发行版</li>
</ul>
<p>对于Helm，有三个重要的概念：</p>
<ul>
<li>chart是创建一个k8s应用实例所需的信息束</li>
<li>config包含配置信息，可以合并到package chart来创建一个可发行的对象</li>
<li>release是一个运行的chart实例，包含特定的配置</li>
</ul>
<br>
<br>
<h3 id="组件">组件</h3>
<p>Components</p>
<p>Helm被实现为两个不同部分来执行：</p>
<p>Helm CLI客户端，负责以下事情：</p>
<ul>
<li>本地chart开发</li>
<li>管理repo</li>
<li>管理release</li>
<li>与Helm Library接口
<ul>
<li>发送chart安装</li>
<li>请求升级或卸载releases</li>
</ul>
</li>
</ul>
<p>Helm Library提供了执行所有helm操作的逻辑。与k8s API接口交互，并提供以下功能：</p>
<ul>
<li>组合chart和配置来构建一个release</li>
<li>安装chart到k8s，并提供release对象</li>
<li>通过与k8s交互，升级和卸载chart</li>
</ul>
<br>
<br>
<h3 id="实现">实现</h3>
<p>Implementation</p>
<p>Helm client和library由go编写。library使用k8s client与k8s集群通信。目前，library使用<code>REST+JSON</code>。它存储信息在k8s内的secrets里，不需要自己的数据库。配置文件以YAML编写。</p>
<br>
<br>
<h2 id="高级技术">高级技术</h2>
<p>Advanced Helm Techniques: <a href="https://helm.sh/docs/topics/advanced/">https://helm.sh/docs/topics/advanced/</a></p>
<br>
<h3 id="后置渲染">后置渲染</h3>
<p>Post Rendering</p>
<br>
<br>
<h3 id="go-sdk">GO SDK</h3>
<br>
<br>
<h3 id="后端存储">后端存储</h3>
<p>Storage backends</p>
<br>
<br>
<h2 id="rbac">RBAC</h2>
<p>Role-based Access Control: <a href="https://helm.sh/docs/topics/rbac/">https://helm.sh/docs/topics/rbac/</a></p>
<p>k8s rbac: <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">https://kubernetes.io/docs/reference/access-authn-authz/rbac/</a></p>
<p>介绍Helm如何与k8s RBAC进行交互。</p>
<p>在k8s中，授权角色给特定用户或应用的服务账号(service account)，以确保应用程序的操作在特定范围内。从k8s v1.6开始，RBAC默认启用。</p>
<p>使用RBAC，你可以：</p>
<ul>
<li>授权特权操作给管理员</li>
<li>限制用户在特定命名空间/集群范围创建资源的能力</li>
<li>限制用户在特定命名空间/集群范围内查看资源的能力</li>
</ul>
<br>
<h3 id="管理用户账户">管理用户账户</h3>
<p>Managing user accounts</p>
<p>所有的k8s集群有两种类型的用户：</p>
<ul>
<li>service accounts managed by Kubernetes</li>
<li>normal users</li>
</ul>
<p>普通用户假定由外部进行管理，独立的服务。管理员分发私钥，用户存储密码，甚至是用户名密码列表这样的文件。在这方面，k8s不具有代表普通用户账户的对象。普通用户无法通过API调用被添加到集群。</p>
<p>相比之下，服务账号是由k8s API管理的用户。它们被绑定到特定的命名空间，通过API server自动创建，或通过API调用手动创建。服务账号绑定在一组凭据里，存储为secret，它被挂载到pod，允许集群内进程与k8s API进行交谈。</p>
<p>API请求被绑定到任何一个用户（普通用户、服务账号），或者被视为匿名请求。这意味着集群内或集群外的每一个进程，从工作站上输入<code>kubectl</code>的人类用户，到节点上的kubelets，到控制面板的成员，在进行请求API server时必须进行认证，或被视为匿名用户。</p>
<br>
<br>
<h3 id="角色集群角色角色绑定集群角色绑定">角色、集群角色、角色绑定、集群角色绑定</h3>
<p>Roles, ClusterRoles, RoleBindings, and ClusterRoleBindings</p>
<p>在k8s中，用户账户和服务账户只能够根据授权访问来查看和修改资源。这种授权是通过使用<strong>角色(Roles)<strong>和</strong>角色绑定(RoleBindings)</strong>。角色和角色绑定被绑定到特定的命名空间，它通过角色提供授权，授予用户在此命名空间内查看或修改资源的能力。</p>
<p>在集群范围内，这些被称为<strong>集群角色(ClusterRoles)<strong>和</strong>集群角色绑定(ClusterRoleBindings)</strong>。授权用户集群角色，允许它们访问和修改整个集群的资源。这也需要查看和修改集群范围(命名空间，资源配额，节点)的资源。</p>
<p>集群角色可通过角色绑定的引用来绑定到特定的命名空间。<code>admin</code>, <code>edit</code>, <code>view</code>是最常使用的默认集群角色。</p>
<p>k8s有一些默认的集群角色可用，它们的本意是面向用户的角色。它们包含超级角色(<code>cluster-admin</code>)，和细粒度访问的角色(<code>admin</code>, <code>edit</code>, <code>view</code>)。</p>
<br>
<table>
<thead>
<tr>
<th>Default ClusterRole</th>
<th>Default ClusterRoleBinding</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>cluster-admin</td>
<td>system:masters group</td>
<td>允许超级用户访问对任意资源执行任意动作。</td>
</tr>
<tr>
<td>admin</td>
<td>None</td>
<td>允许管理员访问，在命名空间内使用角色绑定来授权。如读写命名空间内的大部分资源，包括在命名空间内创建角色和角色绑定的能力。但不允许对资源配额或命名空间进行写操作。</td>
</tr>
<tr>
<td>edit</td>
<td>None</td>
<td>允许在命名空间内读取大多数对象的权限，不允许查看或修改角色和角色绑定</td>
</tr>
<tr>
<td>view</td>
<td>None</td>
<td>允许在命名空间内查看大多数对象的权限。不允许查看角色和角色绑定。不允许查看secrets。</td>
</tr>
</tbody>
</table>
<br>
<br>
<h3 id="限制用户账户使用rbac访问">限制用户账户使用RBAC访问</h3>
<p>Restricting a user account access using RBAC</p>
<p>现在让我们了解基于角色的访问控制的基础知识，让我们讨论管理员如何限制用户的访问范围。</p>
<br>
<p><strong>示例：授予用户命名空间范围的读写权限</strong></p>
<p>Grant a user read/write access to a particular namespace</p>
<p>要限制用户对特定命名空间的读写权限，可以使用<code>edit</code>或<code>admin</code>角色。</p>
<p>此外，你还可以使用<code>cluster-admin</code>来创建一个角色绑定。授予在命名空间范围内的<code>cluster-admin</code>来提供在此命名空间内完整控制资源的权限，包含命名空间自身。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 创建ns
kubectl create namespace foo

#创建RoleBinding
kubectl create rolebinding sam-edit
    --clusterrole edit \
    --user sam \
    --namespace foo
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>示例：授予用户集群范围的读写权限</strong></p>
<p>Example: Grant a user read/write access at the cluster scope</p>
<p>如果用户希望安装chart，在集群范围内安装集群资源（ns, roles, crd&hellip;），它们将需要集群范围的写权限。要这样做，授予用户<code>admin</code>或<code>cluster-admin</code>角色权限。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">kubectl create clusterrolebinding sam-view
    --clusterrole view \
    --user sam


kubectl create clusterrolebinding sam-secret-reader
    --clusterrole secret-reader \
    --user sam
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>示例：授予用户命名空间范围的只读权限</strong></p>
<p>Example: Grant a user read-only access to a particular namespace</p>
<p>你可能注意到了，没有查看secret的集群角色。<code>view</code>集群角色没有授予用户访问secret的权限。然而，Helm默认将release metadata存储为secret。</p>
<p>为了使用户运行<code>helm list</code>，它需要读取这些secrets。为此，我们将创建一个特殊的<code>secret-reader</code>集群角色。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># cluster-role-secret-reader.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">secret-reader</span><span class="w">
</span><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;secrets&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;watch&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">]</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">kubectl create -f clusterrole-secret-reader.yaml

kubectl create namespace foo

kubectl create rolebinding sam-view
    --clusterrole view \
    --user sam \
    --namespace foo


kubectl create rolebinding sam-secret-reader
    --clusterrole secret-reader \
    --user sam \
    --namespace foo
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>示例：授予用户集群范围的只读权限</strong></p>
<p>Example: Grant a user read-only access at the cluster scope</p>
<p>如果用户想运行<code>helm l ist --all-namespaces</code>命令，API需要用户拥有集群范围内的读权限。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">kubectl create clusterrolebinding sam-view
    --clusterrole view \
    --user sam

kubectl create clusterrolebinding sam-secret-reader
    --clusterrole secret-reader \
    --user sam
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h2 id="插件">插件</h2>
<p>The Helm Plugins Guide: <a href="https://helm.sh/docs/topics/plugins/">https://helm.sh/docs/topics/plugins/</a></p>
<p>Helm plugin是一个可通过helm CLI访问的工具，但不是内置的helm基础代码的一部分。</p>
<br>
<br>
<h2 id="v2迁移到v3">V2迁移到V3</h2>
<p>Migrating Helm v2 to v3: <a href="https://helm.sh/docs/topics/v2_v3_migration/">https://helm.sh/docs/topics/v2_v3_migration/</a></p>
<br>
<br>
<h2 id="弃用的k8s-api">弃用的k8s api</h2>
<p>Deprecated Kubernetes APIs: <a href="https://helm.sh/docs/topics/kubernetes_apis/">https://helm.sh/docs/topics/kubernetes_apis/</a></p>
<br>
<br>
<h2 id="版本支持">版本支持</h2>
<p>Helm Version Support Policy: <a href="https://helm.sh/docs/topics/version_skew/">https://helm.sh/docs/topics/version_skew/</a></p>
<br>
<br>
<h2 id="sql存储后端的权限管理">SQL存储后端的权限管理</h2>
<p>Permissions management for SQL storage backend: <a href="https://helm.sh/docs/topics/permissions_sql_storage_backend/">https://helm.sh/docs/topics/permissions_sql_storage_backend/</a></p>
<br>
<br>
<hr>
<br>
<br>
<h1 id="最佳实践">最佳实践</h1>
<p>The Chart Best Practices Guide: <a href="https://helm.sh/docs/chart_best_practices/">https://helm.sh/docs/chart_best_practices/</a></p>
<p>涵盖了Helm团队对创建chart的最佳做法。它侧重于chart应该如何构造。主要关注那些可能会公开部署的charts的最佳实践。</p>
<br>
<h2 id="一般约定">一般约定</h2>
<p>General Conventions: <a href="https://helm.sh/docs/chart_best_practices/conventions/">https://helm.sh/docs/chart_best_practices/conventions/</a></p>
<br>
<h3 id="chart名称">chart名称</h3>
<p>Chart Names</p>
<p>chart名称必须是小写字母和数字，可用<code>-</code>隔开。</p>
<p>chart目录必须与chart名称相同。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 示例
drupal
nginx-lego
aws-cluster-autoscaler

nginx-lego
nginx-lego/
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="版本号">版本号</h3>
<p>Version Numbers</p>
<p>只要有可能，Helm使用SemVer2来表示版本号。请注意，Docker image tag并不一定遵循SemVer，注意。</p>
<br>
<br>
<h3 id="格式化yaml">格式化YAML</h3>
<p>Formatting YAML</p>
<p>YAML应该使用两个空格（别使用tab）。</p>
<br>
<br>
<h3 id="词">词</h3>
<p>Usage of the Words Helm and Chart</p>
<p>Helm词的一些约定：</p>
<ul>
<li>Helm指作为一个整体的项目</li>
<li><code>helm</code>客户端CLI</li>
<li><code>chart</code>不需要大写，它不是专有名词</li>
<li><code>Chart.yaml</code>需要大写，因为该文件名是大小写敏感的</li>
</ul>
<br>
<br>
<h2 id="值">值</h2>
<p>Values: <a href="https://helm.sh/docs/chart_best_practices/values/">https://helm.sh/docs/chart_best_practices/values/</a></p>
<p>提供给你如何组织和设计chart的<code>values.yaml</code>文件，并使用你的值。</p>
<br>
<h3 id="命名约定">命名约定</h3>
<p>Naming Conventions</p>
<p>变量名必须小写字母开头，使用驼峰分开：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">chicken: true
chickenNoodleSoup: true
</code></pre></td></tr></table>
</div>
</div><p>请注意，所有Helm内置变量以大写字母开头，用户可以轻松区分开:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">.Release.Name
.Capabilities.KubeVersion
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="嵌套值">嵌套值</h3>
<p>YAML是一种灵活的格式，值可以被深度嵌套。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">server:
  name: nginx
  port: 80
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">{{ if .Values.server }}
  {{ default &#34;none&#34; .Values.server.name }}
{{ end }}
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="使类型清晰">使类型清晰</h3>
<p>Make Types Clear</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># YAM的类型强制规则有时是反直觉的。例如一下两者是不同的</span><span class="w">
</span><span class="w"></span><span class="nt">foo</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w"></span><span class="nt">foo</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># 避免类型转化错误的最简单的方法是要明确字符串和隐含的一切。使用引号引用字符串</span><span class="w">
</span><span class="w"></span><span class="c"># 要避免整数转换错误，将整数存储为字符串，使用以下方法来获取整数值</span><span class="w">
</span><span class="w"></span>{{<span class="w"> </span><span class="l">int $value }}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># 在大多数情况下，显式类型标签被尊重。如以下1234被当作字符串</span><span class="w">
</span><span class="w"></span><span class="nt">foo</span><span class="p">:</span><span class="w"> </span><span class="cp">!!string</span><span class="w"> </span><span class="m">1234</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="考虑用户如何使用你的值">考虑用户如何使用你的值</h3>
<p>Consider How Users Will Use Your Values</p>
<p>值有三个来源：</p>
<ul>
<li><code>values.yaml</code>文件</li>
<li><code>helm install -f</code>或<code>helm upgrade -f</code>时指定的文件里</li>
<li><code>--set</code>或<code>--set-string</code>选项指定</li>
</ul>
<p>当设计值的组织结构时，用户是希望可通过<code>-f</code>或<code>--set</code>选项来覆盖它们。YAML建议写成映射(mapping)，便于替换<code>--set servers.foo.port=80</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">servers:
  foo:
    port: 80
  bar:
    port: 81
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="valuesyaml">values.yaml</h3>
<p>每个在<code>values.yaml</code>中定义的属性应该被记录(documented)。文档字符串应该用它描述的属性的名称开始，然后给出至少一个单句描述。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># serverHost is the host name for the webserver</span><span class="w">
</span><span class="w"></span><span class="nt">serverHost</span><span class="p">:</span><span class="w"> </span><span class="l">example</span><span class="w">
</span><span class="w"></span><span class="c"># serverPort is the HTTP listener port for the webserver</span><span class="w">
</span><span class="w"></span><span class="nt">serverPort</span><span class="p">:</span><span class="w"> </span><span class="m">9191</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h2 id="模板">模板</h2>
<p>Templates: <a href="https://helm.sh/docs/chart_best_practices/templates/">https://helm.sh/docs/chart_best_practices/templates/</a></p>
<br>
<h3 id="templates目录架构">templates目录架构</h3>
<p>Structure of <code>templates/</code></p>
<p><code>templates/</code>目录应该是如下结构：</p>
<ul>
<li>模板文件是<code>.yaml</code>扩展的YAML输出。<code>.tpl</code>扩展可用于未经格式化的模板文件</li>
<li>模板文件名应使用虚线(example-configmap.yaml)，而不是驼峰</li>
<li>每个资源定义应该有自己的模板文件</li>
<li>模板文件应放映资源类型（如<code>foo-pod.yaml</code>, <code>bar-svc.yaml</code>）</li>
</ul>
<br>
<br>
<h3 id="定义的模板的名称">定义的模板的名称</h3>
<p>Names of Defined Templates</p>
<p>定义的模板(模板文件内的<code>{{ define }}</code>)是全局访问的。这意味着，chart和它的subchart可以访问所有<code>{{ define }}</code>创建的模板。这样我想起了Pythond的模板语言（Django模板语言，Jinja2等等）。</p>
<p>出于此原因，所有定义的模板名称都应该命名空间。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">{{- define &#34;nginx.fullname&#34; }}
{{/* ... */}}
{{ end -}}
</code></pre></td></tr></table>
</div>
</div><p>It is highly recommended that new charts are created via helm create command as the template names are automatically defined as per this best practice.</p>
<br>
<br>
<h3 id="格式化模板">格式化模板</h3>
<p>Formatting Templates</p>
<p>模板应该使用两个空格，而不是tab。花括号前后应该有空格。有适当的空格和缩进。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">{{ .foo }}
{{ print &#34;foo&#34; }}
{{- print &#34;bar&#34; -}}

{{ if $foo -}}
  {{- with .Bar }}Hello{{ end -}}
{{- end -}}
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="生成模板中的空格">生成模板中的空格</h3>
<p>Whitespace in Generated Templates</p>
<p>优选的是，保持在生成的模板中的空格数量降到最低。特别是，许多空行不应出现彼此相邻。但偶尔空行还是可以的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># This is best</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Job</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">first</span><span class="p">:</span><span class="w"> </span><span class="l">first</span><span class="w">
</span><span class="w">    </span><span class="nt">second</span><span class="p">:</span><span class="w"> </span><span class="l">second</span><span class="w">
</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># This is okay</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Job</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">first</span><span class="p">:</span><span class="w"> </span><span class="l">first</span><span class="w">
</span><span class="w">    </span><span class="nt">second</span><span class="p">:</span><span class="w"> </span><span class="l">second</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="注释">注释</h3>
<p>Comments (YAML Comments vs Template Comments)</p>
<p>YAML文件注释和模板注释。当一个模板记录功能时，应该使用模板注释。当Helm用户通过查看注释调试时，在模板内应该使用YANML注释。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># yaml 注释


{{- /*
模板注释
*/ -}}


{{- /*
mychart.shortname provides a 6 char truncated version of the release name.
*/ -}}
{{ define &#34;mychart.shortname&#34; -}}
{{ .Release.Name | trunc 6 }}
{{- end -}}


# This may cause problems if the value is more than 100Gi
memory: {{ .Values.maxMem | quote }}
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="在模板和模板输出中使用json">在模板和模板输出中使用JSON</h3>
<p>Use of JSON in Templates and Template Output</p>
<p>YAML是JSON的超集(superset)。在一些情况下，使用JSON语法可比其它YAML表示更具有可读性。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 列表

# yaml
arguments:
  - &#34;--dirname&#34;
  - &#34;/foo&#34;

# json
arguments: [&#34;--dirname&#34;, &#34;/foo&#34;]
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h2 id="依赖-1">依赖</h2>
<p>Dependencies: <a href="https://helm.sh/docs/chart_best_practices/dependencies/">https://helm.sh/docs/chart_best_practices/dependencies/</a></p>
<p>介绍<code>Chart.yaml</code>内声明的<code>dependencies</code>的最佳实践。</p>
<br>
<h3 id="版本">版本</h3>
<p>Versions</p>
<p>如果可能的化，使用版本范围，而不是某个确切的版本。建议使用补丁级别(patch-level)版本匹配:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># &gt;= 1.2.3, &lt; 1.3.0
version: ~1.2.3
</code></pre></td></tr></table>
</div>
</div><p>repo ruls，如果可能，使用HTTPS。文件URL(<code>file://...</code>)被认为是一个特殊，对由一个固定部署的流水线charts。</p>
<br>
<br>
<h3 id="条件和标记">条件和标记</h3>
<p>Conditions and Tags</p>
<p>条件或标记应被添加到任何依赖（可选的）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 条件的推荐格式
condition: somechart.enabled


# 标记
tags:
  - webaccelerator
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h2 id="标签和注释">标签和注释</h2>
<p>Labels and Annotations: <a href="https://helm.sh/docs/chart_best_practices/labels/">https://helm.sh/docs/chart_best_practices/labels/</a></p>
<p>讨论chart中使用标签和注释的最佳实践。</p>
<br>
<h3 id="标签还是注释">标签还是注释</h3>
<p>Is it a Label or an Annotation?</p>
<p>以下条件的元数据项应该为标签(label)：</p>
<ul>
<li>它利用k8s来标识此资源</li>
<li>暴露给查询系统的目的是有用的</li>
</ul>
<p>如果元数据的条目不用于查询，它应该设置为注释。Helm hooks总是注释。</p>
<br>
<br>
<h3 id="标准的标签">标准的标签</h3>
<p>Standard Labels</p>
<p>下表定义了Helm chart常用的标签。Helm自身从未要求特定的标签存在。REC的标签是建议的，并应该放置到全局一致性的chart。OPT的标签是可选的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">名称    状态   描述
app.kubernetes.io/name  REC    这应该是app名称。通常使用{{ template &#34;name&#34; . }} 这由许多k8s manifests使用，不是Helm特定的
helm.sh/chart           REC  chart名称和版本: {{ .Chart.Name }}-{{ .Chart.Version }}
app.kubernetes.io/managed-by    REC    这应该始终设置为{{ .Release.Service }}
app.kubernetes.io/instance    REC    这应该为{{ .Release.Name }}，有助于在同意应用不同实例之间进行区分
app.kubernetes.io/version    OPT   应用的版本设置为{{ .Chart.AppVersion }}
app.kubernetes.io/component    OPT   This is a common label for marking the different roles that pieces may play in an application
|app.kubernetes.io/part-of    OPT   当多个charts或软件片一起使用来做一个应用
</code></pre></td></tr></table>
</div>
</div><p>可在k8s 文档中，带有<code>app.kubernetes.io</code>前缀的文档中查看更多信息。</p>
<br>
<br>
<h2 id="pods和podtemplates">Pods和PodTemplates</h2>
<p>Pods and PodTemplates: <a href="https://helm.sh/docs/chart_best_practices/pods/">https://helm.sh/docs/chart_best_practices/pods/</a></p>
<p>以下资源列表使用PodTemplate：</p>
<ul>
<li>Deployment</li>
<li>ReplicationController</li>
<li>ReplicaSet</li>
<li>DaemonSet</li>
<li>StatefulSet</li>
</ul>
<br>
<h3 id="镜像">镜像</h3>
<p>Images</p>
<p>容器镜像应该使用确定的标记或镜像的SHA。但不应该使用<code>latest</code>, <code>head</code>, <code>canary</code>这样的标记。</p>
<p>镜像可以在<code>values.yaml</code>文件中定义，使其很容易替换镜像。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">image: {{ .Values.redisImage | quote }}
</code></pre></td></tr></table>
</div>
</div><p>镜像和标记可在<code>values.yaml</code>中被定义为分开的两个字段：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">image: &#34;{{ .Values.redisImage }}:{{ .Values.redisTag }}&#34;
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="镜像拉取策略">镜像拉取策略</h3>
<p>ImagePullPolicy</p>
<p><code>helm create</code>默认在<code>deployment.yaml</code>中设置<code>imagePullPolicy</code>为<code>IfNotPresent</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.image.pullPolicy }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># values.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">image</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">pullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>同样，如果未设置<code>impagePullPolicy</code>，k8s默认会将其设置为<code>IfNotPresent</code>。如果想要修改此值，只需在<code>values.yaml</code>文件中更新此值。</p>
<br>
<br>
<h3 id="podtemplate应该声明选择器">PodTemplate应该声明选择器</h3>
<p>PodTemplates Should Declare Selectors</p>
<p>所有的PodTemplate部分应该指定一个选择器。示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="l">MyName</span><span class="w">
</span><span class="w"></span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="l">MyName</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>这是一个很好的做法，因为它使set和pod相关联。</p>
<p>但是，这对于像Deployment这样的集更为重要。没有这一点，整个标签集(set of labels)用于选择匹配pod，如果你使用的标签发生改变（如版本或日期），这将打破匹配。</p>
<br>
<br>
<h2 id="自定义资源的定义">自定义资源的定义</h2>
<p>Custom Resource Definitions</p>
<p>当使用自定义资源定义(CRDs)，区分两种不同的片是很重要的：</p>
<ul>
<li>声明一个CRD(<code>kind: CustomResourceDefinition</code>)</li>
<li>然后资源使用CRD</li>
</ul>
<br>
<h3 id="使用资源前安装crd声明">使用资源前安装CRD声明</h3>
<p>Install a CRD Declaration Before Using the Resource</p>
<p>Helm是尽可能优化地载入更多的资源到k8s中。按照设计，k8s可以采取一整套清单(manifests)，并带它们所有上线（这就是所谓的和解循环(reconciliation loop))）。</p>
<p>但是，CRDs有一些不同。对于CRD，在任意CRDs类型资源被使用之前，必须先注册声明。注册过程有时需要几秒。</p>
<br>
<p><strong>方法1：让helm为你做此事</strong></p>
<p>Method 1: Let helm Do It For You</p>
<p>随着Helm3的到来，出于更简单的方法，Helm移除了旧的<code>crd-install</code> hooks。这在是一个称为<code>crds</code>的新目录，在你创建的chart的此目录下保存你的CRDs。这些CRDs没有模板，但会在chart运行<code>helm install</code>时默认安装。如果CRD已存在，它会被跳过。你也可以通过传递<code>--skip-crds</code>选项来跳过CRD的安装。</p>
<p><strong>一些注意事项:</strong></p>
<p>目前不支持使用Helm更新或删除CRDs。这是一个经过反复讨论的明确的决定，由于存在非故意丢失数据的危险。此外，目前社区如何处理CRDs和它的生命周期没有共识，由于这种演变，Helm将添加对这些用例的支持。</p>
<p><code>helm install</code>和<code>helm upgrade</code>的<code>--dry-run</code>选项暂不支持CRDs。Dry Run的目的是去验证chart的输出将实际地工作，如果发送到服务器。但CRDs可通过服务器行为的修改。Helm无法在dry run上安装CRD，因此发现客户端将不知道自定义资源(CR)，并验证将失败。你可以可选地移动CRDs到它们自己的chart，或使用<code>helm template</code>来代替。</p>
<p>围绕CRD支持的另一个重要的考虑点是如何处理模板的渲染(rendering of templates)。一个在Helm2中使用<code>crd-install</code>方法的明显的缺点是不能正确验证chart，由于改变API可用性（一个CRD被实际添加到另一个可用API到k8s集群）。如果一个chart安装了CRD，<code>helm</code>不再有一组API版本的有效集。这也是在移除从CRDs的模板支持的原因。随着安装CRD的新的<code>crds</code>方法，我们现在确保<code>helm</code>有关于当前集群状态的完整信息。</p>
<br>
<p><strong>方法2：独立chart</strong></p>
<p>Separate Charts</p>
<p>另一种方法是，把CRD定义在一个chart中，然后把所有资源使用的该CRD放在另一个chart。</p>
<p>在此方法中，每个char都必须单独安装。然而，这个工作流程可能是集群操作器(cluster operators)（对集群拥有admin权限）使用。</p>
<br>
<br>
<h2 id="rbac-1">RBAC</h2>
<p>Role-Based Access Control: <a href="https://helm.sh/docs/chart_best_practices/rbac/">https://helm.sh/docs/chart_best_practices/rbac/</a></p>
<p>RBAC资源有：</p>
<ul>
<li>ServiceAccount (namespaced)</li>
<li>Role (namespaced)</li>
<li>ClusterRole</li>
<li>RoleBinding (namespaced)</li>
<li>ClusterRoleBinding</li>
</ul>
<br>
<h3 id="yaml配置">YAML配置</h3>
<p>RBAC和ServiceAccount配置因该在单独的密钥里。它们是不同的东西。拆分这两个概念在YAML歧义消除它们，使之更清楚。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">rbac</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># Specifies whether RBAC resources should be created</span><span class="w">
</span><span class="w">  </span><span class="nt">create</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">serviceAccount</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># Specifies whether a ServiceAccount should be created</span><span class="w">
</span><span class="w">  </span><span class="nt">create</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="c"># The name of the ServiceAccount to use.</span><span class="w">
</span><span class="w">  </span><span class="c"># If not set and create is true, a name is generated using the fullname template</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>多个服务账号可以扩展为更复杂的charts。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">someComponent:
  serviceAccount:
    create: true
    name:
anotherComponent:
  serviceAccount:
    create: true
    name:
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="rbac资源应该被默认创建">RBAC资源应该被默认创建</h3>
<p>RBAC Resources Should be Created by Default</p>
<p><code>rbac.create</code>应该是一个布尔值，由RBAC资源来控制创建。默认应该为true。希望管理RBAC访问控制的用户可以将此设置为false。</p>
<br>
<br>
<h3 id="使用rbac资源">使用RBAC资源</h3>
<p>Using RBAC Resources</p>
<p><code>serviceAccount.name</code>应该被设置为由chart创建的访问控制资源使用的服务账号名称。如果<code>serviceAccount.create</code>为true，那么此名称的服务名称应该被创建。如果此名称未设置，则使用模板<code>fullname</code>来生成。如果为false，则它不应该被创建，但它应该与同样的资源相关联，以便创建后引用该手动创建RBAC资源正常工作。如果为false且没有指定名称，则使用默认的服务账号。</p>
<p>下面的助手模板应该用于服务账号：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">{{<span class="l">/*</span><span class="w">
</span><span class="w"></span><span class="l">Create the name of the service account to use</span><span class="w">
</span><span class="w"></span><span class="cp">*/}}</span><span class="w">
</span><span class="w"></span>{{- <span class="l">define &#34;mychart.serviceAccountName&#34; -}}</span><span class="w">
</span><span class="w"></span>{{- <span class="l">if .Values.serviceAccount.create -}}</span><span class="w">
</span><span class="w">    </span>{{<span class="w"> </span><span class="l">default (include &#34;mychart.fullname&#34; .) .Values.serviceAccount.name }}</span><span class="w">
</span><span class="w"></span>{{- <span class="l">else -}}</span><span class="w">
</span><span class="w">    </span>{{<span class="w"> </span><span class="l">default &#34;default&#34; .Values.serviceAccount.name }}</span><span class="w">
</span><span class="w"></span>{{- <span class="l">end -}}</span><span class="w">
</span><span class="w"></span>{{- <span class="l">end -}}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<hr>
<br>
<br>
<h1 id="模板-1">模板</h1>
<p>Chart Template: <a href="https://helm.sh/docs/chart_template_guide/">https://helm.sh/docs/chart_template_guide/</a></p>
<p>Helm‘s chart templates，重点介绍模板语言。让我想起的Django模板语言、Jinja2模板语言。</p>
<p>模板生成清单文件，这是k8s可理解的YAML格式的资源描述。本章重点介绍以下概念：</p>
<ul>
<li>Helm模板语言</li>
<li>Values使用</li>
<li>使用模板的技术</li>
</ul>
<br>
<h2 id="入门">入门</h2>
<p>Getting Started: <a href="https://helm.sh/docs/chart_template_guide/getting_started/">https://helm.sh/docs/chart_template_guide/getting_started/</a></p>
<p>创建一个chart并添加一个模板。</p>
<br>
<h3 id="charts-1">Charts</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">mychart/
  Chart.yaml
  values.yaml
  charts/
  templates/
  ...
</code></pre></td></tr></table>
</div>
</div><p><code>templates/</code>目录存放模板文件。当Helm评估一个chart，它会发送所有模板目录中的文件到模板渲染引擎。然后，它收集模板的结果，并将它们发送到k8s。</p>
<p><code>values.yaml</code>文件对模板也很重要。此文件包含了一个chart的默认值。默认值可通过命令行选项进行覆盖。</p>
<p><code>Chart.yaml</code>文件包含对chart包的描述信息。你可在模板中访问它。<code>charts/</code>目录可能包含其它chats(称为subcharts)。</p>
<br>
<br>
<h3 id="示例-1">示例</h3>
<p>A Starter Chart</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 创建一个名为mychart的chart包
helm create mychart
Creating mychart


# 目录结构
tree ./mychart -L 2
./mychart
├── charts
├── Chart.yaml
├── templates
│   ├── deployment.yaml
│   ├── _helpers.tpl    #模板助手，你可以重新使用整个chart
│   ├── hpa.yaml    #
│   ├── ingress.yaml
│   ├── NOTES.txt    #chart包的帮助文本(help text)，会在运行helm install显示
│   ├── serviceaccount.yaml
│   ├── service.yaml
│   └── tests
└── values.yaml


# 创建自己的模板
rm -rf mychart/templates/*
</code></pre></td></tr></table>
</div>
</div><p>当编写生产环境的chart包时，有这些charts包的基础版本可能很有用。</p>
<br>
<br>
<h3 id="第一个模板">第一个模板</h3>
<p>A First Template</p>
<p>创建一个<code>ConfigMap</code>资源的模板。由于它是一个基本的资源，因此它为我们提供了一个很好的起点。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># mychart/templates/configmap.yaml</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mychart-configpmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>小技巧：模板名称不遵循严格的命名模式。然而，我们建议为YAML文件使用<code>.yaml</code>后缀，为模板助手使用<code>.tpl</code>后缀。</p>
<p>上述YAML文件是一个最基本的ConfigMap，最有最小的必要的字段。它会通过模板引擎进行发送。</p>
<p>一个普通的平YAML文件是蛮好的。当Helm读取此模板，它会简单地将文件原样发送给k8s。</p>
<p>在这个简单的例子中，我们现在有了一个可安装的chart包。安装一下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">helm install full-coral mychart
NAME: full-coral
LAST DEPLOYED: Sun Sep 27 10:38:03 2020
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None


helm ls
NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART           APP VERSION
full-coral      default         1               2020-09-27 10:38:03.546664865 +0800 CST deployed        mychart-0.1.0   1.16.0


helm get manifest full-coral
---
# Source: mychart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: mychart-configmap
data:
  myvalue: &#34;Hello World&#34;


kubectl get configmap
NAME                DATA   AGE
mychart-configmap   1      9m47s


# 卸载
helm uninstall full-coral
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>添加一个简单的模板调用</strong></p>
<p>Adding a Simple Template Call</p>
<p>硬编码的<code>name</code>，通常被认为是不好的做法。每个发行版的名称应该是唯一的。因此，我们可能将生成一个名称字段来写入发行版名称。</p>
<p>注意，由于DNS系统的限制，<code>name</code>字段被限制为63字符。出于这个原因，发行版名称被限制为53字符。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 模板指令放置于{{ xxx }} 块内
helm install clunky-serval mychart/
NAME: clunky-serval
LAST DEPLOYED: Sun Sep 27 11:16:20 2020
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None


helm get manifest clunky-serval
---
# Source: mychart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: clunky-serval-configmap
data:
  myvalue: &#34;Hello World&#34;


# 可使用--debug查看详情
# 下面将渲染模板，返回渲染输出，不会真正安装
helm install --debug --dry-run goodly-guppy ./mychart
</code></pre></td></tr></table>
</div>
</div><p>使用<code>--dry-run</code>将更容易对代码进行测试，但它不会保证k8s会接受你生成的模板。</p>
<br>
<br>
<h2 id="内置对象">内置对象</h2>
<p>Built-in Objects: <a href="https://helm.sh/docs/chart_template_guide/builtin_objects/">https://helm.sh/docs/chart_template_guide/builtin_objects/</a></p>
<p>对象动模板引擎传递到模板。你的代码可以传递对象范围（如<code>with</code>和<code>range</code>）。有一些方法可在模板中创建新的对象，如<code>tuple</code>函数。</p>
<p>对象可以很简单，它只有一个值。它们也可以包含其它对象或函数。如，<code>Realease</code>对象可包含几个对象（如<code>Release.Name</code>），<code>Files</code>对象有一些函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">- `Release`对象
  - `Release.Name`
  - `Release.Namespace`
  - `Release.IsUpgrade`
  - `Release.IsInstall`
  - `Release.Revision`
  - `Release.Service`：在Helm中，总是Helm
- `Values`: `values.yaml`中传递给模板的值
- `Chart`: `Chart.yaml`文件内容
- `Files`: 访问chart包中非模板的文件
  - `Files.Get`: 通过名称生成文件的函数
  - `Files.GetBytes`
  - `Files.Glob`: 返回文件为列表的函数
  - `Files.Lines`: 一行行读取文件的函数
  - `Files.AsSecrets`: 返回文件内容为base64编码字符串的函数
  - `Files.AsConfig`: 返回文件内容为YAML map的函数
- `Capabilities`
  - `Capabilities.APIVersions`
  - `Capabilities.APIVersions.Has $version`
  - `Capabilities.KubeVersion`, `Capabilities.KubeVersion.Version`
  - `Capabilities.KubeVersion.Major`
  - `Capabilities.KubeVersion.Minor`
- `Template`
  - `Template.Name`
  - `Template.BasePath`
</code></pre></td></tr></table>
</div>
</div><p>内置的值总以大写字母开头。这与go命名方式保持一致。</p>
<br>
<br>
<h3 id="值文件">值文件</h3>
<p>Values Files: <a href="https://helm.sh/docs/chart_template_guide/values_files/">https://helm.sh/docs/chart_template_guide/values_files/</a></p>
<p><code>Values</code>是一个内置的对象。它提供了访问值并传递到chart包。值文件是平YAML文件。其内容来源于多个源：</p>
<ul>
<li>chart包中的<code>values.yaml</code>文件</li>
<li>如果是一个subchart包，则为parent chart包的<code>values.yaml</code>文件</li>
<li>通过<code>helm install/upgrade</code>的<code>-f myvals.yaml</code>传递值</li>
<li>通过<code>helm install/upgrade</code>的<code>--set foo=bar</code>选项传递值</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># values.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">favoriteDrink</span><span class="p">:</span><span class="w"> </span><span class="l">coffee</span><span class="w">
</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># configmap.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.favoriteDrink }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 渲染
helm install geared-marsupi ./mychart --dry-run --debug
HOOKS:
MANIFEST:
---
# Source: mychart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: geared-marsupi-configmap
data:
  myvalue: &#34;Hello World&#34;
  drink: coffee


# 通过命令行选项覆盖值
helm install solid-vulture ./mychart --dry-run --debug --set favoriteDrink=slurm
HOOKS:
MANIFEST:
---
# Source: mychart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: solid-vulture-configmap
data:
  myvalue: &#34;Hello World&#34;
  drink: slurm
</code></pre></td></tr></table>
</div>
</div><p>值文件也可以包含更多结构化的内容。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># values.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">favorite</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span><span class="l">coffee</span><span class="w">
</span><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span><span class="l">pizza</span><span class="w">
</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># configmap.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.favorite.drink }}</span><span class="w">
</span><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.favorite.food }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>虽然结构化数据这种方式是可行的，但建议你保持值的浅度(shallow)，有利于平整。当看到subcharts包的值时，我们将看到值是如何使用树状结构命名的。</p>
<br>
<br>
<h3 id="删除一个默认键">删除一个默认键</h3>
<p>Deleting a default key</p>
<p>如果你需要从默认值删除一个键，你可以覆盖这个键的值为<code>null</code>，在这种情况下，Helm将从覆盖值得合并中移除这个键。</p>
<br>
<br>
<h2 id="模板函数和管道">模板函数和管道</h2>
<p>Template Functions and Pipelines: <a href="https://helm.sh/docs/chart_template_guide/functions_and_pipelines/">https://helm.sh/docs/chart_template_guide/functions_and_pipelines/</a></p>
<p>到目前为止，我们以将看到如何将信息转换为模板。但这些信息放入未修改的模板。有时候，我们希望以一种更可用的方式来转换提供的数据。</p>
<p>在模板指令中调用<code>quote</code>函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">quote .Values.favorite.drink }}</span><span class="w">
</span><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">quote .Values.favorite.food }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>模板函数使用<code>funcationName arg1 arg2...</code>语法。上面的<code>quote .Values.favorite.drink</code>调用<code>quote</code>函数并传递一个参数。</p>
<p>Helm有超过60个可用的函数。一些通过go模板语言定义。大多数是Sprig template library的一部分。</p>
<br>
<h3 id="管道">管道</h3>
<p>pipelines(<code>|</code>)</p>
<p>模板语言的一个强大功能就是它的管道(<code>|</code>)。管道是让几件事情依序进行的有效方式。让我们使用管道重写上面的示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.favorite.drink | quote }}</span><span class="w">
</span><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.favorite.food | quote }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>使用管道，我们可以将多个函数链接在一起：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">drink</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.favorite.drink | repeat 5 | quote }}</span><span class="w">
</span><span class="w"></span><span class="nt">food</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.favorite.food | upper | quote }}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c">#drink: &#34;coffeecoffeecoffeecoffeecoffee&#34;</span><span class="w">
</span><span class="w"></span><span class="c">#food: &#34;PIZZA&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="default函数">default函数</h3>
<p><code>default</code>函数经常在模板中使用(<code>default DEFAULT_VALUE GIVEN_VALUE</code>)。此函数允许你指定一个默认值。有则替换它，无则使用默认值。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">drink</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.favorite.drink | default &#34;tea&#34; | quote }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>在实际的chart包中，所有静态默认值都应该位于<code>values.yaml</code>中，而不应该使用<code>default</code>重复。然而，<code>default</code>命令对于不能在<code>values.yaml</code>中声明的值，是完美的计算值的方法。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">drink</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.favorite.drink | default (printf &#34;%s-tea&#34; (include &#34;fullname&#34; .)) }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="lookup函数">lookup函数</h3>
<p><code>lookup</code>函数可用于在正在运行的集群中查找资源。它查找<code>apiVersion</code>, <code>kind</code>, <code>namespace</code>, <code>name</code>到resource或resource list。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># apiVersion, kind, namespace, name都是string
# name, namespace两个是可选的，可以为空进行传递


# 下列将会返回mynamespace对象的注释
(lookup &#34;v1&#34; &#34;Namespace&#34; &#34;&#34; &#34;mynamespace&#34;).metadata.annotations


# 当lookup返回一个列表(list)对象时，可以通过items字段访问列表对象
{{ range $index, $service := (lookup &#34;v1&#34; &#34;Service&#34; &#34;mynamespace&#34; &#34;&#34;).items }}
    {{/* do something with each service */}}
{{ end }}
</code></pre></td></tr></table>
</div>
</div><p>当没有找到对象时，则返回一个空值。这可以用于检查对象是否存在。</p>
<p><code>lookup</code>函数使用Helm现有的k8s连接配置来查询k8s。如果调用API server进行交互时返回错误，则Helm的模板处理将失败。</p>
<p>请记住，Helm是不应该在<code>helm template</code>或<code>helm install|update|delete|rollback --dry-run</code>期间连接到k8s API server，因此，<code>lookup</code>在此情况下将会获得一个空列表。</p>
<br>
<br>
<h3 id="操作符">操作符</h3>
<p>Operators are functions</p>
<p>对于模板，操作符(<code>eq</code>, <code>ne</code>, <code>lt</code>, <code>gt</code>, <code>and</code>, <code>or</code>等)都被实现为函数。在管道中，操作符可使用括号<code>()</code>进行分组。</p>
<br>
<br>
<h2 id="函数列表">函数列表</h2>
<p>Template Function List: <a href="https://helm.sh/docs/chart_template_guide/function_list/">https://helm.sh/docs/chart_template_guide/function_list/</a></p>
<p>Helm包含很多模板函数，你可以在模板中使用它们。下面按照功能列出：</p>
<ul>
<li>Cryptographic and Security</li>
<li>Date</li>
<li>Dictionaries</li>
<li>Encoding</li>
<li>File Path</li>
<li>Kubernetes and Chart</li>
<li>Logic and Flow Control</li>
<li>Lists</li>
<li>Math</li>
<li>Network</li>
<li>Reflection</li>
<li>Regular Expressions</li>
<li>Semantic Versions</li>
<li>String</li>
<li>Type Conversion</li>
<li>URL</li>
<li>UUID</li>
</ul>
<br>
<br>
<h2 id="流程控制">流程控制</h2>
<p>Flow Control: <a href="https://helm.sh/docs/chart_template_guide/control_structures/">https://helm.sh/docs/chart_template_guide/control_structures/</a></p>
<p>控制结构（在模板原语中称为行动）提供给模板作者，模板生成的控制流程的能力。Helm的模板语言提供了如下控制结构：</p>
<ul>
<li><code>if</code>, <code>else</code>：创建条件块</li>
<li><code>with</code>：指定一个范围</li>
<li><code>range</code>： 提供一个类似的for循环</li>
</ul>
<p>除此之外，它为声明和使用命名模板段提供了一些动作：</p>
<ul>
<li><code>define</code>：在模板内声明一个新的命名模板</li>
<li><code>template</code>：导入一个命名的模板</li>
<li><code>block</code>：声明一个特殊的可填写的模板区域</li>
</ul>
<p>这些都让我想起之前用Django模板语言写前端的时候，基本上一样的原理。</p>
<br>
<h3 id="if和else">if和else</h3>
<p><code>if</code>, <code>else</code>块示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">{{<span class="w"> </span><span class="l">if PIPELINE }}</span><span class="w">
</span><span class="w">  </span><span class="c"># Do something</span><span class="w">
</span><span class="w"></span>{{<span class="w"> </span><span class="l">else if OTHER PIPELINE }}</span><span class="w">
</span><span class="w">  </span><span class="c"># Do something else</span><span class="w">
</span><span class="w"></span>{{<span class="w"> </span><span class="l">else }}</span><span class="w">
</span><span class="w">  </span><span class="c"># Default case</span><span class="w">
</span><span class="w"></span>{{<span class="w"> </span><span class="l">end }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.favorite.drink | default &#34;tea&#34; | quote }}</span><span class="w">
</span><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.favorite.food | upper | quote }}</span><span class="w">
</span><span class="w">  </span>{{<span class="w"> </span><span class="l">if eq .Values.favorite.drink &#34;coffee&#34; }}mug: true{{ end }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="控制空格">控制空格</h3>
<p>Controlling Whitespace</p>
<p>虽然我们看到了条件语句，我们也应该了解模板中的空格的控制方式。这主要是确保对于生成的YAML文件的缩进的正确性。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.favorite.drink | default &#34;tea&#34; | quote }}</span><span class="w">
</span><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.favorite.food | upper | quote }}</span><span class="w">
</span><span class="w">  </span>{{<span class="w"> </span><span class="l">if eq .Values.favorite.drink &#34;coffee&#34; }}</span><span class="w">
</span><span class="w">    </span><span class="nt">mug</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span>{{<span class="w"> </span><span class="l">end }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>生成的不正确的YAML格式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># Source: mychart/templates/configmap.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">eyewitness-elk-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;coffee&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;PIZZA&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">mug</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>mug被不正确地缩进。让我们修改模板：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.favorite.drink | default &#34;tea&#34; | quote }}</span><span class="w">
</span><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.favorite.food | upper | quote }}</span><span class="w">
</span><span class="w">  </span>{{<span class="w"> </span><span class="l">if eq .Values.favorite.drink &#34;coffee&#34; }}</span><span class="w">
</span><span class="w">  </span><span class="nt">mug</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span>{{<span class="w"> </span><span class="l">end }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>这样生成的YAML是有效的，但显得很滑稽：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># Source: mychart/templates/configmap.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">telling-chimp-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;coffee&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;PIZZA&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">mug</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>请注意，在YAML文件中生成了几个空行。为什么？当模板引擎运行时，它将删除花括号里的内容，但它留下的剩余空格完全一样。</p>
<br>
<p>YAML对空白很在意，所以管理空白变得非常重要。幸运的是，Helm有一些工具来帮助我们。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 首先，模板声明的花括号 {{ 可以使用特殊字符进行修改，来告诉模板引擎排列空白
{{- 表示空白应靠左(chomped left)
-}} 表示空白应在右边消耗(right should be consumed)
# 注意，换行也是空白（Newlines are whitespace)
</code></pre></td></tr></table>
</div>
</div><br>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.favorite.drink | default &#34;tea&#34; | quote }}</span><span class="w">
</span><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.favorite.food | upper | quote }}</span><span class="w">
</span><span class="w">  </span>{{- <span class="l">if eq .Values.favorite.drink &#34;coffee&#34; }}</span><span class="w">
</span><span class="w">  </span><span class="nt">mug</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span>{{- <span class="l">end }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># Source: mychart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: clunky-cat-configmap
data:
  myvalue: &#34;Hello World&#34;
  drink: &#34;coffee&#34;
  food: &#34;PIZZA&#34;
  mug: true
</code></pre></td></tr></table>
</div>
</div><p>小心使用排列修改器(chomping modifier)。很容易不小心做了下面的事情：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.favorite.food | upper | quote }}</span><span class="w">
</span><span class="w">  </span>{{- <span class="l">if eq .Values.favorite.drink &#34;coffee&#34; -}}</span><span class="w">
</span><span class="w">  </span><span class="nt">mug</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span>{{- <span class="l">end -}}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>这会生成<code>food: &quot;PIZZA&quot;mug:true</code>这样，因为它消耗了两侧的换行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 最后，有时很容易告诉模板系统如何缩进，而不是试图掌握模板指令的空格。
# 出于此原因，你有时可能会发现使用 indent函数 处理缩进是很有用的
{{ indent 2 &#34;mug: true&#34; }}
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="使用with修改范围">使用with修改范围</h3>
<p>Modifying scope using with</p>
<p>另一个控制结构是<code>with</code>动作。这可以控制变量的范围，<code>.</code>是指的当前范围。因此，<code>.Values</code>告诉模板到当前范围下去寻找<code>Values</code>对象。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># with语法和if语句类似</span><span class="w">
</span><span class="w"></span>{{<span class="w"> </span><span class="l">with PIPELINE }}</span><span class="w">
</span><span class="w">  </span><span class="c"># restricted scope</span><span class="w">
</span><span class="w"></span>{{<span class="w"> </span><span class="l">end }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>范围可以被更改。<code>with</code>可以允许你将当前范围(<code>.</code>)设置为特定对象。例如，我们使用<code>.Values.favorite</code>工作。让我们在<code>.Values.favorite</code>范围来重写ConfigMap：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span><span class="w">  </span>{{- <span class="l">with .Values.favorite }}</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.drink | default &#34;tea&#34; | quote }}</span><span class="w">
</span><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.food | upper | quote }}</span><span class="w">
</span><span class="w">  </span>{{- <span class="l">end }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 注意，由于我们使用 with 将范围设置在了 .Values.favorite
# 所以我们使用 .drink, .food。范围在 {{ end }} 后被还原
</code></pre></td></tr></table>
</div>
</div><p>但这里有一个值得注意的问题！在限制的范围内，你将无法从父对象范围(<code>.</code>)访问其它对象。以下示例会失败：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">{{- <span class="l">with .Values.favorite }}</span><span class="w">
</span><span class="w"></span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.drink | default &#34;tea&#34; | quote }}</span><span class="w">
</span><span class="w"></span><span class="nt">food</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.food | upper | quote }}</span><span class="w">
</span><span class="w"></span><span class="nt">release</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}</span><span class="w">
</span><span class="w"></span>{{- <span class="l">end }}</span><span class="w">
</span><span class="w"></span><span class="nt">release-2</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>由于<code>Release.Name</code>没有在限制的范围(<code>.</code>)内，会报错。但在限制的之外就没有问题。</p>
<p>或者，我们可以使用<code>$</code>符号从父范围访问<code>Release.Name</code>对象。<code>$</code>符号在开始执行时会映射到根范围内，在模板执行时也不会改变。示例如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">{{- <span class="l">with .Values.favorite }}</span><span class="w">
</span><span class="w"></span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.drink | default &#34;tea&#34; | quote }}</span><span class="w">
</span><span class="w"></span><span class="nt">food</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.food | upper | quote }}</span><span class="w">
</span><span class="w"></span><span class="nt">release</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">$.Release.Name }}</span><span class="w">
</span><span class="w"></span>{{- <span class="l">end }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>在了解<code>range</code>后，我们会看到模板变量，它提供了一个解决上述作用域问题的方法。</p>
<br>
<br>
<h3 id="range循环">range循环</h3>
<p>Looping with the range action</p>
<p>许多编程语言都是用<code>for</code>循环，在Helm模板语言中，它使用<code>range</code>操作符来实现迭代。</p>
<p>首先，让我们在<code>values.yaml</code>文件里添加一个列表。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">favorite</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span><span class="l">coffee</span><span class="w">
</span><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span><span class="l">pizza</span><span class="w">
</span><span class="w"></span><span class="nt">pizzaToppings</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">mushrooms</span><span class="w">
</span><span class="w">  </span>- <span class="l">cheese</span><span class="w">
</span><span class="w">  </span>- <span class="l">peppers</span><span class="w">
</span><span class="w">  </span>- <span class="l">onions</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>在我们的ConfigMap中获取值里面的列表：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span><span class="w">  </span>{{- <span class="l">with .Values.favorite }}</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.drink | default &#34;tea&#34; | quote }}</span><span class="w">
</span><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.food | upper | quote }}</span><span class="w">
</span><span class="w">  </span>{{- <span class="l">end }}</span><span class="w">
</span><span class="w">  </span><span class="nt">toppings</span><span class="p">:</span><span class="w"> </span><span class="p">|-</span><span class="sd">
</span><span class="sd">    {{- ranage .Values.pizzaToppings }}
</span><span class="sd">    - {{ . | title | quote }}
</span><span class="sd">    {{- end }}</span><span class="w">    
</span></code></pre></td></tr></table>
</div>
</div><p>我们可以使用<code>$</code>来访问父范围内的<code>Values.pizzaToppings</code>。<code>$</code>符号映射到根目录下，并在函数执行时不会改变。示例如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span><span class="w">  </span>{{- <span class="l">with $.Values.favorite }}</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.drink | default &#34;tea&#34; | quote }}</span><span class="w">
</span><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.food | upper | quote }}</span><span class="w">
</span><span class="w">  </span><span class="nt">toppings</span><span class="p">:</span><span class="w"> </span><span class="p">|-</span><span class="sd">
</span><span class="sd">    {{- range $.Values.pizzaToppings }}
</span><span class="sd">    - {{ .| title | quote }}
</span><span class="sd">    {{- end }}</span><span class="w">    
</span><span class="w">  </span>{{- <span class="l">end }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>渲染示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># Source: mychart/templates/configmap.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">edgy-dragonfly-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;coffee&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;PIZZA&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">toppings</span><span class="p">:</span><span class="w"> </span><span class="p">|-</span><span class="sd">
</span><span class="sd">    - &#34;Mushrooms&#34;
</span><span class="sd">    - &#34;Cheese&#34;
</span><span class="sd">    - &#34;Peppers&#34;
</span><span class="sd">    - &#34;Onions&#34;</span><span class="w">    
</span></code></pre></td></tr></table>
</div>
</div><p>符号<code>|-</code>声明一个多行字符串。因此，实际上我们的toppings不是一个YAML list，而是一个big string。我们为什么要这样做？因为在ConfigMaps <code>data</code>里的数据是由键值对(k/v)组成，其中键和值都是简单的字符串。要理解为什么这样的化，请查看k8s configmap文档。</p>
<p>YAML里的<code>|-</code>符号表示一个多行字符串(multi-line string)。这可以在文件中嵌入一大块数据。</p>
<p>Helm模板具有一个<code>tuple</code>函数，来使得操作更简单。让我想起了Python中的tuple数据类型。示例如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">sizes</span><span class="p">:</span><span class="w"> </span><span class="p">|-</span><span class="sd">
</span><span class="sd">  {{- range ruple &#34;small&#34; &#34;medium&#34; &#34;large&#34;}}
</span><span class="sd">  - {{ . }}
</span><span class="sd">  {{- end }}</span><span class="w">  
</span></code></pre></td></tr></table>
</div>
</div><p>结果如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">sizes</span><span class="p">:</span><span class="w"> </span><span class="p">|-</span><span class="sd">
</span><span class="sd">  - small
</span><span class="sd">  - medium
</span><span class="sd">  - large</span><span class="w">  
</span></code></pre></td></tr></table>
</div>
</div><p>除了list和tuple，<code>range</code>还可以迭代具有有键值对的map和dict。我们将在后面的章节中了解它们。</p>
<br>
<br>
<br>
<h2 id="变量">变量</h2>
<p>Variables: <a href="https://helm.sh/docs/chart_template_guide/variables/">https://helm.sh/docs/chart_template_guide/variables/</a></p>
<p>我们可以在模板中使用变量。在Helm模板中，变量是其它对象的命名引用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Releae.Name }}-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span><span class="w">  </span>{{- <span class="l">$relname := .Release.Name -}}</span><span class="w">
</span><span class="w">  </span>{{- <span class="l">with .Values.favorite }}</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.drink | default &#34;tea&#34; | quote }}</span><span class="w">
</span><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.food | upper | quote }}</span><span class="w">
</span><span class="w">  </span><span class="nt">release</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">$relname }}</span><span class="w">
</span><span class="w">  </span>{{- <span class="l">end }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>在<code>with</code>块之前，我们赋值了一个变量。在<code>with</code>块内，<code>$relname</code>变量仍然指向版本名称。</p>
<p>在<code>range</code>循环中使用变量：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">toppings</span><span class="p">:</span><span class="w"> </span><span class="p">|-</span><span class="sd">
</span><span class="sd">    {{- range $index, $topping := .Values.pizzaToppings }}
</span><span class="sd">      {{ $index }}: {{ $topping }}
</span><span class="sd">    {{- end }</span><span class="w">    
</span></code></pre></td></tr></table>
</div>
</div><p>渲染效果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">toppings</span><span class="p">:</span><span class="w"> </span><span class="p">|-</span><span class="sd">
</span><span class="sd">      0: mushrooms
</span><span class="sd">      1: cheese
</span><span class="sd">      2: peppers
</span><span class="sd">      3: onions</span><span class="w">      
</span></code></pre></td></tr></table>
</div>
</div><p>有一个变量(<code>$</code>)它永远是全局的，此变量将永远指向根上下文(root context)。放你使用<code>range</code>循环，并且需要知道chart的版本名称时，这非常有用。示例如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">{{- <span class="l">range .Values.tlsSecrets }}</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.name }}</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># Many helm templates would use `.` below, but that will not work,</span><span class="w">
</span><span class="w">    </span><span class="c"># however `$` will work here</span><span class="w">
</span><span class="w">    </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">template &#34;fullname&#34; $ }}</span><span class="w">
</span><span class="w">    </span><span class="c"># I cannot reference .Chart.Name, but I can do $.Chart.Name</span><span class="w">
</span><span class="w">    </span><span class="nt">helm.sh/chart</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $.Chart.Name }}-{{ $.Chart.Version }}&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">app.kubernetes.io/instance</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $.Release.Name }}&#34;</span><span class="w">
</span><span class="w">    </span><span class="c"># Value from appVersion in Chart.yaml</span><span class="w">
</span><span class="w">    </span><span class="nt">app.kubernetes.io/version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $.Chart.AppVersion }}&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">app.kubernetes.io/managed-by</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $.Release.Service }}&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/tls</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">tls.crt</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.certificate }}</span><span class="w">
</span><span class="w">  </span><span class="nt">tls.key</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.key }}</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span>{{- <span class="l">end }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>到目前为止，我们已看到了只在一个文件中声明的模板。但是Helm模板语言的一个强大功能是声明多个模板和使用它们。我们将在后面的章节了解到。</p>
<br>
<br>
<br>
<h2 id="命名模板">命名模板</h2>
<p>Named Templates: <a href="https://helm.sh/docs/chart_template_guide/named_templates/">https://helm.sh/docs/chart_template_guide/named_templates/</a></p>
<p>是时候使用多个模板了。本章中，我们将在一个文件中命名模板，然后在其它地方使用它们。这让我想起了Python写Web是的模板。命名模板（有时称为子模板）是在文件中定义的一个简单的模板。有两种方法来创建它，有几种不同的方法来使用它。</p>
<p>在流程控制(flow control)章节，我们介绍了<code>define</code>, <code>template</code>, <code>block</code>这三个声明和管理模板的动作。在本章中，我们将讨论这三种动作，并引入一种特殊目的的<code>include</code>函数。</p>
<p>命名模板的一个重要细节：模板名称是全局的。如果声明了两个相同名称的模板，whichever one is loaded last will be the one used. 由于subcharts中的模板与顶级模板一起编译，你应该小心命名。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 一种流行的命名约定是使用chart名作为前缀：
{{ define &#34;mychart.labels&#34; }}
# 通过使用特定的chart名称作为前缀，我们可以避免相同模板名称所带来的冲突
</code></pre></td></tr></table>
</div>
</div><br>
<h3 id="下划线文件">下划线文件</h3>
<p>Partials and <code>_</code> files</p>
<p>目前为止，我们使用的一个文件中包含一个模板。但是Helm模板语言允许你创建命名嵌套模板，可通过名称在其它任何地方进行访问。</p>
<p>在我们开始编写这些模板之前，我们需要注意一下命名规范：</p>
<ul>
<li><code>templates/</code>下的大多数文件被视为包含k8s manifests</li>
<li><code>NOTES.txt</code>是一个例外</li>
<li>以下划线(<code>_</code>)开头的文件被假定为不包含k8s manifests。这些文件不会被渲染为k8s对象定义，但可在任意chart templates中使用。</li>
</ul>
<p>这些文件用来存储特定(partials)和助手(helpers)。实际上，当我们第一次创建<code>mychart</code>，我们会看到<code>_helpers.tpl</code>文件，此文件是默认的template partials。</p>
<br>
<br>
<h3 id="声明和使用模板">声明和使用模板</h3>
<p>Declaring and using templates with <code>define</code> and <code>template</code>。</p>
<p><code>define</code>动作允许我们在一个模板文件中创建命名模板(named template)。语法如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-tpl" data-lang="tpl"><span class="cp">{{</span> <span class="na">define</span> <span class="s2">&#34;MY.NAME &#34;</span><span class="cp">}}</span><span class="x">
</span><span class="x">  # body of template here
</span><span class="x"></span><span class="cp">{{</span> <span class="na">end</span> <span class="cp">}}</span><span class="x">
</span></code></pre></td></tr></table>
</div>
</div><p>栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">{{- <span class="l">define &#34;mychart.labels&#34; }}</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">generator</span><span class="p">:</span><span class="w"> </span><span class="l">helm</span><span class="w">
</span><span class="w">    </span><span class="nt">data</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">now | htmlDate }}</span><span class="w">
</span><span class="w"></span>{{- <span class="l">end }}</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-configmap</span><span class="w">
</span><span class="w">  </span>{{- <span class="l">template &#34;mychart.labels&#34; }}</span><span class="w">
</span><span class="w">  </span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span><span class="w">    </span>{{- <span class="l">range $key, $va1 := .Values.favorite }}</span><span class="w">
</span><span class="w">    </span>{{<span class="w"> </span><span class="nt">$key }}</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">$va1 | quote }}</span><span class="w">
</span><span class="w">    </span>{{- <span class="l">end }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>渲染之后的效果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># Source: mychart/templates/configmap.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">running-panda-configmap</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">generator</span><span class="p">:</span><span class="w"> </span><span class="l">helm</span><span class="w">
</span><span class="w">    </span><span class="nt">date</span><span class="p">:</span><span class="w"> </span><span class="ld">2016-11-02</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;coffee&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;pizza&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><code>define</code>仅定义，只有在模板中调用时才会产生输出。</p>
<p>按照惯例，Helm charts将这些模板放在partials文件中（通常是<code>_helpers.tpl</code>），如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-tpl" data-lang="tpl"><span class="cp">{{</span><span class="o">/*</span> <span class="na">Generate</span> <span class="na">basic</span> <span class="na">labels</span> <span class="o">*/</span><span class="cp">}}</span><span class="x">
</span><span class="x"></span><span class="cp">{{</span><span class="o">-</span> <span class="na">define</span> <span class="s2">&#34;mychart.labels&#34;</span> <span class="cp">}}</span><span class="x">
</span><span class="x">  labels:
</span><span class="x">    generator: helm
</span><span class="x">    date: </span><span class="cp">{{</span> <span class="na">now</span> <span class="o">|</span> <span class="na">htmlDate</span> <span class="cp">}}</span><span class="x">
</span><span class="x"></span><span class="cp">{{</span><span class="o">-</span> <span class="na">end</span> <span class="cp">}}</span><span class="x">
</span></code></pre></td></tr></table>
</div>
</div><br>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 按照管理，define函数 应该有一个简单的文档块 {{/*...*/}}
# 如上。然后在其它模板文件中访问它。
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="设置模板范围">设置模板范围</h3>
<p>Setting the scope of a template</p>
<p>在上面定义的模板中，我们没有使用任何对象。让我们做些修改：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-tpl" data-lang="tpl"><span class="cp">{{</span><span class="o">/*</span> <span class="na">Generate</span> <span class="na">basic</span> <span class="na">labels</span> <span class="o">*/</span><span class="cp">}}</span><span class="x">
</span><span class="x"></span><span class="cp">{{</span><span class="o">-</span> <span class="na">define</span> <span class="s2">&#34;mychart.labels&#34;</span> <span class="cp">}}</span><span class="x">
</span><span class="x">  labels:
</span><span class="x">    generator: helm
</span><span class="x">    data: </span><span class="cp">{{</span> <span class="na">now</span> <span class="o">|</span> <span class="na">htmlData</span> <span class="cp">}}</span><span class="x">
</span><span class="x">    chart: </span><span class="cp">{{</span> <span class="o">.</span><span class="na">Chart</span><span class="o">.</span><span class="na">Name</span> <span class="cp">}}</span><span class="x">
</span><span class="x">    version: </span><span class="cp">{{</span> <span class="o">.</span><span class="na">Chart</span><span class="o">.</span><span class="na">Version</span> <span class="cp">}}</span><span class="x">
</span><span class="x"></span><span class="cp">{{</span><span class="o">-</span> <span class="na">end</span> <span class="cp">}}</span><span class="x">
</span></code></pre></td></tr></table>
</div>
</div><p>上面定义的名称和版本是动态的，会根据不同的模板生成不同的值。</p>
<p>之前的引用并没有床底范围，因此在模板内我们不能使用<code>.</code>来访问任何事物。现在我们对模板加上范围:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-configmap</span><span class="w">
</span><span class="w">  </span>{{- <span class="l">template &#34;mychart.labels&#34; . }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>注意上面在模板调用处使用的点(<code>.</code>)。我们可以非常容易地传递<code>.Values</code>或<code>.Values.favorite</code>或任何我们需要的范围。但是，我们需要的是顶级范围。</p>
<p>现在运行渲染(<code>helm install --dry-run --debug plinking-anaco ./mychart</code>)来预览下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># Source: mychart/templates/configmap.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">plinking-anaco-configmap</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">generator</span><span class="p">:</span><span class="w"> </span><span class="l">helm</span><span class="w">
</span><span class="w">    </span><span class="nt">date</span><span class="p">:</span><span class="w"> </span><span class="ld">2016-11-02</span><span class="w">
</span><span class="w">    </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l">mychart</span><span class="w">
</span><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="m">0.1.0</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="include">include</h3>
<p>The <code>include</code> function</p>
<p>假设我们定义了如下一个简单模板：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-tpl" data-lang="tpl"><span class="cp">{{</span><span class="o">-</span> <span class="na">define</span> <span class="s2">&#34;mychart.app&#34;</span> <span class="o">-</span><span class="cp">}}</span><span class="x">
</span><span class="x">app_name: </span><span class="cp">{{</span> <span class="o">.</span><span class="na">Chart</span><span class="o">.</span><span class="na">Name</span> <span class="cp">}}</span><span class="x">
</span><span class="x">app_version: &#34;</span><span class="cp">{{</span> <span class="o">.</span><span class="na">Chart</span><span class="o">.</span><span class="na">Version</span> <span class="cp">}}</span><span class="x">&#34;
</span><span class="x"></span><span class="cp">{{</span><span class="o">-</span> <span class="na">end</span> <span class="o">-</span><span class="cp">}}</span><span class="x">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p>一个错误的栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-configmap</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>{{<span class="w"> </span><span class="l">template &#34;mychart.app&#34; . }}</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span><span class="w">  </span>{{- <span class="l">range $key, $val := .Values.favorite }}</span><span class="w">
</span><span class="w">  </span>{{<span class="w"> </span><span class="nt">$key }}</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">$val | quote }}</span><span class="w">
</span><span class="w">  </span>{{- <span class="l">end }}</span><span class="w">
</span><span class="w"></span>{{<span class="w"> </span><span class="l">template &#34;mychart.app&#34; . }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>渲染的结果并不正确：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># Source: mychart/templates/configmap.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">measly-whippet-configmap</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app_name</span><span class="p">:</span><span class="w"> </span><span class="l">mychart</span><span class="w">
</span><span class="w"></span><span class="nt">app_version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0.1.0+1478129847&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;coffee&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;pizza&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">app_name</span><span class="p">:</span><span class="w"> </span><span class="l">mychart</span><span class="w">
</span><span class="w"></span><span class="nt">app_version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0.1.0+1478129847&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Because the template that is substituted in has the text aligned to the right. Because template is an action, and not a function, there is no way to pass the output of a template call to other functions; the data is simply inserted inline.</p>
<p>To work around this case, Helm provides an alternative to template that will import the contents of a template into the present pipeline where it can be passed along to other functions in the pipeline.</p>
<p>因为模板是靠右对齐的文本，因为<code>template</code>是一个动作，不是一个函数，因此无法传递调用其它函数的<code>template</code>的输出，数据被简单的插入内联。</p>
<br>
<p>现在我们需要使用<code>ident</code>来告诉模板正确的缩进，栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-configmap</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w"></span>{{<span class="w"> </span><span class="l">include &#34;mychart.app&#34; . | indent 4 }}</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span><span class="w">  </span>{{- <span class="l">range $key, $va1 := .Values.favorite }}</span><span class="w">
</span><span class="w">  </span>{{<span class="w"> </span><span class="nt">$key }}</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">$val | quote }}</span><span class="w">
</span><span class="w">  </span>{{- <span class="l">end }}</span><span class="w">
</span><span class="w">  </span>{{<span class="w"> </span><span class="l">include &#34;mychart.app&#34; . | indent 2 }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>正确的渲染结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># Source: mychart/templates/configmap.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">edgy-mole-configmap</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app_name</span><span class="p">:</span><span class="w"> </span><span class="l">mychart</span><span class="w">
</span><span class="w">    </span><span class="nt">app_version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0.1.0+1478129987&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">myvalue</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Hello World&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;coffee&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;pizza&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">app_name</span><span class="p">:</span><span class="w"> </span><span class="l">mychart</span><span class="w">
</span><span class="w">  </span><span class="nt">app_version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0.1.0+1478129987&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>在Helm template中使用<code>include</code>对<code>template</code>被认为更好，这使得输出格式可以为YAML文档更好地处理。</p>
<p>有时候，我们想要导入内容，但不作为模板。也就是逐字导入文件。我们可以通过<code>.Files</code>对象访问文件来实现这一目标。</p>
<br>
<br>
<h2 id="在模板内访问文件">在模板内访问文件</h2>
<p>Accessing Files Inside Templates: <a href="https://helm.sh/docs/chart_template_guide/accessing_files/">https://helm.sh/docs/chart_template_guide/accessing_files/</a></p>
<p>Helm提供了<code>.Files</code>对象来访问文件。在开始模板示例之前，有些事需要注意下：</p>
<ul>
<li>可以添加额外的文件到Helm chart。这些文件将被捆绑。要注意，charts必须小于1MB，因为k8s对象的存储限制。</li>
<li>某些文件无法通过<code>.Files</code>对象访问，通常出于安全原因
<ul>
<li><code>templates/</code>目录内的文件无法访问</li>
<li><code>.helmignore</code>中包含的文件无法访问</li>
</ul>
</li>
<li>Charts不保留UNIX mode信息，当设计到<code>.Files</code>对象时，文件级别的权限对一个文件的可用性没有影响。</li>
</ul>
<br>
<h3 id="示例-2">示例</h3>
<p>Basic example</p>
<p>添加三个位于<code>mychart/</code>目录下的文件。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># config1.toml
message = Hello from config 1

# config1.tom2
message = Hello from config 2

# config1.tom3
message = Goodbye from config 3
</code></pre></td></tr></table>
</div>
</div><p>在模板中访问文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>{{- <span class="l">$files := .Files }}</span><span class="w">
</span><span class="w">  </span>{{- <span class="l">range tuple &#34;config1.tom1&#34; &#34;config2.toml&#34; &#34;config3.toml&#34; }}</span><span class="w">
</span><span class="w">  </span>{{<span class="w"> </span><span class="nt">.}}</span><span class="p">:</span><span class="w"> </span><span class="p">|-</span><span class="sd">
</span><span class="sd">    </span><span class="w">    </span>{{<span class="w"> </span><span class="l">$files.Get .}}</span><span class="w">
</span><span class="w">  </span>{{- <span class="l">end }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 首先，创建了一个 $files变量 来保存.Files对象的引用
# 我们同样使用 tuple函数来创建循环的文件列表
# 接着打印每个文件名 {{ . }}: |- 后面接着文件内容 {{ $files.Get . }}
</code></pre></td></tr></table>
</div>
</div><p>渲染效果示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># Source: mychart/templates/configmap.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">quieting-giraf-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">config1.toml</span><span class="p">:</span><span class="w"> </span><span class="p">|-</span><span class="sd">
</span><span class="sd">    </span><span class="w">    </span><span class="l">message = Hello from config 1</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">config2.toml</span><span class="p">:</span><span class="w"> </span><span class="p">|-</span><span class="sd">
</span><span class="sd">    </span><span class="w">    </span><span class="l">message = This is config 2</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">config3.toml</span><span class="p">:</span><span class="w"> </span><span class="p">|-</span><span class="sd">
</span><span class="sd">    </span><span class="w">    </span><span class="l">message = Goodbye from config 3</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="路径助手">路径助手</h3>
<p>Path helpers</p>
<p>使用文件时，对文件路径执行一些标准的操作是有用的。为了帮助处理，Helm从go path包中引入了许多函数供你使用:</p>
<ul>
<li><code>Base</code></li>
<li><code>Dir</code></li>
<li><code>Ext</code></li>
<li><code>IsAbs</code></li>
<li><code>Clean</code></li>
</ul>
<br>
<br>
<h3 id="glob模式">Glob模式</h3>
<p>Glob patterns</p>
<p>随着你的chart包的增长，你会发现你有一个更大的需来组织你的文件，因此我们提供了<code>Files.Glob(pattern string)</code>方法，以帮助提取某些文件与glob patterns的所有灵活性。</p>
<p><code>.Glob</code>返回一个<code>Files</code>类型，因此你可以在返回的对象上调用任意<code>Files</code>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 示例的目录结构
foo/:
  foo.txt foo.yaml

bar/:
  bar.go bar.conf baz.yaml
</code></pre></td></tr></table>
</div>
</div><p>使用Globs的多种选项：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">{{ $currentScope := .}}
{{ range $path, $_ :=  .Files.Glob  &#34;**.yaml&#34; }}
    {{- with $currentScope}}
        {{ .Files.Get $path }}
    {{- end }}
{{ end }}
</code></pre></td></tr></table>
</div>
</div><p>或者：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">{{ range $path, $_ :=  .Files.Glob  &#34;**.yaml&#34; }}
      {{ $.Files.Get $path }}
{{ end }}
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="configmap和secrets的实用功能">ConfigMap和Secrets的实用功能</h3>
<p>ConfigMap and Secrets utility functions</p>
<p>将文件内容放置到K8s ConfigMap或Secrets中非常常见，然后在运行的时候挂载到容器。为了帮助实现此功能，我们在<code>Files</code>类型上提供了几种实用的方法：</p>
<ul>
<li><code>AsCoinfig</code></li>
<li><code>AsSecrets</code></li>
</ul>
<p>栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">conf</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w"></span>{{<span class="w"> </span><span class="l">(.Files.Glob &#34;foo/*&#34;).AsConfig | indent 2 }}</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">very-secret</span><span class="w">
</span><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w"></span>{{<span class="w"> </span><span class="l">(.Files.Glob &#34;bar/*&#34;).AsSecrets | indent 2 }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="编码">编码</h3>
<p>Encoding</p>
<p>你可以导入一个文件，并实用base64编码来确保成功传输：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-secret</span><span class="w">
</span><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="p">|-</span><span class="sd">
</span><span class="sd">    </span><span class="w">    </span>{{<span class="w"> </span><span class="l">.Files.Get &#34;config1.toml&#34; | b64enc }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>渲染后的效果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># Source: mychart/templates/secret.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">lucky-turkey-secret</span><span class="w">
</span><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="p">|-</span><span class="sd">
</span><span class="sd">    </span><span class="w">    </span><span class="l">bWVzc2FnZSA9IEhlbGxvIGZyb20gY29uZmlnIDEK</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="行">行</h3>
<p>Lines</p>
<p>有时候需要在模板中访问一个文件中的每行内容。我们为此提供了<code>Lines</code>方法。</p>
<p>示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">some-file.txt</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">range .Files.Lines &#34;foo/bar.txt&#34; }}</span><span class="w">
</span><span class="w">    </span>{{<span class="w"> </span><span class="l">. }}{{ end }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h2 id="notestxt">NOTES.txt</h2>
<p>Creating a NOTES.txt File: <a href="https://helm.sh/docs/chart_template_guide/notes_files/">https://helm.sh/docs/chart_template_guide/notes_files/</a></p>
<p>在<code>helm install</code>或<code>helm upgrade</code>结束，Helm可以为用户打印一块有用的信息。此信息使用模板且高度可定制。</p>
<p>要为你的chart包添加安装说明，简单地创建一个<code>templates/NOTES.txt</code>文件。此文件是纯文本文件，但它像作为模板一样处理，并可访问所有正常模板函数和对象。</p>
<p><code>NOTES.txt</code>文件示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">Thank you for installing {{ .Chart.Name }}

Your release is named {{ .Release.Name }}

To learn more about the release, try:
  $ helm status {{ .Release.Name }}
  $ helm get all {{ .Release.Name }}
</code></pre></td></tr></table>
</div>
</div><p>接下来运行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">helm install rude-cardinal ./mychart

RESOURCES:
==&gt; v1/Secret
NAME                   TYPE      DATA      AGE
rude-cardinal-secret   Opaque    1         0s

==&gt; v1/ConfigMap
NAME                      DATA      AGE
rude-cardinal-configmap   3         0s


NOTES:
Thank you for installing mychart.

Your release is named rude-cardinal.

To learn more about the release, try:

  $ helm status rude-cardinal
  $ helm get all rude-cardinal
</code></pre></td></tr></table>
</div>
</div><p>强烈建议创建<code>NOTES.txt</code>文件，以帮助用户获得chart包的有用信息。</p>
<br>
<br>
<h2 id="subcharts">Subcharts</h2>
<p>Subcharts and Global Values: <a href="https://helm.sh/docs/chart_template_guide/subcharts_and_globals/">https://helm.sh/docs/chart_template_guide/subcharts_and_globals/</a></p>
<p>之前我们只有一个chart，但charts可能会有依赖(dependencies)，称为subcharts。subcharts也有自己的值和模板。本章我们将会创建subchart，并看看我们可以从模板访问值的不同的方式。</p>
<p>subcharts的一些重要详情：</p>
<ul>
<li>一个subchart被认为是独立的(stand-alone)，这意味着一个subchart不能明确依赖它的parent chart</li>
<li>出于此原因，subchart不能访问parent chart的值</li>
<li>parent chart可以覆盖subcharts的值</li>
<li>Helm有一个全局值(global values)的概念，这些全局值可被所有charts访问</li>
</ul>
<br>
<h3 id="创建一个subchart">创建一个subchart</h3>
<p>Creating a Subchart</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="nb">cd</span> mychart/charts

helm create mysubchart

rm -rf mysubchart/templates/*.*
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="对subchart添加值和模板">对subchart添加值和模板</h3>
<p>Adding Values and a Template to the Subchart</p>
<p>为subchart添加一个简单的值和模板：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># values.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">dessert</span><span class="p">:</span><span class="w"> </span><span class="l">cake</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-cfgmap2</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">dessert</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.dessert }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>因为每个subchart都是独立的chart，我们可以测试mysubchart：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">helm install --generate-name --dry-run --debug mychart/charts/mysubchart
SERVER: <span class="s2">&#34;localhost:44134&#34;</span>
CHART PATH: /Users/mattbutcher/Code/Go/src/helm.sh/helm/_scratch/mychart/charts/mysubchart
NAME:   newbie-elk
TARGET NAMESPACE:   default
CHART:  mysubchart 0.1.0
MANIFEST:
---
<span class="c1"># Source: mysubchart/templates/configmap.yaml</span>
apiVersion: v1
kind: ConfigMap
metadata:
  name: newbie-elk-cfgmap2
data:
  dessert: cake
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="从parent-chart覆盖值">从parent chart覆盖值</h3>
<p>现在，mychart是mysubchart的parent chart。因为mychart是parent chart，我们可以在mychart中指定配置，并将配置推送到mysubchart中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># mychart/values.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">favorite</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span><span class="l">coffee</span><span class="w">
</span><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span><span class="l">pizza</span><span class="w">
</span><span class="w"></span><span class="nt">pizzaToppings</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">mushrooms</span><span class="w">
</span><span class="w">  </span>- <span class="l">cheese</span><span class="w">
</span><span class="w">  </span>- <span class="l">peppers</span><span class="w">
</span><span class="w">  </span>- <span class="l">onions</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">mysubchart</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">dessert</span><span class="p">:</span><span class="w"> </span><span class="l">ice cream</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>我们在parent chart(mychart)的值文件里添加了mysubchart的值，mysubchart这部分值会发送到mysubchart包，这回覆盖mysubchart的值。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">helm install --dry-run --debug mychart

<span class="c1"># Source: mychart/charts/mysubchart/templates/configmap.yaml</span>
apiVersion: v1
kind: ConfigMap
metadata:
  name: unhinged-bee-cfgmap2
data:
  dessert: ice cream
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="全局值">全局值</h3>
<p>Global Chart Values</p>
<p>有时候你需要将值提供给所有模板，这可以使用全局值(global chart values)。全局值可被任意chart或subchart通过相同的名称来访问。全局需要明确地声明。</p>
<p>值数据类型保留在称为<code>Values.global</code>的区域，此区域可以设置全局值。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># mychart/values.yaml</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">favorite</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">drink</span><span class="p">:</span><span class="w"> </span><span class="l">coffee</span><span class="w">
</span><span class="w">  </span><span class="nt">food</span><span class="p">:</span><span class="w"> </span><span class="l">pizza</span><span class="w">
</span><span class="w"></span><span class="nt">pizzaToppings</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">mushrooms</span><span class="w">
</span><span class="w">  </span>- <span class="l">cheese</span><span class="w">
</span><span class="w">  </span>- <span class="l">peppers</span><span class="w">
</span><span class="w">  </span>- <span class="l">onions</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">mysubchart</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">dessert</span><span class="p">:</span><span class="w"> </span><span class="l">ice cream</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">global</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">salad</span><span class="p">:</span><span class="w"> </span><span class="l">caesar</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># 任意chart和subchart都可以使用 {{ .Values.global.salad }} 来访问这个值</span><span class="w">
</span><span class="w"></span><span class="c"># mychart/templates/configmap.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">salad</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.global.salad }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># mysubchart/templates/configmap.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Name }}-cfgmap2</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">dessert</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.dessert }}</span><span class="w">
</span><span class="w">  </span><span class="nt">salad</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.global.salad }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>渲染输出效果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># Source: mychart/templates/configmap.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">silly-snake-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">salad</span><span class="p">:</span><span class="w"> </span><span class="l">caesar</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="c"># Source: mychart/charts/mysubchart/templates/configmap.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">silly-snake-cfgmap2</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">dessert</span><span class="p">:</span><span class="w"> </span><span class="l">ice cream</span><span class="w">
</span><span class="w">  </span><span class="nt">salad</span><span class="p">:</span><span class="w"> </span><span class="l">caesar</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="共享模板">共享模板</h3>
<p>Sharing Templates with Subcharts</p>
<p>parent charts和subcharts可以共享模板。任意在chart中定义的block(块)都可以被其它charts所使用。</p>
<p>定义一个简单的模板栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">{{- <span class="l">define &#34;labels&#34; }}from: mychart {{ end }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>尽管chart开发者可以在<code>include</code>和<code>template</code>之间选择，但使用<code>include</code>的优点是它可以动态引用模板：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">{{ include $mytemplate }}
</code></pre></td></tr></table>
</div>
</div><p>上面间接引用<code>$mytemplate</code>。<code>template</code>函数，相反它只接受一个字符串。</p>
<br>
<br>
<h3 id="避免使用块">避免使用块</h3>
<p>Avoid Using Blocks</p>
<p>go模板语言提供了一个<code>block</code>关键字，来允许开发者提供一个覆盖的默认实现。在Helm chart中，块(block)并不是覆盖的最佳工具，因为如果提供了相同块的多个实现，选择的那个是不可预测的。</p>
<p>建议使用<code>include</code>来代替。</p>
<br>
<br>
<h2 id="helmignore">.helmignore</h2>
<p>The .helmignore file: <a href="https://helm.sh/docs/chart_template_guide/helm_ignore_file/">https://helm.sh/docs/chart_template_guide/helm_ignore_file/</a></p>
<p><code>.helmignore</code>也就类似于<code>.gitignore</code>, <code>.dockerignore</code>，指定不需要包含在chart包中的文件。</p>
<p>如果此文件存在，<code>helm package</code>命令将忽略<code>.helmignore</code>里面匹配到的文件打包到应用的包里。</p>
<p>一个<code>.helmignore</code>文件的栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># comment

# Match any file or path named .git
.git

# Match any text file
*.txt

# Match only directories named mydir
mydir/

# Match only text files in the top-level directory
/*.txt

# Match only the file foo.txt in the top-level directory
/foo.txt

# Match any file named ab.txt, ac.txt, or ad.txt
a[b-d].txt

# Match any file under subdir matching temp*
*/temp*

*/*/temp*
temp?
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h2 id="模板调试">模板调试</h2>
<p>Debugging Templates: <a href="https://helm.sh/docs/chart_template_guide/debugging/">https://helm.sh/docs/chart_template_guide/debugging/</a></p>
<p>有几个命令可帮助调试模板：</p>
<ul>
<li><code>helm lint</code>: 验证chart最佳实践的工具</li>
<li><code>helm install --dry-run --debug</code>或<code>helm template --debug</code>：渲染模板并返回k8s manifest文件</li>
<li><code>helm get manifest</code>：查看安装了哪些模板</li>
</ul>
<br>
<br>
<h2 id="yaml技巧">YAML技巧</h2>
<p>YAML Techniques: <a href="https://helm.sh/docs/chart_template_guide/yaml_techniques/">https://helm.sh/docs/chart_template_guide/yaml_techniques/</a></p>
<br>
<br>
<hr>
<br>
<br>
<h1 id="helm命令">Helm命令</h1>
<p>Helm Commands: <a href="https://helm.sh/docs/helm/">https://helm.sh/docs/helm/</a></p>
<br>
<br>
<hr>
<br>
<br>
<h1 id="社区指南">社区指南</h1>
<p>Community Guides: <a href="https://helm.sh/docs/community/">https://helm.sh/docs/community/</a></p>
<br>
<br>
<hr>
<br>
<br>
<h1 id="faq">FAQ</h1>
<p>Frequently Asked Questions: <a href="https://helm.sh/docs/faq/">https://helm.sh/docs/faq/</a></p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2020-09-21</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/helm/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://zhang21.cn/helm/" data-title="Helm" data-hashtags="Helm,K8s,DevOps,CNCF"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://zhang21.cn/helm/" data-title="Helm"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Reddit" data-sharer="reddit" data-url="https://zhang21.cn/helm/"><i class="fab fa-reddit fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://zhang21.cn/helm/" data-title="Helm"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.0.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://zhang21.cn/helm/" data-title="Helm"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/helm/">Helm</a>,&nbsp;<a href="/tags/k8s/">K8s</a>,&nbsp;<a href="/tags/devops/">DevOps</a>,&nbsp;<a href="/tags/cncf/">cncf</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/go/" class="prev" rel="prev" title="Go"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Go</a>
            <a href="/flagger/" class="next" rel="next" title="Flagger">Flagger<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.83.1">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2017 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://zhang21.cn" target="_blank">Zhang21</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css"><script type="text/javascript" src="https://zhang21.disqus.com/embed.js" defer></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":20},"comment":{},"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"RZ22ZCTIDN","algoliaIndex":"hugo-index","algoliaSearchKey":"11ec277ef4d730e232eda9651548da78","highlightTag":"em","maxResultLength":20,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"twemoji":true};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
