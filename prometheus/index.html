<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Prometheus - 风继续吹</title><meta name="Description" content="个人博客"><meta property="og:title" content="Prometheus" />
<meta property="og:description" content="参考：

Prometheus文档： https://prometheus.io/docs
GitHub: https://github.com/prometheus/
PrometheusAlert: https://github.com/feiyu563/PrometheusAlert

环境：

CentOS7x86_64
Prometheus v2.14

" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zhang21.cn/prometheus/" /><meta property="og:image" content="https://zhang21.cn/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-09-11T11:01:12&#43;00:00" />
<meta property="article:modified_time" content="2018-09-11T11:01:12&#43;00:00" /><meta property="og:site_name" content="My cool site" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://zhang21.cn/logo.png"/>

<meta name="twitter:title" content="Prometheus"/>
<meta name="twitter:description" content="参考：

Prometheus文档： https://prometheus.io/docs
GitHub: https://github.com/prometheus/
PrometheusAlert: https://github.com/feiyu563/PrometheusAlert

环境：

CentOS7x86_64
Prometheus v2.14

"/>
<meta name="application-name" content="风继续吹">
<meta name="apple-mobile-web-app-title" content="风继续吹"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://zhang21.cn/prometheus/" /><link rel="prev" href="https://zhang21.cn/kubernetes/" /><link rel="next" href="https://zhang21.cn/bootstrap/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Prometheus",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/zhang21.cn\/prometheus\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/zhang21.cn\/images\/Apple-Devices-Preview.png",
                            "width":  3200 ,
                            "height":  2048 
                        }],"genre": "posts","keywords": "DevOps, Prometheus, Monitor, Alert","wordcount":  32719 ,
        "url": "https:\/\/zhang21.cn\/prometheus\/","datePublished": "2018-09-11T11:01:12+00:00","dateModified": "2018-09-11T11:01:12+00:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "Zhang21","logo": "https:\/\/zhang21.cn\/leslie.png"},"author": {
                "@type": "Person",
                "name": "Zhang21"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="风继续吹"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>风继续吹</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="https://github.com/zhang21" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="风继续吹"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>风继续吹</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="https://github.com/zhang21" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Prometheus</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://zhang21.cn" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Zhang21</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/monitor/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>monitor</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2018-09-11">2018-09-11</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;约 32719 字&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;预计阅读 66 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#介绍">介绍</a>
      <ul>
        <li><a href="#概述">概述</a>
          <ul>
            <li><a href="#prometheus是什么">Prometheus是什么</a></li>
            <li><a href="#什么时候适合">什么时候适合</a></li>
            <li><a href="#什么时候不适合">什么时候不适合</a></li>
          </ul>
        </li>
        <li><a href="#第一步">第一步</a></li>
        <li><a href="#术语">术语</a></li>
        <li><a href="#faq">FAQ</a></li>
      </ul>
    </li>
    <li><a href="#概念">概念</a>
      <ul>
        <li><a href="#数据模型">数据模型</a>
          <ul>
            <li><a href="#指标名称和标签">指标名称和标签</a></li>
          </ul>
        </li>
        <li><a href="#指标类型">指标类型</a>
          <ul>
            <li><a href="#counter">Counter</a></li>
            <li><a href="#gauge">Gauge</a></li>
            <li><a href="#histogram">Histogram</a></li>
            <li><a href="#summary">Summary</a></li>
          </ul>
        </li>
        <li><a href="#作业和实例">作业和实例</a></li>
      </ul>
    </li>
    <li><a href="#prometheus">Prometheus</a>
      <ul>
        <li><a href="#入门">入门</a></li>
        <li><a href="#安装">安装</a>
          <ul>
            <li><a href="#使用预编译的二进制文件">使用预编译的二进制文件</a></li>
            <li><a href="#使用源码">使用源码</a></li>
            <li><a href="#使用docker">使用Docker</a></li>
            <li><a href="#使用配置管理系统">使用配置管理系统</a></li>
          </ul>
        </li>
        <li><a href="#配置">配置</a>
          <ul>
            <li><a href="#配置文件">配置文件</a></li>
            <li><a href="#记录规则">记录规则</a>
              <ul>
                <li><a href="#配置规则">配置规则</a></li>
                <li><a href="#语法检查规则">语法检查规则</a></li>
                <li><a href="#记录规则-1">记录规则</a></li>
              </ul>
            </li>
            <li><a href="#告警规则">告警规则</a>
              <ul>
                <li><a href="#定义告警规则">定义告警规则</a></li>
                <li><a href="#模板">模板</a></li>
                <li><a href="#运行时检查告警">运行时检查告警</a></li>
                <li><a href="#发送告警通知">发送告警通知</a></li>
              </ul>
            </li>
            <li><a href="#模板-1">模板</a>
              <ul>
                <li><a href="#简单告警字段模板">简单告警字段模板</a></li>
                <li><a href="#简单迭代">简单迭代</a></li>
                <li><a href="#展示一个值">展示一个值</a></li>
                <li><a href="#使用控制台url参数">使用控制台url参数</a></li>
                <li><a href="#高级的迭代">高级的迭代</a></li>
                <li><a href="#定义可重复使用的模板">定义可重复使用的模板</a></li>
              </ul>
            </li>
            <li><a href="#模板引用">模板引用</a>
              <ul>
                <li><a href="#数据结构">数据结构</a></li>
                <li><a href="#函数">函数</a></li>
                <li><a href="#模板类型差异">模板类型差异</a></li>
              </ul>
            </li>
            <li><a href="#规则单元测试">规则单元测试</a></li>
          </ul>
        </li>
        <li><a href="#查询">查询</a>
          <ul>
            <li><a href="#查询prometheus">查询Prometheus</a>
              <ul>
                <li><a href="#表达式语言数据类型">表达式语言数据类型</a></li>
                <li><a href="#literals">Literals</a></li>
                <li><a href="#时序选择器">时序选择器</a></li>
                <li><a href="#子查询">子查询</a></li>
              </ul>
            </li>
            <li><a href="#操作符">操作符</a>
              <ul>
                <li><a href="#二元运算符">二元运算符</a></li>
                <li><a href="#矢量匹配">矢量匹配</a></li>
                <li><a href="#聚合运算符">聚合运算符</a></li>
                <li><a href="#二元运算符优先级">二元运算符优先级</a></li>
              </ul>
            </li>
            <li><a href="#函数-1">函数</a></li>
            <li><a href="#查询栗子">查询栗子</a>
              <ul>
                <li><a href="#简单时序选择">简单时序选择</a></li>
                <li><a href="#子查询-1">子查询</a></li>
                <li><a href="#使用函数运算符">使用函数，运算符</a></li>
              </ul>
            </li>
            <li><a href="#http-api">HTTP API</a>
              <ul>
                <li><a href="#格式">格式</a></li>
                <li><a href="#表达式查询">表达式查询</a></li>
                <li><a href="#查询元数据">查询元数据</a></li>
                <li><a href="#表达式查询结果的格式">表达式查询结果的格式</a></li>
                <li><a href="#目标">目标</a></li>
                <li><a href="#规则">规则</a></li>
                <li><a href="#告警">告警</a></li>
                <li><a href="#查询目标元数据">查询目标元数据</a></li>
                <li><a href="#告警器">告警器</a></li>
                <li><a href="#状态">状态</a></li>
                <li><a href="#tsdb-admin-apis">TSDB Admin APIs</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#存储">存储</a>
          <ul>
            <li><a href="#本地存储">本地存储</a></li>
            <li><a href="#compaction">Compaction</a></li>
            <li><a href="#操作配置">操作配置</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#可视化">可视化</a>
      <ul>
        <li><a href="#表达式浏览器">表达式浏览器</a></li>
        <li><a href="#grafana">Grafana</a>
          <ul>
            <li><a href="#安装-1">安装</a>
              <ul>
                <li><a href="#centos">CentOS</a></li>
                <li><a href="#docker">Docker</a></li>
              </ul>
            </li>
            <li><a href="#使用">使用</a></li>
          </ul>
        </li>
        <li><a href="#console-template">Console template</a></li>
      </ul>
    </li>
    <li><a href="#示例配置">示例配置</a>
      <ul>
        <li><a href="#prometheus配置样例">prometheus配置样例</a></li>
        <li><a href="#alertmanager配置样例">alertmanager配置样例</a></li>
        <li><a href="#prometheus自动发现">prometheus自动发现</a></li>
        <li><a href="#prometheus告警规则">prometheus告警规则</a></li>
        <li><a href="#进程探针配置">进程探针配置</a></li>
        <li><a href="#进程告警规则">进程告警规则</a></li>
      </ul>
    </li>
    <li><a href="#集成">集成</a>
      <ul>
        <li><a href="#客户端库">客户端库</a></li>
        <li><a href="#编写客户端库">编写客户端库</a>
          <ul>
            <li><a href="#惯例">惯例</a></li>
            <li><a href="#整体结构">整体结构</a></li>
            <li><a href="#指标">指标</a></li>
            <li><a href="#公开">公开</a></li>
            <li><a href="#标准和运行时收集器">标准和运行时收集器</a></li>
            <li><a href="#单元测试">单元测试</a></li>
            <li><a href="#打包和依赖">打包和依赖</a></li>
            <li><a href="#性能考虑">性能考虑</a></li>
          </ul>
        </li>
        <li><a href="#推送指标">推送指标</a></li>
        <li><a href="#探针和集成">探针和集成</a>
          <ul>
            <li><a href="#第三方探针">第三方探针</a></li>
          </ul>
        </li>
        <li><a href="#编写探针">编写探针</a>
          <ul>
            <li><a href="#可维护性和纯度">可维护性和纯度</a></li>
            <li><a href="#配置-1">配置</a></li>
            <li><a href="#指标-1">指标</a>
              <ul>
                <li><a href="#命名">命名</a></li>
                <li><a href="#标签">标签</a></li>
                <li><a href="#类型">类型</a></li>
                <li><a href="#帮助字符串">帮助字符串</a></li>
                <li><a href="#丢弃更少的有用信息">丢弃更少的有用信息</a></li>
                <li><a href="#点字符串">点字符串</a></li>
              </ul>
            </li>
            <li><a href="#收集器">收集器</a>
              <ul>
                <li><a href="#关于抓取自身的指标">关于抓取自身的指标</a></li>
                <li><a href="#机器和进程指标">机器和进程指标</a></li>
              </ul>
            </li>
            <li><a href="#部署">部署</a>
              <ul>
                <li><a href="#调度">调度</a></li>
                <li><a href="#推送">推送</a></li>
                <li><a href="#抓取失败">抓取失败</a></li>
                <li><a href="#抓取页面">抓取页面</a></li>
                <li><a href="#端口号">端口号</a></li>
              </ul>
            </li>
            <li><a href="#宣布">宣布</a></li>
          </ul>
        </li>
        <li><a href="#textfile">textfile</a></li>
      </ul>
    </li>
    <li><a href="#最佳实践">最佳实践</a>
      <ul>
        <li><a href="#指标和标签命名">指标和标签命名</a>
          <ul>
            <li><a href="#指标名称">指标名称</a></li>
            <li><a href="#标签-1">标签</a></li>
            <li><a href="#基本单位">基本单位</a></li>
          </ul>
        </li>
        <li><a href="#控制台和仪表盘">控制台和仪表盘</a></li>
        <li><a href="#集成-1">集成</a>
          <ul>
            <li><a href="#如何集成">如何集成</a>
              <ul>
                <li><a href="#服务的三种类型">服务的三种类型</a></li>
                <li><a href="#子系统">子系统</a></li>
              </ul>
            </li>
            <li><a href="#要提防的事">要提防的事</a>
              <ul>
                <li><a href="#使用标签">使用标签</a></li>
                <li><a href="#不要滥用标签">不要滥用标签</a></li>
                <li><a href="#四种类型比较">四种类型比较</a></li>
                <li><a href="#时间戳">时间戳</a></li>
                <li><a href="#避免缺失指标">避免缺失指标</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#hisgogram和summary">Hisgogram和Summary</a></li>
        <li><a href="#告警-1">告警</a>
          <ul>
            <li><a href="#告警什么">告警什么</a></li>
          </ul>
        </li>
        <li><a href="#记录规则-2">记录规则</a>
          <ul>
            <li><a href="#命名和聚合">命名和聚合</a></li>
            <li><a href="#示例">示例</a></li>
          </ul>
        </li>
        <li><a href="#pushgateway">Pushgateway</a>
          <ul>
            <li><a href="#应该使用pushgateway吗">应该使用Pushgateway吗</a></li>
            <li><a href="#替代策略">替代策略</a></li>
          </ul>
        </li>
        <li><a href="#远程存储">远程存储</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>参考：</p>
<ul>
<li>Prometheus文档： <a href="https://prometheus.io/docs">https://prometheus.io/docs</a></li>
<li>GitHub: <a href="https://github.com/prometheus/">https://github.com/prometheus/</a></li>
<li>PrometheusAlert: <a href="https://github.com/feiyu563/PrometheusAlert">https://github.com/feiyu563/PrometheusAlert</a></li>
</ul>
<p>环境：</p>
<ul>
<li>CentOS7x86_64</li>
<li>Prometheus v2.14</li>
</ul>
<br>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/Prometheus/prometheus.jpg"
        data-srcset="/images/Prometheus/prometheus.jpg, /images/Prometheus/prometheus.jpg 1.5x, /images/Prometheus/prometheus.jpg 2x"
        data-sizes="auto"
        alt="/images/Prometheus/prometheus.jpg"
        title="Prometheus" /></p>
<br/>
<br/>
<hr>
<br/>
<br/>
<h1 id="介绍">介绍</h1>
<p>Introduction</p>
<br/>
<h2 id="概述">概述</h2>
<br/>
<h3 id="prometheus是什么">Prometheus是什么</h3>
<p>What is Prometheus?</p>
<p>Prometheus是一个最初在SoundCloud上构建的<strong>开源监控系统和报警工具包</strong>。现在是一个独立的开源项目，由社区进行维护。</p>
<br>
<p><strong>功能(Features)</strong>
Prometheus的主要特点：</p>
<ul>
<li>具有由度量名称(metric name)和键值对(key-value)标识的时间序列(time series)数据的多维(multi-dimensional)数据模型</li>
<li>灵活的查询语言，以利用此维度</li>
<li>不依赖分布式存储(distributed storage)，单个服务器节点是自治的(autonomous)</li>
<li>时间序列集合通过HTPP的<code>pull model</code>发生</li>
<li><code>push</code>时间序列通过中间网关(intermediary gateway)的支持</li>
<li>通过服务发现或静态配置来发现目标</li>
<li>图形和仪表盘支持多种模式</li>
</ul>
<br>
<p><strong>组件(Components)</strong>
Prometheus系统由多个组件构成，其中某些组件是可选的：</p>
<ul>
<li>主要的<strong>Prometheus Server</strong>，用于存储时间序列数据</li>
<li><strong>client libraries</strong>，用于检测应用程序代码</li>
<li><strong>push gateway</strong>，用于支持短暂的(short-lived)工作</li>
<li><strong>exporters</strong>，用于服务的特殊目的</li>
<li><strong>alertmanager</strong>，用于处理报警</li>
<li>各种支持工具</li>
</ul>
<br>
<p><strong>架构(Architecture)</strong>
Prometheus的体系结构和系统组件图：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/Prometheus/architecture.png"
        data-srcset="/images/Prometheus/architecture.png, /images/Prometheus/architecture.png 1.5x, /images/Prometheus/architecture.png 2x"
        data-sizes="auto"
        alt="/images/Prometheus/architecture.png"
        title="Prometheus架构图" /></p>
<br/>
<br/>
<h3 id="什么时候适合">什么时候适合</h3>
<p>When does it fit?</p>
<p>Prometheus适用于记录任何纯数字时间序列。它既适用于以机器为中心的监控，也适用于高度动态的面向服务架构的监控。在微服务的世界中，它对多维数据收集和查询的支持是一种特殊的优势。
Prometheus专为提高可靠性而设计，是你在断电期间可以快速诊断问题的系统。每个Prometheus Server都是独立的，不依赖于网络存储或其它远程服务。当基础架构其它部分损坏时，你仍可以依赖它，并且你不需要设置大量的基础架构来使用它。</p>
<br/>
<br/>
<h3 id="什么时候不适合">什么时候不适合</h3>
<p>When does it not fit?</p>
<p>Prometheus重视可靠性。即使在系统故障情况下，你也可以随时查看有关系统的可用统计信息。如果你需要100%的准确度，Prometheus不是一个好的选择，你可能需要使用其它系统。</p>
<br/>
<br/>
<br/>
<h2 id="第一步">第一步</h2>
<p>步骤：</p>
<ul>
<li>下载</li>
<li>配置</li>
<li>运行</li>
<li>使用表达式浏览器</li>
<li>使用图形接口</li>
<li>监控其它目标</li>
</ul>
<br/>
<br/>
<br/>
<h2 id="术语">术语</h2>
<p>GLOSSARY</p>
<ul>
<li>
<p><strong>Alert</strong>
是Prometheus正在开火的警报规则的结果。警报从Prometheus发送到AlterManger。</p>
</li>
<li>
<p><strong>Alertmanager</strong>
接收警报，将它们聚合成组，删除重复数据，应用静音、限制，然后发送电子邮件等通知。</p>
</li>
<li>
<p><strong>Bridge</strong>
是一个从Client Library中获取样本并将它们暴露给 non-Prometheus 监控系统的组件。例如，Python、Java、Go&hellip;客户端可将指标导出到Graphite。</p>
</li>
<li>
<p><strong>Client library</strong>
是某种语言的库(Go, Java, Python&hellip;)，可以直接检测代码，编写自定义收集器以从其它系统中收集指标并将指标公开给Prometheus。</p>
</li>
<li>
<p><strong>Collector</strong>
是表示一组度量标准的 exporter 的一部分。如果它是直接检测的一部分，则可以是单个度量，如果是从另一个系统提取度量，则可以是许多度量。</p>
</li>
<li>
<p><strong>Direct instrumentation</strong>
作为源代码程序的一部分内联添加的检测。</p>
</li>
<li>
<p><strong>Endpoint</strong></p>
</li>
<li>
<p><strong>Exporter</strong>
是一个公开Prometheus指标的程序，通常将 non-prometheus 格式的指标转换为 Prometheus 支持的格式。</p>
</li>
<li>
<p><strong>Instance</strong>
唯一标识作业中目标的标签</p>
</li>
<li>
<p><strong>Job</strong>
具有相同目的的目标集合</p>
</li>
<li>
<p><strong>Notification</strong>
代表一组多个警报</p>
</li>
<li>
<p><strong>Promdash</strong>
原生Prometheus仪表盘构建器。它已被弃用，并被 Grafana 取代</p>
</li>
<li>
<p><strong>Prometheus</strong>
通常指的是Prometheus System的核心程序，也可指整个监控系统。</p>
</li>
<li>
<p><strong>PromQL</strong>
Prometheus Query Language</p>
</li>
<li>
<p><strong>Pushgateway</strong>
持续从批量作业中最新推出的指标</p>
</li>
<li>
<p><strong>Remote Read</strong>
允许从其它系统透明读取时间序列作为查询的一部分</p>
</li>
<li>
<p><strong>Remote Read Adapter</strong>
并非所有系统都支持远程读取。远程读取适配器便是用于此。</p>
</li>
<li>
<p><strong>Remote Read Endpoint</strong>
Prometheus进行远程读取时的对象</p>
</li>
<li>
<p><strong>Remote Write</strong>
允许动态地将采集的样本发送到其它系统</p>
</li>
<li>
<p><strong>Remote Write Adapter</strong></p>
</li>
<li>
<p><strong>Remote Write Endpoint</strong></p>
</li>
<li>
<p><strong>Sample</strong>
时间序列中某个时间点的单个值，Prometheus中，每个样本都包含一个<code>float64</code>和<code>ms</code>精度的时间戳。</p>
</li>
<li>
<p><strong>Silence</strong>
防止报警</p>
</li>
<li>
<p><strong>Target</strong>
抓取对象的定义</p>
</li>
</ul>
<br/>
<br/>
<br/>
<h2 id="faq">FAQ</h2>
<p>faq: <a href="https://prometheus.io/docs/introduction/faq/">https://prometheus.io/docs/introduction/faq/</a></p>
<br/>
<br/>
<hr>
<br/>
<br/>
<h1 id="概念">概念</h1>
<p>CONCEPTS</p>
<br/>
<h2 id="数据模型">数据模型</h2>
<p>Data model</p>
<p>Prometheus从根本上将所有数据存储为<strong>时间序列(time series)</strong>: 属于同一指标和同一标记维度的带时间戳值的流。除了存储时间序列，Prometheus还可以临时生成时间序列作为查询的结果。</p>
<br/>
<br/>
<h3 id="指标名称和标签">指标名称和标签</h3>
<p>Metric names and labels</p>
<p>每个时间序列都是有<strong>指标名称(metric name)<strong>和一组键值对(也称为</strong>标签(label)</strong>)来唯一标识。</p>
<p>指标名称： 可能包含ASCII字母，下划线，冒号。它必须匹配正则: <code>[a-zA-Z_:][a-zA-Z0-9_:]*</code>。
标签启用Prometheus的维度数据模型：</p>
<br/>
<br/>
<br/>
<h2 id="指标类型">指标类型</h2>
<p>metric types: <a href="https://prometheus.io/docs/concepts/metric_types/">https://prometheus.io/docs/concepts/metric_types/</a></p>
<p>Prometheus Client Library提供了四个核心指标类型。这些目前仅在客户端和在有线协议(wire protocol)中区分。Prometheus Server尚未使用的类型信息和所有数据合并为无类型(untyped)时间序列。这在未来可能改变。</p>
<br>
<p>Prometheus clinet使用文档:</p>
<ul>
<li><a href="https://godoc.org/github.com/prometheus/client_golang/prometheus" target="_blank" rel="noopener noreffer ">Go</a></li>
<li><a href="https://github.com/prometheus/client_java" target="_blank" rel="noopener noreffer ">Java</a></li>
<li><a href="https://github.com/prometheus/client_python" target="_blank" rel="noopener noreffer ">Python</a></li>
</ul>
<br>
<h3 id="counter">Counter</h3>
<p>Counter，只增不减的计数器。</p>
<p>Counter是一个累计指标，代表一个单调递增计数器，即只增不减，除非重启或被重置为0。例如，你可以使用counter来代表服务的请求数、已完成的任务数、错误的数量&hellip;</p>
<p>不要用counter来暴露一个可以减少的值。例如，不要对当前运行的进程数使用<code>counter</code>类型，使用<code>gauge</code>类型。</p>
<p>一般在定义counter类型指标的名称时，推荐使用<code>xxx_total</code>作为后缀名。（如<code>http_request_total</code>）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 获取HTTP请求量的增长率
rate(http_requests_total[5m])

# 统计前十
topk(10, http_requests_total)
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="gauge">Gauge</h3>
<p>Gauge，可以任意变化的仪表盘。</p>
<p>Gauge类型代表一个样本数据可以任意变化，即可增可减。通常用于像温度、内存使用率这种指标数据，也可表示能随时升降的计数（如当前的并发数）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 获取一段时间内的变化情况
dalta(cpu_temp_celsius{host=&#34;zeus&#34;}[2h])

# 简单线性回归，预测未来数据
predict_linear(node_filesystem_free{job=&#34;node&#34;}[2h], 4 * 3600) &lt; 0

</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="histogram">Histogram</h3>
<p>Histogram和Summary主用用于统计和分析样本的分布情况。</p>
<p>Histogram(直方图)在一段时间范围内对数据进行采样（通常是请求持续时间(request durations)和响应大小(response sizes)等），并将其计入可配置的存储桶(bucket)中，后续可通过指定区间筛选样本，也可以统计样本总数，最后一般将数据展示为直方图。</p>
<p>Histogram类型的样本会提供三种指标：</p>
<ul>
<li>样本值分布在桶中的数量，命名为<code>xxx_bucket{le=&quot;&lt;上边界&gt;&quot;}</code>。标识指标值小于等于上边界所有样本数量。</li>
<li>所有样本值的大小总和，命名为<code>xxx_sum</code>。</li>
<li>样本总数，命名为<code>xxx_count</code>，值和<code>xxx_bucket{le=&quot;+Inf}</code>相同。</li>
</ul>
<p>可使用<code>histogram_quantile()</code>函数来计算Histogram类型样本的分位数。</p>
<br>
<br>
<h3 id="summary">Summary</h3>
<p>Summary(摘要)与Histogram类似，表示一段时间内的数据采集结果（通常是请求持续时间或响应大小）。它直接存储了分位数，而不是通过区间来计算。</p>
<p>Summary类型的样本也提供了三种指标：</p>
<ul>
<li>样本值的分位数分布情况，命名为<code>xxx{quantile=&quot;&lt;φ&gt;&quot;}</code>。</li>
<li>所有样本值的大小总和，命名为<code>xxx_sum</code>。</li>
<li>样本总数，命名为<code>xxx_count</code>。</li>
</ul>
<br/>
<br/>
<br/>
<h2 id="作业和实例">作业和实例</h2>
<p>Job and Instance</p>
<p>Prometheus配置文件中配置。</p>
<br/>
<br/>
<hr>
<br/>
<br/>
<h1 id="prometheus">Prometheus</h1>
<br/>
<h2 id="入门">入门</h2>
<p>GETTING STARTED</p>
<p>本节介绍如何安装，配置，使用Prometheus的简单例子。你将在本地安装和运行Prometheus，将其配置为自我填充和示例应用程序，然后使用查询，规则和图表来使用收集的序列数据。</p>
<br>
<p><strong>下载</strong></p>
<p>下载地址: <a href="https://prometheus.io/download/">https://prometheus.io/download/</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">tar xvfz prometheus-*.tar.gz

cd prometheus-*
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>配置和监控</strong>
Prometheus通过在目标上通过HTTP endPoints来抓取指标，来收集受监控目标的指标。由于Prometheus也以相同的方式公开自身数据，它也可以获取和监测自身的健康状况。
虽然Prometheus Server只收集有关自身的数据在实践中不是很有用，但它是一个很好的示例。如<code>prometheus.yml</code>示例配置文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">global</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w">     </span><span class="l">15s</span><span class="w"> </span><span class="c"># By default, scrape targets every 15 seconds.</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># Attach these labels to any time series or alerts when communicating with</span><span class="w">
</span><span class="w">  </span><span class="c"># external systems (federation, remote storage, Alertmanager).</span><span class="w">
</span><span class="w">  </span><span class="nt">external_labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">monitor</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;codelab-monitor&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># A scrape configuration containing exactly one endpoint to scrape:</span><span class="w">
</span><span class="w"></span><span class="c"># Here it&#39;s Prometheus itself.</span><span class="w">
</span><span class="w"></span><span class="nt">scrape_configs</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span><span class="w">
</span><span class="w">  </span>- <span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;prometheus&#39;</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># Override the global default and scrape targets from this job every 5 seconds.</span><span class="w">
</span><span class="w">    </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;localhost:9090&#39;</span><span class="p">]</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p><strong>启动</strong>
启动后，可访问9090端口查看状态。可访问<code>localhost:9090/metrics</code>查看有关自身的相关指标。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">cd prometheus-2.3.2.linux-amd64
./prometheus --config.file=&#34;prometheus.yml&#34;
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/Prometheus/9090.png"
        data-srcset="/images/Prometheus/9090.png, /images/Prometheus/9090.png 1.5x, /images/Prometheus/9090.png 2x"
        data-sizes="auto"
        alt="/images/Prometheus/9090.png"
        title="9090" /></p>
<br>
<p><strong>使用表达式浏览器</strong>
让我们看一下Prometheus收集的一些数据。要使用Prometheus的内建表达式浏览器(expression browser)，请跳转到<code>http://localhost:9090/graph</code>并选择<code>Graph -&gt; Console</code>，在其中输入表达式。
绘制表达式图形同样在此操作。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">#表达式
prometheus_target_interval_length_seconds


#表达式
prometheus_target_interval_length_seconds{quantile=&#34;0.99&#34;}


#计算返回的时间序列数
count(prometheus_target_interval_length_seconds)
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/Prometheus/expression01.png"
        data-srcset="/images/Prometheus/expression01.png, /images/Prometheus/expression01.png 1.5x, /images/Prometheus/expression01.png 2x"
        data-sizes="auto"
        alt="/images/Prometheus/expression01.png"
        title="表达式结果" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/Prometheus/expression02.png"
        data-srcset="/images/Prometheus/expression02.png, /images/Prometheus/expression02.png 1.5x, /images/Prometheus/expression02.png 2x"
        data-sizes="auto"
        alt="/images/Prometheus/expression02.png"
        title="表达式图形" /></p>
<br>
<p><strong>启动简单的目标</strong>
启动一些示例目标让Prometheus获取。
确保已安装Go表一起并设置了正常的GO PATH。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">mkdir ./sample &amp;&amp; cd sample

git clone https://github.com/prometheus/client_golang.git
cd client_golang/examples/random
go get -d
go build


# Start 3 example targets in separate terminals:
./random -listen-address=:9091
./random -listen-address=:9092
./random -listen-address=:9093


#访问
http://localhost:9091/metrices
http://localhost:9092/metrices
http://localhost:9093/metrices
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>监控示例目标</strong>
现在需要配置Prometheus来抓取目标。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">scrape_configs</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">job_name</span><span class="p">:</span><span class="w">       </span><span class="s1">&#39;example-random&#39;</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># Override the global default and scrape targets from this job every 5 seconds.</span><span class="w">
</span><span class="w">    </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;localhost:8080&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;localhost:8081&#39;</span><span class="p">]</span><span class="w">
</span><span class="w">        </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;production&#39;</span><span class="w">
</span><span class="w">
</span><span class="w">      </span>- <span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;localhost:8082&#39;</span><span class="p">]</span><span class="w">
</span><span class="w">        </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;canary&#39;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>重启Prometheus，检测<code>rpc_durations_seconds</code> metric来验证。</p>
<br>
<p><strong>配置规则</strong>
Configure rules for aggregating scraped data into new time series</p>
<p>聚合超过数千个时间序列的查询在计算<code>ad-hoc</code>时会变慢。为了提高效率，Prometheus允许你通过配置的规则将预录表达式预先记录到全新的持久时间序列中。</p>
<p>创建规则文件<code>prometheus.rules.yml</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">#job_service:rpc_durations_seconds_count:avg_rate5m
groups:
- name: example
  rules:
  - record: job_service:rpc_durations_seconds_count:avg_rate5m
    expr: avg(rate(rpc_durations_seconds_count[5m])) by (job, service)
</code></pre></td></tr></table>
</div>
</div><p>要是Prometheus选择此新规则，需要修改Prometheus配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">global:
  scrape_interval:     15s # By default, scrape targets every 15 seconds.
  evaluation_interval: 15s # Evaluate rules every 15 seconds.

  # Attach these extra labels to all timeseries collected by this Prometheus instance.
  external_labels:
    monitor: &#39;codelab-monitor&#39;

rule_files:
  - &#39;prometheus.rules.yml&#39;

scrape_configs:
  - job_name: &#39;prometheus&#39;

    # Override the global default and scrape targets from this job every 5 seconds.
    scrape_interval: 5s

    static_configs:
      - targets: [&#39;localhost:9090&#39;]

  - job_name:       &#39;example-random&#39;

    # Override the global default and scrape targets from this job every 5 seconds.
    scrape_interval: 5s

    static_configs:
      - targets: [&#39;localhost:8091&#39;, &#39;localhost:8092&#39;]
        labels:
          group: &#39;production&#39;

      - targets: [&#39;localhost:9093&#39;]
        labels:
          group: &#39;canary&#39;
</code></pre></td></tr></table>
</div>
</div><p>重启Prometheus，使用<code>job_service:rpc_durations_seconds_count:avg_rate5m</code> metric验证。</p>
<br/>
<br/>
<h2 id="安装">安装</h2>
<br>
<h3 id="使用预编译的二进制文件">使用预编译的二进制文件</h3>
<br/>
<br/>
<h3 id="使用源码">使用源码</h3>
<br/>
<br/>
<h3 id="使用docker">使用Docker</h3>
<p>所有的Prometheus服务都可以作为 Docker image 来使用。
Prometheus image 使用 volume 来存储实际的指标。对于生产部署，强烈建议使用 Data Volume Container 来升级数据的管理。</p>
<p>栗子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">#bind-mount
docker run -p 9090:9090 -v /tmp/prometheus.yml:/etc/prometheus.yml  prom/prometheus


#volume
docker run -p 9090:9090 -v /promethe-data  prom/prometheus  --config.file=/prometheus-data/prometheus.yml
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>自定义镜像</strong></p>
<p>Dockerfile:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">FROM prom/prometheus
ADD prometheus.yml /etc/prometheus/
xxx
</code></pre></td></tr></table>
</div>
</div><p>构建：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">docker build -t my-prometheus .
</code></pre></td></tr></table>
</div>
</div><br/>
<br/>
<h3 id="使用配置管理系统">使用配置管理系统</h3>
<ul>
<li>Ansible</li>
<li>Chef</li>
<li>Puppet</li>
<li>SaltStack</li>
</ul>
<br/>
<br/>
<br/>
<h2 id="配置">配置</h2>
<p>Configuration</p>
<p>Prometheus通过命令行标志(flag)和配置文件进行配置。使用<code>./prometheus -h</code>查看所有命令行标志。
Prometheus可在运行时重新加载配置。</p>
<br/>
<h3 id="配置文件">配置文件</h3>
<p>configuration file: <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/">https://prometheus.io/docs/prometheus/latest/configuration/configuration/</a></p>
<p>使用<code>--config.file</code>标志指定配置文件。配置文件使用<code>YAML</code>格式。</p>
<p>一个配置文件栗子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">global</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># How frequently to scrape targets by default.</span><span class="w">
</span><span class="w">  </span><span class="nt">[ scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;duration&gt; | default = 1m ]</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># How long until a scrape request times out.</span><span class="w">
</span><span class="w">  </span><span class="nt">[ scrape_timeout</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;duration&gt; | default = 10s ]</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># How frequently to evaluate rules.</span><span class="w">
</span><span class="w">  </span><span class="nt">[ evaluation_interval</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;duration&gt; | default = 1m ]</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># The labels to add to any time series or alerts when communicating with</span><span class="w">
</span><span class="w">  </span><span class="c"># external systems (federation, remote storage, Alertmanager).</span><span class="w">
</span><span class="w">  </span><span class="nt">external_labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">[ &lt;labelname&gt;</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;labelvalue&gt; ... ]</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Rule files specifies a list of globs. Rules and alerts are read from</span><span class="w">
</span><span class="w"></span><span class="c"># all matching files.</span><span class="w">
</span><span class="w"></span><span class="nt">rule_files</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="p">[</span><span class="w"> </span>- <span class="l">&lt;filepath_glob&gt; ... ]</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># A list of scrape configurations.</span><span class="w">
</span><span class="w"></span><span class="nt">scrape_configs</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="p">[</span><span class="w"> </span>- <span class="l">&lt;scrape_config&gt; ... ]</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Alerting specifies settings related to the Alertmanager.</span><span class="w">
</span><span class="w"></span><span class="nt">alerting</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">alert_relabel_configs</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="p">[</span><span class="w"> </span>- <span class="l">&lt;relabel_config&gt; ... ]</span><span class="w">
</span><span class="w">  </span><span class="nt">alertmanagers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="p">[</span><span class="w"> </span>- <span class="l">&lt;alertmanager_config&gt; ... ]</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Settings related to the remote write feature.</span><span class="w">
</span><span class="w"></span><span class="nt">remote_write</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="p">[</span><span class="w"> </span>- <span class="l">&lt;remote_write&gt; ... ]</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Settings related to the remote read feature.</span><span class="w">
</span><span class="w"></span><span class="nt">remote_read</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="p">[</span><span class="w"> </span>- <span class="l">&lt;remote_read&gt; ... ]</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p>各个配置项，详细详细请看文档: <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/">https://prometheus.io/docs/prometheus/latest/configuration/configuration/</a></p>
<ul>
<li><code>scrape_config</code></li>
<li><code>tls_config</code></li>
<li><code>azure_sd_config</code></li>
<li><code>consul_sd_config</code></li>
<li><code>dns_sd_config</code></li>
<li><code>ec2_sd_config</code></li>
<li><code>openstack_sd_config</code></li>
<li><code>file_sd_config</code></li>
<li><code>gce_sd_config</code></li>
<li><code>kubernetes_sd_config</code></li>
<li><code>marathon_sd_config</code></li>
<li><code>nerve_sd_config</code></li>
<li><code>serverset_sd_config</code></li>
<li><code>triton_sd_config</code></li>
<li><code>static_config</code></li>
<li><code>relabel_config</code></li>
<li><code>metric_relabel_configs</code></li>
<li><code>alert_relabel_configs</code></li>
<li><code>alertmanager_config</code></li>
<li><code>remote_write</code></li>
<li><code>remote_read</code></li>
</ul>
<br>
<br>
<br>
<h3 id="记录规则">记录规则</h3>
<p>Recording rules</p>
<br>
<h4 id="配置规则">配置规则</h4>
<p>Configuring rules</p>
<p>Prometheus支持两种类型的可被配置的以规定的间隔进行评估的规则:</p>
<ul>
<li>recording rules</li>
<li>alterting rules</li>
</ul>
<p>要在Prometheus中包含规则，创建包含必要规则的语句并在Prometheus配置文件中通过<code>rule_files</code>字段配置并加载文件。规则使用YAML格式。</p>
<p>规则文件可在Prometheus运行通过发送<code>SIGHUP</code>到Prometheus来进行重载。只有在所有规则文件都是正确格式下才会应用更改。</p>
<br>
<br>
<h4 id="语法检查规则">语法检查规则</h4>
<p>Syntax-checking rules</p>
<p>要快速检查规则文件的语法是否正确，而无需启动Prometheus Server，可安装和运行Prometheus的<code>promtool</code>命令行工具:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">go get github.com/prometheus/prometheus/cmd/promtool

promtool check rules /path/to/example.rules.yml
</code></pre></td></tr></table>
</div>
</div><p>如果规则文件语法正确，会返回<code>0</code>状态码。如果语法错误，会返回错误信息和<code>1</code>状态码。</p>
<br>
<br>
<h4 id="记录规则-1">记录规则</h4>
<p>Recording rules</p>
<p>记录规则允许你预先计算经常需要或计算昂贵的表达式并保存它们的结果到一个新的时序集(set of time series)。查询预先计算的结果会比每次执行原始表达式快得多。这对Dashboard来说尤其有用，它经常刷新时间反复查询同样的表达式。</p>
<p>记录和告警规则位于一个规则组(rule group)。一个组内的规则在一个规定的间隔内依序运行。</p>
<p>规则文件语法:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">groups</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="p">[</span><span class="w"> </span>- <span class="l">&lt;rule_group&gt; ]</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>栗子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">groups:
  - name: example
    relues:
    - record: job:http_inprogress_requests:sum
      expr: sum(http_inprogress_requests) by (job)
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>&lt;rule_group&gt;</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># The name of the group. Must be unique within a file.</span><span class="w">
</span><span class="w"></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;string&gt;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># How often rules in the group are evaluated.</span><span class="w">
</span><span class="w"></span><span class="nt">[ interval</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;duration&gt; | default = global.evaluation_interval ]</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="p">[</span><span class="w"> </span>- <span class="l">&lt;rule&gt; ... ]</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<p><strong><rule></strong></p>
<p>记录规则的语法:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># The name of the time series to output to. Must be a valid metric name.</span><span class="w">
</span><span class="w"></span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;string&gt;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># The PromQL expression to evaluate. Every evaluation cycle this is</span><span class="w">
</span><span class="w"></span><span class="c"># evaluated at the current time, and the result recorded as a new set of</span><span class="w">
</span><span class="w"></span><span class="c"># time series with the metric name as given by &#39;record&#39;.</span><span class="w">
</span><span class="w"></span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;string&gt;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Labels to add or overwrite before storing the result.</span><span class="w">
</span><span class="w"></span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">[ &lt;labelname&gt;</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;labelvalue&gt;]</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>告警规则的语法:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># The name of the alert. Must be a valid metric name.</span><span class="w">
</span><span class="w"></span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;string&gt;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># The PromQL expression to evaluate. Every evaluation cycle this is</span><span class="w">
</span><span class="w"></span><span class="c"># evaluated at the current time, and all resultant time series become</span><span class="w">
</span><span class="w"></span><span class="c"># pending/firing alerts.</span><span class="w">
</span><span class="w"></span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;string&gt;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Alerts are considered firing once they have been returned for this long.</span><span class="w">
</span><span class="w"></span><span class="c"># Alerts which have not yet fired for long enough are considered pending.</span><span class="w">
</span><span class="w"></span><span class="nt">[ for</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;duration&gt; | default = 0s ]</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Labels to add or overwrite for each alert.</span><span class="w">
</span><span class="w"></span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">[ &lt;labelname&gt;</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;tmp_string&gt;]</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Annotations to add to each alert.</span><span class="w">
</span><span class="w"></span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">[ &lt;labelname&gt;</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;tmpl_string&gt; ]</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="告警规则">告警规则</h3>
<p>Alerting rules</p>
<p>告警规则允许你根据Prometheus表达式语言来定义告警条件，并发送提醒到外部服务。每当告警表达式在给定的时间内导致一个或多个矢量元素，告警计数主动作为这些元素的标签集。</p>
<br>
<h4 id="定义告警规则">定义告警规则</h4>
<p>在Prometheus中，告警规则的配置与记录规则的配置一样。</p>
<p>栗子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">groups</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example</span><span class="w">
</span><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alerts</span><span class="p">:</span><span class="w"> </span><span class="l">HighRequestLatency</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">job:request_latency_seconds:mean5m{job=&#34;myjob&#34;} &gt; 0.5</span><span class="w">
</span><span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l">10m</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">page</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="l">High request latency</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>可选的<code>for</code>子句导致Prometheus等待在第一次遇到一个新的表达式输出矢量元素和计数的告警作为点燃的此元素的一定持续时间。在这个栗子中，Prometheus将检查在点燃告警之前的每个10分钟的警告持续激活。元素是活跃的，但未点燃，出于待定(pending)状态。</p>
<p><code>labels</code>子句允许指定一组附加标签到告警。任何目前有冲突的标签将被覆盖。标签的值可以作为模板。</p>
<p><code>annotations</code>子句指定的一组信息可用来存储更长的附加信息。注释的值可以作为模板。</p>
<br>
<br>
<h4 id="模板">模板</h4>
<p>Templating</p>
<p>标签和注释的值可以使用<code>console template</code>作为模板。<code>$labels</code>变量保存一个告警实例的k/v键值对。已配置的外部标签可通过<code>$externalLabels</code>变量进行访问。<code>$value</code>变量保存告警实例的评估值。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># To insert a firing element&#39;s label values:</span><span class="w">
</span><span class="w"></span>{{<span class="w"> </span><span class="l">$labels.&lt;labelname&gt; }}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># To insert the numeric expression value of the firing element:</span><span class="w">
</span><span class="w"></span>{{<span class="w"> </span><span class="l">$value }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>栗子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">groups</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example</span><span class="w">
</span><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># Alert for any instance that is unreachable for &gt;5 minutes.</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">InstanceDown</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">up == 0</span><span class="w">
</span><span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l">5m</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">page</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Instance {{ $labels.instance }} down&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 5 minutes.&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># Alert for any instance that has a median request latency &gt;1s.</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">APIHighRequestLatency</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">api_http_request_latencies_second{quantile=&#34;0.5&#34;} &gt; 1</span><span class="w">
</span><span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l">10m</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;High request latency on {{ $labels.instance }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $labels.instance }} has a median request latency above 1s (current value: {{ $value }})s&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="运行时检查告警">运行时检查告警</h4>
<p>Inspecting alerts during runtime</p>
<p>要手动检查告警是否活跃(active)(pending或firing)，请浏览原生Prometheus的Alerts栏目项。这里将确切地显示标签集，每个定义的告警当前的状态。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/Prometheus/alerts_state.png"
        data-srcset="/images/Prometheus/alerts_state.png, /images/Prometheus/alerts_state.png 1.5x, /images/Prometheus/alerts_state.png 2x"
        data-sizes="auto"
        alt="/images/Prometheus/alerts_state.png"
        title="/images/Prometheus/alerts_state.png" /></p>
<p>对于<code>pengding</code>和<code>firing</code>的告警，Prometheus还存储合成<code>ALERTS{alertname=&quot;&lt;alert name&gt;&quot;, alertstate=&quot;pending|firing&quot;, &lt;additional alert labels&gt;}</code>形式的时间序列。只要该警告是在所指示的active(pending或firing)状态，样本值被设置为1。当不再是这样时，该系列被标记为stale。</p>
<br>
<br>
<h4 id="发送告警通知">发送告警通知</h4>
<p>Sending alert notifications</p>
<p>Prometheus的告警规则善于盘算现在什么坏了(broken)，但是它不是一个成熟的通知解决方案。需要另一层添加汇总，通知速率限制，沉默和告警依赖于简单告警定义。在Prometheus的生态系统中，<strong>Alertmanager</strong>承担了这一角色。因此，Prometheus可以配置成定期发送关于告警状态信息到Alertmanager实例，然后采取调度权发送通知。
Prometheus通过集成服务发现，可配置为自动发现可用的Alertmanager实例。</p>
<br>
<br>
<h3 id="模板-1">模板</h3>
<p>Template example</p>
<p>Prometheus在alerts的annotations和labels中支持模板化，以及在控制台页面。模板要针对本地数据库运行查询、迭代数据，使用条件、格式数据等能力。Prometheus模板语言是基于Go template system。</p>
<br>
<h4 id="简单告警字段模板">简单告警字段模板</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">InstanceDown</span><span class="w">
</span><span class="w"></span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">up == 0</span><span class="w">
</span><span class="w"></span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l">5m</span><span class="w">
</span><span class="w"></span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">page</span><span class="w">
</span><span class="w"></span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Instance {{$labels.instance}} down&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{$labels.instance}} of job {{$labels.job}} has been down for more than 5 minutes.&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>告警字段模板为每个点燃的告警在每一个规则迭代过程中执行，所以保持任意查询和模板的轻量化。如果你需要为告警编写更复杂的模板，建议链接到控制台。</p>
<br>
<br>
<h4 id="简单迭代">简单迭代</h4>
<p>simple iteration</p>
<p>这显示的实例列表，以及它们是否up:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">{{<span class="w"> </span><span class="l">range query &#34;up&#34; }}</span><span class="w">
</span><span class="w">  </span>{{<span class="w"> </span><span class="l">.Labels.instance }} {{ .Value }}</span><span class="w">
</span><span class="w"></span>{{<span class="w"> </span><span class="l">end }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>特殊的<code>.</code>变量包含对于每次循环迭代当前样本的值。</p>
<br>
<br>
<h4 id="展示一个值">展示一个值</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">{{<span class="w"> </span><span class="l">with query &#34;some_metric{instance=&#39;someinstance&#39;}&#34; }}</span><span class="w">
</span><span class="w">  </span>{{<span class="w"> </span><span class="l">. | first | value | humanize }</span><span class="w">
</span><span class="w"></span>{{<span class="w"> </span><span class="l">end }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Go和Go的模板语言两者都是强类型，因此必须检查阳平返回，以避免执行错误。
这里所包含的<code>prom_query_drilldown</code>模板处理，允许结果的格式，并链接到表达式浏览器。</p>
<br>
<br>
<h4 id="使用控制台url参数">使用控制台url参数</h4>
<p>Using console URL parameters</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">{{<span class="w"> </span><span class="l">with printf &#34;node_memory_MemTotal{job=&#39;node&#39;, instance=&#39;%s&#39;}&#34; .Params.instance | query}}</span><span class="w">
</span><span class="w">  </span>{{<span class="w"> </span><span class="l">. | first | value | humanize1024 }}B</span><span class="w">
</span><span class="w"></span>{{<span class="w"> </span><span class="l">end }}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>如果作为<code>console.html?instance=hostname</code>访问, <code>.Params.instance</code>将评估<code>hostname</code>。</p>
<br>
<br>
<h4 id="高级的迭代">高级的迭代</h4>
<p>Advanced iteration</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="l">&lt;table&gt;</span><span class="w">
</span><span class="w"></span>{{<span class="w"> </span><span class="l">range printf &#34;node_network_receive_bytes{job=&#39;node&#39;,instance=&#39;%s&#39;,device!=&#39;lo&#39;}&#34; .Params.instance | query | sortByLabel &#34;device&#34;}}</span><span class="w">
</span><span class="w"></span><span class="l">&lt;tr&gt;&lt;th colspan=2&gt;{{ .Labels.device }}&lt;/th&gt;&lt;/tr&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;tr&gt;</span><span class="w">
</span><span class="w">  </span><span class="l">&lt;td&gt;Received&lt;/td&gt;</span><span class="w">
</span><span class="w">  </span><span class="l">&lt;td&gt;{{ with printf &#34;rate(node_network_receive_bytes{job=&#39;node&#39;,instance=&#39;%s&#39;,device=&#39;%s&#39;}[5m])&#34; .Labels.instance .Labels.device | query }}{{ . | first | value | humanize }}B/s{{end}}&lt;/td&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;/tr&gt;</span><span class="w">
</span><span class="w"></span><span class="l">&lt;tr&gt;</span><span class="w">
</span><span class="w">  </span><span class="l">&lt;td&gt;Transmitted&lt;/td&gt;</span><span class="w">
</span><span class="w">  </span><span class="l">&lt;td&gt;{{ with printf &#34;rate(node_network_transmit_bytes{job=&#39;node&#39;,instance=&#39;%s&#39;,device=&#39;%s&#39;}[5m])&#34; .Labels.instance .Labels.device | query }}{{ . | first | value | humanize }}B/s{{end}}&lt;/td&gt;</span><span class="w">
</span><span class="w">  </span><span class="l">&lt;/tr&gt;{{ end }}</span><span class="w">
</span><span class="w"></span><span class="l">&lt;/table&gt;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>这里，我们迭代了所有网络设备，并显示每个设备的网络流量。随着<code>range</code>动作不指定变量，<code>.Params.instance</code>循环内不可用，<code>.</code>现在是作为循环变量。</p>
<br>
<br>
<h4 id="定义可重复使用的模板">定义可重复使用的模板</h4>
<p>Defining reusable templates</p>
<p>Prometheus支持定义可重复使用的模板。当与控制台库相结合时，使得可共享模板，这很有用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">{{<span class="w"> </span><span class="l">/* Define the template */ }}</span><span class="w">
</span><span class="w"></span>{{<span class="l">define &#34;myTemplate&#34;}}</span><span class="w">
</span><span class="w">  </span><span class="l">do something</span><span class="w">
</span><span class="w"></span>{{<span class="w"> </span><span class="l">end }}</span><span class="w">
</span><span class="w">
</span><span class="w"></span>{{<span class="l">/* Use the template */}}</span><span class="w">
</span><span class="w"></span>{{<span class="l">template &#34;myTemplate&#34;}}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>模板仅限于一个参数。<code>args</code>函数可包装多个参数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">{{<span class="l">define &#34;myMultiArgTemplate&#34;}}</span><span class="w">
</span><span class="w">  </span><span class="nt">First argument</span><span class="p">:</span><span class="w"> </span>{{<span class="l">.arg0}}</span><span class="w">
</span><span class="w">  </span><span class="nt">Second argument</span><span class="p">:</span><span class="w"> </span>{{<span class="l">.arg1}}</span><span class="w">
</span><span class="w"></span>{{<span class="w"> </span><span class="l">end }}</span><span class="w">
</span><span class="w"></span>{{<span class="w"> </span><span class="l">template &#34;myMultiArgTemplate&#34; (args 1 2)}}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="模板引用">模板引用</h3>
<p>TEMPLATE REFERENCE</p>
<br>
<h4 id="数据结构">数据结构</h4>
<p>Data Structures</p>
<p>用于处理时间序列数据的主要数据结构栗子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">type sample struct {
    Labels map[string]string
    Value float64
}
</code></pre></td></tr></table>
</div>
</div><p>栗子的指标名称(metric)编码在<code>Labels</code>map的特殊的<code>__name__</code>标签里。
<code>[]sample</code>表示实例列表。
Go中的<code>interface{}</code>与C中的void pointer类似。</p>
<br>
<br>
<h4 id="函数">函数</h4>
<p>除了Go模板提供的默认函数，Prometheus为模板查询结果提供了更易处理的函数。
如果函数在管道中使用，管道值将作为最后一个参数传递。</p>
<p><strong>Queries</strong></p>
<br>
<p><strong>Numbers</strong></p>
<br>
<p><strong>Strings</strong></p>
<br>
<p><strong>Others</strong></p>
<br>
<br>
<h4 id="模板类型差异">模板类型差异</h4>
<p>Template type differences</p>
<p>每种类型的模板提供了可用于参数模板的不同信息，并有一些其它差异。</p>
<br>
<br>
<h3 id="规则单元测试">规则单元测试</h3>
<p>Unit Testing for Rules</p>
<p>你可使用<code>promtool</code>来测试你的规则。</p>
<br>
<br>
<br>
<h2 id="查询">查询</h2>
<p>Querying</p>
<br>
<h3 id="查询prometheus">查询Prometheus</h3>
<p>Prometheus提供了一个名为<code>PromQL</code>(Prometheus Query Language)功能化查询语言，让用户选择并实时汇总时间序列数据。表达式的结果可被显示为图形，可在Prometheus浏览器上查看，或通过HTTP API来获取。</p>
<br>
<h4 id="表达式语言数据类型">表达式语言数据类型</h4>
<p>Expression language data types</p>
<p>在Prometheus表达式语言中，一个表达式或子表达式可以评估为四种类型中的一种:</p>
<ul>
<li><strong>瞬时向量(Instant vector)</strong>: 包含每个时间序列的单个样品的一组时间序列，全部共享相同的时间戳</li>
<li><strong>区间向量(Range vector)</strong>: 包含随时间序列的范围的数据点的一组时间序列</li>
<li><strong>标量(Scalar)</strong>: 一个简单的数字浮点值</li>
<li><strong>字符串(String)</strong>: 一个简单的字符串值，当前未使用</li>
</ul>
<p>根据不同的使用情况(graphing, displaying the output of an expression)，例如：瞬时向量表达式返回的数据类型是唯一可以直接绘制成图表的数据类型。</p>
<br>
<br>
<h4 id="literals">Literals</h4>
<p><strong>String literals</strong></p>
<p>字符串可以被指定为在单引号、双引号或反引号内的文字。</p>
<p>PromQL遵循Go的转义规则。
不像Go，Prometheus不丢弃反引号里面的换行符。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">&#34;this is a string&#34;
&#39;these are unescaped: \n \\ \t&#39;
`these are not unescaped: \n &#39; &#34; \t`&#34;&#39;`
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>Float literals</strong></p>
<p>标量浮点值可被逐字地写为<code>[-](digits)[.(digits)]</code>数字形式。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">-2.43
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="时序选择器">时序选择器</h4>
<p>Time series Selectors</p>
<p>Prometheus中的所有正则表达式使用<a href="https://github.com/google/re2/wiki/Syntax" target="_blank" rel="noopener noreffer ">RE2 syntax</a>。</p>
<br>
<p><strong>Instant vector selectors</strong></p>
<p>Instant vector selectors允许一组时间序列并为每个在给定的时间戳单一样品值的选择: 在最简单的格式中，只制定了一个指标名称。这导致了包含有该指标名称的所有时间序列的元素instant vector。</p>
<p>这个栗子将选择具有<code>http_requests_total</code>指标名称的所有时间序列:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">http_requests_total
</code></pre></td></tr></table>
</div>
</div><p>有可能通过附加一组标签在大括号来匹配进一步过滤这些时间序列。</p>
<p>这个栗子只选择<code>job label为</code>prometheus<code>和group lable为</code>canary的<code>http_requests_total</code>指标名称。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">http_requests_total{job=&#34;prometheus&#34;, group=&#34;canary&#34;}
</code></pre></td></tr></table>
</div>
</div><p>也可将标签值负匹配，或匹配正则表达式。下面的标签匹配操作符存在:</p>
<ul>
<li><code>=</code>: 等于;</li>
<li><code>!=</code> 不等于;</li>
<li><code>=~</code>: 正则匹配;</li>
<li><code>!~</code>: 非正则匹配.</li>
</ul>
<p>举个栗子，以下匹配<code>staging</code>, <code>testing</code>, <code>development</code>环境变量和<code>GET</code>以外的HTTP方法的<code>http_requests_total</code>指标名称的所有时序。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">http_requests_total{environment=~&#34;staging|testing|development&#34;, method!=&#34;GET&#34;}
</code></pre></td></tr></table>
</div>
</div><p>栗子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">{job=~&#34;.*&#34;} # Bad!

{job=~&#34;.+&#34;}              # Good!
{job=~&#34;.*&#34;,method=&#34;get&#34;} # Good!

{__name__=~&#34;job:.*&#34;}
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>Range Vector Selectors</strong></p>
<p>Range vector literals与 instant vector literals类似，不同之处在于它选择了一个范围。时间序列放在方括号<code>[]</code>内。</p>
<p>时间范围被指定为一个数字，使用以下单位:</p>
<ul>
<li><code>s</code>: 秒;</li>
<li><code>m</code>: 分;</li>
<li><code>h</code>: 时;</li>
<li><code>d</code>: 天;</li>
<li><code>w</code>: 周;</li>
<li><code>y</code>: 年。</li>
</ul>
<p>栗子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">http_requests_total{job=&#34;prometheus&#34;}[5m]
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>Offset modifier</strong></p>
<p><code>offset</code>修饰符允许为查询中的individual instant和range vectors改变时间偏移。</p>
<p>栗子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">http_requests_total offset 5m

sum(http_requests_total{method=&#34;GET&#34;} offset 5m) // GOOD.

sum(http_requests_total{method=&#34;GET&#34;}) offset 5m // INVALID.

rate(http_requests_total[5m] offset 1w)
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="子查询">子查询</h4>
<p>Subquery</p>
<p>子查询允许你为一个给定的range和resolution运行一个即时查询(instant)。子查询的结果为range vector。</p>
<p>语法:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># resolution可选。Default is the global evaluation interval.
Syntax: &lt;instant_query&gt; &#39;[&#39; &lt;range&gt; &#39;:&#39; [&lt;resolution&gt;] &#39;]&#39; [ offset &lt;duration&gt; ]
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="操作符">操作符</h3>
<p>Operators: <a href="https://prometheus.io/docs/prometheus/latest/querying/operators/">https://prometheus.io/docs/prometheus/latest/querying/operators/</a></p>
<br>
<h4 id="二元运算符">二元运算符</h4>
<p>Binary Operators</p>
<p>Prometheus查询语言支持基本的逻辑和算数运算符。</p>
<br>
<p><strong>Arithmetic binary operators</strong></p>
<p>Prometheus中存在以下二元算术运算符:</p>
<ul>
<li><code>+</code> (addition)</li>
<li><code>-</code> (subtraction)</li>
<li><code>*</code> (multiplication)</li>
<li><code>/</code> (division)</li>
<li><code>%</code> (modulo)</li>
<li><code>^</code> (power/exponentiation)</li>
</ul>
<p>二元运算符在下列之间定义:</p>
<ul>
<li>scalar/scalar</li>
<li>vector/scalar</li>
<li>vector/vector</li>
</ul>
<br>
<p><strong>Comparison binary operators</strong></p>
<p>Prometheus中有以下二元比较符:</p>
<ul>
<li><code>==</code> (equal)</li>
<li><code>!=</code> (not-equal)</li>
<li><code>&gt;</code> (greater-than)</li>
<li><code>&lt;</code> (less-than)</li>
<li><code>&gt;=</code> (greater-or-equal)</li>
<li><code>&lt;=</code> (less-or-equal)</li>
</ul>
<p>比较运算符在下列之间定义，默认情况下进行筛选。它们的行为可由运算符之后提供的<code>bool</code>进行修改，这将返回<code>0</code>或<code>1</code>而不是过滤。</p>
<ul>
<li>scalar/scalar</li>
<li>vector/scalar</li>
<li>vector/vector</li>
</ul>
<br>
<p><strong>Logical/set binary operators</strong></p>
<p>logical/set 二元运算符尽在instan vectors之间定义:</p>
<ul>
<li><code>and</code> (intersection)</li>
<li><code>or</code> (union)</li>
<li><code>unless</code> (complement)</li>
</ul>
<br>
<br>
<h4 id="矢量匹配">矢量匹配</h4>
<p>Vector matching</p>
<p>矢量之间的操作试图找到为左手侧的每个条目匹配右手侧的元素。有两种基本类型匹配的行为: One-to-one 和 many-to-one/one-to-many。</p>
<br>
<p><strong>One-to-one vector matches</strong></p>
<p>一对一从操作的每一侧查找唯一的一对条目。在默认情况下，操作遵循如下格式<code>vector1 &lt;operator&gt; vector2</code>。如果它们有完全相同的一组标签和相应的值，则两个条目匹配。<code>ignoring</code>关键字允许匹配忽略某些标签，<code>on</code>关键字允许降低考虑的标签集来提供列表:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) &lt;vector expr&gt;
&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) &lt;vector expr&gt;
</code></pre></td></tr></table>
</div>
</div><p>输入案例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">method_code:http_errors:rate5m{method=&#34;get&#34;, code=&#34;500&#34;}  24
method_code:http_errors:rate5m{method=&#34;get&#34;, code=&#34;404&#34;}  30
method_code:http_errors:rate5m{method=&#34;put&#34;, code=&#34;501&#34;}  3
method_code:http_errors:rate5m{method=&#34;post&#34;, code=&#34;500&#34;} 6
method_code:http_errors:rate5m{method=&#34;post&#34;, code=&#34;404&#34;} 21

method:http_requests:rate5m{method=&#34;get&#34;}  600
method:http_requests:rate5m{method=&#34;del&#34;}  34
method:http_requests:rate5m{method=&#34;post&#34;} 120
</code></pre></td></tr></table>
</div>
</div><p>查询栗子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">method_code:http_errors:rate5m{code=&#34;500&#34;} / ignoring(code) method:http_requests:rate5m
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>Many-to-one and one-to-many vector matches</strong></p>
<p>多对一或一对多匹配指的是一侧能够匹配多侧的多个元素。这明确要求必须使用<code>group_left</code>或<code>group_right</code>修饰符，其中左/右确定该矢量有更高的基数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;
&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;
&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;
&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;
</code></pre></td></tr></table>
</div>
</div><p>查询案例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">method_code:http_errors:rate5m / ignoring(code) group_left method:http_request:rate5m
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">{method=&#34;get&#34;, code=&#34;500&#34;}  0.04            //  24 / 600
{method=&#34;get&#34;, code=&#34;404&#34;}  0.05            //  30 / 600
{method=&#34;post&#34;, code=&#34;500&#34;} 0.05            //   6 / 120
{method=&#34;post&#34;, code=&#34;404&#34;} 0.175           //  21 / 120
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="聚合运算符">聚合运算符</h4>
<p>Aggregation operators</p>
<p>Prometheus支持以下内置聚合运算符，可以用于聚合单一瞬间向量的元素:</p>
<ul>
<li><code>sum</code> (calculate sum over dimensions)</li>
<li><code>min</code> (select minimum over dimensions)</li>
<li><code>max</code> (select maximum over dimensions)</li>
<li><code>avg</code> (calculate the average over dimensions)</li>
<li><code>stddev</code> (calculate population standard deviation over dimensions)</li>
<li><code>stdvar</code> (calculate population standard variance over dimensions)</li>
<li><code>count</code> (count number of elements in the vector)</li>
<li><code>count_values</code> (count number of elements with the same value)</li>
<li><code>bottomk</code> (smallest k elements by sample value)</li>
<li><code>topk</code> (largest k elements by sample value)</li>
<li><code>quantile</code> (calculate φ-quantile (<code>0 ≤ φ ≤ 1</code>) over dimensions)</li>
</ul>
<p>栗子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">&lt;aggr-op&gt; [without|by (&lt;label list&gt;)] ([parameter,] &lt;vector expression&gt;)

&lt;aggr-op&gt;([parameter,] &lt;vector expression&gt;) [without|by (&lt;label list&gt;)]

sum without (instance) (http_requests_total)

sum by (application, group) (http_requests_total)

count_values(&#34;version&#34;, build_version)

topk(5, http_requests_total)
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="二元运算符优先级">二元运算符优先级</h4>
<p>Binary operator precedence</p>
<p>以下优先级由高到低:</p>
<ul>
<li><code>^</code></li>
<li><code>*</code>, <code>/</code>, <code>%</code></li>
<li><code>+</code>, <code>-</code></li>
<li><code>==</code>, <code>!=</code>, <code>&lt;=</code>, <code>&lt;</code>, <code>&gt;=</code>, <code>&gt;</code></li>
<li><code>and</code>, <code>unless</code></li>
<li><code>or</code></li>
</ul>
<br>
<br>
<h3 id="函数-1">函数</h3>
<p>Founctions: <a href="https://prometheus.io/docs/prometheus/latest/querying/functions/">https://prometheus.io/docs/prometheus/latest/querying/functions/</a></p>
<p>一些函数有默认的参数，如<code>year(v=vector(time()) instant-vector)</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">abs()
abs(v instant-vector) 返回输入向量的所有样本的绝对值




absent()
absent(v instant-vector)，判断是否存在

absent(nonexistent{job=&#34;myjob&#34;})
# =&gt; {job=&#34;myjob&#34;}

absent(nonexistent{job=&#34;myjob&#34;,instance=~&#34;.*&#34;})
# =&gt; {job=&#34;myjob&#34;}

absent(sum(nonexistent{job=&#34;myjob&#34;}))
# =&gt; {}




ceil()
ceil(v instant-vector) 将v中所有元素的样本值向上四舍五入到最接近的整数


floor()
floor(v instant-vector) 与ceil()相反，将v中所有元素的样本值向下四舍五入到最接近的整数




changes()
changes(v range-vector) 输入一个区间向量，返回这个区间向量内每个样本数据值变化的次数（瞬时向量）。如果样本数据值没有发生变化，则返回结果为1




clamp_max()
clamp_max(v instant-vector, max scalar) 输入一个瞬时向量和最大值，样本数据值若大于max，则改为max，否则不变


clamp_min()
clamp_min(v instant-vector, min scalar) 输入一个瞬时向量和最小值，样本数据值若小于min，则改为min，否则不变




day_of_month()
day_of_month(v=vector(time()) instant-vector) 值范围为1-31


day_of_week()
day_of_week(v=vector(time()) instant-vector) 值范围为0-6


days_in_month()
days_in_month(v=vector(time()) instant-vector) 月份的天数，值范围为28-31


minute()
minute(v=vector(time()) instant-vector) 函数返回给定UTC时间当前小时的第多少分钟，范围为0-59


month()
month(v=vector(time()) instant-vector) 函数返回给定UTC时间当前属于第几个月，范围为1-12

year()
year(v=vector(time()) instant-vector) 返回被给定 UTC 时间的当前年份


hour()
hour(v=vector(time()) instant-vector) 值范围为0-23



delta()
delta(v range-vector) 它计算一个区间向量v的第一个元素和最后一个元素之间的差值，返回一个瞬时向量
delta(cpu_temp_celsius{host=&#34;zeus&#34;}[2h]) # 现在和两小时前的CPU温度差


idelta()
idelta(v range-vector) 计算最后两个样本之间的差




deriv()
deriv(v range-vector) 使用简单的线性回归计算区间向量v中各个时间序列的导数




exp()
exp(v instant-vector) 输入一个瞬时向量，返回各个样本值的e的指数值




histogram_quantile()
histogram_quantile(φ float, b instant-vector)
histogram_quantile(0.9, rate(http_request_duration_seconds_bucket[10m])) # 计算过去10分钟内请求持续在90%
histogram_quantile(0.9, sum(rate(http_request_duration_seconds_bucket[10m])) by (job, le)) # 聚合



holt_winters()
holt_winters(v range-vector, sf scalar, tf scalar) 基于区间向量v，生成时间序列数据平滑值




increase()
increase(v range-vector) 获取区间向量中的第一个和最后一个样本并返回其增长量
increase(http_requests_total{job=&#34;api-server&#34;}[5m]) # 区间向量中每个时间序列过去5分钟内HTTP请求数的增长数




label_join()



label_replace()



ln()
ln(v instant-vector) 计算瞬时向量v中所有样本数据的自然对数



log2()
log2(v instant-vector) 函数计算瞬时向量v中所有样本数据的二进制对数



log10()
log10(v instant-vector) 计算瞬时向量v中所有样本数据的十进制对数




predict_linear()
predict_linear(v range-vector, t scalar) 函数可以预测时间序列v在t秒后的值
predict_linear(node_filesystem_free{job=&#34;node&#34;}[2h], 4 * 3600) &lt; 0 # 基于2小时的样本数据，来预测主机可用磁盘空间的是否在4个小时候被占满



rate()
rate(v range-vector) 直接计算区间向量 v 在时间窗口内平均增长速率
rate(http_requests_total[5m]) 区间向量中每个时间序列过去5分钟内HTTP请求数的每秒增长率


irate()
irate(v range-vector) 用于计算区间向量的增长率，但是其反应出的是瞬时增长率。通过区间向量中最后两个两本数据来计算区间向量的增长速率。
irate(http_requests_total{job=&#34;api-server&#34;}[5m]) # 区间向量中每个时间序列过去 5 分钟内最后两个样本数据的 HTTP 请求数的增长率



resets()
resets(v range-vector) 的参数是一个区间向量。对于每个时间序列，它都返回一个计数器重置的次数。两个连续样本之间的值的减少被认为是一次计数器重置。



round()
round(v instant-vector, to_nearest=1 scalar) 与ceil和floor函数类似，返回向量中所有样本值的最接近的整数



scalar()
scalar(v instant-vector) 函数的参数是一个单元素的瞬时向量,它返回其唯一的时间序列的值作为一个标量



sort()
sort(v instant-vector) 函数对向量按元素的值进行升序排序



sort_desc()
降序排列



sqrt()
sqrt(v instant-vector) 计算向量v 所有元素的平方根






vector()
vector(s scalar)





&lt;aggregation&gt;_over_time()
avg_over_time(range-vector) : 区间向量内每个度量指标的平均值。
min_over_time(range-vector) : 区间向量内每个度量指标的最小值。
max_over_time(range-vector) : 区间向量内每个度量指标的最大值。
sum_over_time(range-vector) : 区间向量内每个度量指标的求和。
count_over_time(range-vector) : 区间向量内每个度量指标的样本数据个数。
quantile_over_time(scalar, range-vector) : 区间向量内每个度量指标的样本数据值分位数，φ-quantile (0 ≤ φ ≤ 1)。
stddev_over_time(range-vector) : 区间向量内每个度量指标的总体标准差。
stdvar_over_time(range-vector) : 区间向量内每个度量指标的总体标准方差。

</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="查询栗子">查询栗子</h3>
<p>Query examples: <a href="https://prometheus.io/docs/prometheus/latest/querying/examples/">https://prometheus.io/docs/prometheus/latest/querying/examples/</a></p>
<br>
<h4 id="简单时序选择">简单时序选择</h4>
<p>返回指标<code>http_requests_total</code>的所有时间序列数据:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">http_requests_total
</code></pre></td></tr></table>
</div>
</div><p>返回指标名为<code>http_requests_total</code>，给定标签job和handler:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">http_requests_total{job=&#34;apiserver&#34;, handler=&#34;/api/comments&#34;}
</code></pre></td></tr></table>
</div>
</div><p>加上时间，5分钟内:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">http_requests_total{job=&#34;apiserver&#34;, handler=&#34;/api/comments&#34;}[5m]
</code></pre></td></tr></table>
</div>
</div><p>使用正则:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">http_requests_total{job=~&#34;.*server&#34;}
</code></pre></td></tr></table>
</div>
</div><p>http状态码不为4xx:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">http_requests_total{status!~&#34;4..&#34;}
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="子查询-1">子查询</h4>
<p>Return the 5-minute rate of the http_requests_total metric for the past 30 minutes, with a resolution of 1 minute.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">rate(http_requests_total[5m])[30m:1m]
</code></pre></td></tr></table>
</div>
</div><p>嵌套子查询:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">max_over_time(deriv(rate(distance_covered_total[5s])[30s:5s])[10m:])
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="使用函数运算符">使用函数，运算符</h4>
<p>过去5分钟的平均值</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">rate(http_requests_total[5m])
</code></pre></td></tr></table>
</div>
</div><p>过去5分钟平均值综合</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">sum by (job) (
  rate(http_requests_total[5m])
)
</code></pre></td></tr></table>
</div>
</div><p>如果两个指标具有相同维度的标签，我们可以使用二元操作符计算样本数据:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">(instance_memory_limit_bytes - instance_memory_usage_bytes) / 1024 / 1024


# 同样的表达式，只不过通过应用相加
sum by (app, proc) (
  instance_memory_limit_bytes - instance_memory_usage_bytes
) / 1024 / 1024
</code></pre></td></tr></table>
</div>
</div><p>获取CPU使用最高的三个样本:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">topk(3, sum by (app, proc) (rate(instance_cpu_time_ns[5m])))
</code></pre></td></tr></table>
</div>
</div><p>假设一个服务实例只有一个时间序列数据，那么我们可以通过下面表达式统计出每个应用的实例数量:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">count(instance_cpu_time_ns) by (app)
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h3 id="http-api">HTTP API</h3>
<p>HTTP API: <a href="https://prometheus.io/docs/prometheus/latest/querying/api/">https://prometheus.io/docs/prometheus/latest/querying/api/</a></p>
<p>目前稳定的HTTP API在Prometheus Server的<code>/api/v1</code>下。</p>
<br>
<h4 id="格式">格式</h4>
<p>API响应格式为JSON。每个成功的请求都返回<code>2xx</code>状态码。</p>
<p>到达API处理程序无效的请求返回一个错误的JSON对象和以下状态码之一:</p>
<ul>
<li><code>400 Bad Request</code>: 当参数错误或者缺失</li>
<li><code>422 Unprocessable Entity</code>: 当表达式无法执行</li>
<li><code>503 Service Unavailable</code>:  当请求超时或者被中断时</li>
</ul>
<p>JSON响应包格式如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;success&#34;</span> <span class="err">|</span> <span class="s2">&#34;error&#34;</span><span class="p">,</span>
  <span class="nt">&#34;data&#34;</span><span class="p">:</span> <span class="err">&lt;data&gt;</span><span class="p">,</span>

  <span class="err">//</span> <span class="err">Only</span> <span class="err">set</span> <span class="err">if</span> <span class="err">status</span> <span class="err">is</span> <span class="nt">&#34;error&#34;</span><span class="err">.</span> <span class="err">The</span> <span class="err">data</span> <span class="err">field</span> <span class="err">may</span> <span class="err">still</span> <span class="err">hold</span>
  <span class="err">//</span> <span class="err">additional</span> <span class="err">data.</span>
  <span class="s2">&#34;errorType&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;string&gt;&#34;</span><span class="p">,</span>
  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;string&gt;&#34;</span><span class="p">,</span>

  <span class="err">//</span> <span class="err">Only</span> <span class="err">if</span> <span class="err">there</span> <span class="err">were</span> <span class="err">warnings</span> <span class="err">while</span> <span class="err">executing</span> <span class="err">the</span> <span class="err">request.</span>
  <span class="err">//</span> <span class="err">There</span> <span class="err">will</span> <span class="err">still</span> <span class="err">be</span> <span class="err">data</span> <span class="err">in</span> <span class="err">the</span> <span class="err">data</span> <span class="err">field.</span>
  <span class="nt">&#34;warnings&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;&lt;string&gt;&#34;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>请求中输入的时间为RFC3339或Unix原子时间，输出时间戳总是Unix原子时间。</p>
<p>查询参数的名称可用中括号<code>[]</code>重复次数。</p>
<p><code>&lt;duration&gt;</code>占位符指的是<code>[0-9]+[smhdwy]</code>形式的Prometheus 持续时间字符串。例如，<code>5m</code>表示5分钟的持续时间。</p>
<br>
<br>
<h4 id="表达式查询">表达式查询</h4>
<p>查询语言表达式可在单个时刻或一定范围内进行评估。以下部分用于描述每个类型的表达式查询的API endpoint。</p>
<br>
<p><strong>瞬时查询(Instant query)</strong></p>
<p>端点:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">GET /api/v1/query
POST /api/v1/query
</code></pre></td></tr></table>
</div>
</div><p>URL查询参数:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 表达式
query=&lt;string&gt;

# 时间戳，可选。默认使用当前系统时间
time=&lt;rfc3339 | unix_timestamp&gt;

# 超时，可选。默认使用全局的-query.timeout参数
timeout=&lt;duration&gt;
</code></pre></td></tr></table>
</div>
</div><p>查询结果的<code>data</code>部分格式如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">{
  &#34;resultType&#34;: &#34;matrix&#34; | &#34;vector&#34; | &#34;scalar&#34; | &#34;string&#34;,
  &#34;result&#34;: &lt;value&gt;
}
</code></pre></td></tr></table>
</div>
</div><p>栗子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ curl &#39;http://localhost:9090/api/v1/query?query=up&amp;time=2015-07-01T20:10:51.781Z&#39;
{
   &#34;status&#34; : &#34;success&#34;,
   &#34;data&#34; : {
      &#34;resultType&#34; : &#34;vector&#34;,
      &#34;result&#34; : [
         {
            &#34;metric&#34; : {
               &#34;__name__&#34; : &#34;up&#34;,
               &#34;job&#34; : &#34;prometheus&#34;,
               &#34;instance&#34; : &#34;localhost:9090&#34;
            },
            &#34;value&#34;: [ 1435781451.781, &#34;1&#34; ]
         },
         {
            &#34;metric&#34; : {
               &#34;__name__&#34; : &#34;up&#34;,
               &#34;job&#34; : &#34;node&#34;,
               &#34;instance&#34; : &#34;localhost:9100&#34;
            },
            &#34;value&#34; : [ 1435781451.781, &#34;0&#34; ]
         }
      ]
   }
}
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>区间查询(range query)</strong></p>
<p>端点:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">GET /api/v1/query_range
POST /api/v1/query_range
</code></pre></td></tr></table>
</div>
</div><p>URL查询参数:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 表达式
query=&lt;string&gt;

# 时间戳
start=&lt;rfc3339 | unix_timestamp&gt;
end=&lt;rfc3339 | unix_timestamp&gt;

# 查询时间步长，时间区间内每step秒执行一次
step=&lt;duration | float&gt;

# 超时，可选
timeout=&lt;duration&gt;
</code></pre></td></tr></table>
</div>
</div><p>查询结果的<code>data</code>部分格式如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">{
  &#34;resultType&#34;: &#34;matrix&#34;,
  &#34;result&#34;: &lt;value&gt;
}
</code></pre></td></tr></table>
</div>
</div><p>栗子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ curl &#39;http://localhost:9090/api/v1/query_range?query=up&amp;start=2015-07-01T20:10:30.781Z&amp;end=2015-07-01T20:11:00.781Z&amp;step=15s&#39;
{
   &#34;status&#34; : &#34;success&#34;,
   &#34;data&#34; : {
      &#34;resultType&#34; : &#34;matrix&#34;,
      &#34;result&#34; : [
         {
            &#34;metric&#34; : {
               &#34;__name__&#34; : &#34;up&#34;,
               &#34;job&#34; : &#34;prometheus&#34;,
               &#34;instance&#34; : &#34;localhost:9090&#34;
            },
            &#34;values&#34; : [
               [ 1435781430.781, &#34;1&#34; ],
               [ 1435781445.781, &#34;1&#34; ],
               [ 1435781460.781, &#34;1&#34; ]
            ]
         },
         {
            &#34;metric&#34; : {
               &#34;__name__&#34; : &#34;up&#34;,
               &#34;job&#34; : &#34;node&#34;,
               &#34;instance&#34; : &#34;localhost:9091&#34;
            },
            &#34;values&#34; : [
               [ 1435781430.781, &#34;0&#34; ],
               [ 1435781445.781, &#34;0&#34; ],
               [ 1435781460.781, &#34;1&#34; ]
            ]
         }
      ]
   }
}
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="查询元数据">查询元数据</h4>
<p><strong>通过标签匹配器查找序列(Finding series by label matchers)</strong></p>
<p>端点:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">GET /api/v1/series
POST /api/v1/series
</code></pre></td></tr></table>
</div>
</div><p>URL请求参数:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 标签选择器是 series_selector。必须至少提供一个match[]参数
match[]=&lt;series_selector&gt;

# 时间戳
start=&lt;rfc3339 | unix_timestamp&gt;
end=&lt;rfc3339 | unix_timestamp&gt;
</code></pre></td></tr></table>
</div>
</div><p>返回结果的data部分，由k/v键值对的对象列表组成。
栗子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ curl -g &#39;http://localhost:9090/api/v1/series?&#39; --data-urlencode=&#39;match[]=up&#39; --data-urlencode=&#39;match[]=process_start_time_seconds{job=&#34;prometheus&#34;}&#39;
{
   &#34;status&#34; : &#34;success&#34;,
   &#34;data&#34; : [
      {
         &#34;__name__&#34; : &#34;up&#34;,
         &#34;job&#34; : &#34;prometheus&#34;,
         &#34;instance&#34; : &#34;localhost:9090&#34;
      },
      {
         &#34;__name__&#34; : &#34;up&#34;,
         &#34;job&#34; : &#34;node&#34;,
         &#34;instance&#34; : &#34;localhost:9091&#34;
      },
      {
         &#34;__name__&#34; : &#34;process_start_time_seconds&#34;,
         &#34;job&#34; : &#34;prometheus&#34;,
         &#34;instance&#34; : &#34;localhost:9090&#34;
      }
   ]
}
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>获取标签名(label)</strong></p>
<p>端点:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">GET /api/v1/labels
POST /api/v1/labels
</code></pre></td></tr></table>
</div>
</div><p>返回结果的<code>data</code>部分是一个标签名字符串列表。
栗子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ curl &#39;localhost:9090/api/v1/labels&#39;
{
    &#34;status&#34;: &#34;success&#34;,
    &#34;data&#34;: [
        &#34;__name__&#34;,
        &#34;call&#34;,
        &#34;code&#34;,
        &#34;config&#34;,
        &#34;dialer_name&#34;,
        &#34;endpoint&#34;,
        &#34;event&#34;,
        &#34;goversion&#34;,
        &#34;handler&#34;,
        &#34;instance&#34;,
        &#34;interval&#34;,
        &#34;job&#34;,
        &#34;le&#34;,
        &#34;listener_name&#34;,
        &#34;name&#34;,
        &#34;quantile&#34;,
        &#34;reason&#34;,
        &#34;role&#34;,
        &#34;scrape_job&#34;,
        &#34;slice&#34;,
        &#34;version&#34;
    ]
}
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>查询标签值</strong></p>
<p>请求如下端点:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">GET /api/v1/label/&lt;label_name&gt;/values
</code></pre></td></tr></table>
</div>
</div><p>JSON响应的<code>data</code>部分是标签值字符串列表。
栗子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ curl http://localhost:9090/api/v1/label/job/values
{
   &#34;status&#34; : &#34;success&#34;,
   &#34;data&#34; : [
      &#34;node&#34;,
      &#34;prometheus&#34;
   ]
}
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="表达式查询结果的格式">表达式查询结果的格式</h4>
<p>Expression query result formats</p>
<p>表达式查询结果可能会在<code>data</code>部分的<code>result</code>字段中返回以下响应值。</p>
<br>
<p><strong>区间向量(range vectors)</strong></p>
<p>区间向量返回<code>matrix</code> resultType。<code>result</code>的响应格式如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[
  {
    &#34;metric&#34;: { &#34;&lt;label_name&gt;&#34;: &#34;&lt;label_value&gt;&#34;, ... },
    &#34;values&#34;: [ [ &lt;unix_time&gt;, &#34;&lt;sample_value&gt;&#34; ], ... ]
  },
  ...
]
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>瞬时向量(instant vectors)</strong></p>
<p>瞬时向量返回<code>vector</code> resultType。<code>result</code>的响应格式如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[
  {
    &#34;metric&#34;: { &#34;&lt;label_name&gt;&#34;: &#34;&lt;label_value&gt;&#34;, ... },
    &#34;value&#34;: [ &lt;unix_time&gt;, &#34;&lt;sample_value&gt;&#34; ]
  },
  ...
]
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>标量(Scalars)</strong></p>
<p>标量返回<code>scalar</code> resultType。<code>result</code>的响应格式如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[ &lt;unix_time&gt;, &#34;&lt;scalar_value&gt;&#34; ]
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>字符串(string)</strong></p>
<p>字符串返回<code>string</code> resultType。<code>result</code>的响应格式如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[ &lt;unix_time&gt;, &#34;&lt;string_value&gt;&#34; ]
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="目标">目标</h4>
<p>Targets</p>
<p>以下端点返回Prometheus目标发现的当前状态的概述:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">GET /api/v1/targets
</code></pre></td></tr></table>
</div>
</div><p>栗子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">curl http://localhost:9090/api/v1/targets
{
  &#34;status&#34;: &#34;success&#34;,
  &#34;data&#34;: {
    &#34;activeTargets&#34;: [
      {
        &#34;discoveredLabels&#34;: {
          &#34;__address__&#34;: &#34;127.0.0.1:9090&#34;,
          &#34;__metrics_path__&#34;: &#34;/metrics&#34;,
          &#34;__scheme__&#34;: &#34;http&#34;,
          &#34;job&#34;: &#34;prometheus&#34;
        },
        &#34;labels&#34;: {
          &#34;instance&#34;: &#34;127.0.0.1:9090&#34;,
          &#34;job&#34;: &#34;prometheus&#34;
        },
        &#34;scrapeUrl&#34;: &#34;http://127.0.0.1:9090/metrics&#34;,
        &#34;lastError&#34;: &#34;&#34;,
        &#34;lastScrape&#34;: &#34;2017-01-17T15:07:44.723715405+01:00&#34;,
        &#34;health&#34;: &#34;up&#34;
      }
    ],
    &#34;droppedTargets&#34;: [
      {
        &#34;discoveredLabels&#34;: {
          &#34;__address__&#34;: &#34;127.0.0.1:9100&#34;,
          &#34;__metrics_path__&#34;: &#34;/metrics&#34;,
          &#34;__scheme__&#34;: &#34;http&#34;,
          &#34;job&#34;: &#34;node&#34;
        },
      }
    ]
  }
}
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="规则">规则</h4>
<p>Rules</p>
<p>此api端点返回当前载入的告警和记录规则的列表。此外，它还会返回由每个告警规则的Prometheus实例点燃的当前激活的告警。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">GET /api/v1/rules
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">curl http://localhost:9090/api/v1/rules

{
    &#34;data&#34;: {
        &#34;groups&#34;: [
            {
                &#34;rules&#34;: [
                    {
                        &#34;alerts&#34;: [
                            {
                                &#34;activeAt&#34;: &#34;2018-07-04T20:27:12.60602144+02:00&#34;,
                                &#34;annotations&#34;: {
                                    &#34;summary&#34;: &#34;High request latency&#34;
                                },
                                &#34;labels&#34;: {
                                    &#34;alertname&#34;: &#34;HighRequestLatency&#34;,
                                    &#34;severity&#34;: &#34;page&#34;
                                },
                                &#34;state&#34;: &#34;firing&#34;,
                                &#34;value&#34;: &#34;1e+00&#34;
                            }
                        ],
                        &#34;annotations&#34;: {
                            &#34;summary&#34;: &#34;High request latency&#34;
                        },
                        &#34;duration&#34;: 600,
                        &#34;health&#34;: &#34;ok&#34;,
                        &#34;labels&#34;: {
                            &#34;severity&#34;: &#34;page&#34;
                        },
                        &#34;name&#34;: &#34;HighRequestLatency&#34;,
                        &#34;query&#34;: &#34;job:request_latency_seconds:mean5m{job=\&#34;myjob\&#34;} &gt; 0.5&#34;,
                        &#34;type&#34;: &#34;alerting&#34;
                    },
                    {
                        &#34;health&#34;: &#34;ok&#34;,
                        &#34;name&#34;: &#34;job:http_inprogress_requests:sum&#34;,
                        &#34;query&#34;: &#34;sum(http_inprogress_requests) by (job)&#34;,
                        &#34;type&#34;: &#34;recording&#34;
                    }
                ],
                &#34;file&#34;: &#34;/rules.yaml&#34;,
                &#34;interval&#34;: 60,
                &#34;name&#34;: &#34;example&#34;
            }
        ]
    },
    &#34;status&#34;: &#34;success&#34;
}
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="告警">告警</h4>
<p>Alerts</p>
<p>此端点返回所有激活的告警的列表。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">GET /api/v1/alerts
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">curl http://localhost:9090/api/v1/alerts

{
    &#34;data&#34;: {
        &#34;alerts&#34;: [
            {
                &#34;activeAt&#34;: &#34;2018-07-04T20:27:12.60602144+02:00&#34;,
                &#34;annotations&#34;: {},
                &#34;labels&#34;: {
                    &#34;alertname&#34;: &#34;my-alert&#34;
                },
                &#34;state&#34;: &#34;firing&#34;,
                &#34;value&#34;: &#34;1e+00&#34;
            }
        ]
    },
    &#34;status&#34;: &#34;success&#34;
}
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="查询目标元数据">查询目标元数据</h4>
<p>Query target metadata</p>
<p>此段点返回目前由目标爬取的关于指标的元数据。这是实验性的，未来可能发生改变。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">GET /api/v1/targets/metadata
</code></pre></td></tr></table>
</div>
</div><p>URL查询参数:</p>
<ul>
<li><code>match_target=&lt;label_selectors&gt;</code>: 标签选择器通过标签集匹配的目标。如果为空，则所有目标都被选中。</li>
<li><code>metics=&lt;string&gt;</code>: 检索元数据的指标名称。如果为空，则所有指标元数据都被检索。</li>
<li><code>limit=&lt;number&gt;</code>: 匹配的目标的最大数量。</li>
</ul>
<p>栗子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">curl -G http://localhost:9091/api/v1/targets/metadata \
    --data-urlencode &#39;metric=go_goroutines&#39; \
    --data-urlencode &#39;match_target={job=&#34;prometheus&#34;}&#39; \
    --data-urlencode &#39;limit=2&#39;
{
  &#34;status&#34;: &#34;success&#34;,
  &#34;data&#34;: [
    {
      &#34;target&#34;: {
        &#34;instance&#34;: &#34;127.0.0.1:9090&#34;,
        &#34;job&#34;: &#34;prometheus&#34;
      },
      &#34;type&#34;: &#34;gauge&#34;,
      &#34;help&#34;: &#34;Number of goroutines that currently exist.&#34;,
      &#34;unit&#34;: &#34;&#34;
    },
    {
      &#34;target&#34;: {
        &#34;instance&#34;: &#34;127.0.0.1:9091&#34;,
        &#34;job&#34;: &#34;prometheus&#34;
      },
      &#34;type&#34;: &#34;gauge&#34;,
      &#34;help&#34;: &#34;Number of goroutines that currently exist.&#34;,
      &#34;unit&#34;: &#34;&#34;
    }
  ]
}
</code></pre></td></tr></table>
</div>
</div><p>栗子:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">curl -G http://localhost:9091/api/v1/targets/metadata \
    --data-urlencode &#39;match_target={instance=&#34;127.0.0.1:9090&#34;}&#39;
{
  &#34;status&#34;: &#34;success&#34;,
  &#34;data&#34;: [
    // ...
    {
      &#34;target&#34;: {
        &#34;instance&#34;: &#34;127.0.0.1:9090&#34;,
        &#34;job&#34;: &#34;prometheus&#34;
      },
      &#34;metric&#34;: &#34;prometheus_treecache_zookeeper_failures_total&#34;,
      &#34;type&#34;: &#34;counter&#34;,
      &#34;help&#34;: &#34;The total number of ZooKeeper failures.&#34;,
      &#34;unit&#34;: &#34;&#34;
    },
    {
      &#34;target&#34;: {
        &#34;instance&#34;: &#34;127.0.0.1:9090&#34;,
        &#34;job&#34;: &#34;prometheus&#34;
      },
      &#34;metric&#34;: &#34;prometheus_tsdb_reloads_total&#34;,
      &#34;type&#34;: &#34;counter&#34;,
      &#34;help&#34;: &#34;Number of times the database reloaded block data from disk.&#34;,
      &#34;unit&#34;: &#34;&#34;
    },
    // ...
  ]
}
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="告警器">告警器</h4>
<p>AlertManagers</p>
<p>此端点返回Prometheus alertmanager discovery的当前状态的概述:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">GET /api/v1/alertmanagers
</code></pre></td></tr></table>
</div>
</div><p>active和dropped Alertmanagers都是响应的一部分:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">curl http://localhost:9090/api/v1/alertmanagers
{
  &#34;status&#34;: &#34;success&#34;,
  &#34;data&#34;: {
    &#34;activeAlertmanagers&#34;: [
      {
        &#34;url&#34;: &#34;http://127.0.0.1:9090/api/v1/alerts&#34;
      }
    ],
    &#34;droppedAlertmanagers&#34;: [
      {
        &#34;url&#34;: &#34;http://127.0.0.1:9093/api/v1/alerts&#34;
      }
    ]
  }
}
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="状态">状态</h4>
<p>Status</p>
<p>以下状态端点暴露当前Prometheus配置。</p>
<br>
<p><strong>Config</strong></p>
<p>此端点返回当前加载的配置文件:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">GET /api/v1/status/config
</code></pre></td></tr></table>
</div>
</div><p>配置返回为转存的YAML文件。由于YAML库的限制，YAML中不包含注释:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">curl http://localhost:9090/api/v1/status/config
{
  &#34;status&#34;: &#34;success&#34;,
  &#34;data&#34;: {
    &#34;yaml&#34;: &#34;&lt;content of the loaded config file in YAML&gt;&#34;,
  }
}
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>Flags</strong></p>
<p>此端点返回Prometheus配置的标志值:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">GET /api/v1/status/flags
</code></pre></td></tr></table>
</div>
</div><p>所有值的结果类型都是字符串:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">curl http://localhost:9090/api/v1/status/flags
{
  &#34;status&#34;: &#34;success&#34;,
  &#34;data&#34;: {
    &#34;alertmanager.notification-queue-capacity&#34;: &#34;10000&#34;,
    &#34;alertmanager.timeout&#34;: &#34;10s&#34;,
    &#34;log.level&#34;: &#34;info&#34;,
    &#34;query.lookback-delta&#34;: &#34;5m&#34;,
    &#34;query.max-concurrency&#34;: &#34;20&#34;,
    ...
  }
}
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>RunTime Information</strong></p>
<p>此端点返回Prometheus Server的各种运行信息属性:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">GET /api/v1/status/runtimeinfo
</code></pre></td></tr></table>
</div>
</div><p>根据运行属性，返回的值有两种类型:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">curl http://localhost:9090/api/v1/status/runtimeinfo
{
  &#34;status&#34;: &#34;success&#34;,
  &#34;data&#34;: {
    &#34;startTime&#34;: &#34;2019-11-02T17:23:59.301361365+01:00&#34;,
    &#34;CWD&#34;: &#34;/&#34;,
    &#34;reloadConfigSuccess&#34;: true,
    &#34;lastConfigTime&#34;: &#34;2019-11-02T17:23:59+01:00&#34;,
    &#34;chunkCount&#34;: 873,
    &#34;timeSeriesCount&#34;: 873,
    &#34;corruptionCount&#34;: 0,
    &#34;goroutineCount&#34;: 48,
    &#34;GOMAXPROCS&#34;: 4,
    &#34;GOGC&#34;: &#34;&#34;,
    &#34;GODEBUG&#34;: &#34;&#34;,
    &#34;storageRetention&#34;: &#34;15d&#34;
  }
}
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>Build Information</strong></p>
<p>此端点返回各种关于Prometheus Server的构建信息属性:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">GET /api/v1/status/buildinfo
</code></pre></td></tr></table>
</div>
</div><p>所有结果的值的类型都是字符串:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">curl http://localhost:9090/api/v1/status/buildinfo
{
  &#34;status&#34;: &#34;success&#34;,
  &#34;data&#34;: {
    &#34;version&#34;: &#34;2.13.1&#34;,
    &#34;revision&#34;: &#34;cb7cbad5f9a2823a622aaa668833ca04f50a0ea7&#34;,
    &#34;branch&#34;: &#34;master&#34;,
    &#34;buildUser&#34;: &#34;julius@desktop&#34;,
    &#34;buildDate&#34;: &#34;20191102-16:19:59&#34;,
    &#34;goVersion&#34;: &#34;go1.13.1&#34;
  }
}
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="tsdb-admin-apis">TSDB Admin APIs</h4>
<p>这些都是为高级用户公开的数据库功能的API。除非设置<code>--web.enable-admin-api</code>，否则不启用这些API。</p>
<p>我们也公开了一个gRPC API。这是实验性的，未来可能会改变。</p>
<br>
<p><strong>Snapshot</strong></p>
<p>创建所有当前数据的快照<code>snapshots/datetime-rand</code>早TSDB的数据目录并返回目录作为响应。它将可选地跳过快照数据尽在头部块，并且未被压缩到磁盘。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">POST /api/v1/admin/tsdb/snapshot
PUT /api/v1/admin/tsdb/snapshot
</code></pre></td></tr></table>
</div>
</div><p>URL查询参数:</p>
<ul>
<li><code>skip_head=&lt;bool&gt;</code>: 跳过存在于头部块(head block)的数据，可选。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">curl -XPOST http://localhost:9090/api/v1/admin/tsdb/snapshot
{
  &#34;status&#34;: &#34;success&#34;,
  &#34;data&#34;: {
    &#34;name&#34;: &#34;20171210T211224Z-2be650b6d019eb54&#34;
  }
}
</code></pre></td></tr></table>
</div>
</div><p>快照现在位于: <code>&lt;data-dir&gt;/snapshots/20171210T211224Z-2be650b6d019eb54</code></p>
<br>
<p><strong>Delete Series</strong></p>
<p>删除在一个时间范围内选择的一些列数据。实际数据仍然存在于磁盘上，并在未来被清除或通过点击Clean Tombstones endpoint来明确清理。
如果成功，返回<code>204</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">POST /api/v1/admin/tsdb/delete_series
PUT /api/v1/admin/tsdb/delete_series
</code></pre></td></tr></table>
</div>
</div><p>URL查询参数:</p>
<ul>
<li><code>match[]=&lt;series_selector&gt;</code>: 至少必须提供一个</li>
<li><code>start=&lt;rfc3339 | unix_timestamp&gt;</code></li>
<li><code>end=&lt;rfc3339 | unix_timestamp&gt;</code></li>
</ul>
<p>未指定时间范围将删除匹配的所有数据。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">curl -X POST -g &#39;http://localhost:9090/api/v1/admin/tsdb/delete_series?match[]=up&amp;match[]=process_start_time_seconds{job=&#34;prometheus&#34;}&#39;
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>Clean Tombstones</strong></p>
<p>从磁盘中删除已删除的数据并清理现有的tombstones。这可在清理数据后腾出磁盘空间。</p>
<p>如果成功，返回<code>204</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">POST /api/v1/admin/tsdb/clean_tombstones
PUT /api/v1/admin/tsdb/clean_tombstones
</code></pre></td></tr></table>
</div>
</div><p>不需要任何参数或body:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">curl -XPOST http://localhost:9090/api/v1/admin/tsdb/clean_tombstones
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<br>
<h2 id="存储">存储</h2>
<p>Storage: <a href="https://prometheus.io/docs/prometheus/latest/storage/">https://prometheus.io/docs/prometheus/latest/storage/</a></p>
<p>Prometheus包含了一个本地磁盘上的时序数据库(time series database)，但是可选地与远程存储系统集成。</p>
<br>
<h3 id="本地存储">本地存储</h3>
<p>Local storage</p>
<p>Prometheus本地时序数据库存储时序数据自定义格式存储到磁盘上。</p>
<br>
<p><strong>On-disk layout</strong></p>
<p>Prometheus按两小时为一个时间窗口分组存储在一个块(block)中。每个块是一个单独地目录，里面包含该时间窗口内的所有样本数据(chunks)，元数据文件(meta.json)以及索引文件(index)。其中索引文件会将指标名称和标签索引到样板数据的时间序列中。此期间如果通过 API 删除时间序列，删除记录会保存在单独的逻辑文件<code>tombstone</code>当中。</p>
<p>当前样本数据所在的块会被直接保存在内存中，不会持久化到磁盘中。为了确保Prometheus发生崩溃或重启时能够恢复数据，Prometheus启动时会通过预写日志（write-ahead-log(WAL)）重新记录，从而恢复数据。预写日志文件保存在<code>wal</code>目录中，每个文件大小为<code>128MB</code>。wal 文件包括还没有被压缩的原始数据，所以比常规的块文件大得多。一般情况下，Prometheus 会保留三个 wal 文件，但如果有些高负载服务器需要保存两个小时以上的原始数据，wal文件的数量就会大于3个。</p>
<p>Prometheus块数据的目录结构如下所示:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">./data
├── 01BKGV7JBM69T2G1BGBGM6KB12
│   └── meta.json
├── 01BKGTZQ1SYQJTR4PB43C8PD98
│   ├── chunks
│   │   └── 000001
│   ├── tombstones
│   ├── index
│   └── meta.json
├── 01BKGTZQ1HHWHV8FBJXW1Y3W0K
│   └── meta.json
├── 01BKGV7JC0RY8A6MACW02A2PJD
│   ├── chunks
│   │   └── 000001
│   ├── tombstones
│   ├── index
│   └── meta.json
└── wal
    ├── 00000002
    └── checkpoint.000001
</code></pre></td></tr></table>
</div>
</div><p>本地存储的局限性是它无法构建集群(clustered)或副本(replicated)。因此，如果本地磁盘或节点出现故障，存储将无法扩展和迁移。使用RAID用于磁盘的可用性，使用快照用于备份，容量规划&hellip;建议提高耐用性。如果你对数据持久化的要求不是很严格，可以使用本地磁盘存储多达数年的数据。</p>
<p>可替代地，外部存储可通过使用<code>remote read/write APIs</code>。仔细评估这些系统，因为它们在耐用性，性能和效率差异很大。</p>
<p>有关存储格式的详细信息，请参考 <a href="https://github.com/prometheus/prometheus/blob/master/tsdb/docs/format/README.md" target="_blank" rel="noopener noreffer ">TSDB格式</a></p>
<br>
<br>
<h3 id="compaction">Compaction</h3>
<p>最初两个小时的块最终会在后台被压缩成更长的块。</p>
<br>
<h3 id="操作配置">操作配置</h3>
<p>Prometheus提供了几个标志来允许配置本地存储。最重要的几个:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># 数据存储路径，默认data/
--storage.tsdb.path


# 样本数据在存储中保存的时间。超过该时间限制的数据就会被删除。默认15d
-storage.tsdb.retention.time


# 每个块的最大字节数（不包括 wal 文件）。如果超过限制，最早的样本数据会被优先删除。支持的单位有 KB, MB, GB, PB。默认0，即为不限制
--storage.tsdb.retention.size


# 压缩wal
--storage.tsdb.wal-compression
</code></pre></td></tr></table>
</div>
</div><br>
<p>一般情况下，Prometheus中存储的每一个样本大概会占用1-2Byte。因此，如果需要对Prometheus Server的本地磁盘空间做容量规划，可通过以下公式计算:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">needed_disk_space = retention_time_seconds * ingested_samples_per_second * bytes_per_sample
</code></pre></td></tr></table>
</div>
</div><p>从上面公式中可以看出在保留时间（<code>retention_time_seconds</code>）和样本大小（<code>bytes_per_sample</code>）不变的情况下，如果想减少本地磁盘的容量需求，只能通过减少每秒获取样本数（<code>ingested_samples_per_second</code>）的方式。因此有两种手段，一是减少时间序列的数量，二是增加采集样本的时间间隔。考虑到 Prometheus 会对时间序列进行压缩效率，减少时间序列的数量效果更明显。</p>
<br/>
<br/>
<hr>
<br/>
<br/>
<h1 id="可视化">可视化</h1>
<p>Visualization</p>
<br>
<h2 id="表达式浏览器">表达式浏览器</h2>
<p>Expression browser</p>
<p>表达其浏览器在 Prometheus Server 的 <code>/graph</code> 处。
对于图形，请使用 Grafana 或 Console template。</p>
<br/>
<br/>
<br/>
<h2 id="grafana">Grafana</h2>
<p>Grafana: <a href="https://grafana.com/">https://grafana.com/</a></p>
<p>Grafana，美丽的分析和监控的开放平台，时序分析的开源那软件。</p>
<p>Grafana 支持查询 Prometheus。如下是一个Grafana仪表盘，用于查询Prometheus的数据：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/Prometheus/grafana_prometheus.png"
        data-srcset="/images/Prometheus/grafana_prometheus.png, /images/Prometheus/grafana_prometheus.png 1.5x, /images/Prometheus/grafana_prometheus.png 2x"
        data-sizes="auto"
        alt="/images/Prometheus/grafana_prometheus.png"
        title="/images/Prometheus/grafana_prometheus.png" /></p>
<br/>
<h3 id="安装-1">安装</h3>
<p>完整的安装说明，请查看Grafana Docs。</p>
<br/>
<h4 id="centos">CentOS</h4>
<p><strong>RPM</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="err">#</span><span class="nx">sudo</span> <span class="nx">yum</span> <span class="nx">install</span> <span class="p">&lt;</span><span class="nx">rpm</span> <span class="kn">package</span> <span class="nx">url</span><span class="p">&gt;</span>
<span class="nx">sudo</span> <span class="nx">yum</span> <span class="nx">install</span> <span class="nx">https</span><span class="p">:</span><span class="c1">//s3-us-west-2.amazonaws.com/grafana-releases/release/grafana-5.1.4-1.x86_64.rpm
</span></code></pre></td></tr></table>
</div>
</div><p><strong>repo</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[grafana]
name=grafana
baseurl=https://packagecloud.io/grafana/stable/el/7/$basearch
repo_gpgcheck=1
enabled=1
gpgcheck=1
gpgkey=https://packagecloud.io/gpg.key https://grafanarel.s3.amazonaws.com/RPM-GPG-KEY-grafana
sslverify=1
sslcacert=/etc/pki/tls/certs/ca-bundle.crt


sudo yum install -y grafana


#启动
systemctl start grafana-server


#命令行工具
grafana-cli
</code></pre></td></tr></table>
</div>
</div><p><strong>包详情</strong></p>
<ul>
<li>Installs binary to <code>/usr/sbin/grafana-server</code></li>
<li>Copies init.d script to <code>/etc/init.d/grafana-server</code></li>
<li>Installs default file (environment vars) to <code>/etc/sysconfig/grafana-server</code></li>
<li>Copies configuration file to <code>/etc/grafana/grafana.ini</code></li>
<li>Installs systemd service (if systemd is available) name <code>grafana-server.service</code></li>
<li>The default configuration uses a log file at <code>/var/log/grafana/grafana.log</code></li>
<li>The default configuration specifies an sqlite3 database at <code>/var/lib/grafana/grafana.db</code></li>
</ul>
<br>
<p><strong>二进制tar文件</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># Download and unpack Grafana from binary tar (adjust version as appropriate).
curl -L -O https://grafanarel.s3.amazonaws.com/builds/grafana-2.5.0.linux-x64.tar.gz
tar zxf grafana-2.5.0.linux-x64.tar.gz

# Start Grafana.
cd grafana-2.5.0/
./bin/grafana-server web
</code></pre></td></tr></table>
</div>
</div><br/>
<br/>
<h4 id="docker">Docker</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">#基础栗子
docker run -d -p 3000:3000 grafana/grafana


#配置化
docker run \
  -d \
  -p 3000:3000 \
  --name=grafana \
  -e &#34;GF_SERVER_ROOT_URL=http://grafana.server.name&#34; \
  -e &#34;GF_SECURITY_ADMIN_PASSWORD=secret&#34; \
  grafana/grafana:version


#默认环境变量值
GF_PATHS_CONFIG	/etc/grafana/grafana.ini
GF_PATHS_DATA	/var/lib/grafana
GF_PATHS_HOME	/usr/share/grafana
GF_PATHS_LOGS	/var/log/grafana
GF_PATHS_PLUGINS	/var/lib/grafana/plugins
GF_PATHS_PROVISIONING	/etc/grafana/provisioning

</code></pre></td></tr></table>
</div>
</div><br/>
<br/>
<h3 id="使用">使用</h3>
<p>默认情况下，访问<code>http://localhost:3000</code>来访问Grafana。默认登录的用户名和密码： <code>admin/admin</code>。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/Prometheus/grafana_login.png"
        data-srcset="/images/Prometheus/grafana_login.png, /images/Prometheus/grafana_login.png 1.5x, /images/Prometheus/grafana_login.png 2x"
        data-sizes="auto"
        alt="/images/Prometheus/grafana_login.png"
        title="Grafana" /></p>
<br>
<p><strong>创建Prometheus数据源</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/Prometheus/add_prometheus_datasource.png"
        data-srcset="/images/Prometheus/add_prometheus_datasource.png, /images/Prometheus/add_prometheus_datasource.png 1.5x, /images/Prometheus/add_prometheus_datasource.png 2x"
        data-sizes="auto"
        alt="/images/Prometheus/add_prometheus_datasource.png"
        title="/images/Prometheus/add_prometheus_datasource.png" /></p>
<br>
<p><strong>创建Prometheus图表</strong></p>
<br/>
<br/>
<br/>
<h2 id="console-template">Console template</h2>
<p>控制台模板允许使用Go templating language创建任意控制台。这些都是从Prometheus Server提供的。</p>
<br>
<br>
<hr>
<br>
<br>
<h1 id="示例配置">示例配置</h1>
<p>由于prometheus自带的alertmanager对国内通知支持不够完善，因此使用PrometheusAlert做告警通知。</p>
<br>
<h2 id="prometheus配置样例">prometheus配置样例</h2>
<p>prometheus的配置示例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># my global config</span><span class="w">
</span><span class="w"></span><span class="nt">global</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w">     </span><span class="l">1m</span><span class="w"> </span><span class="c"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><span class="w">
</span><span class="w">  </span><span class="nt">evaluation_interval</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w"> </span><span class="c"># Evaluate rules every 15 seconds. The default is every 1 minute.</span><span class="w">
</span><span class="w">  </span><span class="nt">scrape_timeout</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span><span class="w">  </span><span class="c"># scrape_timeout is set to the global default (10s).</span><span class="w">
</span><span class="w">  </span><span class="c"># for thanos</span><span class="w">
</span><span class="w">  </span><span class="nt">external_labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">ali</span><span class="w"> </span><span class="c"># hw|tx</span><span class="w">
</span><span class="w">    </span><span class="nt">replica</span><span class="p">:</span><span class="w"> </span><span class="l">full</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Alertmanager configuration</span><span class="w">
</span><span class="w"></span><span class="nt">alerting</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">alertmanagers</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">static_configs</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;localhost:9093&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Load rules once and periodically evaluate them according to the global &#39;evaluation_interval&#39;.</span><span class="w">
</span><span class="w"></span><span class="nt">rule_files</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="s2">&#34;rules/*.yml&#34;</span><span class="w">  </span><span class="c"># 通用告警规则模板</span><span class="w">
</span><span class="w">  </span>- <span class="s2">&#34;rules/nodes/*.yml&#34;</span><span class="w">  </span><span class="c"># 各主机告警规则</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># A scrape configuration containing exactly one endpoint to scrape:</span><span class="w">
</span><span class="w"></span><span class="c"># Here it&#39;s Prometheus itself.</span><span class="w">
</span><span class="w"></span><span class="nt">scrape_configs</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span><span class="w">
</span><span class="w">  </span>- <span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="l">node-process-exporter</span><span class="w">
</span><span class="w">    </span><span class="nt">file_sd_configs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">files</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="s2">&#34;discovery/exporter/*.yml&#34;</span><span class="w">
</span><span class="w">    </span><span class="c"># metrics_path defaults to &#39;/metrics&#39;</span><span class="w">
</span><span class="w">    </span><span class="c"># scheme defaults to &#39;http&#39;.</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="l">mongodb-exporter</span><span class="w">
</span><span class="w">    </span><span class="nt">file_sd_configs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">files</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="s2">&#34;discovery/mongodb/*.yml&#34;</span><span class="w">
</span><span class="w">  </span>- <span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="l">kafka-exporter</span><span class="w">
</span><span class="w">    </span><span class="nt">file_sd_configs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">files</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="s2">&#34;discovery/kafka/*.yml&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="l">aliyun-exporter</span><span class="w">
</span><span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">targets</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;localhost:9525&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;localhost:9526&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;localhost:9527&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;localhost:9528&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;localhost:9529&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="l">blackbox_exporter</span><span class="w">
</span><span class="w">    </span><span class="nt">metrics_path</span><span class="p">:</span><span class="w"> </span><span class="l">/probe</span><span class="w">
</span><span class="w">    </span><span class="nt">file_sd_configs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">files</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="s2">&#34;discovery/blackbox/*.yml&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">relabel_configs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">__address__]</span><span class="w">
</span><span class="w">        </span><span class="nt">target_label</span><span class="p">:</span><span class="w"> </span><span class="l">__param_target</span><span class="w">
</span><span class="w">      </span>- <span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">module]</span><span class="w">
</span><span class="w">        </span><span class="nt">target_label</span><span class="p">:</span><span class="w"> </span><span class="l">__param_module</span><span class="w">
</span><span class="w">      </span>- <span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">__param_target]</span><span class="w">
</span><span class="w">        </span><span class="nt">target_label</span><span class="p">:</span><span class="w"> </span><span class="l">instance</span><span class="w">
</span><span class="w">      </span>- <span class="nt">target_label</span><span class="p">:</span><span class="w"> </span><span class="l">__address__</span><span class="w">
</span><span class="w">        </span><span class="nt">replacement</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="p">:</span><span class="m">9115</span><span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h2 id="alertmanager配置样例">alertmanager配置样例</h2>
<p>alertmanager的配置示例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="c"># global config</span><span class="w">
</span><span class="w"></span><span class="nt">global</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">resolve_timeout</span><span class="p">:</span><span class="w"> </span><span class="l">5m</span><span class="w">
</span><span class="w">  </span><span class="c"># smtp config</span><span class="w">
</span><span class="w">  </span><span class="c"># slack config</span><span class="w">
</span><span class="w">  </span><span class="c"># wechat config</span><span class="w">
</span><span class="w">  </span><span class="c"># http config</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># templates config</span><span class="w">
</span><span class="w"></span><span class="nt">templates</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># route tree</span><span class="w">
</span><span class="w"></span><span class="nt">route</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">receiver</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;web.hook.prometheusalert&#39;</span><span class="w">
</span><span class="w">  </span><span class="nt">group_by</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">instanceId</span><span class="w">
</span><span class="w">    </span>- <span class="l">hostname</span><span class="w">
</span><span class="w">  </span><span class="nt">group_wait</span><span class="p">:</span><span class="w"> </span><span class="l">30s</span><span class="w">
</span><span class="w">  </span><span class="nt">group_interval</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span><span class="w">  </span><span class="c"># notification again</span><span class="w">
</span><span class="w">  </span><span class="nt">repeat_interval</span><span class="p">:</span><span class="w"> </span><span class="l">10m</span><span class="w">
</span><span class="w">  </span><span class="c"># continue config</span><span class="w">
</span><span class="w">  </span><span class="c"># match: [ &lt;labelname&gt;: &lt;labelvalue&gt;, ... ]</span><span class="w">
</span><span class="w">  </span><span class="c"># match_re: [ &lt;labelname&gt;: &lt;regex&gt;, ... ]</span><span class="w">
</span><span class="w">  </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">match</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">warning</span><span class="w">
</span><span class="w">      </span><span class="nt">repeat_interval</span><span class="p">:</span><span class="w"> </span><span class="l">1h</span><span class="w">
</span><span class="w">  </span>- <span class="nt">match_re</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">notice|info</span><span class="w">
</span><span class="w">      </span><span class="nt">repeat_interval</span><span class="p">:</span><span class="w"> </span><span class="l">6h</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># receiver lists</span><span class="w">
</span><span class="w"></span><span class="nt">receivers</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;web.hook.prometheusalert&#39;</span><span class="w">
</span><span class="w">  </span><span class="nt">webhook_configs</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;http://127.0.0.1:8080/prometheus/alert&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># list of inhibit rules</span><span class="w">
</span><span class="w"></span><span class="nt">inhibit_rules</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># aliyun</span><span class="w">
</span><span class="w">  </span>- <span class="nt">source_match</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;critical&#39;</span><span class="w">
</span><span class="w">    </span><span class="nt">target_match_re</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;warning&#39;</span><span class="w">
</span><span class="w">    </span><span class="c"># source_match_re</span><span class="w">
</span><span class="w">    </span><span class="c"># target_match_re</span><span class="w">
</span><span class="w">    </span><span class="c"># Labels that must have an equal value in the source and target</span><span class="w">
</span><span class="w">    </span><span class="nt">equal</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;instance&#39;</span><span class="p">,</span><span class="s1">&#39;job&#39;</span><span class="p">,</span><span class="s1">&#39;instanceId&#39;</span><span class="p">,</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span><span class="w">
</span><span class="w">  </span><span class="c"># nodes</span><span class="w">
</span><span class="w">  </span>- <span class="nt">source_match</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;critical&#39;</span><span class="w">
</span><span class="w">    </span><span class="nt">target_match_re</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;warning&#39;</span><span class="w">
</span><span class="w">    </span><span class="nt">equal</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">instance</span><span class="w">
</span><span class="w">    </span>- <span class="l">job</span><span class="w">
</span><span class="w">    </span>- <span class="l">hostname</span><span class="w">
</span><span class="w">    </span>- <span class="l">kind</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h2 id="prometheus自动发现">prometheus自动发现</h2>
<p>prometheus的文件自动发现示例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l">localhost</span><span class="w">
</span><span class="w">    </span><span class="nt">hostgroup</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span><span class="w">  </span><span class="nt">targets</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;localhost:9100&#34;</span><span class="w"> </span><span class="c"># node-exporter</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;localhost:9256&#34;</span><span class="w"> </span><span class="c"># process-exporter</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h2 id="prometheus告警规则">prometheus告警规则</h2>
<p>prometheus的告警规则示例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">groups</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">node-cpu</span><span class="w">
</span><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># cpu核数</span><span class="w">
</span><span class="w">  </span>- <span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">instance:node_cpus:count</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">count without (cpu, mode) (node_cpu_seconds_total{mode=&#34;idle&#34;})</span><span class="w">
</span><span class="w">  </span><span class="c"># 每个cpu使用率</span><span class="w">
</span><span class="w">  </span>- <span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">instance_cpu:node_cpu_seconds_not_idle:rate2m</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">sum without (mode) (1 - rate(node_cpu_seconds_total{mode=&#34;idle&#34;}[2m]))</span><span class="w">
</span><span class="w">  </span><span class="c"># 总cpu使用率</span><span class="w">
</span><span class="w">  </span>- <span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">instance:node_cpu_utilization:ratio</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">avg without (cpu) (instance_cpu:node_cpu_seconds_not_idle:rate2m)</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">cpu使用率大于85%</span><span class="w">
</span><span class="w">    </span><span class="c">### expr: (1 - avg(irate(node_cpu_seconds_total{mode=&#34;idle&#34;}[5m])) by(instance,hostname)) * 100 &gt; 85</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">instance:node_cpu_utilization:ratio * 100 &gt; 85</span><span class="w">
</span><span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l">3m</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">warning</span><span class="w">
</span><span class="w">      </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CpuUsage</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cpu使用率大于85%: {{ $labels.hostname }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $labels.hostname }}的cpu使用率: {{ $value | humanize }}%&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">cpu使用率大于90%</span><span class="w">
</span><span class="w">    </span><span class="c">### expr: (1 - avg(irate(node_cpu_seconds_total{mode=&#34;idle&#34;}[5m])) by(instance,hostname)) * 100 &gt; 90</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">instance:node_cpu_utilization:ratio * 100 &gt; 90</span><span class="w">
</span><span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">critical</span><span class="w">
</span><span class="w">      </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CpuUsage</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cpu使用率大于90%: {{ $labels.hostname }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $labels.hostname }}的cpu使用率: {{ $value | humanize }}%&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">wxurl</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;xxx&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">cpu使用率一分钟内增长30%且大于70%</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">delta(instance:node_cpu_utilization:ratio[2m]) * 100 &gt; 30 and on(hostname) instance:node_cpu_utilization:ratio * 100 &gt; 70</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">warning</span><span class="w">
</span><span class="w">      </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CpuUsageDelta</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cpu使用率一分钟内增长30%且大于70%: {{ $labels.hostname }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $labels.hostname }} 的cpu使用率一分钟内增长30%且大于70%，增长率: {{ $value | humanize }}%&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">wxurl</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;xxx&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">cpu使用率一分钟内增长40%且大于80%</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">delta(instance:node_cpu_utilization:ratio[2m]) * 100 &gt; 40 and on(hostname) instance:node_cpu_utilization:ratio * 100 &gt; 80</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">critical</span><span class="w">
</span><span class="w">      </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CpuUsageDelta</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cpu使用率一分钟内增长40%且大于80%: {{ $labels.hostname }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $labels.hostname }} 的cpu使用率一分钟内增长40%且大于80%，增长率: {{ $value | humanize }}%&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">cpu使用率一分钟内增长50%</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">delta(instance:node_cpu_utilization:ratio[2m]) * 100 &gt; 50</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">critical</span><span class="w">
</span><span class="w">      </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cpu使用率一分钟内增长50%: {{ $labels.hostname }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $labels.hostname }} 的cpu使用率一分钟内增长50%，增长率: {{ $value | humanize }}%&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">cpu负载大于Cores</span><span class="w">
</span><span class="w">    </span><span class="c">### expr: node_load1 &gt; count(node_cpu_seconds_total{mode=&#34;idle&#34;}) without (cpu,mode)</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">node_load1 &gt; instance:node_cpus:count</span><span class="w">
</span><span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l">3m</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">warning</span><span class="w">
</span><span class="w">      </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CpuLoad</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cpu负载大于cpu核数: {{ $labels.hostname }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $labels.hostname }}的cpu负载: {{ $value }}&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">cpu负载大于2Cores-2</span><span class="w">
</span><span class="w">    </span><span class="c">### expr: node_load1 &gt; 2 * (count(node_cpu_seconds_total{mode=&#34;idle&#34;}) without (cpu,mode)) - 2</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">node_load1 &gt; (instance:node_cpus:count * 2) - 2</span><span class="w">
</span><span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">critical</span><span class="w">
</span><span class="w">      </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CpuLoad</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cpu负载大于2Cores-2: {{ $labels.hostname }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $labels.hostname }}的cpu负载: {{ $value }}&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">主机上下文切换忙</span><span class="w">
</span><span class="w">    </span><span class="c">### expr: (rate(node_context_switches_total[5m])) / (count without(cpu, mode) (node_cpu_seconds_total{mode=&#34;idle&#34;})) &gt; 2000</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">(rate(node_context_switches_total[5m]) / instance:node_cpus:count) &gt; 2000</span><span class="w">
</span><span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l">5m</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">warning</span><span class="w">
</span><span class="w">      </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;主机上下文切换忙: {{ $labels.hostname }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;主机{{ $labels.hostname }}的上下文切换大于2000/s: {{ $value | humanize }}/s&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">node-memory</span><span class="w">
</span><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># 内存可用率</span><span class="w">
</span><span class="w">  </span>- <span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">instance:node_memory_available:ratio</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p">&gt;</span><span class="sd">
</span><span class="sd">      (
</span><span class="sd">        node_memory_MemAvailable_bytes or
</span><span class="sd">        (
</span><span class="sd">          node_memory_Buffers_bytes +
</span><span class="sd">          node_memory_Cached_bytes +
</span><span class="sd">          node_memory_MemFree_bytes +
</span><span class="sd">          node_memory_Slab_bytes
</span><span class="sd">        )
</span><span class="sd">      ) /
</span><span class="sd">      node_memory_MemTotal_bytes</span><span class="w">      
</span><span class="w">  </span><span class="c"># 内存使用率</span><span class="w">
</span><span class="w">  </span>- <span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">instance:node_memory_utilization:ratio</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>- <span class="l">instance:node_memory_available:ratio</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">主机内存面临压力</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">rate(node_vmstat_pgmajfault[1m]) &gt; 1000</span><span class="w">
</span><span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l">5m</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">warning</span><span class="w">
</span><span class="w">      </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;主机内存面临压力: {{ $labels.instance }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;节点内存面临压力。High rate of major page faults: {{ $value }}&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">内存使用率大于85%</span><span class="w">
</span><span class="w">    </span><span class="c">### expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 &gt; 85</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">instance:node_memory_utilization:ratio * 100 &gt; 85</span><span class="w">
</span><span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l">3m</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">warning</span><span class="w">
</span><span class="w">      </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">MemoryUsage</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;内存使用率超过85%: {{ $labels.hostname }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $labels.hostname }}的内存使用率: {{ $value | humanize }}%&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">内存使用率大于90%</span><span class="w">
</span><span class="w">    </span><span class="c">### expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 &gt; 90</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">instance:node_memory_utilization:ratio * 100 &gt; 90</span><span class="w">
</span><span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">critical</span><span class="w">
</span><span class="w">      </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">MemoryUsage</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;内存使用率超过90%: {{ $labels.hostname }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $labels.hostname }}的内存使用率: {{ $value | humanize }}%&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">内存使用率一分钟内增长30%且大于70%</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">delta(instance:node_memory_utilization:ratio[2m]) * 100 &gt; 30 and on(hostname) instance:node_memory_utilization:ratio * 100 &gt; 70</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">warning</span><span class="w">
</span><span class="w">      </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">MemoryUsageDelta</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;内存使用率一分钟内增长30%且大于70%: {{ $labels.hostname }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $labels.hostname }} 的内存使用率一分钟内增长30%且大于70%，增长率: {{ $value | humanize }}%&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">内存使用率一分钟内增长40%且大于80%</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">delta(instance:node_memory_utilization:ratio[2m]) * 100 &gt; 40 and on(hostname) instance:node_memory_utilization:ratio * 100 &gt; 80</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">critical</span><span class="w">
</span><span class="w">      </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">MemoryUsageDelta</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;内存使用率一分钟内增长40%且大于80%: {{ $labels.hostname }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $labels.hostname }} 的内存使用率一分钟内增长40%且大于80%，增长率: {{ $value | humanize }}%&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">内存使用率一分钟内增长50%</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">delta(instance:node_memory_utilization:ratio[2m]) * 100 &gt; 50</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">critical</span><span class="w">
</span><span class="w">      </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;内存使用率一分钟内增长50%: {{ $labels.hostname }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $labels.hostname }} 的内存使用率一分钟内增长50%，增长率: {{ $value | humanize }}%&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">主机检测到oom kill</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p">&gt;</span><span class="sd">
</span><span class="sd">      increase(node_vmstat_oom_kill[1h]) &gt; 2
</span><span class="sd">      or
</span><span class="sd">      increase(syslog_oom_kills_total[1h]) &gt; 2</span><span class="w">      
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">warning</span><span class="w">
</span><span class="w">      </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;主机检测到oom kill: {{ $labels.hostname }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $labels.hostname }}检测到oom kill: {{ $value }}&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">node-filesystem</span><span class="w">
</span><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># 磁盘分区可用率</span><span class="w">
</span><span class="w">  </span>- <span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">instance:node_filesystem_avail:ratio</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">node_filesystem_avail_bytes{device=~&#34;(/dev/.+|tank/dataset)&#34;} / node_filesystem_size_bytes{device=~&#34;(/dev/.+|tank/dataset)&#34;}</span><span class="w">
</span><span class="w">  </span><span class="c"># 磁盘分区使用率</span><span class="w">
</span><span class="w">  </span>- <span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">instance:node_filesystem_utilization:ratio</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>- <span class="l">instance:node_filesystem_avail:ratio</span><span class="w">
</span><span class="w">  </span><span class="c"># 分区inode可用率</span><span class="w">
</span><span class="w">  </span>- <span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">instance:node_filesystem_files_avail:ratio</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">node_filesystem_files_free / node_filesystem_files</span><span class="w">
</span><span class="w">  </span><span class="c"># 分区inode使用率</span><span class="w">
</span><span class="w">  </span>- <span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">instance:node_filesystem_files_utilization:ratio</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>- <span class="l">instance:node_filesystem_files_avail:ratio</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">磁盘分区使用率大于85%</span><span class="w">
</span><span class="w">    </span><span class="c">### expr: (1- (node_filesystem_avail_bytes{fstype=~&#34;ext4|xfs&#34;} / node_filesystem_size_bytes{fstype=~&#34;ext4|xfs&#34;})) * 100 &gt; 85</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">instance:node_filesystem_utilization:ratio{fstype=~&#34;(ext.|xfs|zfs)&#34;} * 100 &gt; 85</span><span class="w">
</span><span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l">10m</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">warning</span><span class="w">
</span><span class="w">      </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $labels.mountpoint }}&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;磁盘分区{{ $labels.mountpoint}}使用率大于85%&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $labels.hostname }}的磁盘分区{{ $labels.mountpoint }}使用率为: {{ $value | humanize }}%&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">磁盘分区使用率大于90%</span><span class="w">
</span><span class="w">    </span><span class="c">### expr: (1- (node_filesystem_avail_bytes{fstype=~&#34;ext4|xfs&#34;} / node_filesystem_size_bytes{fstype=~&#34;ext4|xfs&#34;})) * 100 &gt; 90</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">instance:node_filesystem_utilization:ratio{fstype=~&#34;(ext.|xfs|zfs)&#34;} * 100 &gt; 90</span><span class="w">
</span><span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l">3m</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">critical</span><span class="w">
</span><span class="w">      </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $labels.mountpoint }}&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;磁盘分区{{ $labels.mountpoint}}使用率大于90%&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $labels.hostname }}的磁盘分区{{ $labels.mountpoint }}使用率为: {{ $value | humanize }}%&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">分区inode使用率大于70%</span><span class="w">
</span><span class="w">    </span><span class="c">### expr: (1 - (node_filesystem_files_free{fstype=~&#34;ext4|xfs&#34;} / node_filesystem_files{fstype=~&#34;ext4|xfs&#34;})) * 100 &gt; 70</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">instance:node_filesystem_files_utilization:ratio{fstype=~&#34;(ext.|xfs)&#34;} * 100 &gt; 70</span><span class="w">
</span><span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l">3m</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">info</span><span class="w">
</span><span class="w">      </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;磁盘分区{{ $labels.mountpoint }}的inode使用率大于70%&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $labels.hostname }}的磁盘分区{{ $labels.mountpoint }}的inode使用率: &#39;{{ $value | humanize }}%&#39;&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">分区inode使用率大于80%</span><span class="w">
</span><span class="w">    </span><span class="c">### expr: (1 - (node_filesystem_files_free{fstype=~&#34;ext4|xfs&#34;} / node_filesystem_files{fstype=~&#34;ext4|xfs&#34;})) * 100 &gt; 80</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">instance:node_filesystem_files_utilization:ratio{fstype=~&#34;(ext.|xfs)&#34;} * 100 &gt; 80</span><span class="w">
</span><span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l">3m</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">warning</span><span class="w">
</span><span class="w">      </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;磁盘分区{{ $labels.mountpoint }}的inode使用率大于80%&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ $labels.hostname }}的磁盘分区{{ $labels.mountpoint }}的inode使用率: &#39;{{ $value | humanize }}%&#39;&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h2 id="进程探针配置">进程探针配置</h2>
<p>process-exporter探针配置示例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="c"># https://github.com/ncabatoff/process-exporter</span><span class="w">
</span><span class="w"></span><span class="c"># /proc/&lt;pid&gt;/xxx</span><span class="w">
</span><span class="w"></span><span class="nt">process_names</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># java</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{.Matches}}&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">cmdline</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="s1">&#39;.+/bin/java .+&#39;</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{.Matches}}&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">cmdline</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="s1">&#39;java .+&#39;</span><span class="w">
</span><span class="w">  </span><span class="c">#匹配完整的运行命令</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{.Matches}}&#34;</span><span class="w">
</span><span class="w">  </span><span class="c">#- name: &#34;{{.Comm}}&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">cmdline</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="s1">&#39;.+&#39;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<h2 id="进程告警规则">进程告警规则</h2>
<p>prometheus进程告警规则示例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">groups</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">测试进程告警规则</span><span class="w">
</span><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">nginx进程不存在</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;sum(namedprocess_namegroup_states{groupname=~&#34;map\\[:nginx: master process .+&#34;}) without(state) == 0&#39;</span><span class="w">
</span><span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">critical</span><span class="w">
</span><span class="w">      </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;nginx进程不存在, 实例: {{ $labels.instance }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;主机: {{ $labels.hostname }}, 进程不存在: {{ $labels.groupname }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">wxurl</span><span class="p">:</span><span class="w"> </span><span class="l">webhook1,webhook2</span><span class="w">
</span><span class="w">      </span><span class="nt">mobile</span><span class="p">:</span><span class="w"> </span><span class="l">phone1,phone2</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>- <span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l">filebeat进程不存在</span><span class="w">
</span><span class="w">    </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">sum without(state) (namedprocess_namegroup_states{groupname=~&#34;map\\[:/usr/share/filebeat/bin/filebeat -e -c .+&#34;, hostgroup=&#34;xxx&#34;}) == 0</span><span class="w">
</span><span class="w">    </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l">critical</span><span class="w">
</span><span class="w">      </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;filebeat进程不存在, 实例: {{ $labels.instance }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;主机: {{ $labels.hostname }}, 进程不存在: {{ $labels.groupname }}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">wxurl</span><span class="p">:</span><span class="w"> </span><span class="l">webhook1,webhook2</span><span class="w">
</span><span class="w">      </span><span class="nt">mobile</span><span class="p">:</span><span class="w"> </span><span class="l">phone1,phone2</span><span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<hr>
<br>
<br>
<h1 id="集成">集成</h1>
<p>INSTRUMENTING</p>
<br>
<h2 id="客户端库">客户端库</h2>
<p>CLIENT LIBRARIES: <a href="https://prometheus.io/docs/instrumenting/clientlibs/">https://prometheus.io/docs/instrumenting/clientlibs/</a></p>
<p>在监控服务之前，您需要通过 Prometheus 客户端库在其代码中添加集成。</p>
<p>选择与你编程语言相匹配的prometheus client library。你可以通过你的应用程序实例的HTTP endpoint来定义和暴露内部指标数据。</p>
<p>当prometheus采集你实例的HTTP端点时，客户端库会将所有指标的当前状态发送给prometheus server。</p>
<br>
<br>
<h2 id="编写客户端库">编写客户端库</h2>
<p>WRITING CLIENT LIBRARIES: <a href="https://prometheus.io/docs/instrumenting/writing_clientlibs/">https://prometheus.io/docs/instrumenting/writing_clientlibs/</a></p>
<p>本章涵盖了Prometheus client libraries应该提供的功能和API。支持10种编程语言，因此编写客户端有很好的感觉。</p>
<br>
<h3 id="惯例">惯例</h3>
<p>Conventions</p>
<p>应该注意的事：</p>
<ul>
<li>采取每门语言的优点</li>
<li>常见的使用情况应该很容易</li>
<li>做某事的正确方式应该是简单的方式</li>
<li>更复杂的用例应该是可能的</li>
</ul>
<p>常见用例：</p>
<ul>
<li>Counters without labels spread liberally around libraries/applications</li>
<li>Timing functions/blocks of code in Summaries/Histograms</li>
<li>Gauges to track current states of things (and their limits)</li>
<li>Monitoring of batch jobs</li>
</ul>
<br>
<br>
<h3 id="整体结构">整体结构</h3>
<p>Overall structure</p>
<p>客户端必须在内部进行回调以进行写操作。客户端一般应该遵循如下描述的结构。</p>
<p>关键类是收集器(collector)。这有个方法(一般称为collect)，此方法返回0和更多指标和样本。Collectors get registered with a CollectorRegistry. 数据通过传递一个CollectorRegistry到一个bridge类/方法/函数来公开，返回的是Promehteus支持的格式指标。每次CollectorRegistry抓取它必须回调每个收集器的收集方法。</p>
<p>大多数用户交互的接口是Counter, Gauge, Summary, Histogram收集器。这些代表一个单一指标，并应涵盖绝大多数使用情况，其中用户集成自己的代码。</p>
<p>更高级的用户案例（如从其它监控系统进行代理）需要编写一个自定义收集器。有人可能还希望编写一个bridge，以一个格式不同的监控系统来产生CollectorRegistry和生成数据，允许用户只考虑一个集成系统。</p>
<p>CollectorRegistry应该提供<code>register()</code>, <code>unregister()</code>函数，并且一个收集器应该被允许注册到多个CollectorRegistrys。</p>
<p>客户端必须是线程安全的。</p>
<br>
<p><strong>命名</strong></p>
<p>Namming</p>
<p>客户端库应遵循此文档中提及的函数，方法，类名称，记住它们的命名规范。例如，<code>set_to_current_time()</code>是一个好的Python命名规范，<code>SetToCurrentTime()</code>是一个好的Go命名规范，<code>setToCurrentTime()</code>是一个好的Java命名规范。</p>
<br>
<br>
<h3 id="指标">指标</h3>
<p>Metrics</p>
<p>Counter, Gauge, Summary, Histogram指标类型是用户的主要接口。</p>
<p>Counter和Gauge必须是客户端库的一部分。Summary和Histogram至少有一个必须提供。</p>
<p>这些应主要用于为静态文件变量(file-static variables)，也就是说，全局变量定义在同一个文件，因为他们集成代码。客户端库应该启用它。常用情况是集成一段整体代码，而不是一个对象的一个实例的上下文中的一段代码。用户不应该在代码中担心探测他们的指标，客户端库应该代劳。</p>
<p>必须有一个默认的CollectorRegistry，默认的标准指标必须隐式注册到它与该用户不需要的特殊工作。必须有一个方式来让指标不注册到默认CollectorRegistry，在批处理作业和单元测试。自定义收集器应该遵顼这一点。</p>
<p>究竟编程语言应该如何创建指标。对于一些(Java, Go)构建器方法是最好的，对于其它(Python)函数参数是足够丰富的。</p>
<p>Java样例客户端:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">YourClass</span> <span class="o">{</span>
  <span class="kd">static</span> <span class="kd">final</span> <span class="n">Counter</span> <span class="n">requests</span> <span class="o">=</span> <span class="n">Counter</span><span class="o">.</span><span class="na">build</span><span class="o">()</span>
      <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">&#34;requests_total&#34;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">help</span><span class="o">(</span><span class="s">&#34;Requests.&#34;</span><span class="o">).</span><span class="na">register</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><br>
<p><strong>Counter</strong></p>
<p>Counter是一个单调递增的计数器。它不允许值减少，但可能被重置为0（如服务器重启）。</p>
<p>计数器必须有以下方法：</p>
<ul>
<li><code>inc()</code>：计数器递增1</li>
<li><code>inc(douvel v)</code>：计数器由给定数增加（<code>v&gt;=0</code>）</li>
</ul>
<p>计数器必须从0开始。</p>
<p>计数器建议有：</p>
<ul>
<li>计算给定一段代码异常抛出/升起的方法，可选地仅特定异常类型</li>
</ul>
<br>
<p><strong>Gauge</strong></p>
<p>Gauge表示一个值可增可减。</p>
<p>测量必须有以下方法：</p>
<ul>
<li><code>inc()</code>：测量递增1</li>
<li><code>inc(double v)</code>：测量由给定数增加</li>
<li><code>dec()</code>：测量递减1</li>
<li><code>dec(double v)</code>：测量由戈丁数减少</li>
<li><code>set(double v)</code>：测量被设置为给定值</li>
</ul>
<p>测量必须从0开始，你也可以在启动时提供一个不同值。</p>
<p>测量应该有以下方法：</p>
<ul>
<li><code>set_to_current_time()</code>：将测量设置为unixtime</li>
</ul>
<p>测量建议有：</p>
<ul>
<li>使用一个方法来追踪某条函数/代码正在进行的请求。在Python中是<code>track_inprogress</code>。</li>
</ul>
<p>测试一段代码实践的一个方法和测试测量的持续时间。这对于批量作业很有用。</p>
<br>
<p><strong>Summary</strong></p>
<p>Summary样例观察滑动时间窗，兵器提供分布、频率、和的瞬时观察。</p>
<p>摘要绝不允许用户设置quantile作为标签名，因为这是内部使用的指定摘要总数(summary quantiles)。摘要鼓励提供quantiles作为exports，但这些都布恩那个进行聚合，并趋于缓慢。摘要必须允许每个quantiles，如<code>_count</code>, <code>_sum</code>是非常有用的，这必须是默认的。</p>
<p>摘要<code>_count</code>, <code>_sum</code>必须从0开始。</p>
<p>摘要必须有的方法：</p>
<ul>
<li><code>observe(double v)</code>：观察给定的量</li>
</ul>
<p>摘要应该有的方法：</p>
<ul>
<li>以秒为用户的时间码。在Python中是<code>time()</code>。不能提供除了秒之外的其它单位。</li>
</ul>
<br>
<p><strong>Histogram</strong></p>
<p>Histogram允许事件的可分布聚合，如请求的等待时间。</p>
<p>直方图绝不允许<code>le</code>作为用户设置的label，<code>le</code>用于内部指派桶。</p>
<p>直方图必须提供一个方式来手动选择桶。方式以<code>linear(start, width, count)</code>和<code>exponential(start, factor, count)</code>应该提供来设置桶。计数必须排除<code>+Inf</code>桶。</p>
<p>直方图应该有相同的默认桶作为其它客户端库。一旦创建了指标桶就不能改变。</p>
<p>直方图必须有的方法：</p>
<ul>
<li><code>observe(double v)</code></li>
</ul>
<p>直方图应该有的方法：</p>
<ul>
<li>以秒为用户的时间码。不能提供除了秒之外的其它单位。</li>
</ul>
<br>
<p><strong>标签</strong></p>
<p>Labels</p>
<p>标签是Prometheus最强大的一个方面，但容易被滥用。因此客户端库必须在提供标签给用户时必须非常小心。</p>
<p>客户端库必须在任何情况下让用户为Gauge, Counter, Summary, Histogram或其它由库提供的任意收集器有不同的标签名。</p>
<p>自定义收集器指标应该总是具有一致的标签名。客户端不该对此进行验证。</p>
<p>虽然标签很强大，但多数指标没有标签。因此，API应该允许标签，而不是控制它。</p>
<p>一个客户端库必须允许在Gauge, Counter, Summary, Histogram创建时间指定任意标签名的列表。客户端库应该支持任意数量的标签名。客户端库必须验证标签名称符合文件要求。</p>
<p>提供访问指标的标记尺寸的一般方法是通过<code>labels()</code>方法，它可以以标签指列表或从标签名到标签执的映射，并返回一个child。通常是<code>.inc()</code>, <code>.dec()</code>, <code>.observe()</code>等等。方法可以在child上调用。</p>
<p>通过<code>labels()</code>返回的Child应该由用户缓存，以避免再次看到它。</p>
<p>有标签的指标应该支持有相同签名作为<code>labels()</code>的<code>remove()</code>方法，这将从指标中移除一个child并不再公开它，<code>clear()</code>方法将移除指标的所有孩子。</p>
<p>这应该有一个方法，来初始化一个带有默认值的孩子，通常只是调用<code>labels()</code>。不带标签的指标必须总是被初始化，以避免缺失指标问题。</p>
<br>
<p><strong>指标名称</strong></p>
<p>Metric names</p>
<p>指标名称必须遵循规范。正如指标名称，这必须满足Gauge, Counter, Summary, Histogram的用途，并与该库提供的任意收集器。</p>
<p>许多客户端库提供三个部分来设置名称：<code>namespace_subsystem_name</code>。</p>
<p>动态/生成 指标名称或指标名子部分必须阻止，当一个自定义收集器从其它监控系统代理时除外。动态的/生成的 指标名称是你要使用的标签而不是一个标志。</p>
<br>
<p><strong>指标描述和帮助</strong></p>
<p>Metric description and help</p>
<p>Gauge/Counter/Summary/Histogram 必须要求提供指标描述和帮助。客户端库提供的任意自定义收集器必须在指标上有描述和帮助。</p>
<br>
<br>
<h3 id="公开">公开</h3>
<p>Exposition</p>
<p>客户端必须执行基于文本的公开格式，详细文档: <a href="https://prometheus.io/docs/instrumenting/exposition_formats/">https://prometheus.io/docs/instrumenting/exposition_formats/</a></p>
<p>公开的指标的可再现的顺序是鼓励的（尤其是以人类可读的格式），如果它可在没有显著资源成本增加来实现。</p>
<br>
<br>
<h3 id="标准和运行时收集器">标准和运行时收集器</h3>
<p>Standard and runtime collectors</p>
<p>客户端库应该在标准导出中提供些什么，下面将介绍。</p>
<p>这些应该被实现为自定义收集器，并在默认的CollectorRegistry默认注册。应该有方式来禁用这些。</p>
<br>
<p><strong>进程指标</strong></p>
<p>Process metrics</p>
<p>这有一些以<code>process_</code>为前缀的指标。如果获得必要的值是有问题的，或甚至根本无法使用语言，或运行时，客户端库应该留出相应的指标或特殊值(如<code>NaN</code>)。所有以字节的内存值，所有以unixtime/seconds的时间。</p>
<table>
<thead>
<tr>
<th>指标名</th>
<th>帮助字符串</th>
<th>单位</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>process_cpu_seconds_total</code></td>
<td>Total user and system CPU time spent in seconds</td>
<td>seconds</td>
</tr>
<tr>
<td><code>process_open_fds</code></td>
<td>Number of open file descriptors</td>
<td>file descriptors</td>
</tr>
<tr>
<td><code>process_max_fds</code></td>
<td>Maximum number of open file descriptors</td>
<td>file descriptors</td>
</tr>
<tr>
<td><code>process_virtual_memory_bytes</code></td>
<td>Virtual memory size in bytes</td>
<td>bytes</td>
</tr>
<tr>
<td><code>process_virtual_memory_max_bytes</code></td>
<td>Maximum amount of virtual memory available in bytes</td>
<td>bytes</td>
</tr>
<tr>
<td><code>process_resident_memory_bytes</code></td>
<td>Resident memory size in bytes</td>
<td>bytes</td>
</tr>
<tr>
<td><code>process_heap_bytes</code></td>
<td>Process heap size in bytes</td>
<td>bytes</td>
</tr>
<tr>
<td><code>process_start_time_seconds</code></td>
<td>Start time of the process since unix epoch in seconds</td>
<td>seconds</td>
</tr>
</tbody>
</table>
<br>
<p><strong>运行时指标</strong></p>
<p>Runtime metrics</p>
<p>此外，客户端库鼓励提供有意义的指标当语言运行时，如<code>go_</code>, <code>hotspot_</code>等等前缀开头的相关指标。</p>
<br>
<br>
<h3 id="单元测试">单元测试</h3>
<p>Unit tests</p>
<p>客户端库应该有覆盖核心集成库和公开的单元测试。</p>
<p>客户端库鼓励提供一个方式，使用户更容易进行单元测试。例如，在Python中有<code>CollectorRegistry.get_sample_value</code>。</p>
<br>
<br>
<h3 id="打包和依赖">打包和依赖</h3>
<p>Packaging and dependencies</p>
<p>理想情况下，客户端库可以被包括在任意应用程序中添加一些集成而不会破坏程序。因此，添加客户端库的依赖时请小心。</p>
<br>
<br>
<h3 id="性能考虑">性能考虑</h3>
<p>Performance considerations</p>
<p>由于客户端库必须是线程安全的，需要某种形式的并发控制和考虑多核机器和应用程序的性能。</p>
<p>根据经验最少的高性能是互斥。处理器原子指令往往是在中间，并且一般是可接受的。</p>
<p>如上所述，<code>labels()</code>的结果应该是可缓存的。指标应该避免被阻塞当它们被递增或递减时。</p>
<br>
<br>
<h2 id="推送指标">推送指标</h2>
<p>PUSHING METRICS: <a href="https://prometheus.io/docs/instrumenting/pushing/">https://prometheus.io/docs/instrumenting/pushing/</a></p>
<p>偶尔，你需要监控不能被抓取的组件。Prometheus Pushgateway允许你推送指标。与Prometheus简单额基于文本格式相结合，这使得它很容易集成，甚至使用shell脚本而不需要客户端库。</p>
<br>
<br>
<h2 id="探针和集成">探针和集成</h2>
<p>EXPORTERS AND INTEGRATIONS: <a href="https://prometheus.io/docs/instrumenting/exporters/">https://prometheus.io/docs/instrumenting/exporters/</a></p>
<p>有许多库和第三方系统可为Prometheus提供相应的指标。</p>
<br>
<h3 id="第三方探针">第三方探针</h3>
<p>Third-party exporters</p>
<p>有一些探针是由Prometheus官方维护的，其它的是由第三方贡献和维护。</p>
<br>
<br>
<h2 id="编写探针">编写探针</h2>
<p>WRITING EXPORTERS: <a href="https://prometheus.io/docs/instrumenting/writing_exporters/">https://prometheus.io/docs/instrumenting/writing_exporters/</a></p>
<p>如果你在集成自己的代码，那么Prometheus client library如何集成自己的代码的通用规则应该被遵守。当从另一个监控或集成系统采取指标时，事情往往并不是非黑即白。</p>
<p>当编写一个探针或自定义收集器时，此文档包含的事情你应该考虑。</p>
<br>
<br>
<h3 id="可维护性和纯度">可维护性和纯度</h3>
<p>Maintainability and purity</p>
<p>当你编写一个探针时，你需要做出的一个决定是有多少工作你愿意放在获得完美的指标上。</p>
<p>如果有问题的系统只有很少改变的指标的一小撮，然后让一切完美是一个容易的选择，一个好的样例是<a href="https://github.com/prometheus/haproxy_exporter" target="_blank" rel="noopener noreffer ">HAProxy exporter</a></p>
<p>在另一方面，当系统上有上百个指标是新版本经常变动的，如果你想试图把事情做完美，那么你已经给自己制造了许多正在进行的工作。<a href="https://github.com/prometheus/mysqld_exporter" target="_blank" rel="noopener noreffer ">MysQL exporter</a>在这系列(spectrum)的末端。</p>
<p><a href="https://github.com/prometheus/node_exporter" target="_blank" rel="noopener noreffer ">node exporter</a>是这些的混合。例如，<code>mdadm</code>收集器手动解析一个文件并公开为此收集器特定创建的指标。对于<code>meminfo</code>收集器，结果跨越不同内核版本，因此我们最终做足够的转换来创建有效的指标。</p>
<br>
<br>
<h3 id="配置-1">配置</h3>
<p>Configuration</p>
<p>当程序工作时，你的目标应该是探针不需要用户自定配置就可以运行。你可能还希望提供过滤某些指标的能力（用户定义只需要收集的指标，不需要收集所有指标），降低系统的开销。例如node exporter可让用户定义收集哪些指标，虽然我是全部收集。</p>
<p>当与其它监控系统一起工作时，框架和协议，你将提供额外的配置或自定义来生成适合Prometheus的指标。在最好的情况下，一个监控系统有类似的足够的Prometheus数据模型，你可以自动确定如何转换指标。如Cloudwatch, SNMP, collectd的情况。至多，我们需要让用户选择获取的那些指标。</p>
<p>也就是探针配置简单化，探针指标用户可选择。</p>
<p>在其它情况下，系统指标是不是十分标准的，这却决于系统和底层应用的使用情况。在这种情况下，用户必须告诉我们如何转换转换指标。<a href="https://github.com/prometheus/jmx_exporter" target="_blank" rel="noopener noreffer ">JMX exporter</a>是最明显的案例，与<a href="https://github.com/prometheus/graphite_exporter" target="_blank" rel="noopener noreffer ">Graphite exporter</a>和<a href="https://github.com/prometheus/statsd_exporter" target="_blank" rel="noopener noreffer ">StatsD exporter</a>也需要配置来提取标签。</p>
<p>确保探针出口开箱没有配置，以及提供需要转换的示例配置的选择，这是一个建议。</p>
<p>YAML是标准的Prometheus配置格式，所有配置默认都应该适应YAML。</p>
<br>
<br>
<h3 id="指标-1">指标</h3>
<p>Metrics</p>
<br>
<h4 id="命名">命名</h4>
<p>Naming</p>
<p>遵循指标命名的最佳实践。</p>
<p>指标名不应该由程序产生，除非在编写自定义收集器或探针时。</p>
<p>指标必须使用基础单位并让它们转换为更可读的图形工具。无论你使用了什么单位，指标名中的单位必须匹配在使用的单位。类似地，公开比率(ratios)，而不是百分比(percentages)。</p>
<p>指标名不应该包含导出的标签，如果标签被聚集将没有意义。Prometheus指标和标签名以<code>snake_case</code>编写。公开的指标不应包含冒号，这些被保留用于用户定义记录规则(recording rules)，当使用聚合时。</p>
<p>只有<code>[a-zA-Z0-9:_]</code>是有效的指标名。</p>
<p><code>_sum</code>, <code>_count</code>, <code>_bucket</code>, <code>_total</code>后缀用于Summary, Histogram, Counter。<code>_total</code>是Counter的惯例，如果你使用COUNTER类型你应该使用它。</p>
<p><code>process_</code>, <code>scrape_</code>前缀是保留的。</p>
<p>当你有一个successful request count和一个failed request count，最佳的方式是一个指标用于成功的请求，另一个指标用于失败的请求。这很容易计算出失败率。不要使用带success或failed标签的一个指标。同样，此规则也同样适用于其它指标。</p>
<p>一个带有原始名的<code>HELP</code>字符串可以提供大部分相同的好处。</p>
<br>
<br>
<h4 id="标签">标签</h4>
<p>Labels</p>
<p>避免将type作为标签名称，它过于笼统往往无意义。你应该尝试尽可能地避免发生冲突，如<code>region</code>, <code>cluster</code>等等。但是，如果这就是应用程序调用的一些资源，最好不要通过重命名来引起混乱。</p>
<p>因此要避免把东西放入一个指标，只是因为它们共享一个前缀。除非你确定一个指标是有意义的，多个指标是安全的。</p>
<p><code>le</code>标签对于Histogram有特殊意义，<code>quantile</code>标签对于Summary有特殊意义。通常避免使用这些标签。write/read， send/receive最好划分为单独的指标，而不是一个指标。</p>
<p>经验法则是，当求和或求平均值时，一个指标应该是有意义的。</p>
<br>
<br>
<h4 id="类型">类型</h4>
<p>Type</p>
<p>你应该尝试匹配你的指标类型到Prometheus类型。这通常是counters和gauges。通常它不会很明显指标是什么类型，特别是如果你自动处理一组指标。一般<code>UNTYPED</code>是一个安全的默认值。</p>
<br>
<br>
<h4 id="帮助字符串">帮助字符串</h4>
<p>Help strings</p>
<p>当你转换指标时，它对用于能够追踪原来是什么样的有帮助，以及造成这种转换有什么规则。将收集器或探针名称、应用的任意规则的ID和名称和原始指标的详情写入帮助字符串将极大地帮助用户。</p>
<p>Prometheus不喜欢一个字段有不同的帮助字符串。</p>
<p>示例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># HELP node_cooling_device_max_state Maximum throttle state of the cooling device
# TYPE node_cooling_device_max_state gauge
node_cooling_device_max_state{name=&#34;0&#34;,type=&#34;Processor&#34;} 7
node_cooling_device_max_state{name=&#34;1&#34;,type=&#34;Processor&#34;} 7
node_cooling_device_max_state{name=&#34;2&#34;,type=&#34;Processor&#34;} 7
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<h4 id="丢弃更少的有用信息">丢弃更少的有用信息</h4>
<p>Drop less useful statistics</p>
<p>有些集成系统公开了1m, 5m, 15m率、平均率，在应用程序启动的时候。</p>
<p>这些都应该被丢弃，因为它们不是很有用，并添加了混乱。Prometheus可以自己计算比率，并且通常作为公开的平均值呈指数衰减。</p>
<br>
<br>
<h4 id="点字符串">点字符串</h4>
<p>Dotted strings</p>
<p>许多监控系统没有标签，而是使用点: <code>my.class.path.mymetric.labelvalue1.labelvalue2.labelvalue3</code></p>
<br>
<br>
<h3 id="收集器">收集器</h3>
<p>Collectors</p>
<p>当为探针实现收集器时，你永远不应该使用通常的直接集成方法，并在每个抓取上更新指标。</p>
<p>每次创建新的指标。在Go的<code>Collect()</code>方法中使用<code>MustNewConstMetric</code>。Python请参考: <a href="https://github.com/prometheus/client_python#custom-collectors">https://github.com/prometheus/client_python#custom-collectors</a></p>
<p>原因有两方面。首先，两个抓取可能发生在同一时间，和直接集成使用的什么是文件级别的全局变量。其次，如果一个标签执消失，它仍然将公开。</p>
<br>
<h4 id="关于抓取自身的指标">关于抓取自身的指标</h4>
<p>Metrics about the scrape itself</p>
<p>有时你想导出关于抓取的指标，如处理了多少记录等。这应该被公开为gauges当它们关于事件时，通过探针名的指标名前缀，如<code>jmx_scrape_duration_seconds</code>。</p>
<br>
<br>
<h4 id="机器和进程指标">机器和进程指标</h4>
<p>Machine and process metrics</p>
<p>许多系统，如ES，会公开机器指标（如cpu, memory, filesystem）等信息。Prometheus生态中的node exporter提供了这些信息，这些指标就应该被丢弃。</p>
<p>在Java世界里，许多集成框架公开了程序级别和JVM级别的统计信息，如CPU, GC等。Java客户端和JMX探针已包含这些，所以也应该丢弃。这同样也可用于其它类似的语言和框架。</p>
<br>
<br>
<h3 id="部署">部署</h3>
<p>Deployment</p>
<p>每个探针应该监控只有一个实例的应用程序，preferably sitting right beside it on the same machine。这意味着你运行没给一个HAProxy，你运行了一个<code>haproxy_exporter</code>进程。</p>
<br>
<h4 id="调度">调度</h4>
<p>Scheduling</p>
<p>当Prometheus抓取指标时，指标应该从应用处拉取，探针不应该基于自己的定时器执行抓取。也就是说，所有的抓取都应该是同步的(synchronous)。</p>
<p>因此，你不应该在公开的指标上设置时间戳，而让Prometheus来做。如果你认为需要时间戳，那么你可能需要使用pushgateway来代替。</p>
<p>如果检索指标特别昂贵，即超过了一分钟，可以接受的是缓存它(cache it)。这应该在注释在HELP字符串中。</p>
<p>Prometheus默认抓取的超时时间是10s。如果你的探针希望超过这一点，你应该在你的用户文档中明确的调用此。</p>
<br>
<br>
<h4 id="推送">推送</h4>
<p>Pushes</p>
<p>有些应用程序和监控系统只能推送指标(push metrics)，如StatsD, Graphite, collectd。有两方面的考虑：</p>
<p>首先，指标什么时候过期？
其次，这些类型的系统倾向于允许你的用户发送变化量(deltas)或原始计数器(raw counter)。你应该尽可能依赖原生计数器，因为这一般是Prometheus model。</p>
<p>对于服务级别的指标，你应该有探针推送到Pushgateway，在事件而不是你自己处理状态之后退出。对于实例级别的指标，还没有明确模式。</p>
<br>
<br>
<h4 id="抓取失败">抓取失败</h4>
<p>Failed scrapes</p>
<p>目前有两种模式的抓取失败，当应用程序不响应或其它问题时。</p>
<p>第一个就是返回<code>5xx</code>错误。</p>
<p>第二个是有一个<code>myexporter_up</code>，如<code>haproxy_up</code>，值是0还是1依赖于抓取工作。</p>
<p>后者更好，即使抓取失败，你还可以得到一些有用的指标。</p>
<br>
<br>
<h4 id="抓取页面">抓取页面</h4>
<p>Landing page</p>
<p>访问地址，如<code>http://expoter:port</code>作为一个简单的包含探针名称的HTML页面，并有指向<code>/metrics</code>页面的链接。</p>
<br>
<br>
<h4 id="端口号">端口号</h4>
<p>Port numbers</p>
<p>用户在一个机器上可能有多个探针和Prometheus组件，为了使得事情更简单每个需要有一个唯一的端口号。这个页面<a href="https://github.com/prometheus/prometheus/wiki/Default-port-allocations">https://github.com/prometheus/prometheus/wiki/Default-port-allocations</a>包含了Prometheus组件和探针目前使用的端口号。</p>
<p>为自己的探针分配一个合理的，没有使用的端口号。</p>
<br>
<br>
<h3 id="宣布">宣布</h3>
<p>Announcing</p>
<p>一旦你准备向世界宣布你的探针，请在<a href="https://github.com/prometheus/docs/blob/master/content/docs/instrumenting/exporters.md" target="_blank" rel="noopener noreffer ">可用的探针列表</a>提交一个PR。</p>
<br/>
<br/>
<h2 id="textfile">textfile</h2>
<p>可以在<code>node_exporter</code>中使用textfile，来获取用户生成的自定义的指标，存入textfile目录下文件内。</p>
<p>启动的时候加上<code>--collector.textfile.directory</code>参数，此目录下文件后缀为<code>xxx.prom</code>。</p>
<p>可以使用supervisor守护编写的脚本，每分钟生成自定义指标写入textfile目录下的对应指标文件。</p>
<p>示例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">node_exporter --collector.textfile.directory<span class="o">=</span>/tmp/textfile

<span class="nb">cd</span> /tmp/textfile
cat test1.prom
<span class="c1"># TYPE test1 gauge</span>
<span class="c1"># HELP test1 test</span>
test1 <span class="m">1</span>
</code></pre></td></tr></table>
</div>
</div><br>
<br>
<hr>
<br>
<br>
<h1 id="最佳实践">最佳实践</h1>
<p>BEST PRACTICES</p>
<br>
<h2 id="指标和标签命名">指标和标签命名</h2>
<p>METRIC AND LABEL NAMING: <a href="https://prometheus.io/docs/practices/naming/">https://prometheus.io/docs/practices/naming/</a></p>
<p>指标和标签的约定不需要使用Prometheus，但可以作为一个风格指南和最佳实践的集合。</p>
<br>
<h3 id="指标名称">指标名称</h3>
<p>Metric names</p>
<p>一个指标名称：</p>
<ul>
<li>必须符合有效字符的数据模型</li>
<li>应该有一个应用程序(single-word)相关的指标所属前缀。如：
<ul>
<li><code>prometheus_notifications_total</code></li>
<li><code>process_cpu_seconds_total</code></li>
<li><code>http_request_duration_seconds</code></li>
</ul>
</li>
<li>必须有一个单一的单位（如秒，毫秒等）</li>
<li>应该使用基本单位（如seconds, bytes, meters，而不是milliseconds, megabytes, kilometers）</li>
<li>应该有一个描述单位的后缀。如：
<ul>
<li><code>http_request_duration_seconds</code></li>
<li><code>node_memory_usage_bytes</code></li>
<li><code>http_requests_total</code></li>
<li><code>process_cpu_seconds_total</code></li>
<li><code>foobar_build_info</code></li>
</ul>
</li>
<li>should represent the same logical thing-being-measured across all label dimensions
<ul>
<li>request duration</li>
<li>bytes of data transfer</li>
<li>instantaneous resource usage as a percentage</li>
</ul>
</li>
</ul>
<p>作为一个经验，在给定指标的所有尺寸上，无论是<code>sum()</code>还是<code>avg()</code>都应该是有意义的。如果没有意义，则将数据分裂成多个指标。</p>
<br>
<br>
<h3 id="标签-1">标签</h3>
<p>Labels</p>
<p>使用标签来区分被测量的事物的特点：</p>
<ul>
<li><code>api_http_requests_total</code>，不同的请求类型：<code>operation=&quot;create|update|delete&quot;</code></li>
<li><code>api_request_duration_seconds</code>，不同的请求阶段：<code>stage=&quot;extract|transform|load&quot;</code></li>
</ul>
<p>不要将标签名对应到指标名，如果相应的标签聚合了，这会冗余并造成混乱。</p>
<blockquote>
<p>注意：
请记住，标签键值对每一个独特的组合代表了一个新的时间序列，这可能会极大的提高存储的数据量。不要使用标签来存储高基数，如用户ID，邮件地址等。</p>
</blockquote>
<br>
<br>
<h3 id="基本单位">基本单位</h3>
<p>Base units</p>
<p>Prometheus没有硬编码任何单位。为了更好的兼容性，应该使用基本单位。以下是一些栗子：</p>
<table>
<thead>
<tr>
<th>Family</th>
<th>Base unit</th>
<th>Remark</th>
</tr>
</thead>
<tbody>
<tr>
<td>Time</td>
<td>seconds</td>
<td>-</td>
</tr>
<tr>
<td>Temperature</td>
<td>celsius</td>
<td>摄氏度优于开尔文</td>
</tr>
<tr>
<td>Length</td>
<td>meters</td>
<td>-</td>
</tr>
<tr>
<td>Bytes</td>
<td>bytes</td>
<td>-</td>
</tr>
<tr>
<td>Bits</td>
<td>bytes</td>
<td>为了避免混淆，通常使用bytes</td>
</tr>
<tr>
<td>Percent</td>
<td>ratio</td>
<td>0-1而不是0-100</td>
</tr>
<tr>
<td>Voltage</td>
<td>volts</td>
<td>-</td>
</tr>
<tr>
<td>Electric current</td>
<td>amperes</td>
<td>-</td>
</tr>
<tr>
<td>Energy</td>
<td>joules</td>
<td>-</td>
</tr>
<tr>
<td>Mass</td>
<td>grams</td>
<td>克优于千克</td>
</tr>
</tbody>
</table>
<br>
<br>
<br>
<br>
<h2 id="控制台和仪表盘">控制台和仪表盘</h2>
<p>CONSOLES AND DASHBOARDS: <a href="https://prometheus.io/docs/practices/consoles/">https://prometheus.io/docs/practices/consoles/</a></p>
<p>可在仪表盘上显示尽可能多的数据，特别是像Prometheus这样的系统提供了集成你的应用程序的能力。</p>
<p>我们发现以下原则非常有效：</p>
<ul>
<li>在一个控制台上不要超过五个图</li>
<li>每个图上不要超过五个线</li>
<li>当使用控制台提供的模板示例，请避免在右边表超过20-30项</li>
</ul>
<br>
<br>
<h2 id="集成-1">集成</h2>
<p>INSTRUMENTATION: <a href="https://prometheus.io/docs/practices/instrumentation/">https://prometheus.io/docs/practices/instrumentation/</a></p>
<p>本章提供了集成你的代码的一套指导方案。</p>
<br>
<h3 id="如何集成">如何集成</h3>
<p>How to instrument</p>
<p>简短的回答是集成一切。每个库、子系统和服务应该至少有几个指标来给你一个粗略的想法它是如何执行的。</p>
<br>
<h4 id="服务的三种类型">服务的三种类型</h4>
<p>The three types of services</p>
<p>为了监控的目的，服务大致可以分为三类：在线服务(online-serving)，离线处理(offline-processing)，批处理作业(batch jobs)。它们之间有重叠，但每个服务往往很好地成为这些类别。</p>
<br>
<p><strong>在线服务系统</strong></p>
<p>Online-serving systems</p>
<p>一个在线服务系统期待立即响应。例如，大多数数据库和HTTP请求都属于这一类。这种系统的关键指标是执行的查询数，错误和延迟。</p>
<br>
<p><strong>离线处理</strong></p>
<p>Offline processing</p>
<p>对于离线处理，没有人正在等待响应。也可能有多个处理阶段。对于每一个阶段，跟踪进入的项目，有多少在处理，最后一次处理的事物，以及发送了多少事物。</p>
<br>
<p><strong>批处理作业</strong></p>
<p>Batch jobs</p>
<p>在离线处理和批处理作业之间有一些模糊线，离线处理也可在批处理作业中完成。批处理作业不连续运行，这使得它们难以区分。</p>
<p>批处理作业的关键指标是它最后一次成功。这对于追踪各个阶段的花费时间，整体运行和最后一次作业完成很有用。对于那些超过几分钟时间运行的批处理作业，使用基于Pull监控的数据抓取很有用。对于运行很频繁地批处理作业，你应该考虑将其转换为守护程序(daemons)，作为离线处理作业来处理它们。</p>
<br>
<br>
<h4 id="子系统">子系统</h4>
<p>Subsystems</p>
<p>除了三种主要类型的服务，系统也应该监控子部分(sub-parts)。</p>
<br>
<p><strong>库</strong></p>
<p>Libraries</p>
<p>库应该提供无需用户额外配置的集成。</p>
<p>如果一个库经常访问进程外的资源（如网络、磁盘、IPC&hellip;），追踪整个查询计数，错误和延迟。</p>
<br>
<p><strong>日志</strong></p>
<p>Logging</p>
<p>作为一般规则，对与日志代码的每一行，你应该有一个递增的计数器(counter)。如果你发现一个有趣的日志信息，你要能过够看到它如何发生，而且持续多久。</p>
<br>
<p><strong>失败</strong></p>
<p>Failures</p>
<p>故障应该与日志有相似的处理。每次出现故障，计数器(counter)都应增加。不像日志，取决于你的代码结构，错误也可以丢到一个更普遍的错误计数器。当报告故障，你通常应该有一些其它指标来表示尝试的总数。这使得故障率很容易计算。</p>
<br>
<p><strong>线程池</strong></p>
<p>Threadpools</p>
<p>对于任何形式的线程池，关键指标是排队请求数，在使用的线程数，总线程数，处理的任务数，以及它们耗时多久。</p>
<br>
<p><strong>缓存</strong></p>
<p>Caches</p>
<p>缓存的关键指标是总查询、点击、总延时、查询数、错误和任何在线服务缓存前的延迟。</p>
<p><strong>收集器</strong></p>
<p>Collectors</p>
<p>当实现一个自定义指标收集器时，建议为收集花费的时间(s)导出为gauge，另一个是遇到的错误的数量。</p>
<br>
<br>
<h3 id="要提防的事">要提防的事</h3>
<p>Things to watch out for</p>
<p>当做监控时，有些事需要注意，Prometheus-specific尤其如此。</p>
<br>
<h4 id="使用标签">使用标签</h4>
<p>Use labels</p>
<p>很少有监控系统有标签和表达式语言的来利用这些优点，所以需要一些时间来使用。当你有多个指标要添加/求平均值/求和，它们通常是带有标签的指标，而不是多个指标。</p>
<p>例如，创建一个带有<code>code</code>标签的<code>http_responses_total</code>指标，而不是<code>http_responses_500_total</code>，<code>http_responses_403_total</code>两个指标。</p>
<br>
<br>
<h4 id="不要滥用标签">不要滥用标签</h4>
<p>Do not overuse labels</p>
<p>每个标签集(labelset)是具有RAM, CPU, disk, network开销的额外时间序列。通常情况下，开销可以忽略不计，但有很多机器和很多指标和很多标签的情况下，这可能会迅速增加。</p>
<p>作为一般原则，尽量保持指标的基础低于10。绝大多数的指标没有任何标签。如果你有一个有100多个基数的指标，调查替代解决方案。</p>
<p>为了让你对基数有一个更好的主意，让我们来看下<code>node_exporter</code>。节点探针公开每个挂载的文件系统的指标。如果你有10000台机器，有10000个<code>node_filesystem_avail</code>时间序列，这对于Prometheus处理很好。</p>
<p>如果你不确定，就不用标签，并随着时间的推移添加更多标签。</p>
<br>
<br>
<h4 id="四种类型比较">四种类型比较</h4>
<p>Counter vs. gauge, summary vs. histogram</p>
<p>对一个给定的指标用哪个四种主要的指标类型是很重要的。</p>
<p>在Counter和Gauge之间选择，有一个简单的经验法则：如果值可减少，这是一个Gauge。Counter只能增加，如累积的量。Gauge可以设置，增加或减少。</p>
<p>Summaries和Histograms是更复杂的指标类型。</p>
<br>
<br>
<h4 id="时间戳">时间戳</h4>
<p>Timestamps, not time since</p>
<p>如果你想追踪从某事发生时的时间量，导出在它发生时的Unix时间戳，而不是从它发生的时间。</p>
<p>导出了时间戳，可以使用<code>time() - my_timestamp_metric</code>表达式计算时间。</p>
<br>
<br>
<h4 id="避免缺失指标">避免缺失指标</h4>
<p>Avoid missing metrics</p>
<p>时间序列，直到某事发生不存在难以应付，因为通常的简单操作不足以正确处理它们。为了避免这种情况，你事先知道可能存在的任何时间序列输出为0(或NaN)。</p>
<p>大多数Prometheus Client Libraries(go, java, python)会为没有标签的指标自动导出0。</p>
<br>
<br>
<br>
<h2 id="hisgogram和summary">Hisgogram和Summary</h2>
<p>HISTOGRAMS AND SUMMARIES: <a href="https://prometheus.io/docs/practices/histograms/">https://prometheus.io/docs/practices/histograms/</a></p>
<br>
<br>
<br>
<h2 id="告警-1">告警</h2>
<p>ALERTING: <a href="https://prometheus.io/docs/practices/alerting/">https://prometheus.io/docs/practices/alerting/</a></p>
<p>请先阅读<a href="https://docs.google.com/document/d/199PqyG3UsyXlwieHaqbGiWVa8eMWi8zzAn0YfcApr8Q/edit" target="_blank" rel="noopener noreffer ">My Philosophy on Alerting</a></p>
<br>
<h3 id="告警什么">告警什么</h3>
<p>What to alert on</p>
<p>目标是告警越少越好，告警要有目的，别瞎告。告警应该很容易找到哪些部件的故障。</p>
<br>
<br>
<br>
<h2 id="记录规则-2">记录规则</h2>
<p>RECORDING RULES: <a href="https://prometheus.io/docs/practices/rules/">https://prometheus.io/docs/practices/rules/</a></p>
<p>记录规则的一致性命名方案，可以一目了然地理解规则的含义。本节可以正确聚合和建议命名规范。</p>
<br>
<h3 id="命名和聚合">命名和聚合</h3>
<p>Naming and aggregation</p>
<p>记录规则(recording rules)应该是这样的一般形式：<code>level:metric:operations</code>。level表示聚合级别和规则输出的标签；metric是指标名称并在使用<code>rate()</code>这些方法时应该保持不变；operations是一个应用到指标的操作列表。</p>
<p>保持指标名称不变，使得易于知道指标是什么和容易在代码库中找到它。</p>
<p>如一些常见的: <code>sum</code>, <code>ratio</code>, <code>count</code>这些。</p>
<br>
<br>
<h3 id="示例">示例</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">- <span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">instance_path:requests:rate5m</span><span class="w">
</span><span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">rate(requests_total{job=&#34;myjob&#34;}[5m])</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">path:requests:rate5m</span><span class="w">
</span><span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">sum without (instance)(instance_path:requests:rate5m{job=&#34;myjob&#34;})</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">instance_path:request_failures:rate5m</span><span class="w">
</span><span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">rate(request_failures_total{job=&#34;myjob&#34;}[5m])</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">instance_path:request_failures_per_requests:ratio_rate5m</span><span class="w">
</span><span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">|2</span><span class="w">
</span><span class="w">      </span><span class="l">instance_path:request_failures:rate5m{job=&#34;myjob&#34;}</span><span class="w">
</span><span class="w">    </span><span class="l">/</span><span class="w">
</span><span class="w">      </span><span class="l">instance_path:requests:rate5m{job=&#34;myjob&#34;}</span><span class="w">
</span><span class="w">
</span><span class="w"></span>- <span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">job:request_latency_seconds_count:avg_rate5m</span><span class="w">
</span><span class="w">  </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l">avg without (instance, path)(instance:request_latency_seconds_count:rate5m{job=&#34;myjob&#34;})</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><br>
<br>
<br>
<h2 id="pushgateway">Pushgateway</h2>
<p>WHEN TO USE THE PUSHGATEWAY: <a href="https://prometheus.io/docs/practices/pushing/">https://prometheus.io/docs/practices/pushing/</a></p>
<p>Pushgateway是一个中间服务，允许你从无法抓取的作业处推送指标。更多详情，查看<a href="https://prometheus.io/docs/instrumenting/pushing/" target="_blank" rel="noopener noreffer ">push metrics</a></p>
<br>
<h3 id="应该使用pushgateway吗">应该使用Pushgateway吗</h3>
<p>Should I be using the Pushgateway?</p>
<p>我们只建议在某些有限的示例中使用Pushgateway。盲目地使用Pushgateway push来代替Prometheus pull有几个陷阱：</p>
<ul>
<li>通过Pushgateway监控多个实例，Pushgateway成为单一的失败点和潜在的瓶颈。</li>
<li>你失去了Prometheus通过<code>up</code>自动检测实例健康。</li>
<li>Pushgateway永远不会忘记推送它，并公开它们给Prometheus，除非这些序列通过PushgatewayApi手动删除。</li>
</ul>
<p>如果原始实例重命名或删除，实例的指标将保留在Pushgateway中。这是因为PushGateway作为指标缓存的生命周期与推送指标的进程的生命周期分开。与Prometheus pull方式对比时，当一个实例消失时，实例的指标将自动消失。使用Pushgateway时，不不是这种情况，你必须手动删除任何陈旧的指标，或自动执行生命周期同步。</p>
<p>通常，Pushgateway的唯一有效用例是用于捕获一个服务级别的批处理作业的结果(outcome)。一个服务级别的批处理作业是与特定机器或作业实例相关的。这样的作业的指标不应包含一个机器或实例标签，以将特定机器的生命周期与推送指标的实例分开。这降低了管理Pushgateway中的陈旧指标的负担。</p>
<br>
<br>
<h3 id="替代策略">替代策略</h3>
<p>Alternative strategies</p>
<p>如果入站防火墙和NAT阻止您从目标机器抓取指标，考虑将Prometheus Server移动到网络后面。我们通常建议在同一网络上运行Prometheus Server来作为监控实例。否则，考虑<a href="https://github.com/prometheus-community/PushProx" target="_blank" rel="noopener noreffer ">PushProx</a>，它允许Prometheus跨过防火墙或NAT。</p>
<br>
<br>
<br>
<h2 id="远程存储">远程存储</h2>
<p>REMOTE WRITE TUNING: <a href="https://prometheus.io/docs/practices/remote_write/">https://prometheus.io/docs/practices/remote_write/</a></p>
<p>Prometheus实现了合理的默认远程写，但许多用户有不同的要求，并希望优化远程设置。</p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2018-09-11</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/prometheus/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://zhang21.cn/prometheus/" data-title="Prometheus" data-hashtags="DevOps,Prometheus,Monitor,Alert"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://zhang21.cn/prometheus/" data-title="Prometheus"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Reddit" data-sharer="reddit" data-url="https://zhang21.cn/prometheus/"><i class="fab fa-reddit fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://zhang21.cn/prometheus/" data-title="Prometheus"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.0.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://zhang21.cn/prometheus/" data-title="Prometheus"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/devops/">DevOps</a>,&nbsp;<a href="/tags/prometheus/">Prometheus</a>,&nbsp;<a href="/tags/monitor/">Monitor</a>,&nbsp;<a href="/tags/alert/">Alert</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/kubernetes/" class="prev" rel="prev" title="Kubernetes"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Kubernetes</a>
            <a href="/bootstrap/" class="next" rel="next" title="Bootstrap">Bootstrap<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.83.1">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2017 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://zhang21.cn" target="_blank">Zhang21</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css"><script type="text/javascript" src="https://zhang21.disqus.com/embed.js" defer></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":20},"comment":{},"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"RZ22ZCTIDN","algoliaIndex":"hugo-index","algoliaSearchKey":"11ec277ef4d730e232eda9651548da78","highlightTag":"em","maxResultLength":20,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"twemoji":true};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
